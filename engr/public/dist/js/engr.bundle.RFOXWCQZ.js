(()=>{var Dr=Object.create;var Ft=Object.defineProperty;var Er=Object.getOwnPropertyDescriptor;var Or=Object.getOwnPropertyNames;var Hr=Object.getPrototypeOf,Mr=Object.prototype.hasOwnProperty;var jt=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var Pr=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Or(e))!Mr.call(o,i)&&i!==t&&Ft(o,i,{get:()=>e[i],enumerable:!(r=Er(e,i))||r.enumerable});return o};var qr=(o,e,t)=>(t=o!=null?Dr(Hr(o)):{},Pr(e||!o||!o.__esModule?Ft(t,"default",{value:o,enumerable:!0}):t,o));var Wt=jt((_s,Be)=>{(function(e){"use strict";typeof define=="function"&&define.amd?define(e):typeof Be!="undefined"&&typeof Be.exports!="undefined"?Be.exports=e():window.Sortable=e()})(function(){"use strict";if(typeof window=="undefined"||!window.document)return function(){throw new Error("Sortable.js requires a window with a document")};var e,t,r,i,a,s,n,_,f,m,g,v,C,I,b=[],T=!1,O=!1,F=!1,N=[],W,L,D,z,j,ee,re,ve,be=!1,Oe=!1,de,He,bt,_e,wt=/\s+/g,G="Sortable"+new Date().getTime(),V=window,k=V.document,ne=V.parseInt,fe=V.setTimeout,Ct=V.jQuery||V.Zepto,Ze=V.Polymer,xt={capture:!1,passive:!1},ie=!!navigator.userAgent.match(/(?:Trident.*rv[ :]?11\.|msie|iemobile)/i),Me=!!navigator.userAgent.match(/Edge/i),St=Me||ie?"cssFloat":"float",mr="draggable"in k.createElement("div"),et=function(){if(ie)return!1;var l=k.createElement("x");return l.style.cssText="pointer-events:auto",l.style.pointerEvents==="auto"}(),tt=!1,rt=!1,oe=Math.abs,It=Math.min,Pe=[],Rt=function(l,d){var c=E(l),h=ne(c.width),p=st(l,0,d),y=st(l,1,d),w=p&&E(p),S=y&&E(y),x=w&&ne(w.marginLeft)+ne(w.marginRight)+B(p).width,R=S&&ne(S.marginLeft)+ne(S.marginRight)+B(y).width;if(c.display==="flex")return c.flexDirection==="column"||c.flexDirection==="column-reverse"?"vertical":"horizontal";if(p&&w.float!=="none"){var H=w.float==="left"?"left":"right";return y&&(S.clear==="both"||S.clear===H)?"vertical":"horizontal"}return p&&(w.display==="block"||w.display==="flex"||w.display==="table"||w.display==="grid"||x>=h&&c[St]==="none"||y&&c[St]==="none"&&x+R>h)?"vertical":"horizontal"},gr=function(l,d){for(var c=0;c<N.length;c++)if(!N[c].children.length){var h=B(N[c]),p=N[c][G].options.emptyInsertThreshold,y=l>=h.left-p&&l<=h.right+p,w=d>=h.top-p&&d<=h.bottom+p;if(y&&w)return N[c]}},yr=function(l,d,c,h,p){var y=B(c),w=h==="vertical"?y.left:y.top,S=h==="vertical"?y.right:y.bottom,x=h==="vertical"?l:d;return w<x&&x<S},vr=function(l,d,c){var h=l===e&&_e||B(l),p=d===e&&_e||B(d),y=c==="vertical"?h.left:h.top,w=c==="vertical"?h.right:h.bottom,S=c==="vertical"?h.width:h.height,x=c==="vertical"?p.left:p.top,R=c==="vertical"?p.right:p.bottom,H=c==="vertical"?p.width:p.height;return y===x||w===R||y+S/2===x+H/2},le=function(l,d){if(!l||!l.getBoundingClientRect)return V;var c=l,h=!1;do if(c.clientWidth<c.scrollWidth||c.clientHeight<c.scrollHeight){var p=E(c);if(c.clientWidth<c.scrollWidth&&(p.overflowX=="auto"||p.overflowX=="scroll")||c.clientHeight<c.scrollHeight&&(p.overflowY=="auto"||p.overflowY=="scroll")){if(!c||!c.getBoundingClientRect||c===k.body)return V;if(h||d)return c;h=!0}}while(c=c.parentNode);return V},it=At(function(l,d,c,h){if(d.scroll){var p=c?c[G]:window,y=d.scrollSensitivity,w=d.scrollSpeed,S=l.clientX,x=l.clientY,R=window.innerWidth,H=window.innerHeight,M=!1;f!==c&&(qe(),_=d.scroll,m=d.scrollFn,_===!0&&(_=le(c,!0),f=_));var A=0,Q=_;do{var Y=Q,Z=B(Y),Ce=Z.top,ct=Z.bottom,xe=Z.left,Ae=Z.right,ue=Z.width,se=Z.height,ae,Se,te,Le,Fe,dt,_t,je,We;if(Y!==V?(ae=Y.scrollWidth,Se=Y.scrollHeight,te=E(Y),dt=ue<ae&&(te.overflowX==="auto"||te.overflowX==="scroll"),_t=se<Se&&(te.overflowY==="auto"||te.overflowY==="scroll"),je=Y.scrollLeft,We=Y.scrollTop):(ae=k.documentElement.scrollWidth,Se=k.documentElement.scrollHeight,te=E(k.documentElement),dt=ue<ae&&(te.overflowX==="auto"||te.overflowX==="scroll"||te.overflowX==="visible"),_t=se<Se&&(te.overflowY==="auto"||te.overflowY==="scroll"||te.overflowY==="visible"),je=k.documentElement.scrollLeft,We=k.documentElement.scrollTop),Le=dt&&(oe(Ae-S)<=y&&je+ue<ae)-(oe(xe-S)<=y&&!!je),Fe=_t&&(oe(ct-x)<=y&&We+se<Se)-(oe(Ce-x)<=y&&!!We),!b[A])for(var ze=0;ze<=A;ze++)b[ze]||(b[ze]={});(b[A].vx!=Le||b[A].vy!=Fe||b[A].el!==Y)&&(b[A].el=Y,b[A].vx=Le,b[A].vy=Fe,clearInterval(b[A].pid),Y&&(Le!=0||Fe!=0)&&(M=!0,b[A].pid=setInterval(function(){h&&this.layer===0&&X.active._emulateDragOver(!0);var ft=b[this.layer].vy?b[this.layer].vy*w:0,ut=b[this.layer].vx?b[this.layer].vx*w:0;typeof m=="function"&&m.call(p,ut,ft,l,j,b[this.layer].el)!=="continue"||(b[this.layer].el===V?V.scrollTo(V.pageXOffset+ut,V.pageYOffset+ft):(b[this.layer].el.scrollTop+=ft,b[this.layer].el.scrollLeft+=ut))}.bind({layer:A}),24))),A++}while(d.bubbleScroll&&Q!==V&&(Q=le(Q,!1)));T=M}},30),qe=function(){b.forEach(function(l){clearInterval(l.pid)}),b=[]},$t=function(l){function d(p,y){return function(w,S,x,R){var H=w.options.group.name&&S.options.group.name&&w.options.group.name===S.options.group.name;if(p==null&&(y||H))return!0;if(p==null||p===!1)return!1;if(y&&p==="clone")return p;if(typeof p=="function")return d(p(w,S,x,R),y)(w,S,x,R);var M=(y?w:S).options.group.name;return p===!0||typeof p=="string"&&p===M||p.join&&p.indexOf(M)>-1}}var c={},h=l.group;(!h||typeof h!="object")&&(h={name:h}),c.name=h.name,c.checkPull=d(h.pull,!0),c.checkPut=d(h.put),c.revertClone=h.revertClone,l.group=c},kt=function(l){!e||!e.parentNode||e.parentNode[G]&&e.parentNode[G]._computeIsAligned(l)},Tt=function(l,d){for(var c=d;!c[G];)c=c.parentNode;return l===c},Dt=function(l,d,c){for(var h=l.parentNode;h&&!h[G];)h=h.parentNode;h&&h[G][c](nt(d,{artificialBubble:!0}))},Et=function(){!et&&r&&E(r,"display","none")},Ot=function(){!et&&r&&E(r,"display","")};k.addEventListener("click",function(l){if(F)return l.preventDefault(),l.stopPropagation&&l.stopPropagation(),l.stopImmediatePropagation&&l.stopImmediatePropagation(),F=!1,!1},!0);var at=function(l){if(l=l.touches?l.touches[0]:l,e){var d=gr(l.clientX,l.clientY);d&&d[G]._onDragOver({clientX:l.clientX,clientY:l.clientY,target:d,rootEl:d})}};P(k,"dragover",at),P(k,"mousemove",at),P(k,"touchmove",at);function X(l,d){if(!(l&&l.nodeType&&l.nodeType===1))throw"Sortable: `el` must be HTMLElement, not "+{}.toString.call(l);this.el=l,this.options=d=nt({},d),l[G]=this;var c={group:null,sort:!0,disabled:!1,store:null,handle:null,scroll:!0,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0,draggable:/[uo]l/i.test(l.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return Rt(l,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(y,w){y.setData("Text",w.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,touchStartThreshold:ne(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:X.supportPointer!==!1&&("PointerEvent"in window||window.navigator&&"msPointerEnabled"in window.navigator),emptyInsertThreshold:5};for(var h in c)!(h in d)&&(d[h]=c[h]);$t(d);for(var p in this)p.charAt(0)==="_"&&typeof this[p]=="function"&&(this[p]=this[p].bind(this));this.nativeDraggable=d.forceFallback?!1:mr,d.supportPointer?P(l,"pointerdown",this._onTapStart):(P(l,"mousedown",this._onTapStart),P(l,"touchstart",this._onTapStart)),this.nativeDraggable&&(P(l,"dragover",this),P(l,"dragenter",this)),N.push(this.el),d.store&&d.store.get&&this.sort(d.store.get(this)||[])}X.prototype={constructor:X,_computeIsAligned:function(l){var d;if(r&&!et?(Et(),d=k.elementFromPoint(l.clientX,l.clientY),Ot()):d=l.target,d=U(d,this.options.draggable,this.el,!1),!rt&&!(!e||e.parentNode!==this.el)){for(var c=this.el.children,h=0;h<c.length;h++)U(c[h],this.options.draggable,this.el,!1)&&c[h]!==d&&(c[h].sortableMouseAligned=yr(l.clientX,l.clientY,c[h],this._getDirection(l,null),this.options));U(d,this.options.draggable,this.el,!0)||(re=null),rt=!0,fe(function(){rt=!1},30)}},_getDirection:function(l,d){return typeof this.options.direction=="function"?this.options.direction.call(this,l,d,e):this.options.direction},_onTapStart:function(l){if(!!l.cancelable){var d=this,c=this.el,h=this.options,p=h.preventOnFilter,y=l.type,w=l.touches&&l.touches[0],S=(w||l).target,x=l.target.shadowRoot&&(l.path&&l.path[0]||l.composedPath&&l.composedPath()[0])||S,R=h.filter,H;if(kr(c),!(ie&&!l.artificialBubble&&!Tt(c,S))&&!e&&!(/mousedown|pointerdown/.test(y)&&l.button!==0||h.disabled)&&!x.isContentEditable){if(S=U(S,h.draggable,c,!1),!S){ie&&Dt(c,l,"_onTapStart");return}if(n!==S){if(H=ce(S,h.draggable),typeof R=="function"){if(R.call(this,l,S,this)){J(d,x,"filter",S,c,c,H),p&&l.cancelable&&l.preventDefault();return}}else if(R&&(R=R.split(",").some(function(M){if(M=U(x,M.trim(),c,!1),M)return J(d,M,"filter",S,c,c,H),!0}),R)){p&&l.cancelable&&l.preventDefault();return}h.handle&&!U(x,h.handle,c,!1)||this._prepareDragStart(l,w,S,H)}}}},_handleAutoScroll:function(l,d){if(!(!e||!this.options.scroll)){var c=l.clientX,h=l.clientY,p=k.elementFromPoint(c,h),y=this;if(d||Me||ie){it(l,y.options,p,d);var w=le(p,!0);T&&(!W||c!==L||h!==D)&&(W&&clearInterval(W),W=setInterval(function(){if(!!e){var S=le(k.elementFromPoint(c,h),!0);S!==w&&(w=S,qe(),it(l,y.options,w,d))}},10),L=c,D=h)}else{if(!y.options.bubbleScroll||le(p,!0)===window){qe();return}it(l,y.options,le(p,!1),!1)}}},_prepareDragStart:function(l,d,c,h){var p=this,y=p.el,w=p.options,S=y.ownerDocument,x;c&&!e&&c.parentNode===y&&(a=y,e=c,t=e.parentNode,s=e.nextSibling,n=c,C=w.group,g=h,z={target:e,clientX:(d||l).clientX,clientY:(d||l).clientY},this._lastX=(d||l).clientX,this._lastY=(d||l).clientY,e.style["will-change"]="all",e.style.transition="",e.style.transform="",x=function(){p._disableDelayedDrag(),e.draggable=p.nativeDraggable,p._triggerDragStart(l,d),J(p,a,"choose",e,a,a,g),K(e,w.chosenClass,!0)},w.ignore.split(",").forEach(function(R){Ht(e,R.trim(),Pt)}),w.supportPointer?P(S,"pointerup",p._onDrop):(P(S,"mouseup",p._onDrop),P(S,"touchend",p._onDrop),P(S,"touchcancel",p._onDrop)),w.delay?(P(S,"mouseup",p._disableDelayedDrag),P(S,"touchend",p._disableDelayedDrag),P(S,"touchcancel",p._disableDelayedDrag),P(S,"mousemove",p._delayedDragTouchMoveHandler),P(S,"touchmove",p._delayedDragTouchMoveHandler),w.supportPointer&&P(S,"pointermove",p._delayedDragTouchMoveHandler),p._dragStartTimer=fe(x,w.delay)):x())},_delayedDragTouchMoveHandler:function(l){var d=l.touches?l.touches[0]:l;It(oe(d.clientX-this._lastX),oe(d.clientY-this._lastY))>=this.options.touchStartThreshold&&this._disableDelayedDrag()},_disableDelayedDrag:function(){var l=this.el.ownerDocument;clearTimeout(this._dragStartTimer),q(l,"mouseup",this._disableDelayedDrag),q(l,"touchend",this._disableDelayedDrag),q(l,"touchcancel",this._disableDelayedDrag),q(l,"mousemove",this._delayedDragTouchMoveHandler),q(l,"touchmove",this._delayedDragTouchMoveHandler),q(l,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(l,d){d=d||(l.pointerType=="touch"?l:null),!this.nativeDraggable||d?this.options.supportPointer?P(k,"pointermove",this._onTouchMove):d?P(k,"touchmove",this._onTouchMove):P(k,"mousemove",this._onTouchMove):(P(e,"dragend",this),P(a,"dragstart",this._onDragStart));try{k.selection?Ne(function(){k.selection.empty()}):window.getSelection().removeAllRanges()}catch(c){}},_dragStarted:function(l){if(O=!1,a&&e){this.nativeDraggable&&(P(k,"dragover",this._handleAutoScroll),P(k,"dragover",kt));var d=this.options;!l&&K(e,d.dragClass,!1),K(e,d.ghostClass,!0),E(e,"transform",""),X.active=this,l&&this._appendGhost(),J(this,a,"start",e,a,a,g)}else this._nulling()},_emulateDragOver:function(l){if(j){if(this._lastX===j.clientX&&this._lastY===j.clientY&&!l)return;this._lastX=j.clientX,this._lastY=j.clientY,Et();for(var d=k.elementFromPoint(j.clientX,j.clientY),c=d;d&&d.shadowRoot;)d=d.shadowRoot.elementFromPoint(j.clientX,j.clientY),c=d;if(c)do{if(c[G]){var h;if(h=c[G]._onDragOver({clientX:j.clientX,clientY:j.clientY,target:d,rootEl:c}),h&&!this.options.dragoverBubble)break}d=c}while(c=c.parentNode);e.parentNode[G]._computeIsAligned(j),Ot()}},_onTouchMove:function(l){if(z){var d=this.options,c=d.fallbackTolerance,h=d.fallbackOffset,p=l.touches?l.touches[0]:l,y=r&&ot(r),w=r&&y&&y.a,S=r&&y&&y.d,x=(p.clientX-z.clientX+h.x)/(w||1),R=(p.clientY-z.clientY+h.y)/(S||1),H=l.touches?"translate3d("+x+"px,"+R+"px,0)":"translate("+x+"px,"+R+"px)";if(!X.active&&!O){if(c&&It(oe(p.clientX-this._lastX),oe(p.clientY-this._lastY))<c)return;this._onDragStart(l,!0)}this._handleAutoScroll(p,!0),ee=!0,j=p,E(r,"webkitTransform",H),E(r,"mozTransform",H),E(r,"msTransform",H),E(r,"transform",H),l.cancelable&&l.preventDefault()}},_appendGhost:function(){if(!r){var l=B(e,this.options.fallbackOnBody?k.body:a,!0),d=E(e),c=this.options;r=e.cloneNode(!0),K(r,c.ghostClass,!1),K(r,c.fallbackClass,!0),K(r,c.dragClass,!0),E(r,"box-sizing","border-box"),E(r,"margin",0),E(r,"top",l.top),E(r,"left",l.left),E(r,"width",l.width),E(r,"height",l.height),E(r,"opacity","0.8"),E(r,"position","fixed"),E(r,"zIndex","100000"),E(r,"pointerEvents","none"),c.fallbackOnBody&&k.body.appendChild(r)||a.appendChild(r)}},_onDragStart:function(l,d){var c=this,h=l.dataTransfer,p=c.options;i=Lt(e),i.draggable=!1,i.style["will-change"]="",this._hideClone(),K(i,c.options.chosenClass,!1),c._cloneId=Ne(function(){c.options.removeCloneOnHide||a.insertBefore(i,e),J(c,a,"clone",e)}),!d&&K(e,p.dragClass,!0),d?(F=!0,c._loopId=setInterval(c._emulateDragOver,50)):(q(k,"mouseup",c._onDrop),q(k,"touchend",c._onDrop),q(k,"touchcancel",c._onDrop),h&&(h.effectAllowed="move",p.setData&&p.setData.call(c,h,e)),P(k,"drop",c),E(e,"transform","translateZ(0)")),O=!0,c._dragStartId=Ne(c._dragStarted.bind(c,d)),P(k,"selectstart",c)},_onDragOver:function(l){var d=this.el,c=l.target,h,p,y,w=this.options,S=w.group,x=X.active,R=C===S,H=w.sort,M=this;if(tt||ie&&!l.rootEl&&!l.artificialBubble&&!Tt(d,c))return;function A(){return x&&(K(e,I?I.options.ghostClass:x.options.ghostClass,!1),K(e,w.ghostClass,!0)),I!==M&&M!==X.active?I=M:M===X.active&&(I=null),(c===e&&!e.animated||c===d&&!c.animated)&&(re=null),!w.dragoverBubble&&!l.rootEl&&c!==k&&(M._handleAutoScroll(l),e.parentNode[G]._computeIsAligned(l)),!w.dragoverBubble&&l.stopPropagation&&l.stopPropagation(),!0}function Q(){J(M,a,"change",c,d,a,g,ce(e,w.draggable),l)}if(l.preventDefault!==void 0&&l.cancelable&&l.preventDefault(),ee=!0,c=U(c,w.draggable,d,!0),!!U(l.target,null,e,!0)||c.animated)return A();if(c!==e&&(F=!1),x&&!w.disabled&&(R?H||(y=!a.contains(e)):I===this||(this.lastPutMode=C.checkPull(this,x,e,l))&&S.checkPut(this,x,e,l))){var Y=this._getDirection(l,c);if(h=B(e),y)return this._hideClone(),t=a,s?a.insertBefore(e,s):a.appendChild(e),A();if(d.children.length===0||d.children[0]===r||xr(l,Y,d)&&!e.animated){if(d.children.length!==0&&d.children[0]!==r&&d===l.target&&(c=qt(d)),c&&(p=B(c)),R?x._hideClone():x._showClone(this),Mt(a,d,e,h,c,p,l,!!c)!==!1)return d.appendChild(e),t=d,_e=null,Q(),this._animate(h,e),c&&this._animate(p,c),A()}else if(c&&c!==e&&c.parentNode===d){var Z=0,Ce,ct=c.sortableMouseAligned,xe=e.parentNode!==d,Ae=Tr(c,Y==="vertical"?"top":"left");if(re!==c&&(de=null,Ce=B(c)[Y==="vertical"?"top":"left"],be=!1),vr(e,c,Y)&&ct||xe||Ae||w.invertSwap||de==="insert"||de==="swap"?(de!=="swap"&&(Oe=w.invertSwap||xe||T||Ae),Z=Sr(l,c,Y,w.swapThreshold,w.invertedSwapThreshold==null?w.swapThreshold:w.invertedSwapThreshold,Oe,re===c),de="swap"):(Z=Ir(c,w),de="insert"),Z===0)return A();_e=null,re=c,ve=Z,p=B(c);var ue=c.nextElementSibling,se=!1;se=Z===1;var ae=Mt(a,d,e,h,c,p,l,se);if(ae!==!1)return(ae===1||ae===-1)&&(se=ae===1),tt=!0,fe(Cr,30),R?x._hideClone():x._showClone(this),se&&!ue?d.appendChild(e):c.parentNode.insertBefore(e,se?ue:c),t=e.parentNode,Ce!==void 0&&!Oe&&(He=oe(Ce-B(c)[Y==="vertical"?"top":"left"])),Q(),!xe&&this._animate(p,c),this._animate(h,e),A()}if(d.contains(e))return A()}return ie&&!l.rootEl&&Dt(d,l,"_onDragOver"),!1},_animate:function(l,d){var c=this.options.animation;if(c){var h=B(d);if(d===e&&(_e=h),l.nodeType===1&&(l=B(l)),l.left+l.width/2!==h.left+h.width/2||l.top+l.height/2!==h.top+h.height/2){var p=ot(this.el),y=p&&p.a,w=p&&p.d;E(d,"transition","none"),E(d,"transform","translate3d("+(l.left-h.left)/(y||1)+"px,"+(l.top-h.top)/(w||1)+"px,0)"),bt=d.offsetWidth,E(d,"transition","transform "+c+"ms"+(this.options.easing?" "+this.options.easing:"")),E(d,"transform","translate3d(0,0,0)")}typeof d.animated=="number"&&clearTimeout(d.animated),d.animated=fe(function(){E(d,"transition",""),E(d,"transform",""),d.animated=!1},c)}},_offUpEvents:function(){var l=this.el.ownerDocument;q(k,"touchmove",this._onTouchMove),q(k,"pointermove",this._onTouchMove),q(l,"mouseup",this._onDrop),q(l,"touchend",this._onDrop),q(l,"pointerup",this._onDrop),q(l,"touchcancel",this._onDrop),q(k,"selectstart",this)},_onDrop:function(l){var d=this.el,c=this.options;O=!1,T=!1,Oe=!1,be=!1,clearInterval(this._loopId),clearInterval(W),qe(),$r(),clearTimeout(this._dragStartTimer),lt(this._cloneId),lt(this._dragStartId),q(k,"mousemove",this._onTouchMove),this.nativeDraggable&&(q(k,"drop",this),q(d,"dragstart",this._onDragStart),q(k,"dragover",this._handleAutoScroll),q(k,"dragover",kt)),this._offUpEvents(),l&&(ee&&(l.cancelable&&l.preventDefault(),!c.dropBubble&&l.stopPropagation()),r&&r.parentNode&&r.parentNode.removeChild(r),(a===t||I&&I.lastPutMode!=="clone")&&i&&i.parentNode&&i.parentNode.removeChild(i),e&&(this.nativeDraggable&&q(e,"dragend",this),Pt(e),e.style["will-change"]="",K(e,I?I.options.ghostClass:this.options.ghostClass,!1),K(e,this.options.chosenClass,!1),J(this,a,"unchoose",e,t,a,g,null,l),a!==t?(v=ce(e,c.draggable),v>=0&&(J(null,t,"add",e,t,a,g,v,l),J(this,a,"remove",e,t,a,g,v,l),J(null,t,"sort",e,t,a,g,v,l),J(this,a,"sort",e,t,a,g,v,l)),I&&I.save()):e.nextSibling!==s&&(v=ce(e,c.draggable),v>=0&&(J(this,a,"update",e,t,a,g,v,l),J(this,a,"sort",e,t,a,g,v,l))),X.active&&((v==null||v===-1)&&(v=g),J(this,a,"end",e,t,a,g,v,l),this.save()))),this._nulling()},_nulling:function(){a=e=t=r=s=i=n=_=f=b.length=W=L=D=z=j=ee=v=g=re=ve=bt=_e=I=C=X.active=null,Pe.forEach(function(l){l.checked=!0}),Pe.length=0},handleEvent:function(l){switch(l.type){case"drop":case"dragend":this._onDrop(l);break;case"dragenter":case"dragover":e&&(this._onDragOver(l),wr(l));break;case"selectstart":l.preventDefault();break}},toArray:function(){for(var l=[],d,c=this.el.children,h=0,p=c.length,y=this.options;h<p;h++)d=c[h],U(d,y.draggable,this.el,!1)&&l.push(d.getAttribute(y.dataIdAttr)||Rr(d));return l},sort:function(l){var d={},c=this.el;this.toArray().forEach(function(h,p){var y=c.children[p];U(y,this.options.draggable,c,!1)&&(d[h]=y)},this),l.forEach(function(h){d[h]&&(c.removeChild(d[h]),c.appendChild(d[h]))})},save:function(){var l=this.options.store;l&&l.set&&l.set(this)},closest:function(l,d){return U(l,d||this.options.draggable,this.el,!1)},option:function(l,d){var c=this.options;if(d===void 0)return c[l];c[l]=d,l==="group"&&$t(c)},destroy:function(){var l=this.el;l[G]=null,q(l,"mousedown",this._onTapStart),q(l,"touchstart",this._onTapStart),q(l,"pointerdown",this._onTapStart),this.nativeDraggable&&(q(l,"dragover",this),q(l,"dragenter",this)),Array.prototype.forEach.call(l.querySelectorAll("[draggable]"),function(d){d.removeAttribute("draggable")}),this._onDrop(),N.splice(N.indexOf(this.el),1),this.el=l=null},_hideClone:function(){i.cloneHidden||(E(i,"display","none"),i.cloneHidden=!0,i.parentNode&&this.options.removeCloneOnHide&&i.parentNode.removeChild(i))},_showClone:function(l){if(l.lastPutMode!=="clone"){this._hideClone();return}i.cloneHidden&&(a.contains(e)&&!this.options.group.revertClone?a.insertBefore(i,e):s?a.insertBefore(i,s):a.appendChild(i),this.options.group.revertClone&&this._animate(e,i),E(i,"display",""),i.cloneHidden=!1)}};function U(l,d,c,h){if(l){c=c||k;do{if(d!=null&&(d[0]===">"&&l.parentNode===c&&Nt(l,d.substring(1))||Nt(l,d))||h&&l===c)return l;if(l===c)break}while(l=br(l))}return null}function br(l){return l.host&&l!==k&&l.host.nodeType?l.host:l.parentNode}function wr(l){l.dataTransfer&&(l.dataTransfer.dropEffect="move"),l.cancelable&&l.preventDefault()}function P(l,d,c){l.addEventListener(d,c,xt)}function q(l,d,c){l.removeEventListener(d,c,xt)}function K(l,d,c){if(l&&d)if(l.classList)l.classList[c?"add":"remove"](d);else{var h=(" "+l.className+" ").replace(wt," ").replace(" "+d+" "," ");l.className=(h+(c?" "+d:"")).replace(wt," ")}}function E(l,d,c){var h=l&&l.style;if(h){if(c===void 0)return k.defaultView&&k.defaultView.getComputedStyle?c=k.defaultView.getComputedStyle(l,""):l.currentStyle&&(c=l.currentStyle),d===void 0?c:c[d];!(d in h)&&d.indexOf("webkit")===-1&&(d="-webkit-"+d),h[d]=c+(typeof c=="string"?"":"px")}}function ot(l){var d="";do{var c=E(l,"transform");c&&c!=="none"&&(d=c+" "+d)}while(l=l.parentNode);if(window.DOMMatrix)return new DOMMatrix(d);if(window.WebKitCSSMatrix)return new WebKitCSSMatrix(d);if(window.CSSMatrix)return new CSSMatrix(d)}function Ht(l,d,c){if(l){var h=l.getElementsByTagName(d),p=0,y=h.length;if(c)for(;p<y;p++)c(h[p],p);return h}return[]}function J(l,d,c,h,p,y,w,S,x){l=l||d[G];var R,H=l.options,M="on"+c.charAt(0).toUpperCase()+c.substr(1);window.CustomEvent&&!ie&&!Me?R=new CustomEvent(c,{bubbles:!0,cancelable:!0}):(R=k.createEvent("Event"),R.initEvent(c,!0,!0)),R.to=p||d,R.from=y||d,R.item=h||d,R.clone=i,R.oldIndex=w,R.newIndex=S,R.originalEvent=x,d&&d.dispatchEvent(R),H[M]&&H[M].call(l,R)}function Mt(l,d,c,h,p,y,w,S){var x,R=l[G],H=R.options.onMove,M;return window.CustomEvent&&!ie&&!Me?x=new CustomEvent("move",{bubbles:!0,cancelable:!0}):(x=k.createEvent("Event"),x.initEvent("move",!0,!0)),x.to=d,x.from=l,x.dragged=c,x.draggedRect=h,x.related=p||d,x.relatedRect=y||B(d),x.willInsertAfter=S,x.originalEvent=w,l.dispatchEvent(x),H&&(M=H.call(R,x,w)),M}function Pt(l){l.draggable=!1}function Cr(){tt=!1}function st(l,d,c){for(var h=0,p=0,y=l.children;p<y.length;){if(y[p].style.display!=="none"&&y[p]!==r&&y[p]!==e&&U(y[p],c.draggable,l,!1)){if(h===d)return y[p];h++}p++}return null}function qt(l){for(var d=l.lastElementChild;(d===r||d.style.display==="none")&&(d=d.previousElementSibling,!!d););return d||null}function xr(l,d,c){var h=B(qt(c)),p=d==="vertical"?l.clientY:l.clientX,y=d==="vertical"?l.clientX:l.clientY,w=d==="vertical"?h.bottom:h.right,S=d==="vertical"?h.left:h.top,x=d==="vertical"?h.right:h.bottom,R=10;return d==="vertical"?y>x+R||y<=x&&p>w&&y>=S:p>w&&y>S||p<=w&&y>x+R}function Sr(l,d,c,h,p,y,w){var S=B(d),x=c==="vertical"?l.clientY:l.clientX,R=c==="vertical"?S.height:S.width,H=c==="vertical"?S.top:S.left,M=c==="vertical"?S.bottom:S.right,A=B(e),Q=!1;if(!y){if(w&&He<R*h)if(!be&&(ve===1?x>H+R*p/2:x<M-R*p/2)&&(be=!0),be)Q=!0;else{var Y=c==="vertical"?A.top:A.left,Z=c==="vertical"?A.bottom:A.right;if(ve===1?x<H+He:x>M-He)return ve*-1}else if(x>H+R*(1-h)/2&&x<M-R*(1-h)/2)return x>H+R/2?-1:1}return Q=Q||y,Q&&(x<H+R*p/2||x>M-R*p/2)?x>H+R/2?1:-1:0}function Ir(l,d){var c=ce(e,d.draggable),h=ce(l,d.draggable);return c<h?1:-1}function Rr(l){for(var d=l.tagName+l.className+l.src+l.href+l.textContent,c=d.length,h=0;c--;)h+=d.charCodeAt(c);return h.toString(36)}function ce(l,d){var c=0;if(!l||!l.parentNode)return-1;for(;l&&(l=l.previousElementSibling);)l.nodeName.toUpperCase()!=="TEMPLATE"&&l!==i&&c++;return c}function Nt(l,d){if(l)try{if(l.matches)return l.matches(d);if(l.msMatchesSelector)return l.msMatchesSelector(d);if(l.webkitMatchesSelector)return l.webkitMatchesSelector(d)}catch(c){return!1}return!1}var we;function At(l,d){return function(){if(!we){var c=arguments,h=this;we=fe(function(){c.length===1?l.call(h,c[0]):l.apply(h,c),we=void 0},d)}}}function $r(){clearTimeout(we),we=void 0}function nt(l,d){if(l&&d)for(var c in d)d.hasOwnProperty(c)&&(l[c]=d[c]);return l}function Lt(l){return Ze&&Ze.dom?Ze.dom(l).cloneNode(!0):Ct?Ct(l).clone(!0)[0]:l.cloneNode(!0)}function kr(l){Pe.length=0;for(var d=l.getElementsByTagName("input"),c=d.length;c--;){var h=d[c];h.checked&&Pe.push(h)}}function Ne(l){return fe(l,0)}function lt(l){return clearTimeout(l)}function B(l,d,c){if(!(!l.getBoundingClientRect&&l!==V)){var h,p,y,w,S,x,R;if(l!==V?(h=l.getBoundingClientRect(),p=h.top,y=h.left,w=h.bottom,S=h.right,x=h.height,R=h.width):(p=0,y=0,w=window.innerHeight,S=window.innerWidth,x=window.innerHeight,R=window.innerWidth),c&&l!==V){if(d=d||l.parentNode,!ie)do if(d&&d.getBoundingClientRect&&E(d,"transform")!=="none"){var H=d.getBoundingClientRect();p-=H.top+ne(E(d,"border-top-width")),y-=H.left+ne(E(d,"border-left-width")),w=p+h.height,S=y+h.width;break}while(d=d.parentNode);var M=ot(l),A=M&&M.a,Q=M&&M.d;M&&(p/=Q,y/=A,R/=A,x/=Q,w=p+x,S=y+R)}return{top:p,left:y,bottom:w,right:S,width:R,height:x}}}function Tr(l,d){for(var c=le(c,!0),h=B(l)[d];c;){var p=B(c)[d],y;if(d==="top"||d==="left"?y=h>=p:y=h<=p,!y)return!0;if(c===V)break;c=le(c,!1)}return!1}return P(k,"touchmove",function(l){(X.active||O)&&l.cancelable&&l.preventDefault()}),X.utils={on:P,off:q,css:E,find:Ht,is:function(l,d){return!!U(l,d,l,!1)},extend:nt,throttle:At,closest:U,toggleClass:K,clone:Lt,index:ce,nextTick:Ne,cancelNextTick:lt,detectDirection:Rt,getChild:st},X.create=function(l,d){return new X(l,d)},X.version="1.8.3",X})});var _r=jt((fs,dr)=>{"use strict";function Nr(o){return o&&typeof o=="object"&&"default"in o?o.default:o}var Ar=Nr(Wt());function u(o,e){return typeof o=="string"?(e||document).querySelector(o):o||null}u.each=(o,e)=>typeof o=="string"?Array.from((e||document).querySelectorAll(o)):o||null;u.create=(o,e)=>{let t=document.createElement(o);for(let r in e){let i=e[r];if(r==="inside")u(i).appendChild(t);else if(r==="around"){let a=u(i);a.parentNode.insertBefore(t,a),t.appendChild(a)}else r==="styles"?typeof i=="object"&&Object.keys(i).map(a=>{t.style[a]=i[a]}):r in t?t[r]=i:t.setAttribute(r,i)}return t};u.on=(o,e,t,r)=>{r?u.delegate(o,e,t,r):(r=t,u.bind(o,e,r))};u.off=(o,e,t)=>{o.removeEventListener(e,t)};u.bind=(o,e,t)=>{e.split(/\s+/).forEach(function(r){o.addEventListener(r,t)})};u.delegate=(o,e,t,r)=>{o.addEventListener(e,function(i){let a=i.target.closest(t);a&&(i.delegatedTarget=a,r.call(this,i,a))})};u.unbind=(o,e)=>{if(o)for(let t in e){let r=e[t];t.split(/\s+/).forEach(function(i){o.removeEventListener(i,r)})}};u.fire=(o,e,t)=>{let r=document.createEvent("HTMLEvents");r.initEvent(e,!0,!0);for(let i in t)r[i]=t[i];return o.dispatchEvent(r)};u.data=(o,e)=>{if(!e)return o.dataset;for(let t in e)o.dataset[t]=e[t]};u.style=(o,e)=>{if(typeof e=="string")return u.getStyle(o,e);Array.isArray(o)||(o=[o]),o.map(t=>{for(let r in e)t.style[r]=e[r]})};u.removeStyle=(o,e)=>{Array.isArray(o)||(o=[o]),Array.isArray(e)||(e=[e]),o.map(t=>{for(let r of e)t.style[r]=""})};u.getStyle=(o,e)=>{if(!e)return getComputedStyle(o);let t=getComputedStyle(o)[e];return["width","height"].includes(e)&&(t=parseFloat(t)),t};u.closest=(o,e)=>e?e.matches(o)?e:u.closest(o,e.parentNode):null;u.inViewport=(o,e)=>{let{top:t,left:r,bottom:i,right:a}=o.getBoundingClientRect(),{top:s,left:n,bottom:_,right:f}=e.getBoundingClientRect();return t>=s&&r>=n&&i<=_&&a<=f};u.scrollTop=function(e,t){requestAnimationFrame(()=>{e.scrollTop=t})};u.scrollbarSize=function(){return u.scrollBarSizeValue||(u.scrollBarSizeValue=Lr()),u.scrollBarSizeValue};function Lr(){let o=document.createElement("div");u.style(o,{width:"100px",height:"100px",overflow:"scroll",position:"absolute",top:"-9999px"}),document.body.appendChild(o);let e=o.offsetWidth-o.clientWidth;return document.body.removeChild(o),e}u.hasVerticalOverflow=function(o){return o.scrollHeight>o.offsetHeight+10};u.hasHorizontalOverflow=function(o){return o.scrollWidth>o.offsetWidth+10};u.measureTextWidth=function(o){let e=document.createElement("div");return e.style.position="absolute",e.style.visibility="hidden",e.style.height="auto",e.style.width="auto",e.style.whiteSpace="nowrap",e.innerText=o,document.body.appendChild(e),e.clientWidth+1};function Fr(o){var e=typeof o;return o!=null&&(e=="object"||e=="function")}var he=Fr,Ve=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function Ye(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function jr(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}function Wr(o,e){return e={exports:{}},o(e,e.exports),e.exports}var zr=typeof Ve=="object"&&Ve&&Ve.Object===Object&&Ve,Br=zr,Vr=typeof self=="object"&&self&&self.Object===Object&&self,Yr=Br||Vr||Function("return this")(),De=Yr,Xr=function(){return De.Date.now()},ht=Xr,Gr=De.Symbol,Ge=Gr,Jt=Object.prototype,Qr=Jt.hasOwnProperty,Ur=Jt.toString,Ie=Ge?Ge.toStringTag:void 0;function Jr(o){var e=Qr.call(o,Ie),t=o[Ie];try{o[Ie]=void 0}catch(i){}var r=Ur.call(o);return e?o[Ie]=t:delete o[Ie],r}var Kr=Jr,Zr=Object.prototype,ei=Zr.toString;function ti(o){return ei.call(o)}var ri=ti,ii="[object Null]",ai="[object Undefined]",zt=Ge?Ge.toStringTag:void 0;function oi(o){return o==null?o===void 0?ai:ii:zt&&zt in Object(o)?Kr(o):ri(o)}var Kt=oi;function si(o){return o!=null&&typeof o=="object"}var ni=si,li="[object Symbol]";function ci(o){return typeof o=="symbol"||ni(o)&&Kt(o)==li}var di=ci,Bt=0/0,_i=/^\s+|\s+$/g,fi=/^[-+]0x[0-9a-f]+$/i,ui=/^0b[01]+$/i,hi=/^0o[0-7]+$/i,pi=parseInt;function mi(o){if(typeof o=="number")return o;if(di(o))return Bt;if(he(o)){var e=typeof o.valueOf=="function"?o.valueOf():o;o=he(e)?e+"":e}if(typeof o!="string")return o===0?o:+o;o=o.replace(_i,"");var t=ui.test(o);return t||hi.test(o)?pi(o.slice(2),t?2:8):fi.test(o)?Bt:+o}var Vt=mi,gi="Expected a function",yi=Math.max,vi=Math.min;function bi(o,e,t){var r,i,a,s,n,_,f=0,m=!1,g=!1,v=!0;if(typeof o!="function")throw new TypeError(gi);e=Vt(e)||0,he(t)&&(m=!!t.leading,g="maxWait"in t,a=g?yi(Vt(t.maxWait)||0,e):a,v="trailing"in t?!!t.trailing:v);function C(D){var z=r,j=i;return r=i=void 0,f=D,s=o.apply(j,z),s}function I(D){return f=D,n=setTimeout(O,e),m?C(D):s}function b(D){var z=D-_,j=D-f,ee=e-z;return g?vi(ee,a-j):ee}function T(D){var z=D-_,j=D-f;return _===void 0||z>=e||z<0||g&&j>=a}function O(){var D=ht();if(T(D))return F(D);n=setTimeout(O,b(D))}function F(D){return n=void 0,v&&r?C(D):(r=i=void 0,s)}function N(){n!==void 0&&clearTimeout(n),f=0,r=_=i=n=void 0}function W(){return n===void 0?s:F(ht())}function L(){var D=ht(),z=T(D);if(r=arguments,i=this,_=D,z){if(n===void 0)return I(_);if(g)return n=setTimeout(O,e),C(_)}return n===void 0&&(n=setTimeout(O,e)),s}return L.cancel=N,L.flush=W,L}var Zt=bi,wi="Expected a function";function Ci(o,e,t){var r=!0,i=!0;if(typeof o!="function")throw new TypeError(wi);return he(t)&&(r="leading"in t?!!t.leading:r,i="trailing"in t?!!t.trailing:i),Zt(o,e,{leading:r,maxWait:e,trailing:i})}var xi=Ci,Si="[object AsyncFunction]",Ii="[object Function]",Ri="[object GeneratorFunction]",$i="[object Proxy]";function ki(o){if(!he(o))return!1;var e=Kt(o);return e==Ii||e==Ri||e==Si||e==$i}var Ti=ki,Di=De["__core-js_shared__"],pt=Di,Yt=function(){var o=/[^.]+$/.exec(pt&&pt.keys&&pt.keys.IE_PROTO||"");return o?"Symbol(src)_1."+o:""}();function Ei(o){return!!Yt&&Yt in o}var Oi=Ei,Hi=Function.prototype,Mi=Hi.toString;function Pi(o){if(o!=null){try{return Mi.call(o)}catch(e){}try{return o+""}catch(e){}}return""}var qi=Pi,Ni=/[\\^$.*+?()[\]{}|]/g,Ai=/^\[object .+?Constructor\]$/,Li=Function.prototype,Fi=Object.prototype,ji=Li.toString,Wi=Fi.hasOwnProperty,zi=RegExp("^"+ji.call(Wi).replace(Ni,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function Bi(o){if(!he(o)||Oi(o))return!1;var e=Ti(o)?zi:Ai;return e.test(qi(o))}var Vi=Bi;function Yi(o,e){return o==null?void 0:o[e]}var Xi=Yi;function Gi(o,e){var t=Xi(o,e);return Vi(t)?t:void 0}var vt=Gi,Qi=vt(Object,"create"),Te=Qi;function Ui(){this.__data__=Te?Te(null):{},this.size=0}var Ji=Ui;function Ki(o){var e=this.has(o)&&delete this.__data__[o];return this.size-=e?1:0,e}var Zi=Ki,ea="__lodash_hash_undefined__",ta=Object.prototype,ra=ta.hasOwnProperty;function ia(o){var e=this.__data__;if(Te){var t=e[o];return t===ea?void 0:t}return ra.call(e,o)?e[o]:void 0}var aa=ia,oa=Object.prototype,sa=oa.hasOwnProperty;function na(o){var e=this.__data__;return Te?e[o]!==void 0:sa.call(e,o)}var la=na,ca="__lodash_hash_undefined__";function da(o,e){var t=this.__data__;return this.size+=this.has(o)?0:1,t[o]=Te&&e===void 0?ca:e,this}var _a=da;function pe(o){var e=-1,t=o==null?0:o.length;for(this.clear();++e<t;){var r=o[e];this.set(r[0],r[1])}}pe.prototype.clear=Ji;pe.prototype.delete=Zi;pe.prototype.get=aa;pe.prototype.has=la;pe.prototype.set=_a;var Xt=pe;function fa(){this.__data__=[],this.size=0}var ua=fa;function ha(o,e){return o===e||o!==o&&e!==e}var pa=ha;function ma(o,e){for(var t=o.length;t--;)if(pa(o[t][0],e))return t;return-1}var Ue=ma,ga=Array.prototype,ya=ga.splice;function va(o){var e=this.__data__,t=Ue(e,o);if(t<0)return!1;var r=e.length-1;return t==r?e.pop():ya.call(e,t,1),--this.size,!0}var ba=va;function wa(o){var e=this.__data__,t=Ue(e,o);return t<0?void 0:e[t][1]}var Ca=wa;function xa(o){return Ue(this.__data__,o)>-1}var Sa=xa;function Ia(o,e){var t=this.__data__,r=Ue(t,o);return r<0?(++this.size,t.push([o,e])):t[r][1]=e,this}var Ra=Ia;function me(o){var e=-1,t=o==null?0:o.length;for(this.clear();++e<t;){var r=o[e];this.set(r[0],r[1])}}me.prototype.clear=ua;me.prototype.delete=ba;me.prototype.get=Ca;me.prototype.has=Sa;me.prototype.set=Ra;var $a=me,ka=vt(De,"Map"),Ta=ka;function Da(){this.size=0,this.__data__={hash:new Xt,map:new(Ta||$a),string:new Xt}}var Ea=Da;function Oa(o){var e=typeof o;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?o!=="__proto__":o===null}var Ha=Oa;function Ma(o,e){var t=o.__data__;return Ha(e)?t[typeof e=="string"?"string":"hash"]:t.map}var Je=Ma;function Pa(o){var e=Je(this,o).delete(o);return this.size-=e?1:0,e}var qa=Pa;function Na(o){return Je(this,o).get(o)}var Aa=Na;function La(o){return Je(this,o).has(o)}var Fa=La;function ja(o,e){var t=Je(this,o),r=t.size;return t.set(o,e),this.size+=t.size==r?0:1,this}var Wa=ja;function ge(o){var e=-1,t=o==null?0:o.length;for(this.clear();++e<t;){var r=o[e];this.set(r[0],r[1])}}ge.prototype.clear=Ea;ge.prototype.delete=qa;ge.prototype.get=Aa;ge.prototype.has=Fa;ge.prototype.set=Wa;var za=ge,Ba="__lodash_hash_undefined__";function Va(o){return this.__data__.set(o,Ba),this}var Ya=Va;function Xa(o){return this.__data__.has(o)}var Ga=Xa;function Qe(o){var e=-1,t=o==null?0:o.length;for(this.__data__=new za;++e<t;)this.add(o[e])}Qe.prototype.add=Qe.prototype.push=Ya;Qe.prototype.has=Ga;var Qa=Qe;function Ua(o,e,t,r){for(var i=o.length,a=t+(r?1:-1);r?a--:++a<i;)if(e(o[a],a,o))return a;return-1}var Ja=Ua;function Ka(o){return o!==o}var Za=Ka;function eo(o,e,t){for(var r=t-1,i=o.length;++r<i;)if(o[r]===e)return r;return-1}var to=eo;function ro(o,e,t){return e===e?to(o,e,t):Ja(o,Za,t)}var io=ro;function ao(o,e){var t=o==null?0:o.length;return!!t&&io(o,e,0)>-1}var oo=ao;function so(o,e,t){for(var r=-1,i=o==null?0:o.length;++r<i;)if(t(e,o[r]))return!0;return!1}var no=so;function lo(o,e){return o.has(e)}var co=lo,_o=vt(De,"Set"),mt=_o;function fo(){}var uo=fo;function ho(o){var e=-1,t=Array(o.size);return o.forEach(function(r){t[++e]=r}),t}var er=ho,po=1/0,mo=mt&&1/er(new mt([,-0]))[1]==po?function(o){return new mt(o)}:uo,go=mo,yo=200;function vo(o,e,t){var r=-1,i=oo,a=o.length,s=!0,n=[],_=n;if(t)s=!1,i=no;else if(a>=yo){var f=e?null:go(o);if(f)return er(f);s=!1,i=co,_=new Qa}else _=e?[]:n;e:for(;++r<a;){var m=o[r],g=e?e(m):m;if(m=t||m!==0?m:0,s&&g===g){for(var v=_.length;v--;)if(_[v]===g)continue e;e&&_.push(g),n.push(m)}else i(_,g,t)||(_!==n&&_.push(g),n.push(m))}return n}var bo=vo;function wo(o){return o&&o.length?bo(o):[]}var Co=wo;function tr(o){return o.replace(/([A-Z])/g,e=>`-${e[0].toLowerCase()}`)}function gt(o){return Object.keys(o).map(t=>{let r=tr(t),i=o[t];return i===void 0?"":`data-${r}="${i}" `}).join("").trim()}function Gt(o){var e=document.createElement("textarea");e.style.position="fixed",e.style.top=0,e.style.left=0,e.style.width="2em",e.style.height="2em",e.style.padding=0,e.style.border="none",e.style.outline="none",e.style.boxShadow="none",e.style.background="transparent",e.value=o,document.body.appendChild(e),e.select();try{document.execCommand("copy")}catch(t){console.log("Oops, unable to copy")}document.body.removeChild(e)}function xo(o){return!isNaN(o)}var rr=xi,So=Zt;function $e(o,e=null){return(...t)=>new Promise(r=>{setTimeout(()=>{let a=o.apply(e,t);r(a)})})}function Ke(o,e,t){let r=t.reduce((i,a)=>(i[a]={get(){return e[a]}},i),{});Object.defineProperties(o,r)}function Io(o){return o!==void 0||o!==null}function Ro(o){return!Io(o)}function ke(o){return!isNaN(o)}function $o(o){return Array.isArray(o)?o:[o]}function Qt(o){return Co(o)}function Re(o,e){return o-e}function Ut(o){return o.replace(/<[^>]*>/g,"")}function ko(o,e){return o&&(Object.keys(e).forEach(t=>{let r=new RegExp(`{(${t})}`,"g");o=o.replace(r,e[t])}),o)}function To(o){if(!o)return"";let e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};return String(o).replace(/[&<>"'`=/]/g,t=>e[t]||t)}var ir=class{constructor(e){this.options=e,this.sortRows=$e(this.sortRows,this),this.switchColumn=$e(this.switchColumn,this),this.removeColumn=$e(this.removeColumn,this),this.options.filterRows=$e(this.options.filterRows,this)}init(e,t){e||(e=this.options.data),t&&(this.options.columns=t),this.data=e,this.rowCount=0,this.columns=[],this.rows=[],this.prepareColumns(),this.prepareRows(),this.prepareTreeRows(),this.prepareRowView(),this.prepareNumericColumns()}get currentSort(){return this.columns.find(t=>t.sortOrder!=="none")||{colIndex:-1,sortOrder:"none"}}prepareColumns(){this.columns=[],this.validateColumns(),this.prepareDefaultColumns(),this.prepareHeader()}prepareDefaultColumns(){if(this.options.checkboxColumn&&!this.hasColumnById("_checkbox")){let e={id:"_checkbox",content:this.getCheckboxHTML(),editable:!1,resizable:!1,sortable:!1,focusable:!1,dropdown:!1,width:32};this.columns.push(e)}if(this.options.serialNoColumn&&!this.hasColumnById("_rowIndex")){let e={id:"_rowIndex",content:"",align:"center",editable:!1,resizable:!1,focusable:!1,dropdown:!1};this.columns.push(e)}}prepareHeader(){let e=this.columns.concat(this.options.columns),t={isHeader:1,editable:!0,sortable:!0,resizable:!0,focusable:!0,dropdown:!0,width:null,format:r=>r==null?"":r+""};this.columns=e.map((r,i)=>this.prepareCell(r,i)).map(r=>Object.assign({},t,r)).map(r=>(r.content=r.content||r.name||"",r.id=r.id||r.content,r))}prepareCell(e,t){let r={content:"",sortOrder:"none",colIndex:t,column:this.columns[t]};return e!==null&&typeof e=="object"?Object.assign(r,e):r.content=e,r}prepareNumericColumns(){let e=this.getRow(0);!e||(this.columns=this.columns.map((t,r)=>{let i=e[r].content;return!t.align&&xo(i)&&(t.align="right"),t}))}prepareRows(){this.validateData(this.data),this.rows=this.data.map((e,t)=>{let r=this._getNextRowCount(),i=[],a={rowIndex:r};if(Array.isArray(e))for(this.options.checkboxColumn&&i.push(this.getCheckboxHTML()),this.options.serialNoColumn&&i.push(r+1+""),i=i.concat(e);i.length<this.columns.length;)i.push("");else{for(let s of this.columns)s.id==="_checkbox"?i.push(this.getCheckboxHTML()):s.id==="_rowIndex"?i.push(r+1+""):i.push(e[s.id]);a.indent=e.indent||0}return this.prepareRow(i,a)})}prepareTreeRows(){this.rows.forEach((e,t)=>{if(ke(e.meta.indent)){let r=this.getRow(t+1);e.meta.isLeaf=!r||Ro(r.meta.indent)||r.meta.indent<=e.meta.indent,e.meta.isTreeNodeClose=!1}})}prepareRowView(){this.rowViewOrder=this.rows.map(e=>e.meta.rowIndex)}prepareRow(e,t){let r={rowIndex:t.rowIndex,indent:t.indent};return e=e.map((i,a)=>this.prepareCell(i,a)).map(i=>Object.assign({},r,i)),e.meta=t,e}validateColumns(){let e=this.options.columns;if(!Array.isArray(e))throw new Xe("`columns` must be an array");e.forEach((t,r)=>{if(typeof t!="string"&&typeof t!="object")throw new Xe(`column "${r}" must be a string or an object`)})}validateData(e){if(Array.isArray(e)&&(e.length===0||Array.isArray(e[0])||typeof e[0]=="object"))return!0;throw new Xe("`data` must be an array of arrays or objects")}appendRows(e){this.validateData(e),this.rows.push(...this.prepareRows(e))}sortRows(e,t="none"){e=+e,this.getColumns().map(r=>{r.colIndex===e?r.sortOrder=t:r.sortOrder="none"}),this._sortRows(e,t)}_sortRows(e,t){if(this.currentSort.colIndex===e&&(this.currentSort.sortOrder==="asc"&&t==="desc"||this.currentSort.sortOrder==="desc"&&t==="asc")){this.reverseArray(this.rowViewOrder),this.currentSort.sortOrder=t;return}if(this.rowViewOrder.sort((r,i)=>{let a=r,s=i,n=this.getCell(e,r).content,_=this.getCell(e,i).content;if(n=n==null?"":n,_=_==null?"":_,t==="none")return a-s;if(t==="asc"){if(n<_)return-1;if(n>_)return 1;if(n===_)return 0}else if(t==="desc"){if(n<_)return 1;if(n>_)return-1;if(n===_)return 0}return 0}),this.hasColumnById("_rowIndex")){let r=this.getColumnIndexById("_rowIndex");this.rows.forEach((i,a)=>{let s=this.rowViewOrder.indexOf(a),n=i[r];n.content=s+1+""})}}reverseArray(e){let t=null,r=null,i=e.length;for(t=0,r=i-1;t<r;t+=1,r-=1){let a=e[t];e[t]=e[r],e[r]=a}}switchColumn(e,t){let r=this.columns[e];this.columns[e]=this.columns[t],this.columns[t]=r,this.columns[e].colIndex=e,this.columns[t].colIndex=t,this.rows.forEach(i=>{let a=Object.assign({},i[e],{colIndex:t}),s=Object.assign({},i[t],{colIndex:e});i[t]=a,i[e]=s})}removeColumn(e){e=+e;let t=i=>i.colIndex!==e,r=(i,a)=>Object.assign({},i,{colIndex:a});this.columns=this.columns.filter(t).map(r),this.rows.forEach(i=>{i.splice(e,1),i.forEach((a,s)=>{a.colIndex=s})})}updateRow(e,t){e.length<this.columns.length&&(this.hasColumnById("_rowIndex")&&(e=[t+1+""].concat(e)),this.hasColumnById("_checkbox")&&(e=['<input type="checkbox" />'].concat(e)));let r=this.prepareRow(e,{rowIndex:t}),i=this.rows.findIndex(a=>a[0].rowIndex===t);return this.rows[i]=r,r}updateCell(e,t,r){let i;typeof e=="object"&&(i=e,e=i.colIndex,t=i.rowIndex,r=i),i=this.getCell(e,t);for(let a in r){let s=r[a];s!==void 0&&(i[a]=s)}return i}updateColumn(e,t){let r=this.getColumn(e);for(let i in t){let a=t[i];a!==void 0&&(r[i]=a)}return r}filterRows(e){return this.options.filterRows(this.rows,e).then(t=>(t||(t=this.getAllRowIndices()),t.then||(t=Promise.resolve(t)),t.then(r=>(this._filteredRows=r,{rowsToHide:this.getAllRowIndices().filter(a=>!r.includes(a)),rowsToShow:r}))))}getFilteredRowIndices(){return this._filteredRows||this.getAllRowIndices()}getAllRowIndices(){return this.rows.map(e=>e.meta.rowIndex)}getRowCount(){return this.rowCount}_getNextRowCount(){let e=this.rowCount;return this.rowCount++,e}getRows(e,t){return this.rows.slice(e,t)}getRowsForView(e,t){return this.rowViewOrder.map(i=>this.rows[i]).slice(e,t)}getColumns(e){let t=this.columns;return e&&(t=t.slice(this.getStandardColumnCount())),t}getStandardColumnCount(){return this.options.checkboxColumn&&this.options.serialNoColumn?2:this.options.checkboxColumn||this.options.serialNoColumn?1:0}getColumnCount(e){let t=this.columns.length;return e&&(t=t-this.getStandardColumnCount()),t}getColumn(e){return e=+e,e<0&&(e=this.columns.length+e),this.columns.find(t=>t.colIndex===e)}getColumnById(e){return this.columns.find(t=>t.id===e)}getRow(e){return e=+e,this.rows[e]}getCell(e,t){return t=+t,e=+e,this.getRow(t)[e]}getChildren(e){e=+e;let t=this.getRow(e).meta.indent,r=[];for(let i=e+1;i<this.rowCount;i++){let a=this.getRow(i);if(!isNaN(a.meta.indent)&&(a.meta.indent>t&&r.push(i),a.meta.indent===t))break}return r}getImmediateChildren(e){e=+e;let t=this.getRow(e).meta.indent,r=[],i=t+1;for(let a=e+1;a<this.rowCount;a++){let s=this.getRow(a);if(!(isNaN(s.meta.indent)||s.meta.indent>i)&&(s.meta.indent===i&&r.push(a),s.meta.indent===t))break}return r}get(){return{columns:this.columns,rows:this.rows}}getData(e){return this.data[e]}hasColumn(e){return Boolean(this.columns.find(t=>t.content===e))}hasColumnById(e){return Boolean(this.columns.find(t=>t.id===e))}getColumnIndex(e){return this.columns.findIndex(t=>t.content===e)}getColumnIndexById(e){return this.columns.findIndex(t=>t.id===e)}getCheckboxHTML(){return'<input type="checkbox" />'}},Xe=class extends TypeError{},yt={chevronDown:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>',chevronRight:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline></svg>'},Ee=class{constructor(e){this.instance=e,Ke(this,this.instance,["wrapper","options","style","header","bodyScrollable","columnmanager","rowmanager","datamanager","keyboard"]),this.bindEvents()}bindEvents(){this.bindFocusCell(),this.bindEditCell(),this.bindKeyboardSelection(),this.bindCopyCellContents(),this.bindMouseEvents(),this.bindTreeEvents()}bindFocusCell(){this.bindKeyboardNav()}bindEditCell(){this.$editingCell=null,u.on(this.bodyScrollable,"dblclick",".dt-cell",(e,t)=>{this.activateEditing(t)}),this.keyboard.on("enter",()=>{this.$focusedCell&&!this.$editingCell?this.activateEditing(this.$focusedCell):this.$editingCell&&this.deactivateEditing()})}bindKeyboardNav(){let e=t=>{if(!this.$focusedCell||this.$editingCell)return!1;let r=this.$focusedCell,{rowIndex:i,colIndex:a}=u.data(r);return t==="left"?r=this.getLeftMostCell$(i):t==="right"?r=this.getRightMostCell$(i):t==="up"?r=this.getTopMostCell$(a):t==="down"&&(r=this.getBottomMostCell$(a)),this.focusCell(r),!0};["left","right","up","down","tab","shift+tab"].map(t=>this.keyboard.on(t,()=>this.focusCellInDirection(t))),["left","right","up","down"].map(t=>this.keyboard.on(`ctrl+${t}`,()=>e(t))),this.keyboard.on("esc",()=>{this.deactivateEditing(!1),this.columnmanager.toggleFilter(!1)}),this.options.inlineFilters&&(this.keyboard.on("ctrl+f",t=>{let r=u.closest(".dt-cell",t.target),{colIndex:i}=u.data(r);return this.activateFilter(i),!0}),u.on(this.header,"focusin",".dt-filter",()=>{this.unfocusCell(this.$focusedCell)}))}bindKeyboardSelection(){let e=t=>{let r=this.getSelectionCursor();return t==="left"?r=this.getLeftCell$(r):t==="right"?r=this.getRightCell$(r):t==="up"?r=this.getAboveCell$(r):t==="down"&&(r=this.getBelowCell$(r)),r};["left","right","up","down"].map(t=>this.keyboard.on(`shift+${t}`,()=>this.selectArea(e(t))))}bindCopyCellContents(){this.keyboard.on("ctrl+c",()=>{let e=this.copyCellContents(this.$focusedCell,this.$selectionCursor),t=this.instance.translate("{count} cells copied",{count:e});e&&this.instance.showToastMessage(t,2)}),this.options.pasteFromClipboard&&this.keyboard.on("ctrl+v",e=>(this.instance.pasteTarget.focus(),setTimeout(()=>{let t=this.instance.pasteTarget.value;this.instance.pasteTarget.value="",this.pasteContentInCell(t)},10),!1))}bindMouseEvents(){let e=null;u.on(this.bodyScrollable,"mousedown",".dt-cell",r=>{e=!0,this.focusCell(u(r.delegatedTarget))}),u.on(this.bodyScrollable,"mouseup",()=>{e=!1});let t=r=>{!e||this.selectArea(u(r.delegatedTarget))};u.on(this.bodyScrollable,"mousemove",".dt-cell",rr(t,50))}bindTreeEvents(){u.on(this.bodyScrollable,"click",".dt-tree-node__toggle",(e,t)=>{let r=u.closest(".dt-cell",t),{rowIndex:i}=u.data(r);r.classList.contains("dt-cell--tree-close")?this.rowmanager.openSingleNode(i):this.rowmanager.closeSingleNode(i)})}focusCell(e,{skipClearSelection:t=0,skipDOMFocus:r=0,skipScrollToCell:i=0}={}){if(!e||e===this.$editingCell)return;let{colIndex:a,isHeader:s}=u.data(e);s||this.columnmanager.getColumn(a).focusable===!1||(i||this.scrollToCell(e),this.deactivateEditing(),t||this.clearSelection(),this.$focusedCell&&this.$focusedCell.classList.remove("dt-cell--focus"),this.$focusedCell=e,e.classList.add("dt-cell--focus"),r||e.focus(),this.highlightRowColumnHeader(e))}unfocusCell(e){!e||(e.classList.remove("dt-cell--focus"),this.$focusedCell=null,this.lastHeaders&&this.lastHeaders.forEach(t=>t&&t.classList.remove("dt-cell--highlight")))}highlightRowColumnHeader(e){let{colIndex:t,rowIndex:r}=u.data(e),i=this.datamanager.getColumnIndexById("_rowIndex"),a=`.dt-cell--header-${t}`,s=`.dt-cell--${i}-${r}`;this.lastHeaders&&this.lastHeaders.forEach(f=>f&&f.classList.remove("dt-cell--highlight"));let n=u(a,this.wrapper),_=u(s,this.wrapper);this.lastHeaders=[n,_],this.lastHeaders.forEach(f=>f&&f.classList.add("dt-cell--highlight"))}selectAreaOnClusterChanged(){if(!(this.$focusedCell&&this.$selectionCursor))return;let{colIndex:e,rowIndex:t}=u.data(this.$selectionCursor),r=this.getCell$(e,t);if(!r||r===this.$selectionCursor)return;let i=u.data(this.$focusedCell);this.$focusedCell=this.getCell$(i.colIndex,i.rowIndex),this.selectArea(r)}focusCellOnClusterChanged(){if(!this.$focusedCell)return;let{colIndex:e,rowIndex:t}=u.data(this.$focusedCell),r=this.getCell$(e,t);!r||this.focusCell(r,{skipClearSelection:1,skipDOMFocus:1,skipScrollToCell:1})}selectArea(e){!this.$focusedCell||this._selectArea(this.$focusedCell,e)&&(this.$selectionCursor=e)}_selectArea(e,t){if(e===t)return!1;let r=this.getCellsInRange(e,t);return r?(this.clearSelection(),this._selectedCells=r.map(i=>this.getCell$(...i)),requestAnimationFrame(()=>{this._selectedCells.map(i=>i.classList.add("dt-cell--highlight"))}),!0):!1}getCellsInRange(e,t){let r,i,a,s;if(typeof e=="number")[r,i,a,s]=arguments;else if(typeof e=="object"){if(!(e&&t))return!1;let g=u.data(e),v=u.data(t);r=+g.colIndex,i=+g.rowIndex,a=+v.colIndex,s=+v.rowIndex}if(i>s&&([i,s]=[s,i]),r>a&&([r,a]=[a,r]),this.isStandardCell(r)||this.isStandardCell(a))return!1;let n=[],_=r,f=i,m=[];for(;f<=s;)m.push(f),f+=1;return m.map(g=>{for(;_<=a;)n.push([_,g]),_++;_=r}),n}clearSelection(){(this._selectedCells||[]).forEach(e=>e.classList.remove("dt-cell--highlight")),this._selectedCells=[],this.$selectionCursor=null}getSelectionCursor(){return this.$selectionCursor||this.$focusedCell}activateEditing(e){this.focusCell(e);let{rowIndex:t,colIndex:r}=u.data(e),i=this.columnmanager.getColumn(r);if(i&&(i.editable===!1||i.focusable===!1))return;let a=this.getCell(r,t);if(a&&a.editable===!1)return;if(this.$editingCell){let{_rowIndex:_,_colIndex:f}=u.data(this.$editingCell);if(t===_&&r===f)return}this.$editingCell=e,e.classList.add("dt-cell--editing");let s=u(".dt-cell__edit",e);s.innerHTML="";let n=this.getEditor(r,t,a.content,s);n&&(this.currentCellEditor=n,n.initValue(a.content,t,i))}deactivateEditing(e=!0){e&&this.submitEditing(),this.$focusedCell&&this.$focusedCell.focus(),this.$editingCell&&(this.$editingCell.classList.remove("dt-cell--editing"),this.$editingCell=null)}getEditor(e,t,r,i){let a=this.datamanager.getColumn(e),s=this.datamanager.getRow(t),n=this.datamanager.getData(t),_=this.options.getEditor?this.options.getEditor(e,t,r,i,a,s,n):this.getDefaultEditor(i);return _===!1?!1:(_===void 0&&(_=this.getDefaultEditor(i)),_)}getDefaultEditor(e){let t=u.create("input",{class:"dt-input",type:"text",inside:e});return{initValue(r){t.focus(),t.value=r},getValue(){return t.value},setValue(r){t.value=r}}}submitEditing(){let e=Promise.resolve();if(!this.$editingCell)return e;let t=this.$editingCell,{rowIndex:r,colIndex:i}=u.data(t),a=this.datamanager.getColumn(i);if(t){let s=this.currentCellEditor;if(s){let n=s.getValue();n.then||(n=Promise.resolve(n)),e=n.then(_=>{let f=this.getCell(i,r).content;if(f===_)return!1;let m=s.setValue(_,r,a);return this.updateCell(i,r,_,!0),t.focus(),m&&m.then&&m.catch(g=>{console.log(g),this.updateCell(i,r,f)}),m})}}return this.currentCellEditor=null,e}copyCellContents(e,t){if(!t&&e){let{colIndex:s,rowIndex:n}=u.data(e),_=this.getCell(s,n);return Gt(_.content),1}let r=this.getCellsInRange(e,t);if(!r)return 0;let i=r.map(s=>this.getCell(...s)).reduce((s,n)=>{let _=n.rowIndex;return s[_]=s[_]||[],s[_].push(n.content),s},[]),a=i.map(s=>s.join("	")).join(`
`);return Gt(a),i.reduce((s,n)=>s+n.length,0)}pasteContentInCell(e){if(!this.$focusedCell)return;let t=e.split(`
`).map(s=>s.split("	")).filter(s=>s.length&&s.every(n=>n)),{colIndex:r,rowIndex:i}=u.data(this.$focusedCell),a={colIndex:+r,rowIndex:+i};t.forEach((s,n)=>{let _=n+a.rowIndex;s.forEach((f,m)=>{let g=m+a.colIndex;this.updateCell(g,_,f,!0)})})}activateFilter(e){this.columnmanager.toggleFilter(),this.columnmanager.focusFilter(e),this.columnmanager.isFilterShown||this.$focusedCell&&this.$focusedCell.focus()}updateCell(e,t,r,i=!1){let a=this.datamanager.updateCell(e,t,{content:r});this.refreshCell(a,i)}refreshCell(e,t=!1){let r=u(this.selector(e.colIndex,e.rowIndex),this.bodyScrollable);r.innerHTML=this.getCellContent(e,t)}toggleTreeButton(e,t){let r=this.columnmanager.getFirstColumnIndex(),i=this.getCell$(r,e);i&&i.classList[t?"remove":"add"]("dt-cell--tree-close")}isStandardCell(e){return e<this.columnmanager.getFirstColumnIndex()}focusCellInDirection(e){if(!this.$focusedCell||this.$editingCell&&["left","right","up","down"].includes(e))return!1;this.$editingCell&&["tab","shift+tab"].includes(e)&&this.deactivateEditing();let t=this.$focusedCell;if(e==="left"||e==="shift+tab"?t=this.getLeftCell$(t):e==="right"||e==="tab"?t=this.getRightCell$(t):e==="up"?t=this.getAboveCell$(t):e==="down"&&(t=this.getBelowCell$(t)),!t)return!1;let{colIndex:r}=u.data(t);if(!this.columnmanager.getColumn(r).focusable){let a=this.$focusedCell;this.unfocusCell(a),this.$focusedCell=t;let s=this.focusCellInDirection(e);return s||this.focusCell(a),s}return this.focusCell(t),!0}getCell$(e,t){return u(this.selector(e,t),this.bodyScrollable)}getAboveCell$(e){let{colIndex:t}=u.data(e),r=e.parentElement.previousElementSibling;for(;r&&r.classList.contains("dt-row--hide");)r=r.previousElementSibling;return r?u(`.dt-cell--col-${t}`,r):e}getBelowCell$(e){let{colIndex:t}=u.data(e),r=e.parentElement.nextElementSibling;for(;r&&r.classList.contains("dt-row--hide");)r=r.nextElementSibling;return r?u(`.dt-cell--col-${t}`,r):e}getLeftCell$(e){return e.previousElementSibling}getRightCell$(e){return e.nextElementSibling}getLeftMostCell$(e){return this.getCell$(this.columnmanager.getFirstColumnIndex(),e)}getRightMostCell$(e){return this.getCell$(this.columnmanager.getLastColumnIndex(),e)}getTopMostCell$(e){return this.getCell$(e,this.rowmanager.getFirstRowIndex())}getBottomMostCell$(e){return this.getCell$(e,this.rowmanager.getLastRowIndex())}getCell(e,t){return this.instance.datamanager.getCell(e,t)}getRowHeight(){return u.style(u(".dt-row",this.bodyScrollable),"height")}scrollToCell(e){if(u.inViewport(e,this.bodyScrollable))return!1;let{rowIndex:t}=u.data(e);return this.rowmanager.scrollToRow(t),!1}getRowCountPerPage(){return Math.ceil(this.instance.getViewportHeight()/this.getRowHeight())}getCellHTML(e){let{rowIndex:t,colIndex:r,isHeader:i,isFilter:a,isTotalRow:s}=e,n=gt({rowIndex:t,colIndex:r,isHeader:i,isFilter:a,isTotalRow:s}),_=this.datamanager.getRow(t),f=!(i||a||s);return`
            <div class="${["dt-cell","dt-cell--col-"+r,f?`dt-cell--${r}-${t}`:"",f?"dt-cell--row-"+t:"",i?"dt-cell--header":"",i?`dt-cell--header-${r}`:"",a?"dt-cell--filter":"",f&&_&&_.meta.isTreeNodeClose?"dt-cell--tree-close":""].join(" ")}" ${n} tabindex="0">
                ${this.getCellContent(e)}
            </div>
        `}getCellContent(e,t=!1){let{isHeader:r,isFilter:i,colIndex:a}=e,n=!r&&e.editable!==!1?this.getEditCellHTML(a):"",f=r&&e.sortable!==!1?`<span class="sort-indicator">
                ${this.options.sortIndicator[e.sortOrder]}
            </span>`:"",g=r&&e.resizable!==!1?'<span class="dt-cell__resize-handle"></span>':"",C=r&&e.dropdown!==!1?this.columnmanager.getDropdownHTML():"",I=Ee.getCustomCellFormatter(e),b;if(r||i||!I)b=e.content;else if(!e.html||t){let W=this.datamanager.getRow(e.rowIndex),L=this.datamanager.getData(e.rowIndex);b=I(e.content,W,e.column,L)}else b=e.html;if(e.html=b,this.options.treeView&&!(r||i)&&e.indent!==void 0){let W=this.datamanager.getRow(e.rowIndex+1),L=W&&W.meta.indent>e.indent,D=20,z="px";if(this.datamanager.getColumnIndexById("_rowIndex")+1===e.colIndex){let ee=(e.indent||0)*D,re=L?`<span class="dt-tree-node__toggle" style="left: ${ee-D}${z}">
                        <span class="icon-open">${yt.chevronDown}</span>
                        <span class="icon-close">${yt.chevronRight}</span>
                    </span>`:"";b=`<span class="dt-tree-node" style="padding-left: ${ee}${z}">
                    ${re}
                    <span>${b}</span>
                </span>`}}let O=`
            <div class="${["dt-cell__content",r?`dt-cell__content--header-${a}`:`dt-cell__content--col-${a}`].join(" ")}">
                ${b}
                ${f}
                ${g}
                ${C}
            </div>
            ${n}
        `,F=document.createElement("div");F.innerHTML=b;let N=F.textContent;return N=N.replace(/\s+/g," ").trim(),O=O.replace(">",` title="${To(N)}">`),O}getEditCellHTML(e){return`<div class="dt-cell__edit dt-cell__edit--col-${e}"></div>`}selector(e,t){return`.dt-cell--${e}-${t}`}static getCustomCellFormatter(e){return e.format||e.column&&e.column.format||null}},ar=class{constructor(e){this.instance=e,Ke(this,this.instance,["options","fireEvent","header","datamanager","cellmanager","style","wrapper","rowmanager","bodyScrollable","bodyRenderer"]),this.bindEvents()}renderHeader(){this.header.innerHTML="<div></div>",this.refreshHeader()}refreshHeader(){let e=this.datamanager.getColumns();u("div",this.header).innerHTML=this.getHeaderHTML(e),this.$filterRow=u(".dt-row-filter",this.header),this.$filterRow&&u.style(this.$filterRow,{display:"none"}),this.$columnMap=[],this.bindMoveColumn()}getHeaderHTML(e){let t=this.rowmanager.getRowHTML(e,{isHeader:1});return this.options.inlineFilters&&(t+=this.rowmanager.getRowHTML(e,{isFilter:1})),t}bindEvents(){this.bindDropdown(),this.bindResizeColumn(),this.bindPerfectColumnWidth(),this.bindFilter()}bindDropdown(){let e=".dt-dropdown__toggle",t=".dt-dropdown__list";this.instance.dropdownContainer.innerHTML=this.getDropdownListHTML(),this.$dropdownList=this.instance.dropdownContainer.firstElementChild,u.on(this.header,"click",e,s=>{this.openDropdown(s)});let r=s=>{let n=[e,e+" *",t,t+" *"].join(",");s.target.matches(n)||a()};u.on(document.body,"click",r),document.addEventListener("scroll",a,!0),this.instance.on("onDestroy",()=>{u.off(document.body,"click",r),u.off(document,"scroll",a)}),u.on(this.$dropdownList,"click",".dt-dropdown__list-item",(s,n)=>{if(!this._dropdownActiveColIndex)return;let _=this.options.headerDropdown,{index:f}=u.data(n),m=this._dropdownActiveColIndex,g=_[f].action;g&&g.call(this.instance,this.getColumn(m)),this.hideDropdown()});let i=this;function a(s){i.hideDropdown()}this.hideDropdown()}openDropdown(e){this._dropdownWidth||(u.style(this.$dropdownList,{display:""}),this._dropdownWidth=u.style(this.$dropdownList,"width")),u.style(this.$dropdownList,{display:"",left:e.clientX-this._dropdownWidth+4+"px",top:e.clientY+4+"px"});let t=u.closest(".dt-cell",e.target),{colIndex:r}=u.data(t);this._dropdownActiveColIndex=r}hideDropdown(){u.style(this.$dropdownList,{display:"none"}),this._dropdownActiveColIndex=null}bindResizeColumn(){let e=!1,t,r,i;u.on(this.header,"mousedown",".dt-cell .dt-cell__resize-handle",(n,_)=>{document.body.classList.add("dt-resize"),t=_.parentNode.parentNode;let{colIndex:m}=u.data(t),g=this.getColumn(m);g&&g.resizable===!1||(e=!0,r=u.style(u(".dt-cell__content",t),"width"),i=n.pageX)});let a=n=>{if(document.body.classList.remove("dt-resize"),!t)return;e=!1;let{colIndex:_}=u.data(t);this.setColumnWidth(_),this.style.setBodyStyle(),t=null};u.on(document.body,"mouseup",a),this.instance.on("onDestroy",()=>{u.off(document.body,"mouseup",a)});let s=n=>{if(!e)return;let _=n.pageX-i;this.options.direction==="rtl"&&(_=-1*_);let f=r+_,{colIndex:m}=u.data(t);this.options.minimumColumnWidth>f||(this.datamanager.updateColumn(m,{width:f}),this.setColumnHeaderWidth(m))};u.on(document.body,"mousemove",s),this.instance.on("onDestroy",()=>{u.off(document.body,"mousemove",s)})}bindPerfectColumnWidth(){u.on(this.header,"dblclick",".dt-cell .dt-cell__resize-handle",(e,t)=>{let r=t.parentNode.parentNode,{colIndex:i}=u.data(r),a=this.bodyRenderer.visibleRows.map(b=>b[i]).reduce((b,T)=>b.content.length>T.content.length?b:T),s=this.cellmanager.getCellHTML(a),n=document.createElement("div");n.innerHTML=s;let _=n.querySelector(".dt-cell__content").textContent,{borderLeftWidth:f,borderRightWidth:m,paddingLeft:g,paddingRight:v}=u.getStyle(this.bodyScrollable.querySelector(".dt-cell__content")),C=[f,m,g,v].map(parseFloat).reduce((b,T)=>b+T),I=u.measureTextWidth(_)+C;this.datamanager.updateColumn(i,{width:I}),this.setColumnHeaderWidth(i),this.setColumnWidth(i)})}bindMoveColumn(){if(this.options.disableReorderColumn)return;let e=u(".dt-row",this.header);this.sortable=Ar.create(e,{onEnd:t=>{let{oldIndex:r,newIndex:i}=t,a=t.item,{colIndex:s}=u.data(a);+s!==i&&this.switchColumn(r,i)},preventOnFilter:!1,filter:".dt-cell__resize-handle, .dt-dropdown",chosenClass:"dt-cell--dragging",animation:150})}sortColumn(e,t){this.instance.freeze(),this.sortRows(e,t).then(()=>(this.refreshHeader(),this.rowmanager.refreshRows())).then(()=>this.instance.unfreeze()).then(()=>{this.fireEvent("onSortColumn",this.getColumn(e))})}removeColumn(e){let t=this.getColumn(e);this.instance.freeze(),this.datamanager.removeColumn(e).then(()=>(this.refreshHeader(),this.rowmanager.refreshRows())).then(()=>this.instance.unfreeze()).then(()=>{this.fireEvent("onRemoveColumn",t)})}switchColumn(e,t){this.instance.freeze(),this.datamanager.switchColumn(e,t).then(()=>(this.refreshHeader(),this.rowmanager.refreshRows())).then(()=>{this.setColumnWidth(e),this.setColumnWidth(t),this.instance.unfreeze()}).then(()=>{this.fireEvent("onSwitchColumn",this.getColumn(e),this.getColumn(t))})}toggleFilter(e){if(!this.options.inlineFilters)return;let t;e===void 0?t=!this.isFilterShown:t=e,t?u.style(this.$filterRow,{display:""}):u.style(this.$filterRow,{display:"none"}),this.isFilterShown=t,this.style.setBodyStyle()}focusFilter(e){if(!this.isFilterShown)return;u(`.dt-cell--col-${e} .dt-filter`,this.$filterRow).focus()}bindFilter(){if(!this.options.inlineFilters)return;let e=t=>{this.applyFilter(this.getAppliedFilters())};u.on(this.header,"keydown",".dt-filter",So(e,300))}applyFilter(e){this.datamanager.filterRows(e).then(({rowsToShow:t})=>{this.rowmanager.showRows(t)})}getAppliedFilters(){let e={};return u.each(".dt-filter",this.header).map(t=>{let r=t.value;r&&(e[t.dataset.colIndex]=r)}),e}applyDefaultSortOrder(){let e=this.getColumns().filter(t=>t.sortOrder!=="none");if(e.length===1){let t=e[0];this.sortColumn(t.colIndex,t.sortOrder)}}sortRows(e,t){return this.datamanager.sortRows(e,t)}getColumn(e){return this.datamanager.getColumn(e)}getColumns(){return this.datamanager.getColumns()}setColumnWidth(e,t){e=+e;let r=t||this.getColumn(e).width,i=[`.dt-cell__content--col-${e}`,`.dt-cell__edit--col-${e}`].join(", "),a={width:r+"px"};this.style.setStyle(i,a)}setColumnHeaderWidth(e){e=+e,this.$columnMap=this.$columnMap||[];let t=`.dt-cell__content--header-${e}`,{width:r}=this.getColumn(e),i=this.$columnMap[e];i||(i=this.header.querySelector(t),this.$columnMap[e]=i),i.style.width=r+"px"}getColumnMinWidth(e){return e=+e,this.getColumn(e).minWidth||24}getFirstColumnIndex(){return this.datamanager.getColumnIndexById("_rowIndex")+1}getHeaderCell$(e){return u(`.dt-cell--header-${e}`,this.header)}getLastColumnIndex(){return this.datamanager.getColumnCount()-1}getDropdownHTML(){let{dropdownButton:e}=this.options;return`
            <div class="dt-dropdown">
                <div class="dt-dropdown__toggle">${e}</div>
            </div>
      `}getDropdownListHTML(){let{headerDropdown:e}=this.options;return`
            <div class="dt-dropdown__list">
            ${e.map((t,r)=>`
                <div class="dt-dropdown__list-item" data-index="${r}">${t.label}</div>
            `).join("")}
            </div>
        `}},or=class{constructor(e){this.instance=e,Ke(this,this.instance,["options","fireEvent","wrapper","bodyScrollable","bodyRenderer","style"]),this.bindEvents(),this.refreshRows=$e(this.refreshRows,this)}get datamanager(){return this.instance.datamanager}get cellmanager(){return this.instance.cellmanager}bindEvents(){this.bindCheckbox()}bindCheckbox(){!this.options.checkboxColumn||(this.checkMap=[],u.on(this.wrapper,"click",'.dt-cell--col-0 [type="checkbox"]',(e,t)=>{let r=t.closest(".dt-cell"),{rowIndex:i,isHeader:a}=u.data(r),s=t.checked;a?this.checkAll(s):this.checkRow(i,s)}))}refreshRows(){this.instance.renderBody(),this.instance.setDimensions()}refreshRow(e,t){this.datamanager.updateRow(e,t).forEach(i=>{this.cellmanager.refreshCell(i,!0)})}getCheckedRows(){if(!this.checkMap)return[];let e=[];for(let t in this.checkMap)this.checkMap[t]===1&&e.push(t);return e}highlightCheckedRows(){this.getCheckedRows().map(e=>this.checkRow(e,!0))}checkRow(e,t){let r=t?1:0,i=a=>`.dt-cell--0-${a} [type="checkbox"]`;this.checkMap[e]=r,u.each(i(e),this.bodyScrollable).map(a=>{a.checked=t}),this.highlightRow(e,t),this.showCheckStatus(),this.fireEvent("onCheckRow",this.datamanager.getRow(e))}checkAll(e){let t=e?1:0;e?this.datamanager._filteredRows?this.datamanager._filteredRows.forEach(r=>{this.checkRow(r,e)}):this.checkMap=Array.from(Array(this.getTotalRows())).map(r=>t):this.checkMap=[],u.each('.dt-cell--col-0 [type="checkbox"]',this.bodyScrollable).map(r=>{r.checked=e}),this.highlightAll(e),this.showCheckStatus(),this.fireEvent("onCheckRow")}showCheckStatus(){if(!this.options.checkedRowStatus)return;let t=this.getCheckedRows().length;if(t>0){let r=this.instance.translate("{count} rows selected",{count:t});this.bodyRenderer.showToastMessage(r)}else this.bodyRenderer.clearToastMessage()}highlightRow(e,t=!0){let r=this.getRow$(e);if(!!r){if(!t&&this.bodyScrollable.classList.contains("dt-scrollable--highlight-all")){r.classList.add("dt-row--unhighlight");return}t&&r.classList.contains("dt-row--unhighlight")&&r.classList.remove("dt-row--unhighlight"),this._highlightedRows=this._highlightedRows||{},t?(r.classList.add("dt-row--highlight"),this._highlightedRows[e]=r):(r.classList.remove("dt-row--highlight"),delete this._highlightedRows[e])}}highlightAll(e=!0){if(e)this.bodyScrollable.classList.add("dt-scrollable--highlight-all");else{this.bodyScrollable.classList.remove("dt-scrollable--highlight-all");for(let t in this._highlightedRows)this._highlightedRows[t].classList.remove("dt-row--highlight");this._highlightedRows={}}}showRows(e){e=$o(e);let t=e.map(r=>this.datamanager.getRow(r));this.bodyRenderer.renderRows(t)}showAllRows(){let e=this.datamanager.getAllRowIndices();this.showRows(e)}getChildrenToShowForNode(e){let t=this.datamanager.getRow(e);return t.meta.isTreeNodeClose=!1,this.datamanager.getImmediateChildren(e)}openSingleNode(e){let t=this.getChildrenToShowForNode(e),r=this.bodyRenderer.visibleRowIndices,i=Qt([...t,...r]).sort(Re);this.showRows(i)}getChildrenToHideForNode(e){let t=this.datamanager.getRow(e);t.meta.isTreeNodeClose=!0;let r=this.datamanager.getChildren(e);return r.forEach(i=>{let a=this.datamanager.getRow(i);a.meta.isLeaf||(a.meta.isTreeNodeClose=!0)}),r}closeSingleNode(e){let t=this.getChildrenToHideForNode(e),i=this.bodyRenderer.visibleRowIndices.filter(a=>!t.includes(a)).sort(Re);this.showRows(i)}expandAllNodes(){let r=this.datamanager.getRows().filter(s=>!s.meta.isLeaf).map(s=>this.getChildrenToShowForNode(s.meta.rowIndex)).flat(),i=this.bodyRenderer.visibleRowIndices,a=Qt([...r,...i]).sort(Re);this.showRows(a)}collapseAllNodes(){let r=this.datamanager.getRows().filter(s=>s.meta.indent===0).map(s=>this.getChildrenToHideForNode(s.meta.rowIndex)).flat(),a=this.bodyRenderer.visibleRowIndices.filter(s=>!r.includes(s)).sort(Re);this.showRows(a)}setTreeDepth(e){let t=this.datamanager.getRows(),r=t.filter(n=>n.meta.indent<e),i=t.filter(n=>n.meta.indent>=e),a=i.filter(n=>n.meta.indent>e);i.forEach(n=>{n.meta.isLeaf||(n.meta.isTreeNodeClose=!0)}),r.forEach(n=>{n.meta.isLeaf||(n.meta.isTreeNodeClose=!1)});let s=t.filter(n=>!a.includes(n)).map(n=>n.meta.rowIndex).sort(Re);this.showRows(s)}getRow$(e){return u(this.selector(e),this.bodyScrollable)}getTotalRows(){return this.datamanager.getRowCount()}getFirstRowIndex(){return 0}getLastRowIndex(){return this.datamanager.getRowCount()-1}scrollToRow(e){e=+e,this._lastScrollTo=this._lastScrollTo||0;let t=this.getRow$(e);if(u.inViewport(t,this.bodyScrollable))return;let{height:r}=t.getBoundingClientRect(),{top:i,bottom:a}=this.bodyScrollable.getBoundingClientRect(),s=Math.floor((a-i)/r),n=0;e>this._lastScrollTo?n=r*(e+1-s):n=r*(e+1-1),this._lastScrollTo=e,u.scrollTop(this.bodyScrollable,n)}getRowHTML(e,t){let r=gt(t),i=t.rowIndex;return t.isFilter&&(e=e.map(a=>Object.assign({},a,{content:this.getFilterInput({colIndex:a.colIndex,name:a.name}),isFilter:1,isHeader:void 0,editable:!1})),i="filter"),t.isHeader&&(i="header"),`
            <div class="dt-row dt-row-${i}" ${r}>
                ${e.map(a=>this.cellmanager.getCellHTML(a)).join("")}
            </div>
        `}getFilterInput(e){let t=`title="Filter based on ${e.name||"Index"}"`;return`<input class="dt-filter dt-input" type="text" ${gt(e)} tabindex="1"
            ${e.colIndex===0?"disabled":t} />`}selector(e){return`.dt-row-${e}`}},Do=Wr(function(o,e){(function(t){o.exports=t()})(function(){return function t(r,i,a){function s(f,m){if(!i[f]){if(!r[f]){var g=typeof Ye=="function"&&Ye;if(!m&&g)return g(f,!0);if(n)return n(f,!0);var v=new Error("Cannot find module '"+f+"'");throw v.code="MODULE_NOT_FOUND",v}var C=i[f]={exports:{}};r[f][0].call(C.exports,function(I){var b=r[f][1][I];return s(b||I)},C,C.exports,t,r,i,a)}return i[f].exports}for(var n=typeof Ye=="function"&&Ye,_=0;_<a.length;_++)s(a[_]);return s}({1:[function(t,r,i){Object.defineProperty(i,"__esModule",{value:!0});var a=function(){function m(g,v){for(var C=0;C<v.length;C++){var I=v[C];I.enumerable=I.enumerable||!1,I.configurable=!0,"value"in I&&(I.writable=!0),Object.defineProperty(g,I.key,I)}}return function(g,v,C){return v&&m(g.prototype,v),C&&m(g,C),g}}();function s(m,g){if(!(m instanceof g))throw new TypeError("Cannot call a class as a function")}var n={width:"100%",height:"100%"},_=function(g){return Number(g)===Number(g)},f=function(){a(m,null,[{key:"create",value:function(v,C){return new m(v,C)}},{key:"mergeStyle",value:function(v,C){for(var I in C)v.style[I]!==C[I]&&(v.style[I]=C[I])}},{key:"getMaxBrowserHeight",value:function(){var v=document.createElement("div"),C=document.createElement("div");m.mergeStyle(v,{position:"absolute",height:"1px",opacity:0}),m.mergeStyle(C,{height:"1e7px"}),v.appendChild(C),document.body.appendChild(v);var I=C.offsetHeight;return document.body.removeChild(v),I}}]);function m(g,v){var C=this;s(this,m),this._config={},this._lastRepaint=null,this._maxElementHeight=m.getMaxBrowserHeight(),this.refresh(g,v);var I=this._config,b=function T(){var O=C._getScrollPosition(),F=C._lastRepaint;if(C._renderAnimationFrame=window.requestAnimationFrame(T),O!==F&&(!F||Math.abs(O-F)>C._averageHeight)){var N=C._renderChunk();C._lastRepaint=O,N!==!1&&typeof I.afterRender=="function"&&I.afterRender()}};b()}return a(m,[{key:"destroy",value:function(){window.cancelAnimationFrame(this._renderAnimationFrame)}},{key:"refresh",value:function(v,C){var I=this;if(Object.assign(this._config,n,C),!v||v.nodeType!==1)throw new Error("HyperList requires a valid DOM Node container");this._element=v;var b=this._config,T=this._scroller||b.scroller||document.createElement(b.scrollerTagName||"tr");if(typeof b.useFragment!="boolean"&&(this._config.useFragment=!0),!b.generate)throw new Error("Missing required `generate` function");if(!_(b.total))throw new Error("Invalid required `total` value, expected number");if(!Array.isArray(b.itemHeight)&&!_(b.itemHeight))throw new Error("\n        Invalid required `itemHeight` value, expected number or array\n      ".trim());_(b.itemHeight)?this._itemHeights=Array(b.total).fill(b.itemHeight):this._itemHeights=b.itemHeight,Object.keys(n).filter(function(L){return L in b}).forEach(function(L){var D=b[L],z=_(D),j=z?!1:D.slice(-1)==="%";if(D&&typeof D!="string"&&typeof D!="number"){var ee="Invalid optional `"+L+"`, expected string or number";throw new Error(ee)}else z&&(b[L]=D+"px");if(L==="height"){var re=z?D:parseInt(D.replace(/px|%/,""),10);j?I._containerHeight=window.innerHeight*re/100:I._containerHeight=_(D)?D:re}});var O={width:""+b.width,height:""+b.height,overflow:"auto",position:"relative"};m.mergeStyle(v,O);var F=b.itemHeight*b.total,N=this._maxElementHeight;F>N&&console.warn(["HyperList: The maximum element height",N+"px has","been exceeded; please reduce your item height."].join(" "));var W={opacity:"0",position:"absolute",width:"1px",height:F+"px"};m.mergeStyle(T,W),this._scroller||v.appendChild(T),this._scroller=T,this._scrollHeight=this._computeScrollHeight(),this._itemPositions=this._itemPositions||Array(b.total).fill(0),this._computePositions(0),this._renderChunk(this._lastRepaint!==null),typeof b.afterRender=="function"&&b.afterRender()}},{key:"_getRow",value:function(v){var C=this._config,I=C.generate(v),b=I.height;if(b!==void 0&&_(b)?(I=I.element,b!==this._itemHeights&&(this._itemHeights[v]=b,this._computePositions(v),this._scrollHeight=this._computeScrollHeight(v))):b=this._itemHeights[v],!I||I.nodeType!==1)throw new Error("Generator did not return a DOM Node for index: "+v);var T=I.getAttribute("class")||"";I.setAttribute("class",T+" "+(C.rowClassName||"vrow"));var O=this._itemPositions[v];return m.mergeStyle(I,{position:"absolute",top:O+"px"}),I}},{key:"_getScrollPosition",value:function(){var v=this._config;return typeof v.overrideScrollPosition=="function"?v.overrideScrollPosition():this._element.scrollTop}},{key:"_renderChunk",value:function(v){var C=this._config,I=this._element,b=this._getScrollPosition(),T=C.total,O=C.reverse?this._getReverseFrom(b):this._getFrom(b)-1;if((O<0||O-this._screenItemsLen<0)&&(O=0),!v&&this._lastFrom===O)return!1;this._lastFrom=O;var F=O+this._cachedItemsLen;(F>T||F+this._cachedItemsLen>T)&&(F=T);var N=C.useFragment?document.createDocumentFragment():[],W=this._scroller;N[C.useFragment?"appendChild":"push"](W);for(var L=O;L<F;L++){var D=this._getRow(L);N[C.useFragment?"appendChild":"push"](D)}if(C.applyPatch)return C.applyPatch(I,N);I.innerHTML="",I.appendChild(N)}},{key:"_computePositions",value:function(){var v=arguments.length<=0||arguments[0]===void 0?1:arguments[0],C=this._config,I=C.total,b=C.reverse;v<1&&!b&&(v=1);for(var T=v;T<I;T++)b?T===0?this._itemPositions[0]=this._scrollHeight-this._itemHeights[0]:this._itemPositions[T]=this._itemPositions[T-1]-this._itemHeights[T]:this._itemPositions[T]=this._itemHeights[T-1]+this._itemPositions[T-1]}},{key:"_computeScrollHeight",value:function(){var v=this,C=this._config,I=C.total,b=this._itemHeights.reduce(function(W,L){return W+L},0);m.mergeStyle(this._scroller,{opacity:0,position:"absolute",width:"1px",height:b+"px"});var T=this._itemHeights.slice(0).sort(function(W,L){return W-L}),O=Math.floor(I/2),F=I%2===0?(T[O]+T[O-1])/2:T[O],N=this._element.clientHeight?this._element.clientHeight:this._containerHeight;return this._screenItemsLen=Math.ceil(N/F),this._containerHeight=N,this._cachedItemsLen=Math.max(this._cachedItemsLen||0,this._screenItemsLen*3),this._averageHeight=F,C.reverse&&window.requestAnimationFrame(function(){v._element.scrollTop=b}),b}},{key:"_getFrom",value:function(v){for(var C=0;this._itemPositions[C]<v;)C++;return C}},{key:"_getReverseFrom",value:function(v){for(var C=this._config.total-1;C>0&&this._itemPositions[C]<v+this._containerHeight;)C--;return C}}]),m}();i.default=f,r.exports=i.default},{}]},{},[1])(1)})}),Eo=jr(Do),sr=class{constructor(e){this.instance=e,this.options=e.options,this.datamanager=e.datamanager,this.rowmanager=e.rowmanager,this.cellmanager=e.cellmanager,this.bodyScrollable=e.bodyScrollable,this.footer=this.instance.footer,this.log=e.log}renderRows(e){if(this.visibleRows=e,this.visibleRowIndices=e.map(a=>a.meta.rowIndex),e.length===0){this.bodyScrollable.innerHTML=this.getNoDataHTML();return}let t=this.datamanager.rowViewOrder.map(a=>this.visibleRowIndices.includes(a)?a:null).filter(a=>a!==null),r=getComputedStyle(this.bodyScrollable),i={width:r.width,height:r.height,itemHeight:this.options.cellHeight,total:e.length,generate:a=>{let s=document.createElement("div"),n=t[a],_=this.datamanager.getRow(n),f=this.rowmanager.getRowHTML(_,_.meta);return s.innerHTML=f,s.children[0]},afterRender:()=>{this.restoreState()}};this.hyperlist?this.hyperlist.refresh(this.bodyScrollable,i):this.hyperlist=new Eo(this.bodyScrollable,i),this.renderFooter()}render(){let e=this.datamanager.getRowsForView();this.renderRows(e),this.instance.setDimensions()}renderFooter(){if(!this.options.showTotalRow)return;let e=this.getTotalRow(),t=this.rowmanager.getRowHTML(e,{isTotalRow:1,rowIndex:"totalRow"});this.footer.innerHTML=t}getTotalRow(){return this.datamanager.getColumns().map(i=>{let a=null;return["_rowIndex","_checkbox"].includes(i.id)&&(a=""),{content:a,isTotalRow:1,colIndex:i.colIndex,column:i}}).map((i,a)=>{if(i.content==="")return i;if(this.options.hooks.columnTotal){let s=this.visibleRows.map(_=>_[a].content),n=this.options.hooks.columnTotal.call(this.instance,s,i);if(n!=null)return i.content=n,i}return i.content=this.visibleRows.reduce((s,n)=>{let _=n[a];return typeof _.content=="number"?(s==null&&(s=0),s+_.content):s},i.content),i})}restoreState(){this.rowmanager.highlightCheckedRows(),this.cellmanager.selectAreaOnClusterChanged(),this.cellmanager.focusCellOnClusterChanged()}showToastMessage(e,t){this.instance.toastMessage.innerHTML=this.getToastMessageHTML(e),t&&setTimeout(()=>{this.clearToastMessage()},t*1e3)}clearToastMessage(){this.instance.toastMessage.innerHTML=""}getNoDataHTML(){return`<div class="dt-scrollable__no-data">${this.options.noDataMessage}</div>`}getToastMessageHTML(e){return`<span class="dt-toast__message">${e}</span>`}},nr=class{constructor(e){this.instance=e,Ke(this,this.instance,["options","datamanager","columnmanager","header","footer","bodyScrollable","datatableWrapper","getColumn","bodyRenderer"]),this.scopeClass="dt-instance-"+e.constructor.instances,e.datatableWrapper.classList.add(this.scopeClass);let t=document.createElement("style");e.wrapper.insertBefore(t,e.datatableWrapper),this.styleEl=t,this.bindResizeWindow(),this.bindScrollHeader()}get stylesheet(){return this.styleEl.sheet}bindResizeWindow(){this.onWindowResize=this.onWindowResize.bind(this),this.onWindowResize=rr(this.onWindowResize,300),this.options.layout==="fluid"&&u.on(window,"resize",this.onWindowResize)}bindScrollHeader(){this._settingHeaderPosition=!1,u.on(this.bodyScrollable,"scroll",e=>{this._settingHeaderPosition||(this._settingHeaderPosition=!0,requestAnimationFrame(()=>{let t=-e.target.scrollLeft;u.style(this.header,{transform:`translateX(${t}px)`}),u.style(this.footer,{transform:`translateX(${t}px)`}),this._settingHeaderPosition=!1}))})}onWindowResize(){this.distributeRemainingWidth(),this.refreshColumnWidth(),this.setBodyStyle()}destroy(){this.styleEl.remove(),u.off(window,"resize",this.onWindowResize)}setStyle(e,t){if(e.includes(",")){e.split(",").map(s=>s.trim()).forEach(s=>{this.setStyle(s,t)});return}if(e=e.trim(),!e)return;this._styleRulesMap=this._styleRulesMap||{};let r=this._getPrefixedSelector(e);this._styleRulesMap[r]&&(this.removeStyle(e),t=Object.assign({},this._styleRulesMap[r],t));let i=this._getRuleString(t),a=`${r} { ${i} }`;this._styleRulesMap[r]=t,this.stylesheet.insertRule(a)}removeStyle(e){if(e.includes(",")){e.split(",").map(i=>i.trim()).forEach(i=>{this.removeStyle(i)});return}if(e=e.trim(),!e)return;let t=this._getPrefixedSelector(e),r=Array.from(this.stylesheet.cssRules).findIndex(i=>i.selectorText===t);r!==-1&&this.stylesheet.deleteRule(r)}_getPrefixedSelector(e){return`.${this.scopeClass} ${e}`}_getRuleString(e){return Object.keys(e).map(t=>{let r=t;return t.includes("-")||(r=tr(t)),`${r}:${e[t]};`}).join("")}setDimensions(){this.setCellHeight(),this.setupMinWidth(),this.setupNaturalColumnWidth(),this.setupColumnWidth(),this.distributeRemainingWidth(),this.setColumnStyle(),this.setBodyStyle()}setCellHeight(){this.setStyle(".dt-cell",{height:this.options.cellHeight+"px"})}setupMinWidth(){u.each(".dt-cell--header",this.header).map(e=>{let{colIndex:t}=u.data(e),r=this.getColumn(t);if(!r.minWidth){let i=u.style(u(".dt-cell__content",e),"width");r.minWidth=i}})}setupNaturalColumnWidth(){!u(".dt-row")||(u.each(".dt-row-header .dt-cell",this.header).map(e=>{let{colIndex:t}=u.data(e),r=this.datamanager.getColumn(t),i=u.style(u(".dt-cell__content",e),"width");typeof i=="number"&&i>=this.options.minimumColumnWidth?r.naturalWidth=i:r.naturalWidth=this.options.minimumColumnWidth}),u.each(".dt-row-0 .dt-cell",this.bodyScrollable).map(e=>{let{colIndex:t}=u.data(e),r=this.datamanager.getColumn(t),i=u.style(u(".dt-cell__content",e),"width");typeof i=="number"&&i>=r.naturalWidth?r.naturalWidth=i:r.naturalWidth=r.naturalWidth}))}setupColumnWidth(){if(this.options.layout==="ratio"){let e=u.style(this.datatableWrapper,"width");if(this.options.serialNoColumn){let i=this.datamanager.getColumnById("_rowIndex");e=e-i.width-1}if(this.options.checkboxColumn){let i=this.datamanager.getColumnById("_checkbox");e=e-i.width-1}let t=this.datamanager.getColumns().map(i=>i.id==="_rowIndex"||i.id==="_checkbox"?0:(i.width||(i.width=1),i.ratioWidth=parseInt(i.width,10),i.ratioWidth)).reduce((i,a)=>i+a),r=e/t;this.datamanager.getColumns().map(i=>{i.id==="_rowIndex"||i.id==="_checkbox"||(i.width=Math.floor(r*i.ratioWidth)-1)})}else this.datamanager.getColumns().map(e=>{e.width||(e.width=e.naturalWidth),e.id==="_rowIndex"&&(e.width=this.getRowIndexColumnWidth()),e.width<this.options.minimumColumnWidth&&(e.width=this.options.minimumColumnWidth)})}distributeRemainingWidth(){if(this.options.layout!=="fluid")return;let e=u.style(this.instance.datatableWrapper,"width"),t=u(".dt-row",this.bodyScrollable),r=e;if(t)r=u.style(t,"width");else{let s=u(".dt-row",this.instance.header);r=Array.from(s.children).map(_=>_.offsetWidth).reduce((_,f)=>_+f,0)}let i=this.datamanager.getColumns().filter(s=>s.resizable),a=(e-r)/i.length;i.map(s=>{let n=u.style(this.getColumnHeaderElement(s.colIndex),"width"),_=Math.floor(n+a)-2;this.datamanager.updateColumn(s.colIndex,{width:_})})}setColumnStyle(){this.datamanager.getColumns().map(e=>{e.align||(e.align="left"),["left","center","right"].includes(e.align)||(e.align="left"),this.setStyle(`.dt-cell--col-${e.colIndex}`,{"text-align":e.align}),this.columnmanager.setColumnHeaderWidth(e.colIndex),this.columnmanager.setColumnWidth(e.colIndex)})}refreshColumnWidth(){this.datamanager.getColumns().map(e=>{this.columnmanager.setColumnHeaderWidth(e.colIndex),this.columnmanager.setColumnWidth(e.colIndex)})}setBodyStyle(){let e=u.style(this.datatableWrapper,"width"),t=u(".dt-row",this.bodyScrollable);if(!t)return;let r=u.style(t,"width"),i=e>r?r:e;u.style(this.bodyScrollable,{width:i+"px"}),u.removeStyle(this.bodyScrollable,"height");let a=u.getStyle(this.bodyScrollable,"height"),s=(this.bodyRenderer.hyperlist||{})._scrollHeight||1/0,n=u.hasHorizontalOverflow(this.bodyScrollable),_;s<a&&(_=s,n&&(_+=u.scrollbarSize()),u.style(this.bodyScrollable,{height:_+"px"})),this.bodyScrollable.scrollHeight-this.bodyScrollable.offsetHeight<u.scrollbarSize()&&u.style(this.bodyScrollable,{overflowY:"hidden"}),this.options.layout==="fluid"&&u.style(this.bodyScrollable,{overflowX:"hidden"})}getColumnHeaderElement(e){return e=+e,e<0?null:u(`.dt-cell--col-${e}`,this.header)}getRowIndexColumnWidth(){let e=this.datamanager.getRowCount(),t=22;return u.measureTextWidth(e+"")+t}},Oo={13:"enter",91:"meta",16:"shift",17:"ctrl",18:"alt",37:"left",38:"up",39:"right",40:"down",9:"tab",27:"esc",67:"c",70:"f",86:"v"},lr=class{constructor(e){this.listeners={},u.on(e,"keydown",this.handler.bind(this))}handler(e){let t=Oo[e.keyCode];e.shiftKey&&t!=="shift"&&(t="shift+"+t),(e.ctrlKey&&t!=="ctrl"||e.metaKey&&t!=="meta")&&(t="ctrl+"+t);let r=this.listeners[t];if(r&&r.length>0)for(let i of r){let a=i(e);(a===void 0||a===!0)&&e.preventDefault()}}on(e,t){e.split(",").map(i=>i.trim()).map(i=>{this.listeners[i]=this.listeners[i]||[],this.listeners[i].push(t)})}},Ho={"Sort Ascending":"Sort Ascending","Sort Descending":"Sort Descending","Reset sorting":"Reset sorting","Remove column":"Remove column","No Data":"No Data","{count} cells copied":{"1":"{count} cell copied",default:"{count} cells copied"},"{count} rows selected":{"1":"{count} row selected",default:"{count} rows selected"}},Mo={"Sort Ascending":"Aufsteigend sortieren","Sort Descending":"Absteigend sortieren","Reset sorting":"Sortierung zur\xFCcksetzen","Remove column":"Spalte entfernen","No Data":"Keine Daten","{count} cells copied":{"1":"{count} Zelle kopiert",default:"{count} Zellen kopiert"},"{count} rows selected":{"1":"{count} Zeile ausgew\xE4hlt",default:"{count} Zeilen ausgew\xE4hlt"}},Po={"Sort Ascending":"Trier par ordre croissant","Sort Descending":"Trier par ordre d\xE9croissant","Reset sorting":"R\xE9initialiser le tri","Remove column":"Supprimer colonne","No Data":"Pas de donn\xE9es","{count} cells copied":{"1":"{count} cellule copi\xE9e",default:"{count} cellules copi\xE9es"},"{count} rows selected":{"1":"{count} ligne s\xE9lectionn\xE9e",default:"{count} lignes s\xE9lectionn\xE9es"}},qo={"Sort Ascending":"Ordinamento ascendente","Sort Descending":"Ordinamento decrescente","Reset sorting":"Azzeramento ordinamento","Remove column":"Rimuovi colonna","No Data":"Nessun dato","{count} cells copied":{"1":"Copiato {count} cella",default:"{count} celle copiate"},"{count} rows selected":{"1":"{count} linea selezionata",default:"{count} linee selezionate"}};function No(){return{en:Ho,de:Mo,fr:Po,it:qo}}var cr=class{constructor(e){this.language=e,this.translations=No()}addTranslations(e){this.translations=Object.assign(this.translations,e)}translate(e,t){let r=this.translations[this.language]&&this.translations[this.language][e]||e;return typeof r=="object"&&(r=t&&t.count?this.getPluralizedTranslation(r,t.count):e),ko(r,t||{})}getPluralizedTranslation(e,t){return e[t]||e.default}};function Ao(o,e){let t=[];if(Object.keys(e).length===0)return o.map(r=>r.meta.rowIndex);for(let r in e){let i=e[r],s=(t.length?t.map(f=>o[f]):o).map(f=>f[r]),n=Fo(i),_=Lo(o,n);_?t=_(n.text,s):t=s.map(f=>f.rowIndex)}return t}function Lo(o,e){let t=n=>{let _=Ee.getCustomCellFormatter(n);return _&&n.content?(n.html=_(n.content,o[n.rowIndex],n.column,o[n.rowIndex],!0),Ut(n.html)):n.content||""},r=n=>String(Ut(n.html||"")||t(n)).toLowerCase(),i=n=>parseFloat(n.content),a=(n,_)=>{if(n.column.compareValue){let m=n.column.compareValue(n,_);if(m&&Array.isArray(m))return m}let f=i(n);return isNaN(f)?[r(n),_]:[f,_]};return{contains(n,_){return _.filter(f=>{let m=r(f),g=(n||"").toLowerCase();return!g||m.includes(g)}).map(f=>f.rowIndex)},greaterThan(n,_){return _.filter(f=>{let[m,g]=a(f,n);return m>g}).map(f=>f.rowIndex)},lessThan(n,_){return _.filter(f=>{let[m,g]=a(f,n);return m<g}).map(f=>f.rowIndex)},equals(n,_){return _.filter(f=>parseFloat(f.content)===n).map(f=>f.rowIndex)},notEquals(n,_){return _.filter(f=>parseFloat(f.content)!==n).map(f=>f.rowIndex)},range(n,_){return _.filter(f=>{let m=a(f,n[0]),g=a(f,n[1]),v=m[0];return v>=m[1]&&v<=g[1]}).map(f=>f.rowIndex)},containsNumber(n,_){return _.filter(f=>{let m=parseFloat(n,10),g=n,v=i(f),C=r(f);return m===v||C.includes(g)}).map(f=>f.rowIndex)}}[e.type]}function Fo(o=""){if(o.length===0)return{};let e=o;return[">","<","="].includes(e[0])?e=o.slice(1):e.startsWith("!=")&&(e=o.slice(2)),o.startsWith(">")&&e?{type:"greaterThan",text:e.trim()}:o.startsWith("<")&&e?{type:"lessThan",text:e.trim()}:o.startsWith("=")&&ke(e)?{type:"equals",text:Number(o.slice(1).trim())}:ke(e)?{type:"containsNumber",text:e}:o.startsWith("!=")&&ke(e)?{type:"notEquals",text:Number(o.slice(2).trim())}:o.split(":").length===2&&o.split(":").every(t=>ke(t.trim()))?(e=o.split(":"),{type:"range",text:e.map(t=>t.trim())}):{type:"contains",text:e.toLowerCase()}}function jo(o){return{columns:[],data:[],dropdownButton:yt.chevronDown,headerDropdown:[{label:o.translate("Sort Ascending"),action:function(e){this.sortColumn(e.colIndex,"asc")}},{label:o.translate("Sort Descending"),action:function(e){this.sortColumn(e.colIndex,"desc")}},{label:o.translate("Reset sorting"),action:function(e){this.sortColumn(e.colIndex,"none")}},{label:o.translate("Remove column"),action:function(e){this.removeColumn(e.colIndex)}}],events:{onRemoveColumn(e){},onSwitchColumn(e,t){},onSortColumn(e){},onCheckRow(e){},onDestroy(){}},hooks:{columnTotal:null},sortIndicator:{asc:"\u2191",desc:"\u2193",none:""},overrideComponents:{},filterRows:Ao,freezeMessage:"",getEditor:null,serialNoColumn:!0,checkboxColumn:!1,clusterize:!0,logs:!1,layout:"fixed",noDataMessage:o.translate("No Data"),cellHeight:40,minimumColumnWidth:30,inlineFilters:!1,treeView:!1,checkedRowStatus:!0,dynamicRowHeight:!1,pasteFromClipboard:!1,showTotalRow:!1,direction:"ltr",disableReorderColumn:!1}}var Wo={DataManager:ir,CellManager:Ee,ColumnManager:ar,RowManager:or,BodyRenderer:sr,Style:nr,Keyboard:lr},ye=class{constructor(e,t){if(ye.instances++,typeof e=="string"&&(e=document.querySelector(e)),this.wrapper=e,!(this.wrapper instanceof HTMLElement))throw new Error("Invalid argument given for `wrapper`");this.initializeTranslations(t),this.setDefaultOptions(),this.buildOptions(t),this.prepare(),this.initializeComponents(),this.options.data&&(this.refresh(),this.columnmanager.applyDefaultSortOrder())}initializeTranslations(e){this.language=e.language||"en",this.translationManager=new cr(this.language),e.translations&&this.translationManager.addTranslations(e.translations)}setDefaultOptions(){this.DEFAULT_OPTIONS=jo(this)}buildOptions(e){this.options=this.options||{},this.options=Object.assign({},this.DEFAULT_OPTIONS,this.options||{},e),e.headerDropdown=e.headerDropdown||[],this.options.headerDropdown=[...this.DEFAULT_OPTIONS.headerDropdown,...e.headerDropdown],this.events=Object.assign({},this.DEFAULT_OPTIONS.events,this.options.events||{},e.events||{}),this.fireEvent=this.fireEvent.bind(this)}prepare(){this.prepareDom(),this.unfreeze()}initializeComponents(){let e=Object.assign({},Wo,this.options.overrideComponents),{Style:t,Keyboard:r,DataManager:i,RowManager:a,ColumnManager:s,CellManager:n,BodyRenderer:_}=e;this.style=new t(this),this.keyboard=new r(this.wrapper),this.datamanager=new i(this.options),this.rowmanager=new a(this),this.columnmanager=new s(this),this.cellmanager=new n(this),this.bodyRenderer=new _(this)}prepareDom(){this.wrapper.innerHTML=`
            <div class="datatable" dir="${this.options.direction}">
                <div class="dt-header"></div>
                <div class="dt-scrollable"></div>
                <div class="dt-footer"></div>
                <div class="dt-freeze">
                    <span class="dt-freeze__message">
                        ${this.options.freezeMessage}
                    </span>
                </div>
                <div class="dt-toast"></div>
                <div class="dt-dropdown-container"></div>
                <textarea class="dt-paste-target"></textarea>
            </div>
        `,this.datatableWrapper=u(".datatable",this.wrapper),this.header=u(".dt-header",this.wrapper),this.footer=u(".dt-footer",this.wrapper),this.bodyScrollable=u(".dt-scrollable",this.wrapper),this.freezeContainer=u(".dt-freeze",this.wrapper),this.toastMessage=u(".dt-toast",this.wrapper),this.pasteTarget=u(".dt-paste-target",this.wrapper),this.dropdownContainer=u(".dt-dropdown-container",this.wrapper)}refresh(e,t){this.datamanager.init(e,t),this.render(),this.setDimensions()}destroy(){this.wrapper.innerHTML="",this.style.destroy(),this.fireEvent("onDestroy")}appendRows(e){this.datamanager.appendRows(e),this.rowmanager.refreshRows()}refreshRow(e,t){this.rowmanager.refreshRow(e,t)}render(){this.renderHeader(),this.renderBody()}renderHeader(){this.columnmanager.renderHeader()}renderBody(){this.bodyRenderer.render()}setDimensions(){this.style.setDimensions()}showToastMessage(e,t){this.bodyRenderer.showToastMessage(e,t)}clearToastMessage(){this.bodyRenderer.clearToastMessage()}getColumn(e){return this.datamanager.getColumn(e)}getColumns(){return this.datamanager.getColumns()}getRows(){return this.datamanager.getRows()}getCell(e,t){return this.datamanager.getCell(e,t)}getColumnHeaderElement(e){return this.columnmanager.getColumnHeaderElement(e)}getViewportHeight(){return this.viewportHeight||(this.viewportHeight=u.style(this.bodyScrollable,"height")),this.viewportHeight}sortColumn(e,t){this.columnmanager.sortColumn(e,t)}removeColumn(e){this.columnmanager.removeColumn(e)}scrollToLastColumn(){this.datatableWrapper.scrollLeft=9999}freeze(){u.style(this.freezeContainer,{display:""})}unfreeze(){u.style(this.freezeContainer,{display:"none"})}updateOptions(e){this.buildOptions(e)}fireEvent(e,...t){let r=[...this._internalEventHandlers[e]||[],this.events[e]].filter(Boolean);for(let i of r)i.apply(this,t)}on(e,t){this._internalEventHandlers=this._internalEventHandlers||{},this._internalEventHandlers[e]=this._internalEventHandlers[e]||[],this._internalEventHandlers[e].push(t)}log(){this.options.logs&&console.log.apply(console,arguments)}translate(e,t){return this.translationManager.translate(e,t)}};ye.instances=0;var zo="frappe-datatable",Bo="0.0.0-development",Vo="A modern datatable library for the web",Yo="dist/frappe-datatable.cjs.js",Xo="dist/frappe-datatable.min.js",Go="dist/frappe-datatable.min.js",Qo={start:"yarn run dev",build:"rollup -c && NODE_ENV=production rollup -c",dev:"rollup -c -w","cy:server":"http-server -p 8989","cy:open":"cypress open","cy:run":"cypress run",test:"start-server-and-test cy:server http://localhost:8989 cy:run","test-local":"start-server-and-test cy:server http://localhost:8989 cy:open","travis-deploy-once":"travis-deploy-once","semantic-release":"semantic-release",lint:"eslint src","lint-and-build":"yarn lint && yarn build",commit:"npx git-cz"},Uo=["dist","src"],Jo={autoprefixer:"^9.0.0",chai:"3.5.0",cypress:"^9.2.0","cz-conventional-changelog":"^2.1.0",deepmerge:"^2.0.1",eslint:"^5.0.1","eslint-config-airbnb":"^16.1.0","eslint-config-airbnb-base":"^12.1.0","eslint-plugin-import":"^2.11.0","http-server":"^0.11.1",mocha:"3.3.0","postcss-custom-properties":"^7.0.0","postcss-nested":"^3.0.0",rollup:"^0.59.4","rollup-plugin-commonjs":"^8.3.0","rollup-plugin-eslint":"^4.0.0","rollup-plugin-json":"^2.3.0","rollup-plugin-node-resolve":"^3.0.3","rollup-plugin-postcss":"^1.2.8","rollup-plugin-uglify-es":"^0.0.1","semantic-release":"^17.1.1","start-server-and-test":"^1.4.1","travis-deploy-once":"^5.0.1"},Ko={type:"git",url:"https://github.com/frappe/datatable.git"},Zo=["datatable","data","grid","table"],es="Faris Ansari",ts="MIT",rs={url:"https://github.com/frappe/datatable/issues"},is="https://frappe.io/datatable",as={hyperlist:"^1.0.0-beta",lodash:"^4.17.5",sortablejs:"^1.7.0"},os={commitizen:{path:"cz-conventional-changelog"}},ss={name:zo,version:Bo,description:Vo,main:Yo,unpkg:Xo,jsdelivr:Go,scripts:Qo,files:Uo,devDependencies:Jo,repository:Ko,keywords:Zo,author:es,license:ts,bugs:rs,homepage:is,dependencies:as,config:os};ye.__version__=ss.version;dr.exports=ye});erpnext.taxes_and_totals=class extends erpnext.payments{setup(){this.fetch_round_off_accounts()}apply_pricing_rule_on_item(e){let t=e.price_list_rate,r=e.rate;in_list(["Sales Order","Quotation"],e.parenttype)&&e.blanket_order_rate&&(t=e.blanket_order_rate),e.margin_type=="Percentage"?e.rate_with_margin=flt(t)+flt(t)*(flt(e.margin_rate_or_amount)/100):e.rate_with_margin=flt(t)+flt(e.margin_rate_or_amount),e.base_rate_with_margin=flt(e.rate_with_margin)*flt(this.frm.doc.conversion_rate),r=flt(e.rate_with_margin,precision("rate",e)),e.discount_percentage&&(e.discount_amount=flt(e.rate_with_margin)*flt(e.discount_percentage)/100),e.discount_amount&&(r=flt(e.rate_with_margin-e.discount_amount,precision("rate",e)),e.discount_percentage=100*flt(e.discount_amount)/flt(e.rate_with_margin)),frappe.model.set_value(e.doctype,e.name,"rate",r)}calculate_taxes_and_totals(e){this.discount_amount_applied=!1,this._calculate_taxes_and_totals(),this.calculate_discount_amount(),in_list(["Sales Invoice","POS Invoice","Purchase Invoice"],this.frm.doc.doctype)&&this.frm.doc.docstatus<2&&!this.frm.doc.is_return&&this.calculate_total_advance(e),in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)&&this.frm.doc.is_pos&&this.frm.doc.is_return&&this.update_paid_amount_for_return(),in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice","Proforma Invoice"],this.frm.doc.doctype)&&(this.calculate_commission(),this.calculate_contribution()),this.frm.doc.doctype==="Purchase Invoice"&&this.frm.doc.is_return&&this.frm.doc.grand_total>this.frm.doc.paid_amount&&(this.frm.doc.paid_amount=flt(this.frm.doc.grand_total,precision("grand_total"))),this.frm.refresh_fields()}calculate_discount_amount(){frappe.meta.get_docfield(this.frm.doc.doctype,"discount_amount")&&(this.calculate_item_values(),this.calculate_net_total(),this.set_discount_amount(),this.apply_discount_amount())}_calculate_taxes_and_totals(){this.validate_conversion_rate(),this.calculate_item_values(),this.initialize_taxes(),this.determine_exclusive_rate(),this.calculate_net_total(),this.calculate_taxes(),this.manipulate_grand_total_for_inclusive_tax(),this.calculate_totals(),this._cleanup()}validate_conversion_rate(){this.frm.doc.conversion_rate=flt(this.frm.doc.conversion_rate,cur_frm?precision("conversion_rate"):9);var e=frappe.meta.get_label(this.frm.doc.doctype,"conversion_rate",this.frm.doc.name),t=this.get_company_currency();if(!this.frm.doc.conversion_rate)if(this.frm.doc.currency==t)this.frm.set_value("conversion_rate",1);else{let r=[e,this.frm.doc.currency,t],i=__("{0} is mandatory. Maybe Currency Exchange record is not created for {1} to {2}",r);frappe.throw(i)}}calculate_item_values(){let e=this;this.discount_amount_applied||$.each(this.frm.doc.items||[],function(t,r){frappe.model.round_floats_in(r),r.net_rate=r.rate,!r.qty&&e.frm.doc.is_return?r.amount=flt(r.rate*-1,precision("amount",r)):r.uom=="Percent"?r.amount=flt(r.rate*r.qty/100,precision("amount",r)):r.amount=flt(r.rate*r.qty,precision("amount",r)),r.net_amount=r.amount,r.item_tax_amount=0,r.total_weight=flt(r.weight_per_unit*r.stock_qty),e.set_in_company_currency(r,["price_list_rate","rate","amount","net_rate","net_amount"])})}set_in_company_currency(e,t){var r=this;$.each(t,function(i,a){e["base_"+a]=flt(flt(e[a],precision(a,e))*r.frm.doc.conversion_rate,precision("base_"+a,e))})}initialize_taxes(){var e=this;$.each(this.frm.doc.taxes||[],function(t,r){r.item_wise_tax_detail={};var i=["total","tax_amount_after_discount_amount","tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];cstr(r.charge_type)!="Actual"&&!(e.discount_amount_applied&&e.frm.doc.apply_discount_on=="Grand Total")&&i.push("tax_amount"),$.each(i,function(a,s){r[s]=0}),!this.discount_amount_applied&&cur_frm&&(cur_frm.cscript.validate_taxes_and_charges(r.doctype,r.name),e.validate_inclusive_tax(r)),frappe.model.round_floats_in(r)})}fetch_round_off_accounts(){let e=this;if(frappe.flags.round_off_applicable_accounts=[],e.frm.doc.company)return frappe.call({method:"erpnext.controllers.taxes_and_totals.get_round_off_applicable_accounts",args:{company:e.frm.doc.company,account_list:frappe.flags.round_off_applicable_accounts},callback:function(t){frappe.flags.round_off_applicable_accounts.push(t.message)}})}determine_exclusive_rate(){var e=this,t=!1;$.each(e.frm.doc.taxes||[],function(r,i){cint(i.included_in_print_rate)&&(t=!0)}),t!=!1&&$.each(e.frm.doc.items||[],function(r,i){var a=e._load_item_tax_rate(i.item_tax_rate),s=0,n=0;if($.each(e.frm.doc.taxes||[],function(f,m){var g=e.get_current_tax_fraction(m,a);m.tax_fraction_for_current_item=g[0];var v=g[1];f==0?m.grand_total_fraction_for_current_item=1+m.tax_fraction_for_current_item:m.grand_total_fraction_for_current_item=e.frm.doc.taxes[f-1].grand_total_fraction_for_current_item+m.tax_fraction_for_current_item,s+=m.tax_fraction_for_current_item,n+=v*flt(i.qty)}),!e.discount_amount_applied&&i.qty&&(n||s)){var _=flt(i.amount)-n;i.net_amount=flt(_/(1+s)),i.net_rate=i.qty?flt(i.net_amount/i.qty,precision("net_rate",i)):0,e.set_in_company_currency(i,["net_rate","net_amount"])}})}get_current_tax_fraction(e,t){var r=0,i=0;if(cint(e.included_in_print_rate)){var a=this._get_tax_rate(e,t);e.charge_type=="On Net Total"?r=a/100:e.charge_type=="On Previous Row Amount"?r=a/100*this.frm.doc.taxes[cint(e.row_id)-1].tax_fraction_for_current_item:e.charge_type=="On Previous Row Total"?r=a/100*this.frm.doc.taxes[cint(e.row_id)-1].grand_total_fraction_for_current_item:e.charge_type=="On Item Quantity"&&(i=flt(a))}return e.add_deduct_tax&&e.add_deduct_tax=="Deduct"&&(r*=-1,i*=-1),[r,i]}_get_tax_rate(e,t){return Object.keys(t).indexOf(e.account_head)!=-1?flt(t[e.account_head],precision("rate",e)):e.rate}calculate_net_total(){var e=this;this.frm.doc.total_qty=this.frm.doc.total=this.frm.doc.base_total=this.frm.doc.net_total=this.frm.doc.base_net_total=0,$.each(this.frm.doc.items||[],function(t,r){e.frm.doc.total+=r.amount,e.frm.doc.total_qty+=r.qty,e.frm.doc.base_total+=r.base_amount,e.frm.doc.net_total+=r.net_amount,e.frm.doc.base_net_total+=r.base_net_amount}),frappe.model.round_floats_in(this.frm.doc,["total","base_total","net_total","base_net_total"])}add_taxes_from_item_tax_template(e){let t=this;e&&cint(frappe.defaults.get_default("add_taxes_from_item_tax_template"))&&(typeof e=="string"&&(e=JSON.parse(e)),$.each(e,function(r,i){if(!(t.frm.doc.taxes||[]).find(s=>s.account_head===r)){let s=frappe.model.add_child(t.frm.doc,"taxes");s.charge_type="On Net Total",s.account_head=r,s.rate=0}}))}calculate_taxes(){var e=this;this.frm.doc.rounding_adjustment=0;var t={};$.each(this.frm.doc.taxes||[],function(r,i){i.charge_type=="Actual"&&(t[i.idx]=flt(i.tax_amount,precision("tax_amount",i)))}),$.each(this.frm.doc.items||[],function(r,i){var a=e._load_item_tax_rate(i.item_tax_rate);$.each(e.frm.doc.taxes||[],function(s,n){var _=e.get_current_tax_amount(i,n,a);n.charge_type=="Actual"&&(t[n.idx]-=_,r==e.frm.doc.items.length-1&&(_+=t[n.idx])),n.charge_type!="Actual"&&!(e.discount_amount_applied&&e.frm.doc.apply_discount_on=="Grand Total")&&(n.tax_amount+=_),n.tax_amount_for_current_item=_,n.tax_amount_after_discount_amount+=_,n.category&&(_=n.category=="Valuation"?0:_,_*=n.add_deduct_tax=="Deduct"?-1:1),s==0?n.grand_total_for_current_item=flt(i.net_amount+_):n.grand_total_for_current_item=flt(e.frm.doc.taxes[s-1].grand_total_for_current_item+_),r==e.frm.doc.items.length-1&&(e.round_off_totals(n),e.set_in_company_currency(n,["tax_amount","tax_amount_after_discount_amount"]),e.round_off_base_values(n),e.set_cumulative_total(s,n),e.set_in_company_currency(n,["total"]),s==e.frm.doc.taxes.length-1&&e.discount_amount_applied&&e.frm.doc.apply_discount_on=="Grand Total"&&e.frm.doc.discount_amount&&(e.frm.doc.rounding_adjustment=flt(e.frm.doc.grand_total-flt(e.frm.doc.discount_amount)-n.total,precision("rounding_adjustment"))))})})}set_cumulative_total(e,t){var r=t.tax_amount_after_discount_amount;t.category=="Valuation"&&(r=0),t.add_deduct_tax=="Deduct"&&(r=-1*r),e==0?t.total=flt(this.frm.doc.net_total+r,precision("total",t)):t.total=flt(this.frm.doc.taxes[e-1].total+r,precision("total",t))}_load_item_tax_rate(e){return e?JSON.parse(e):{}}get_current_tax_amount(e,t,r){var i=this._get_tax_rate(t,r),a=0;if(["On Previous Row Amount","On Previous Row Total"].includes(t.charge_type)&&(t.idx===1&&frappe.throw(__("Cannot select charge type as 'On Previous Row Amount' or 'On Previous Row Total' for first row")),t.row_id||(t.row_id=t.idx-1)),t.charge_type=="Actual"){var s=flt(t.tax_amount,precision("tax_amount",t));a=this.frm.doc.net_total?e.net_amount/this.frm.doc.net_total*s:0}else t.charge_type=="On Net Total"?a=i/100*e.net_amount:t.charge_type=="On Previous Row Amount"?a=i/100*this.frm.doc.taxes[cint(t.row_id)-1].tax_amount_for_current_item:t.charge_type=="On Previous Row Total"?a=i/100*this.frm.doc.taxes[cint(t.row_id)-1].grand_total_for_current_item:t.charge_type=="On Item Quantity"&&(a=i*e.qty);return this.set_item_wise_tax(e,t,i,a),a}set_item_wise_tax(e,t,r,i){let a=t.item_wise_tax_detail,s=e.item_code||e.item_name;typeof a=="string"&&(t.item_wise_tax_detail=JSON.parse(t.item_wise_tax_detail),a=t.item_wise_tax_detail);let n=i*this.frm.doc.conversion_rate;a&&a[s]&&(n+=a[s][1]),a[s]=[r,flt(n,precision("base_tax_amount",t))]}round_off_totals(e){frappe.flags.round_off_applicable_accounts.includes(e.account_head)&&(e.tax_amount=Math.round(e.tax_amount),e.tax_amount_after_discount_amount=Math.round(e.tax_amount_after_discount_amount)),e.tax_amount=flt(e.tax_amount,precision("tax_amount",e)),e.tax_amount_after_discount_amount=flt(e.tax_amount_after_discount_amount,precision("tax_amount",e))}round_off_base_values(e){frappe.flags.round_off_applicable_accounts.includes(e.account_head)&&(e.base_tax_amount=Math.round(e.base_tax_amount),e.base_tax_amount_after_discount_amount=Math.round(e.base_tax_amount_after_discount_amount))}manipulate_grand_total_for_inclusive_tax(){var e=this;if(this.frm.doc.taxes&&this.frm.doc.taxes.length){var t=!1;if($.each(this.frm.doc.taxes||[],function(s,n){cint(n.included_in_print_rate)&&(t=!0)}),t){var r=e.frm.doc.taxes.slice(-1)[0],i=frappe.utils.sum($.map(this.frm.doc.taxes||[],function(s){if(!s.included_in_print_rate)return flt(s.tax_amount_after_discount_amount)})),a=e.frm.doc.total+i-flt(r.total,precision("grand_total"));e.discount_amount_applied&&e.frm.doc.discount_amount&&(a-=flt(e.frm.doc.discount_amount)),a=flt(a,precision("rounding_adjustment")),a&&Math.abs(a)<=5/Math.pow(10,precision("tax_amount",r))&&(e.frm.doc.rounding_adjustment=a)}}}calculate_totals(){var e=this,t=this.frm.doc.taxes?this.frm.doc.taxes.length:0;this.frm.doc.grand_total=flt(t?this.frm.doc.taxes[t-1].total+flt(this.frm.doc.rounding_adjustment):this.frm.doc.net_total),in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice","POS Invoice","Proforma Invoice"],this.frm.doc.doctype)?this.frm.doc.base_grand_total=this.frm.doc.total_taxes_and_charges?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total:(this.frm.doc.taxes_and_charges_added=this.frm.doc.taxes_and_charges_deducted=0,t&&($.each(this.frm.doc.taxes||[],function(r,i){in_list(["Valuation and Total","Total"],i.category)&&(i.add_deduct_tax=="Add"?e.frm.doc.taxes_and_charges_added+=flt(i.tax_amount_after_discount_amount):e.frm.doc.taxes_and_charges_deducted+=flt(i.tax_amount_after_discount_amount))}),frappe.model.round_floats_in(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.base_grand_total=flt(this.frm.doc.taxes_and_charges_added||this.frm.doc.taxes_and_charges_deducted?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total),this.set_in_company_currency(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.total_taxes_and_charges=flt(this.frm.doc.grand_total-this.frm.doc.net_total-flt(this.frm.doc.rounding_adjustment),precision("total_taxes_and_charges")),this.set_in_company_currency(this.frm.doc,["total_taxes_and_charges","rounding_adjustment"]),frappe.model.round_floats_in(this.frm.doc,["grand_total","base_grand_total"]),this.set_rounded_total()}set_rounded_total(){var e=0;if(frappe.meta.get_docfield(this.frm.doc.doctype,"disable_rounded_total",this.frm.doc.name)?e=this.frm.doc.disable_rounded_total:frappe.sys_defaults.disable_rounded_total&&(e=frappe.sys_defaults.disable_rounded_total),cint(e)){this.frm.doc.rounded_total=0,this.frm.doc.base_rounded_total=0;return}frappe.meta.get_docfield(this.frm.doc.doctype,"rounded_total",this.frm.doc.name)&&(this.frm.doc.rounded_total=round_based_on_smallest_currency_fraction(this.frm.doc.grand_total,this.frm.doc.currency,precision("rounded_total")),this.frm.doc.rounding_adjustment+=flt(this.frm.doc.rounded_total-this.frm.doc.grand_total,precision("rounding_adjustment")),this.set_in_company_currency(this.frm.doc,["rounding_adjustment","rounded_total"]))}_cleanup(){if(this.frm.doc.base_in_words=this.frm.doc.in_words="",this.frm.doc.items&&this.frm.doc.items.length&&(frappe.meta.get_docfield(this.frm.doc.items[0].doctype,"item_tax_amount",this.frm.doctype)||$.each(this.frm.doc.items||[],function(t,r){delete r.item_tax_amount})),this.frm.doc.taxes&&this.frm.doc.taxes.length){var e=["tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];frappe.meta.get_docfield(this.frm.doc.taxes[0].doctype,"tax_amount_after_discount_amount",this.frm.doctype)||e.push("tax_amount_after_discount_amount"),$.each(this.frm.doc.taxes||[],function(t,r){$.each(e,function(i,a){delete r[a]}),r.item_wise_tax_detail=JSON.stringify(r.item_wise_tax_detail)})}}set_discount_amount(){this.frm.doc.additional_discount_percentage&&(this.frm.doc.discount_amount=flt(flt(this.frm.doc[frappe.scrub(this.frm.doc.apply_discount_on)])*this.frm.doc.additional_discount_percentage/100,precision("discount_amount")))}apply_discount_amount(){var e=this,t=0;if(this.frm.doc.base_discount_amount=0,this.frm.doc.discount_amount){this.frm.doc.apply_discount_on||frappe.throw(__("Please select Apply Discount On")),this.frm.doc.base_discount_amount=flt(this.frm.doc.discount_amount*this.frm.doc.conversion_rate,precision("base_discount_amount"));var r=this.get_total_for_discount_amount(),i=0;r&&($.each(this.frm.doc.items||[],function(a,s){if(t=flt(e.frm.doc.discount_amount)*s.net_amount/r,s.net_amount=flt(s.net_amount-t,precision("base_amount",s)),i+=s.net_amount,(!(e.frm.doc.taxes||[]).length||r==e.frm.doc.net_total||e.frm.doc.apply_discount_on=="Net Total")&&a==(e.frm.doc.items||[]).length-1){var n=flt(e.frm.doc.net_total-i-e.frm.doc.discount_amount,precision("net_total"));s.net_amount=flt(s.net_amount+n,precision("net_amount",s))}s.net_rate=s.qty?flt(s.net_amount/s.qty,precision("net_rate",s)):0,e.set_in_company_currency(s,["net_rate","net_amount"])}),this.discount_amount_applied=!0,this._calculate_taxes_and_totals())}}get_total_for_discount_amount(){if(this.frm.doc.apply_discount_on=="Net Total")return this.frm.doc.net_total;var e=0,t={};return $.each(this.frm.doc.taxes||[],function(r,i){if(in_list(["Actual","On Item Quantity"],i.charge_type)){var a=i.category=="Valuation"?0:i.tax_amount;a*=i.add_deduct_tax=="Deduct"?-1:1,t[i.idx]=a}else if(t[i.row_id]!==null){var s=flt(t[i.row_id])*flt(i.rate)/100;t[i.idx]=s}}),$.each(t,function(r,i){i&&(e+=i)}),flt(this.frm.doc.grand_total-e,precision("grand_total"))}calculate_total_advance(e){var t=frappe.utils.sum($.map(this.frm.doc.advances||[],function(r){return flt(r.allocated_amount,precision("allocated_amount",r))}));this.frm.doc.total_advance=flt(t,precision("total_advance")),this.calculate_outstanding_amount(e)}is_internal_invoice(){return!!(["Sales Invoice","Purchase Invoice"].includes(this.frm.doc.doctype)&&this.frm.doc.company===this.frm.doc.represents_company)}calculate_outstanding_amount(e){if(in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)&&this.frm.doc.is_return&&this.calculate_paid_amount(),!(this.frm.doc.is_return||this.frm.doc.docstatus>0||this.is_internal_invoice())&&(frappe.model.round_floats_in(this.frm.doc,["grand_total","total_advance","write_off_amount"]),in_list(["Sales Invoice","POS Invoice","Purchase Invoice"],this.frm.doc.doctype))){var t=this.frm.doc.rounded_total||this.frm.doc.grand_total;if(this.frm.doc.party_account_currency==this.frm.doc.currency)var r=flt(t-this.frm.doc.total_advance-this.frm.doc.write_off_amount,precision("grand_total"));else var r=flt(flt(t*this.frm.doc.conversion_rate,precision("grand_total"))-this.frm.doc.total_advance-this.frm.doc.base_write_off_amount,precision("base_grand_total"));if(frappe.model.round_floats_in(this.frm.doc,["paid_amount"]),this.set_in_company_currency(this.frm.doc,["paid_amount"]),this.frm.refresh_field&&(this.frm.refresh_field("paid_amount"),this.frm.refresh_field("base_paid_amount")),in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)){let a=this.frm.doc.redeem_loyalty_points&&this.frm.doc.loyalty_amount?flt(r-this.frm.doc.loyalty_amount,precision("base_grand_total")):r;this.set_default_payment(a,e),this.calculate_paid_amount()}this.calculate_change_amount();var i=this.frm.doc.party_account_currency==this.frm.doc.currency?this.frm.doc.paid_amount:this.frm.doc.base_paid_amount;this.frm.doc.outstanding_amount=flt(r-flt(i)+flt(this.frm.doc.change_amount*this.frm.doc.conversion_rate),precision("outstanding_amount"))}}update_paid_amount_for_return(){var e=this.frm.doc.rounded_total||this.frm.doc.grand_total;if(this.frm.doc.party_account_currency==this.frm.doc.currency)var t=flt(e-this.frm.doc.total_advance-this.frm.doc.write_off_amount,precision("grand_total"));else var t=flt(flt(e*this.frm.doc.conversion_rate,precision("grand_total"))-this.frm.doc.total_advance-this.frm.doc.base_write_off_amount,precision("base_grand_total"));this.frm.doc.payments.find(r=>{r.default?r.amount=t:r.amount=0}),this.frm.refresh_fields(),this.calculate_paid_amount()}set_default_payment(e,t){var r=this,i=!0;this.frm.doc.is_pos&&(t===void 0||t)&&$.each(this.frm.doc.payments||[],function(a,s){if(s.default&&i&&e>0){let n=flt(e,precision("base_amount",s));frappe.model.set_value(s.doctype,s.name,"base_amount",n);let _=flt(e/r.frm.doc.conversion_rate,precision("amount",s));frappe.model.set_value(s.doctype,s.name,"amount",_),i=!1}else r.frm.doc.paid_amount&&frappe.model.set_value(s.doctype,s.name,"amount",0)})}calculate_paid_amount(){var e=this,t=0,r=0;this.frm.doc.is_pos?$.each(this.frm.doc.payments||[],function(i,a){a.base_amount=flt(a.amount*e.frm.doc.conversion_rate,precision("base_amount",a)),t+=a.amount,r+=a.base_amount}):this.frm.doc.is_return||(this.frm.doc.payments=[]),this.frm.doc.redeem_loyalty_points&&this.frm.doc.loyalty_amount&&(r+=this.frm.doc.loyalty_amount,t+=flt(this.frm.doc.loyalty_amount/e.frm.doc.conversion_rate,precision("paid_amount"))),this.frm.set_value("paid_amount",flt(t,precision("paid_amount"))),this.frm.set_value("base_paid_amount",flt(r,precision("base_paid_amount")))}calculate_change_amount(){if(this.frm.doc.change_amount=0,this.frm.doc.base_change_amount=0,in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)&&this.frm.doc.paid_amount>this.frm.doc.grand_total&&!this.frm.doc.is_return){var e=$.map(this.frm.doc.payments,function(i){return i.type});if(in_list(e,"Cash")){var t=this.frm.doc.rounded_total||this.frm.doc.grand_total,r=this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total;this.frm.doc.change_amount=flt(this.frm.doc.paid_amount-t+this.frm.doc.write_off_amount,precision("change_amount")),this.frm.doc.base_change_amount=flt(this.frm.doc.base_paid_amount-r+this.frm.doc.base_write_off_amount,precision("base_change_amount"))}}}calculate_write_off_amount(){this.frm.doc.paid_amount>this.frm.doc.grand_total?(this.frm.doc.write_off_amount=flt(this.frm.doc.grand_total-this.frm.doc.paid_amount+this.frm.doc.change_amount,precision("write_off_amount")),this.frm.doc.base_write_off_amount=flt(this.frm.doc.write_off_amount*this.frm.doc.conversion_rate,precision("base_write_off_amount"))):this.frm.doc.paid_amount=0,this.calculate_outstanding_amount(!1)}};frappe.provide("erpnext.accounts.dimensions");erpnext.TransactionController=class extends erpnext.taxes_and_totals{setup(){super.setup();let e=this;frappe.flags.hide_serial_batch_dialog=!0,frappe.ui.form.on(this.frm.doctype+" Item","rate",function(r,i,a){var s=frappe.get_doc(i,a),n=frappe.meta.has_field(i,"margin_type");frappe.model.round_floats_in(s,["rate","price_list_rate"]),s.price_list_rate?s.rate>s.price_list_rate&&n?(s.discount_percentage=0,s.margin_type="Amount",s.margin_rate_or_amount=flt(s.rate-s.price_list_rate,precision("margin_rate_or_amount",s)),s.rate_with_margin=s.rate):(s.discount_percentage=flt((1-s.rate/s.price_list_rate)*100,precision("discount_percentage",s)),s.discount_amount=flt(s.price_list_rate)-flt(s.rate),s.margin_type="",s.margin_rate_or_amount=0,s.rate_with_margin=0):(s.discount_percentage=0,s.margin_type="",s.margin_rate_or_amount=0,s.rate_with_margin=0),s.base_rate_with_margin=s.rate_with_margin*flt(r.doc.conversion_rate),cur_frm.cscript.set_gross_profit(s),cur_frm.cscript.calculate_taxes_and_totals(),cur_frm.cscript.calculate_stock_uom_rate(r,i,a)}),frappe.ui.form.on(this.frm.cscript.tax_table,"rate",function(r,i,a){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"tax_amount",function(r,i,a){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"row_id",function(r,i,a){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"included_in_print_rate",function(r,i,a){cur_frm.cscript.set_dynamic_labels(),cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype,"apply_discount_on",function(r){r.doc.additional_discount_percentage?r.trigger("additional_discount_percentage"):cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype,"additional_discount_percentage",function(r){if(!r.doc.apply_discount_on){frappe.msgprint(__("Please set 'Apply Additional Discount On'"));return}r.via_discount_percentage=!0,r.doc.additional_discount_percentage&&r.doc.discount_amount&&(r.doc.discount_amount=0,r.cscript.calculate_taxes_and_totals());var i=flt(r.doc[frappe.model.scrub(r.doc.apply_discount_on)]),a=flt(i*flt(r.doc.additional_discount_percentage)/100,precision("discount_amount"));r.set_value("discount_amount",a).then(()=>delete r.via_discount_percentage)}),frappe.ui.form.on(this.frm.doctype,"discount_amount",function(r){r.cscript.set_dynamic_labels(),r.via_discount_percentage||(r.doc.additional_discount_percentage=0),r.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype+" Item",{items_add:function(r,i,a){var s=frappe.get_doc(i,a);!s.warehouse&&r.doc.set_warehouse&&(s.warehouse=r.doc.set_warehouse),!s.target_warehouse&&r.doc.set_target_warehouse&&(s.target_warehouse=r.doc.set_target_warehouse),!s.from_warehouse&&r.doc.set_from_warehouse&&(s.from_warehouse=r.doc.set_from_warehouse),erpnext.accounts.dimensions.copy_dimension_from_first_row(r,i,a,"items")}}),this.frm.fields_dict.items.grid.get_field("batch_no")&&this.frm.set_query("batch_no","items",function(r,i,a){return e.set_query_for_batch(r,i,a)}),this.frm.docstatus<2&&this.frm.fields_dict.payment_terms_template&&this.frm.fields_dict.payment_schedule&&this.frm.doc.payment_terms_template&&!this.frm.doc.payment_schedule.length&&this.frm.trigger("payment_terms_template"),this.frm.fields_dict.taxes&&(this.taxes_remove=this.calculate_taxes_and_totals),this.frm.fields_dict.items&&(this.items_remove=this.calculate_net_weight),this.frm.fields_dict.recurring_print_format&&this.frm.set_query("recurring_print_format",function(r){return{filters:[["Print Format","doc_type","=",cur_frm.doctype]]}}),this.frm.fields_dict.return_against&&this.frm.set_query("return_against",function(r){var i={docstatus:1,is_return:0,company:r.company};return e.frm.fields_dict.customer&&r.customer&&(i.customer=r.customer),e.frm.fields_dict.supplier&&r.supplier&&(i.supplier=r.supplier),{filters:i}}),this.frm.fields_dict.items.grid.get_field("expense_account")&&this.frm.set_query("expense_account","items",function(r){return{filters:{company:r.company}}}),frappe.meta.get_docfield(this.frm.doc.doctype,"pricing_rules")&&this.frm.set_indicator_formatter("pricing_rule",function(r){return r.rule_applied?"green":"red"});let t=this.frm.get_docfield("items","batch_no");t&&(t.get_route_options_for_new_doc=function(r){return{item:r.doc.item_code}}),this.frm.fields_dict.items.grid.get_field("blanket_order")&&this.frm.set_query("blanket_order","items",function(r,i,a){var s=locals[i][a];return{query:"erpnext.controllers.queries.get_blanket_orders",filters:{company:r.company,blanket_order_type:r.doctype==="Sales Order"?"Selling":"Purchasing",item:s.item_code}}}),this.frm.fields_dict.taxes_and_charges&&this.frm.set_query("taxes_and_charges",function(){return{filters:[["company","=",e.frm.doc.company],["docstatus","!=",2]]}})}onload(){var e=this;if(this.frm.doc.__islocal){var t=frappe.defaults.get_user_default("currency");let r=(i,a)=>{if(e.frm.fields_dict[i]&&!e.frm.doc[i])return e.frm.set_value(i,a)};return this.frm.trigger("set_default_internal_warehouse"),frappe.run_serially([()=>r("currency",t),()=>r("price_list_currency",t),()=>r("status","Draft"),()=>r("is_subcontracted",0),()=>{this.frm.doc.company&&!this.frm.doc.amended_from&&this.frm.trigger("company")}])}}is_return(){!this.frm.doc.is_return&&this.frm.doc.return_against&&this.frm.set_value("return_against","")}setup_quality_inspection(){if(!in_list(["Delivery Note","Sales Invoice","Purchase Receipt","Purchase Invoice"],this.frm.doc.doctype))return;let e=this;!this.frm.is_new()&&this.frm.doc.docstatus===0&&(this.frm.add_custom_button(__("Quality Inspection(s)"),()=>{e.make_quality_inspection()},__("Create")),this.frm.page.set_inner_btn_group_as_primary(__("Create")));let t=in_list(["Purchase Receipt","Purchase Invoice"],this.frm.doc.doctype)?"Incoming":"Outgoing",r=this.frm.get_docfield("items","quality_inspection");r.get_route_options_for_new_doc=function(i){if(!e.frm.is_new())return{inspection_type:t,reference_type:e.frm.doc.doctype,reference_name:e.frm.doc.name,item_code:i.doc.item_code,description:i.doc.description,item_serial_no:i.doc.serial_no?i.doc.serial_no.split(`
`)[0]:null,batch_no:i.doc.batch_no}},this.frm.set_query("quality_inspection","items",function(i,a,s){let n=locals[a][s];return{filters:{docstatus:1,inspection_type:t,reference_name:i.name,item_code:n.item_code}}})}make_payment_request(){var e=this;let t=in_list(["Sales Order","Sales Invoice"],this.frm.doc.doctype)?"Inward":"Outward";frappe.call({method:"erpnext.accounts.doctype.payment_request.payment_request.make_payment_request",args:{dt:e.frm.doc.doctype,dn:e.frm.doc.name,recipient_id:e.frm.doc.contact_email,payment_request_type:t,party_type:t=="Outward"?"Supplier":"Customer",party:t=="Outward"?e.frm.doc.supplier:e.frm.doc.customer},callback:function(r){if(!r.exc){var i=frappe.model.sync(r.message);frappe.set_route("Form",r.message.doctype,r.message.name)}}})}onload_post_render(){this.frm.doc.__islocal&&!(this.frm.doc.taxes||[]).length&&!(this.frm.doc.__onload&&this.frm.doc.__onload.load_after_mapping)?frappe.after_ajax(()=>this.apply_default_taxes()):this.frm.doc.__islocal&&this.frm.doc.company&&this.frm.doc.items&&!this.frm.doc.is_pos&&frappe.after_ajax(()=>this.calculate_taxes_and_totals()),frappe.meta.get_docfield(this.frm.doc.doctype+" Item","item_code")&&(this.setup_item_selector(),this.frm.get_field("items").grid.set_multiple_add("item_code","qty"))}refresh(){erpnext.toggle_naming_series(),erpnext.hide_company(),this.set_dynamic_labels(),this.setup_sms(),this.setup_quality_inspection();let e=this.frm.get_field("scan_barcode");if(e&&e.get_value()&&(e.set_value(""),e.set_new_description(""),frappe.is_mobile())){if(e.$input_wrapper.find(".input-group").length)return;let t=$('<div class="input-group">');e.$input_wrapper.find(".control-input").append(t),t.append(e.$input),$(`<span class="input-group-btn" style="vertical-align: top">
						<button class="btn btn-default border" type="button">
							<i class="fa fa-camera text-muted"></i>
						</button>
					</span>`).on("click",".btn",()=>{frappe.barcode.scan_barcode().then(r=>{e.set_value(r)})}).appendTo(t)}}scan_barcode(){let e=this.frm.fields_dict.scan_barcode,t=function(r,i=null){i?frappe.show_alert({message:__("Row #{0}: Qty increased by 1",[r]),indicator:"green"}):frappe.show_alert({message:__("Row #{0}: Item added",[r]),indicator:"green"})};return this.frm.doc.scan_barcode&&frappe.call({method:"erpnext.selling.page.point_of_sale.point_of_sale.search_for_serial_or_batch_or_barcode_number",args:{search_value:this.frm.doc.scan_barcode}}).then(r=>{let i=r&&r.message;if(!i||Object.keys(i).length===0){frappe.show_alert({message:__("Cannot find Item with this Barcode"),indicator:"red"});return}let a=this.frm.fields_dict.items.grid,s=null,n=this.frm.doc.items.find(f=>f.item_code===i.item_code),_=this.frm.doc.items.find(f=>!f.item_code);n?s=n:_&&(s=_),s||(s=frappe.model.add_child(this.frm.doc,a.doctype,"items")),t(s.idx,s.item_code),this.frm.from_barcode=this.frm.from_barcode?this.frm.from_barcode+1:1,frappe.model.set_value(s.doctype,s.name,{item_code:i.item_code,qty:(s.qty||0)+1}),["serial_no","batch_no","barcode"].forEach(f=>{if(i[f]&&frappe.meta.has_field(s.doctype,f)){let m=s[f]&&f==="serial_no"?s[f]+`
`+i[f]:i[f];frappe.model.set_value(s.doctype,s.name,f,m)}}),e.set_value(""),refresh_field("items")}),!1}apply_default_taxes(){var e=this,t=frappe.meta.get_docfield(e.frm.doc.doctype,"taxes_and_charges",e.frm.doc.name);if(!(!this.frm.doc.taxes_and_charges&&this.frm.doc.taxes&&this.frm.doc.taxes.length>0)&&t)return frappe.call({method:"erpnext.controllers.accounts_controller.get_default_taxes_and_charges",args:{master_doctype:t.options,tax_template:e.frm.doc.taxes_and_charges||"",company:e.frm.doc.company},debounce:2e3,callback:function(r){!r.exc&&r.message&&frappe.run_serially([()=>{r.message.taxes_and_charges&&(e.frm.doc.taxes_and_charges=r.message.taxes_and_charges),r.message.taxes&&e.frm.set_value("taxes",r.message.taxes)},()=>e.set_dynamic_labels(),()=>e.calculate_taxes_and_totals()])}})}setup_sms(){var e=this;let t=["Purchase Invoice","BOM"];this.frm.doc.docstatus===1&&!in_list(["Lost","Stopped","Closed"],this.frm.doc.status)&&!t.includes(this.frm.doctype)&&this.frm.page.add_menu_item(__("Send SMS"),function(){e.send_sms()})}send_sms(){var e=new erpnext.SMSManager(this.frm.doc)}barcode(e,t,r){var i=locals[t][r];(i.barcode==""||i.barcode==null)&&(i.item_code=""),this.frm.from_barcode=this.frm.from_barcode?this.frm.from_barcode+1:1,this.item_code(e,t,r)}item_code(e,t,r){var i=this,a=frappe.get_doc(t,r),s=0,n=0;if(["Sales Invoice"].includes(this.frm.doc.doctype)?(s=cint(i.frm.doc.update_stock),n=s):(this.frm.doc.doctype==="Purchase Receipt"&&i.frm.doc.is_return||this.frm.doc.doctype==="Delivery Note")&&(n=1),this.frm.from_barcode==0&&(a.barcode=null),this.frm.from_barcode=this.frm.from_barcode-1>=0?this.frm.from_barcode-1:0,a.item_code||a.barcode||a.serial_no)if(!this.validate_company_and_party())this.frm.fields_dict.items.grid.grid_rows[a.idx-1].remove();else return this.frm.call({method:"erpnext.stock.get_item_details.get_item_details",child:a,args:{doc:i.frm.doc,args:{item_code:a.item_code,barcode:a.barcode,serial_no:a.serial_no,batch_no:a.batch_no,set_warehouse:i.frm.doc.set_warehouse,warehouse:a.warehouse,customer:i.frm.doc.customer||i.frm.doc.party_name,quotation_to:i.frm.doc.quotation_to,supplier:i.frm.doc.supplier,currency:i.frm.doc.currency,update_stock:s,conversion_rate:i.frm.doc.conversion_rate,price_list:i.frm.doc.selling_price_list||i.frm.doc.buying_price_list,price_list_currency:i.frm.doc.price_list_currency,plc_conversion_rate:i.frm.doc.plc_conversion_rate,company:i.frm.doc.company,order_type:i.frm.doc.order_type,is_pos:cint(i.frm.doc.is_pos),is_return:cint(i.frm.doc.is_return),is_subcontracted:i.frm.doc.is_subcontracted,transaction_date:i.frm.doc.transaction_date||i.frm.doc.posting_date,ignore_pricing_rule:i.frm.doc.ignore_pricing_rule,doctype:i.frm.doc.doctype,name:i.frm.doc.name,project:a.project||i.frm.doc.project,qty:a.qty||1,net_rate:a.rate,stock_qty:a.stock_qty,conversion_factor:a.conversion_factor,weight_per_unit:a.weight_per_unit,weight_uom:a.weight_uom,manufacturer:a.manufacturer,stock_uom:a.stock_uom,pos_profile:cint(i.frm.doc.is_pos)?i.frm.doc.pos_profile:"",cost_center:a.cost_center,tax_category:i.frm.doc.tax_category,item_tax_template:a.item_tax_template,child_docname:a.name}},callback:function(_){_.exc||frappe.run_serially([()=>{var f=locals[t][r];i.add_taxes_from_item_tax_template(f.item_tax_rate),f.free_item_data&&i.apply_product_discount(f)},()=>{i.frm.doc.is_internal_customer||i.frm.doc.is_internal_supplier?i.get_incoming_rate(a,i.frm.posting_date,i.frm.posting_time,i.frm.doc.doctype,i.frm.doc.company):i.frm.script_manager.trigger("price_list_rate",t,r)},()=>{(i.frm.doc.is_internal_customer||i.frm.doc.is_internal_supplier)&&i.calculate_taxes_and_totals()},()=>i.toggle_conversion_factor(a),()=>{if(n)return frappe.db.get_value("Item",a.item_code,["has_batch_no","has_serial_no"]).then(f=>{f.message&&(f.message.has_batch_no||f.message.has_serial_no)&&(frappe.flags.hide_serial_batch_dialog=!1)})},()=>{if(n&&!frappe.flags.hide_serial_batch_dialog)return frappe.db.get_single_value("Stock Settings","disable_serial_no_and_batch_selector").then(f=>{f&&(frappe.flags.hide_serial_batch_dialog=!0)})},()=>{if(n&&!frappe.flags.hide_serial_batch_dialog){var f=locals[t][r];$.each(_.message,function(m,g){f[m]||(f[m]=g)}),f.has_batch_no&&f.has_serial_no&&(f.batch_no=void 0),erpnext.show_serial_batch_selector(i.frm,f,m=>{i.frm.script_manager.trigger("qty",m.doctype,m.name),i.frm.doc.set_warehouse||i.frm.script_manager.trigger("warehouse",m.doctype,m.name)},void 0,!frappe.flags.hide_serial_batch_dialog)}},()=>i.conversion_factor(e,t,r,!0),()=>i.remove_pricing_rule(a),()=>{if(a.apply_rule_on_other_items){let f=a.name;i.apply_rule_on_other_items({key:a})}},()=>{var f=i.get_company_currency();i.update_item_grid_labels(f)}])}})}price_list_rate(e,t,r){var i=frappe.get_doc(t,r);frappe.model.round_floats_in(i,["price_list_rate","discount_percentage"]),in_list(["Quotation Item","Sales Order Item","Delivery Note Item","Sales Invoice Item","POS Invoice Item","Purchase Invoice Item","Purchase Order Item","Purchase Receipt Item","Proforma Invoice Item"]),t?this.apply_pricing_rule_on_item(i):i.rate=flt(i.price_list_rate*(1-i.discount_percentage/100),precision("rate",i)),this.calculate_taxes_and_totals()}margin_rate_or_amount(e,t,r){let i=frappe.get_doc(t,r);this.apply_pricing_rule_on_item(i),this.calculate_taxes_and_totals(),cur_frm.refresh_fields()}margin_type(e,t,r){let i=frappe.get_doc(t,r);i.margin_type?(this.apply_pricing_rule_on_item(i,e,t,r),this.calculate_taxes_and_totals(),cur_frm.refresh_fields()):frappe.model.set_value(t,r,"margin_rate_or_amount",0)}get_incoming_rate(e,t,r,i,a){let s={item_code:e.item_code,warehouse:in_list("Purchase Receipt","Purchase Invoice")?e.from_warehouse:e.warehouse,posting_date:t,posting_time:r,qty:e.qty*e.conversion_factor,serial_no:e.serial_no,voucher_type:i,company:a,allow_zero_valuation_rate:e.allow_zero_valuation_rate};frappe.call({method:"erpnext.stock.utils.get_incoming_rate",args:{args:s},callback:function(n){frappe.model.set_value(e.doctype,e.name,"rate",n.message*e.conversion_factor)}})}serial_no(e,t,r){var i=this,a=frappe.get_doc(t,r);a&&a.doctype==="Purchase Receipt Item Supplied"||a&&a.serial_no&&(a.item_code?(a.serial_no=a.serial_no.replace(/,/g,`
`),a.conversion_factor=a.conversion_factor||1,refresh_field("serial_no",a.name,a.parentfield),!e.is_return&&cint(frappe.user_defaults.set_qty_in_transactions_based_on_serial_no_input)&&setTimeout(()=>{i.update_qty(t,r)},1e4)):this.frm.trigger("item_code",t,r))}update_qty(e,t){var r=[],i=[],a=frappe.get_doc(e,t);i=a.serial_no.split(`
`);for(var s=0;s<i.length;s++)i[s]!=""&&r.push(i[s]);frappe.model.set_value(a.doctype,a.name,"qty",r.length/a.conversion_factor),frappe.model.set_value(a.doctype,a.name,"stock_qty",r.length)}validate(){this.calculate_taxes_and_totals(!1)}update_stock(){this.frm.trigger("set_default_internal_warehouse")}set_default_internal_warehouse(){let e=this;(this.frm.doc.doctype==="Sales Invoice"&&e.frm.doc.update_stock||this.frm.doc.doctype=="Delivery Note")&&this.frm.doc.is_internal_customer&&this.frm.doc.company===this.frm.doc.represents_company&&frappe.db.get_value("Company",this.frm.doc.company,"default_in_transit_warehouse",function(t){e.frm.set_value("set_target_warehouse",t.default_in_transit_warehouse)}),(this.frm.doc.doctype==="Purchase Invoice"&&e.frm.doc.update_stock||this.frm.doc.doctype=="Purchase Receipt")&&this.frm.doc.is_internal_supplier&&this.frm.doc.company===this.frm.doc.represents_company&&frappe.db.get_value("Company",this.frm.doc.company,"default_in_transit_warehouse",function(t){e.frm.set_value("set_from_warehouse",t.default_in_transit_warehouse)})}company(){var e=this,t=function(){if(e.frm.doc.company&&e.frm.fields_dict.currency){var i=e.get_company_currency(),a=frappe.get_doc(":Company",e.frm.doc.company);e.frm.doc.currency||e.frm.set_value("currency",i),e.frm.doc.currency==i&&e.frm.set_value("conversion_rate",1),e.frm.doc.price_list_currency==i&&e.frm.set_value("plc_conversion_rate",1),a.default_letter_head&&e.frm.fields_dict.letter_head&&e.frm.set_value("letter_head",a.default_letter_head);let s=["Sales Invoice","Quotation","Sales Order","Delivery Note","Proforma Invoice"];a.default_selling_terms&&frappe.meta.has_field(e.frm.doc.doctype,"tc_name")&&s.indexOf(e.frm.doc.doctype)!=-1&&e.frm.set_value("tc_name",a.default_selling_terms);let n=["Request for Quotation","Supplier Quotation","Purchase Order","Material Request","Purchase Receipt"];a.default_buying_terms&&frappe.meta.has_field(e.frm.doc.doctype,"tc_name")&&n.indexOf(e.frm.doc.doctype)!=-1&&e.frm.set_value("tc_name",a.default_buying_terms),frappe.run_serially([()=>e.frm.script_manager.trigger("currency"),()=>e.update_item_tax_map(),()=>e.apply_default_taxes(),()=>e.apply_pricing_rule()])}},r=function(i){if(in_list(["Sales Invoice","Purchase Invoice"],e.frm.doc.doctype)){if(e.frm.doc.doctype=="Sales Invoice")var a="Customer",s="debit_to";else var a="Supplier",s="credit_to";var n=e.frm.doc[frappe.model.scrub(a)];if(n&&e.frm.doc.company)return frappe.call({method:"erpnext.accounts.party.get_party_account",args:{company:e.frm.doc.company,party_type:a,party:n},callback:function(_){!_.exc&&_.message&&(e.frm.set_value(s,_.message),i())}});i()}else i()};frappe.meta.get_docfield(this.frm.doctype,"shipping_address")&&in_list(["Purchase Order","Purchase Receipt","Purchase Invoice"],this.frm.doctype)?(erpnext.utils.get_shipping_address(this.frm,function(){r(t)}),frappe.call({method:"frappe.contacts.doctype.address.address.get_default_address",args:{doctype:"Company",name:this.frm.doc.company},callback:function(i){e.frm.set_value("billing_address",i.message)}})):r(t),this.frm.doc.company&&(erpnext.last_selected_company=this.frm.doc.company)}transaction_date(){this.frm.doc.transaction_date&&(this.frm.transaction_date=this.frm.doc.transaction_date,frappe.ui.form.trigger(this.frm.doc.doctype,"currency"))}posting_date(){var e=this;if(this.frm.doc.posting_date){if(this.frm.posting_date=this.frm.doc.posting_date,this.frm.doc.doctype=="Sales Invoice"&&this.frm.doc.customer||this.frm.doc.doctype=="Purchase Invoice"&&this.frm.doc.supplier)return frappe.call({method:"erpnext.accounts.party.get_due_date",args:{posting_date:e.frm.doc.posting_date,party_type:e.frm.doc.doctype=="Sales Invoice"?"Customer":"Supplier",bill_date:e.frm.doc.bill_date,party:e.frm.doc.doctype=="Sales Invoice"?e.frm.doc.customer:e.frm.doc.supplier,company:e.frm.doc.company},callback:function(t,r){t.message&&(e.frm.doc.due_date=t.message,refresh_field("due_date"),frappe.ui.form.trigger(e.frm.doc.doctype,"currency"),e.recalculate_terms())}});frappe.ui.form.trigger(e.frm.doc.doctype,"currency")}}due_date(){if(this.frm.doc.due_date&&!this.frm.updating_party_details&&!this.frm.doc.is_pos&&(this.frm.doc.payment_terms_template||this.frm.doc.payment_schedule&&this.frm.doc.payment_schedule.length)){var e="",t="",r=__("Please clear the")+" ";this.frm.doc.payment_terms_template&&(e=__("selected Payment Terms Template"),r=r+e),(this.frm.doc.payment_schedule||[]).length&&(t=__("Payment Schedule Table"),e.length!==0&&(t=" and "+t),r=r+t),frappe.msgprint(r)}}bill_date(){this.posting_date()}recalculate_terms(){let e=this.frm.doc;if(e.payment_terms_template)this.payment_terms_template();else if(e.payment_schedule){let t=this;e.payment_schedule.forEach(function(r){r.payment_term?t.payment_term(e,r.doctype,r.name):frappe.model.set_value(r.doctype,r.name,"due_date",e.posting_date||e.transaction_date)})}}get_company_currency(){return erpnext.get_currency(this.frm.doc.company)}contact_person(){erpnext.utils.get_contact_details(this.frm)}currency(){var e=this.frm.doc.transaction_date||this.frm.doc.posting_date,t=this;this.set_dynamic_labels();var r=this.get_company_currency();this.frm.doc.currency&&this.frm.doc.currency!==r&&!this.frm.doc.ignore_pricing_rule?this.get_exchange_rate(e,this.frm.doc.currency,r,function(i){i!=t.frm.doc.conversion_rate&&(t.set_margin_amount_based_on_currency(i),t.set_actual_charges_based_on_currency(i),t.frm.set_value("conversion_rate",i))}):this.conversion_rate()}conversion_rate(){let e=this.frm;this.frm.doc.currency===this.get_company_currency()&&this.frm.set_value("conversion_rate",1),this.frm.doc.currency===this.frm.doc.price_list_currency&&this.frm.doc.plc_conversion_rate!==this.frm.doc.conversion_rate&&this.frm.set_value("plc_conversion_rate",this.frm.doc.conversion_rate),flt(this.frm.doc.conversion_rate)>0&&(this.frm.doc.ignore_pricing_rule?this.calculate_taxes_and_totals():this.in_apply_price_list||this.apply_price_list()),this.frm.set_df_property("conversion_rate","read_only",erpnext.stale_rate_allowed()?0:1)}shipping_rule(){var e=this;if(this.frm.doc.shipping_rule)return this.frm.call({doc:this.frm.doc,method:"apply_shipping_rule",callback:function(t){t.exc||e.calculate_taxes_and_totals()}}).fail(()=>this.frm.set_value("shipping_rule",""));e.calculate_taxes_and_totals()}set_margin_amount_based_on_currency(e){if(in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice","Purchase Invoice","Purchase Order","Purchase Receipt","Proforma Invoice"]),this.frm.doc.doctype){var t=this;$.each(this.frm.doc.items||[],function(r,i){i.margin_type=="Amount"&&frappe.model.set_value(i.doctype,i.name,"margin_rate_or_amount",flt(i.margin_rate_or_amount)/flt(e))})}}set_actual_charges_based_on_currency(e){var t=this;$.each(this.frm.doc.taxes||[],function(r,i){i.charge_type=="Actual"&&frappe.model.set_value(i.doctype,i.name,"tax_amount",flt(i.tax_amount)/flt(e))})}get_exchange_rate(e,t,r,i){var a;if(["Quotation","Sales Order","Delivery Note","Sales Invoice","Proforma Invoice"].includes(this.frm.doctype)?a="for_selling":["Purchase Order","Purchase Receipt","Purchase Invoice"].includes(this.frm.doctype)&&(a="for_buying"),!(!e||!t||!r))return frappe.call({method:"erpnext.setup.utils.get_exchange_rate",args:{transaction_date:e,from_currency:t,to_currency:r,args:a},freeze:!0,freeze_message:__("Fetching exchange rates ..."),callback:function(s){i(flt(s.message))}})}price_list_currency(){var e=this;this.set_dynamic_labels();var t=this.get_company_currency();this.frm.doc.price_list_currency!==t&&!this.frm.doc.ignore_pricing_rule?this.get_exchange_rate(this.frm.doc.posting_date,this.frm.doc.price_list_currency,t,function(r){e.frm.set_value("plc_conversion_rate",r)}):this.plc_conversion_rate()}plc_conversion_rate(){this.frm.doc.price_list_currency===this.get_company_currency()?this.frm.set_value("plc_conversion_rate",1):this.frm.doc.price_list_currency===this.frm.doc.currency&&this.frm.doc.plc_conversion_rate&&cint(this.frm.doc.plc_conversion_rate)!=1&&cint(this.frm.doc.plc_conversion_rate)!=cint(this.frm.doc.conversion_rate)&&this.frm.set_value("conversion_rate",this.frm.doc.plc_conversion_rate),this.in_apply_price_list||this.apply_price_list(null,!0)}uom(e,t,r){var i=this,a=frappe.get_doc(t,r);if(a.item_code&&a.uom)return this.frm.call({method:"erpnext.stock.get_item_details.get_conversion_factor",args:{item_code:a.item_code,uom:a.uom},callback:function(s){s.exc||frappe.model.set_value(t,r,"conversion_factor",s.message.conversion_factor)}});i.calculate_stock_uom_rate(e,t,r)}conversion_factor(e,t,r,i){if(frappe.meta.get_docfield(t,"stock_qty",r)){var a=frappe.get_doc(t,r);if(frappe.model.round_floats_in(a,["qty","conversion_factor"]),a.stock_qty=flt(a.qty*a.conversion_factor,precision("stock_qty",a)),refresh_field("stock_qty",a.name,a.parentfield),this.toggle_conversion_factor(a),e.doctype!="Material Request"&&(a.total_weight=flt(a.stock_qty*a.weight_per_unit),refresh_field("total_weight",a.name,a.parentfield),this.calculate_net_weight()),frappe.flags.dont_fetch_price_list_rate)return;!i&&frappe.meta.has_field(e.doctype,"price_list_currency")&&this.apply_price_list(a,!0),this.calculate_stock_uom_rate(e,t,r)}}batch_no(e,t,r){let i=frappe.get_doc(t,r);this.apply_price_list(i,!0)}toggle_conversion_factor(e){this.frm.get_field("items").grid.fields_map.conversion_factor&&this.frm.fields_dict.items.grid.toggle_enable("conversion_factor",e.uom!=e.stock_uom&&!frappe.meta.get_docfield(cur_frm.fields_dict.items.grid.doctype,"conversion_factor").read_only)}qty(e,t,r){let i=frappe.get_doc(t,r);this.conversion_factor(e,t,r,!0),this.calculate_stock_uom_rate(e,t,r),this.apply_pricing_rule(i,!0)}calculate_stock_uom_rate(e,t,r){let i=frappe.get_doc(t,r);i.stock_uom_rate=flt(i.rate)/flt(i.conversion_factor),refresh_field("stock_uom_rate",i.name,i.parentfield)}service_stop_date(e,t,r){var i=locals[t][r];if(i.service_stop_date){let a=Date.parse(i.service_start_date),s=Date.parse(i.service_end_date),n=Date.parse(i.service_stop_date);n<a?(frappe.model.set_value(t,r,"service_stop_date",""),frappe.throw(__("Service Stop Date cannot be before Service Start Date"))):n>s&&(frappe.model.set_value(t,r,"service_stop_date",""),frappe.throw(__("Service Stop Date cannot be after Service End Date")))}}service_start_date(e,t,r){var i=locals[t][r];i.service_start_date&&frappe.call({method:"erpnext.stock.get_item_details.calculate_service_end_date",args:{args:i},callback:function(a){frappe.model.set_value(t,r,"service_end_date",a.message.service_end_date)}})}calculate_net_weight(){var e=this;this.frm.doc.total_net_weight=0,$.each(this.frm.doc.items||[],function(t,r){e.frm.doc.total_net_weight+=flt(r.total_weight)}),refresh_field("total_net_weight"),this.shipping_rule()}set_dynamic_labels(){this.frm.toggle_reqd("plc_conversion_rate",!!(this.frm.doc.price_list_name&&this.frm.doc.price_list_currency));var e=this.get_company_currency();this.change_form_labels(e),this.change_grid_labels(e),this.frm.refresh_fields()}change_form_labels(e){var t=this;this.frm.set_currency_labels(["base_total","base_net_total","base_total_taxes_and_charges","base_discount_amount","base_grand_total","base_rounded_total","base_in_words","base_taxes_and_charges_added","base_taxes_and_charges_deducted","total_amount_to_pay","base_paid_amount","base_write_off_amount","base_change_amount","base_operating_cost","base_raw_material_cost","base_total_cost","base_scrap_material_cost","base_rounding_adjustment"],e),this.frm.set_currency_labels(["total","net_total","total_taxes_and_charges","discount_amount","grand_total","taxes_and_charges_added","taxes_and_charges_deducted","rounded_total","in_words","paid_amount","write_off_amount","operating_cost","scrap_material_cost","rounding_adjustment","raw_material_cost","total_cost"],this.frm.doc.currency),this.frm.set_currency_labels(["outstanding_amount","total_advance"],this.frm.doc.party_account_currency),cur_frm.set_df_property("conversion_rate","description","1 "+this.frm.doc.currency+" = [?] "+e),this.frm.doc.price_list_currency&&this.frm.doc.price_list_currency!=e&&cur_frm.set_df_property("plc_conversion_rate","description","1 "+this.frm.doc.price_list_currency+" = [?] "+e),this.frm.toggle_display(["conversion_rate","base_total","base_net_total","base_total_taxes_and_charges","base_taxes_and_charges_added","base_taxes_and_charges_deducted","base_grand_total","base_rounded_total","base_in_words","base_discount_amount","base_paid_amount","base_write_off_amount","base_operating_cost","base_raw_material_cost","base_total_cost","base_scrap_material_cost","base_rounding_adjustment"],this.frm.doc.currency!=e),this.frm.toggle_display(["plc_conversion_rate","price_list_currency"],this.frm.doc.price_list_currency!=e);var r=cint(cur_frm.doc.discount_amount)||(cur_frm.doc.taxes||[]).filter(function(i){return i.included_in_print_rate===1}).length;frappe.meta.get_docfield(cur_frm.doctype,"net_total")&&cur_frm.toggle_display("net_total",r),frappe.meta.get_docfield(cur_frm.doctype,"base_net_total")&&cur_frm.toggle_display("base_net_total",r&&t.frm.doc.currency!=e)}change_grid_labels(e){var t=this;if(this.update_item_grid_labels(e),this.toggle_item_grid_columns(e),this.frm.doc.operations&&this.frm.doc.operations.length>0){this.frm.set_currency_labels(["operating_cost","hour_rate"],this.frm.doc.currency,"operations"),this.frm.set_currency_labels(["base_operating_cost","base_hour_rate"],e,"operations");var r=this.frm.fields_dict.operations.grid;$.each(["base_operating_cost","base_hour_rate"],function(i,a){frappe.meta.get_docfield(r.doctype,a)&&r.set_column_disp(a,t.frm.doc.currency!=e)})}if(this.frm.doc.scrap_items&&this.frm.doc.scrap_items.length>0){this.frm.set_currency_labels(["rate","amount"],this.frm.doc.currency,"scrap_items"),this.frm.set_currency_labels(["base_rate","base_amount"],e,"scrap_items");var r=this.frm.fields_dict.scrap_items.grid;$.each(["base_rate","base_amount"],function(a,s){frappe.meta.get_docfield(r.doctype,s)&&r.set_column_disp(s,t.frm.doc.currency!=e)})}this.frm.doc.taxes&&this.frm.doc.taxes.length>0&&(this.frm.set_currency_labels(["tax_amount","total","tax_amount_after_discount"],this.frm.doc.currency,"taxes"),this.frm.set_currency_labels(["base_tax_amount","base_total","base_tax_amount_after_discount"],e,"taxes")),this.frm.doc.advances&&this.frm.doc.advances.length>0&&this.frm.set_currency_labels(["advance_amount","allocated_amount"],this.frm.doc.party_account_currency,"advances"),this.update_payment_schedule_grid_labels(e)}update_item_grid_labels(e){this.frm.set_currency_labels(["base_rate","base_net_rate","base_price_list_rate","base_amount","base_net_amount","base_rate_with_margin"],e,"items"),this.frm.set_currency_labels(["rate","net_rate","price_list_rate","amount","net_amount","stock_uom_rate","rate_with_margin"],this.frm.doc.currency,"items")}update_payment_schedule_grid_labels(e){let t=this;if(this.frm.doc.payment_schedule&&this.frm.doc.payment_schedule.length>0){this.frm.set_currency_labels(["base_payment_amount","base_outstanding","base_paid_amount"],e,"payment_schedule"),this.frm.set_currency_labels(["payment_amount","outstanding","paid_amount"],this.frm.doc.currency,"payment_schedule");var r=this.frm.fields_dict.payment_schedule.grid;$.each(["base_payment_amount","base_outstanding","base_paid_amount"],function(i,a){frappe.meta.get_docfield(r.doctype,a)&&r.set_column_disp(a,t.frm.doc.currency!=e)})}}toggle_item_grid_columns(e){let t=this;var r=this.frm.fields_dict.items.grid;$.each(["base_rate","base_price_list_rate","base_amount","base_rate_with_margin"],function(a,s){frappe.meta.get_docfield(r.doctype,s)&&r.set_column_disp(s,t.frm.doc.currency!=e)});var i=cint(cur_frm.doc.discount_amount)||(cur_frm.doc.taxes||[]).filter(function(a){return a.included_in_print_rate===1}).length;$.each(["net_rate","net_amount"],function(a,s){frappe.meta.get_docfield(r.doctype,s)&&r.set_column_disp(s,i)}),$.each(["base_net_rate","base_net_amount"],function(a,s){frappe.meta.get_docfield(r.doctype,s)&&r.set_column_disp(s,i&&t.frm.doc.currency!=e)})}recalculate(){this.calculate_taxes_and_totals()}recalculate_values(){this.calculate_taxes_and_totals()}calculate_charges(){this.calculate_taxes_and_totals()}ignore_pricing_rule(){if(this.frm.doc.ignore_pricing_rule){var e=this,t=[];return $.each(this.frm.doc.items||[],function(r,i){i.item_code&&!i.is_free_item&&t.push({doctype:i.doctype,name:i.name,item_code:i.item_code,pricing_rules:i.pricing_rules,parenttype:i.parenttype,parent:i.parent})}),this.frm.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.remove_pricing_rules",args:{item_list:t},callback:function(r){!r.exc&&r.message&&(r.message.forEach(i=>{e.remove_pricing_rule(i)}),e._set_values_for_item_list(r.message),e.calculate_taxes_and_totals(),e.frm.doc.apply_discount_on&&e.frm.trigger("apply_discount_on"))}})}else this.apply_pricing_rule()}apply_pricing_rule(e,t){var r=this,i=this._get_args(e);if(!(i.items&&i.items.length)){t&&r.calculate_taxes_and_totals();return}return this.frm.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.apply_pricing_rule",args:{args:i,doc:r.frm.doc},callback:function(a){!a.exc&&a.message&&(r._set_values_for_item_list(a.message),e&&r.set_gross_profit(e),r.frm.doc.apply_discount_on&&r.frm.trigger("apply_discount_on"))}})}_get_args(e){var t=this;return{items:this._get_item_list(e),customer:t.frm.doc.customer||t.frm.doc.party_name,quotation_to:t.frm.doc.quotation_to,customer_group:t.frm.doc.customer_group,territory:t.frm.doc.territory,supplier:t.frm.doc.supplier,supplier_group:t.frm.doc.supplier_group,currency:t.frm.doc.currency,conversion_rate:t.frm.doc.conversion_rate,price_list:t.frm.doc.selling_price_list||t.frm.doc.buying_price_list,price_list_currency:t.frm.doc.price_list_currency,plc_conversion_rate:t.frm.doc.plc_conversion_rate,company:t.frm.doc.company,transaction_date:t.frm.doc.transaction_date||t.frm.doc.posting_date,campaign:t.frm.doc.campaign,sales_partner:t.frm.doc.sales_partner,ignore_pricing_rule:t.frm.doc.ignore_pricing_rule,doctype:t.frm.doc.doctype,name:t.frm.doc.name,is_return:cint(t.frm.doc.is_return),update_stock:in_list(["Sales Invoice","Purchase Invoice"],t.frm.doc.doctype)?cint(t.frm.doc.update_stock):0,conversion_factor:t.frm.doc.conversion_factor,pos_profile:t.frm.doc.doctype=="Sales Invoice"?t.frm.doc.pos_profile:"",coupon_code:t.frm.doc.coupon_code}}_get_item_list(e){var t=[],r=function(i){i.item_code&&(t.push({doctype:i.doctype,name:i.name,child_docname:i.name,item_code:i.item_code,item_group:i.item_group,brand:i.brand,qty:i.qty,stock_qty:i.stock_qty,uom:i.uom,stock_uom:i.stock_uom,parenttype:i.parenttype,parent:i.parent,pricing_rules:i.pricing_rules,warehouse:i.warehouse,serial_no:i.serial_no,batch_no:i.batch_no,price_list_rate:i.price_list_rate,conversion_factor:i.conversion_factor||1}),in_list(["Quotation Item","Sales Order Item","Delivery Note Item","Sales Invoice Item","Purchase Invoice Item","Purchase Order Item","Purchase Receipt Item","Proforma Invoice Item"]),i.doctype&&(t[0].margin_type=i.margin_type,t[0].margin_rate_or_amount=i.margin_rate_or_amount))};return e?r(e):$.each(this.frm.doc.items||[],function(i,a){r(a)}),t}_set_values_for_item_list(e){for(var t=this,r=!1,i={},a=0,s=e.length;a<s;a++){var n=e[a],_=frappe.model.get_value(n.doctype,n.name,"pricing_rules");for(var f in n){var m=n[f];["doctype","name"].indexOf(f)===-1&&(f=="price_list_rate"&&flt(m)!=flt(n.price_list_rate)&&(r=!0),f!=="free_item_data"&&frappe.model.set_value(n.doctype,n.name,f,m))}!t.frm.doc.ignore_pricing_rule&&_&&!n.pricing_rules?t.apply_price_list(frappe.get_doc(n.doctype,n.name)):n.pricing_rules||t.remove_pricing_rule(frappe.get_doc(n.doctype,n.name)),n.free_item_data&&t.apply_product_discount(n),n.apply_rule_on_other_items&&(i[n.name]=n)}t.apply_rule_on_other_items(i),r||t.calculate_taxes_and_totals()}apply_rule_on_other_items(e){let t=this,r=["discount_percentage","pricing_rules","discount_amount","rate"];for(var i in e){let a=e[i];a&&a.apply_rule_on_other_items&&t.frm.doc.items.forEach(s=>{if(in_list(a.apply_rule_on_other_items,s[a.apply_rule_on]))for(var n in a)in_list(r,n)&&a[n]&&(a.price_or_product_discount==="price"||n==="pricing_rules")&&frappe.model.set_value(s.doctype,s.name,n,a[n])})}}apply_product_discount(e){let t=this.frm.doc.items.filter(i=>i.is_free_item)||[],r=t.map(i=>(i.item_code,i.pricing_rules));e.free_item_data.forEach(i=>{let a={};!t||!in_list(r,(i.item_code,i.pricing_rules))?a=frappe.model.add_child(this.frm.doc,this.frm.doc.doctype+" Item","items"):t&&(a=t.filter(s=>s.item_code===i.item_code&&s.pricing_rules===i.pricing_rules)[0]);for(let s in i)a[s]=i[s]}),e.free_item_data="",refresh_field("items")}apply_price_list(e,t){t||this.frm.set_value("plc_conversion_rate","");var r=this,i=this._get_args(e);if(!!(i.items&&i.items.length||i.price_list)&&r.in_apply_price_list!=!0)return r.in_apply_price_list=!0,this.frm.call({method:"erpnext.stock.get_item_details.apply_price_list",args:{args:i},callback:function(a){a.exc?r.in_apply_price_list=!1:frappe.run_serially([()=>r.frm.set_value("price_list_currency",a.message.parent.price_list_currency),()=>r.frm.set_value("plc_conversion_rate",a.message.parent.plc_conversion_rate),()=>{i.items.length&&r._set_values_for_item_list(a.message.children)},()=>{r.in_apply_price_list=!1}])}}).always(()=>{r.in_apply_price_list=!1})}remove_pricing_rule(e){let t=this,r=["discount_percentage","discount_amount","margin_rate_or_amount","rate_with_margin"];if(e.remove_free_item){var i=[];t.frm.doc.items.forEach(a=>{(a.item_code!=e.remove_free_item||!a.is_free_item)&&i.push(a)}),t.frm.doc.items=i,refresh_field("items")}else if(e.applied_on_items&&e.apply_on){let a=e.applied_on_items.split(",");t.frm.doc.items.forEach(s=>{a.includes(s[e.apply_on])&&(r.forEach(n=>{s[n]=0}),["pricing_rules","margin_type"].forEach(n=>{s[n]&&(s[n]="")}))}),t.trigger_price_list_rate()}}trigger_price_list_rate(){var e=this;this.frm.doc.items.forEach(t=>{e.frm.script_manager.trigger("price_list_rate",t.doctype,t.name)})}validate_company_and_party(){var e=this,t=!0;return $.each(["company","customer"],function(r,i){frappe.meta.has_field(e.frm.doc.doctype,i)&&e.frm.doc.doctype!="Purchase Order"&&(e.frm.doc[i]||(frappe.msgprint(__("Please specify")+": "+frappe.meta.get_label(e.frm.doc.doctype,i,e.frm.doc.name)+". "+__("It is needed to fetch Item Details.")),t=!1))}),t}get_terms(){var e=this;erpnext.utils.get_terms(this.frm.doc.tc_name,this.frm.doc,function(t){t.exc||e.frm.set_value("terms",t.message)})}taxes_and_charges(){var e=this;if(this.frm.doc.taxes_and_charges)return this.frm.call({method:"erpnext.controllers.accounts_controller.get_taxes_and_charges",args:{master_doctype:frappe.meta.get_docfield(this.frm.doc.doctype,"taxes_and_charges",this.frm.doc.name).options,master_name:this.frm.doc.taxes_and_charges},callback:function(t){if(!t.exc)if(e.frm.doc.shipping_rule&&e.frm.doc.taxes){for(let r of t.message)e.frm.add_child("taxes",r);refresh_field("taxes")}else e.frm.set_value("taxes",t.message),e.calculate_taxes_and_totals()}})}tax_category(){var e=this;e.frm.updating_party_details||frappe.run_serially([()=>this.update_item_tax_map(),()=>erpnext.utils.set_taxes(this.frm,"tax_category")])}update_item_tax_map(){let e=this,t=[],r={},i={};if($.each(this.frm.doc.items||[],function(a,s){s.item_code&&(t.push([s.item_code,s.name]),r[s.name]=s.net_rate,i[s.name]=s.item_tax_template)}),t.length)return this.frm.call({method:"erpnext.stock.get_item_details.get_item_tax_info",args:{company:e.frm.doc.company,tax_category:cstr(e.frm.doc.tax_category),item_codes:t,item_rates:r,item_tax_templates:i},callback:function(a){a.exc||$.each(e.frm.doc.items||[],function(s,n){n.name&&a.message.hasOwnProperty(n.name)&&a.message[n.name].item_tax_template&&(n.item_tax_template=a.message[n.name].item_tax_template,n.item_tax_rate=a.message[n.name].item_tax_rate,e.add_taxes_from_item_tax_template(n.item_tax_rate))})}})}item_tax_template(e,t,r){var i=this;if(!i.frm.updating_party_details){var a=frappe.get_doc(t,r);if(a.item_tax_template)return this.frm.call({method:"erpnext.stock.get_item_details.get_item_tax_map",args:{company:i.frm.doc.company,item_tax_template:a.item_tax_template,as_json:!0},callback:function(s){s.exc||(a.item_tax_rate=s.message,i.calculate_taxes_and_totals())}});a.item_tax_rate="{}",i.calculate_taxes_and_totals()}}is_recurring(){if(this.frm.doc.is_recurring&&this.frm.doc.__islocal){frappe.msgprint(__("Please set recurring after saving")),this.frm.set_value("is_recurring",0);return}if(this.frm.doc.is_recurring){this.frm.doc.recurring_id||this.frm.set_value("recurring_id",this.frm.doc.name);var e=this.frm.doc.owner=="Administrator"?frappe.user_info("Administrator").email:this.frm.doc.owner;this.frm.doc.notification_email_address=$.map([cstr(e),cstr(this.frm.doc.contact_email)],function(t){return t||null}).join(", "),this.frm.doc.repeat_on_day_of_month=frappe.datetime.str_to_obj(this.frm.doc.posting_date).getDate()}refresh_many(["notification_email_address","repeat_on_day_of_month"])}from_date(){if(this.frm.doc.from_date){var e={Monthly:1,Quarterly:3,"Half-yearly":6,Yearly:12},t=e[this.frm.doc.recurring_type];if(t){var r=frappe.datetime.add_months(this.frm.doc.from_date,t);this.frm.doc.to_date=frappe.datetime.add_days(r,-1),refresh_field("to_date")}}}set_gross_profit(e){if(["Sales Order","Quotation","Proforma Invoice"].includes(this.frm.doc.doctype)&&e.valuation_rate){var t=flt(e.rate)*flt(this.frm.doc.conversion_rate||1);e.gross_profit=flt((t-e.valuation_rate)*e.stock_qty,precision("amount",e))}}setup_item_selector(){}get_advances(){if(!this.frm.is_return)return this.frm.call({method:"set_advances",doc:this.frm.doc,callback:function(e,t){refresh_field("advances")}})}make_payment_entry(){return frappe.call({method:cur_frm.cscript.get_method_for_payment(),args:{dt:cur_frm.doc.doctype,dn:cur_frm.doc.name},callback:function(e){var t=frappe.model.sync(e.message);frappe.set_route("Form",t[0].doctype,t[0].name)}})}make_quality_inspection(){let e=[],t=[{label:"Items",fieldtype:"Table",fieldname:"items",cannot_add_rows:!0,in_place_edit:!0,data:e,get_data:()=>e,fields:[{fieldtype:"Data",fieldname:"docname",hidden:!0},{fieldtype:"Read Only",fieldname:"item_code",label:__("Item Code"),in_list_view:!0},{fieldtype:"Read Only",fieldname:"item_name",label:__("Item Name"),in_list_view:!0},{fieldtype:"Float",fieldname:"qty",label:__("Accepted Quantity"),in_list_view:!0,read_only:!0},{fieldtype:"Float",fieldname:"sample_size",label:__("Sample Size"),reqd:!0,in_list_view:!0},{fieldtype:"Data",fieldname:"description",label:__("Description"),hidden:!0},{fieldtype:"Data",fieldname:"serial_no",label:__("Serial No"),hidden:!0},{fieldtype:"Data",fieldname:"batch_no",label:__("Batch No"),hidden:!0}]}],r=this,i=new frappe.ui.Dialog({title:__("Select Items for Quality Inspection"),fields:t,primary_action:function(){let a=i.get_values();frappe.call({method:"erpnext.controllers.stock_controller.make_quality_inspections",args:{doctype:r.frm.doc.doctype,docname:r.frm.doc.name,items:a.items},freeze:!0,callback:function(s){s.message.length>0&&(s.message.length===1?frappe.set_route("Form","Quality Inspection",s.message[0]):(frappe.route_options={reference_type:r.frm.doc.doctype,reference_name:r.frm.doc.name},frappe.set_route("List","Quality Inspection"))),i.hide()}})},primary_action_label:__("Create")});this.frm.doc.items.forEach(a=>{if(!a.quality_inspection){let s=i.fields_dict.items;s.df.data.push({docname:a.name,item_code:a.item_code,item_name:a.item_name,qty:a.qty,description:a.description,serial_no:a.serial_no,batch_no:a.batch_no}),s.grid.refresh()}}),e=i.fields_dict.items.df.data,e.length?i.show():frappe.msgprint(__("All items in this document already have a linked Quality Inspection."))}get_method_for_payment(){var e="erpnext.accounts.doctype.payment_entry.payment_entry.get_payment_entry";return cur_frm.doc.__onload&&cur_frm.doc.__onload.make_payment_via_journal_entry&&(in_list(["Sales Invoice","Purchase Invoice"],cur_frm.doc.doctype)?e="erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_invoice":e="erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_order"),e}set_query_for_batch(e,t,r){var i=this,a=frappe.get_doc(t,r);if(!a.item_code)frappe.throw(__("Please enter Item Code to get batch no"));else{if(e.doctype=="Purchase Receipt"||e.doctype=="Purchase Invoice"&&e.update_stock)return{filters:{item:a.item_code}};{let s={item_code:a.item_code,posting_date:i.frm.doc.posting_date||frappe.datetime.nowdate()};return e.is_return&&(s.is_return=1),a.warehouse&&(s.warehouse=a.warehouse),{query:"erpnext.controllers.queries.get_batch_no",filters:s}}}}set_query_for_item_tax_template(e,t,r){var i=frappe.get_doc(t,r);if(i.item_code){let a={item_code:i.item_code,valid_from:["<=",e.transaction_date||e.bill_date||e.posting_date],item_group:i.item_group};return e.tax_category&&(a.tax_category=e.tax_category),e.company&&(a.company=e.company),{query:"erpnext.controllers.queries.get_tax_template",filters:a}}else return e.company?{filters:{company:e.company}}:{}}payment_terms_template(){var e=this;let t=this.frm.doc;if(t.payment_terms_template&&t.doctype!=="Delivery Note"){var r=t.posting_date||t.transaction_date;frappe.call({method:"erpnext.controllers.accounts_controller.get_payment_terms",args:{terms_template:t.payment_terms_template,posting_date:r,grand_total:t.rounded_total||t.grand_total,base_grand_total:t.base_rounded_total||t.base_grand_total,bill_date:t.bill_date},callback:function(i){if(i.message&&!i.exc){e.frm.set_value("payment_schedule",i.message);let a=e.get_company_currency();e.update_payment_schedule_grid_labels(a)}}})}}payment_term(e,t,r){let i=this;var a=locals[t][r];a.payment_term&&frappe.call({method:"erpnext.controllers.accounts_controller.get_payment_term_details",args:{term:a.payment_term,bill_date:this.frm.doc.bill_date,posting_date:this.frm.doc.posting_date||this.frm.doc.transaction_date,grand_total:this.frm.doc.rounded_total||this.frm.doc.grand_total,base_grand_total:this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total},callback:function(s){if(s.message&&!s.exc)for(var n in s.message){frappe.model.set_value(t,r,n,s.message[n]);let _=i.get_company_currency();i.update_payment_schedule_grid_labels(_)}}})}against_blanket_order(e,t,r){var i=locals[t][r];i.against_blanket_order||(frappe.model.set_value(this.frm.doctype+" Item",i.name,"blanket_order",null),frappe.model.set_value(this.frm.doctype+" Item",i.name,"blanket_order_rate",0))}blanket_order(e,t,r){var i=this,a=locals[t][r];a.blanket_order&&(a.parenttype=="Sales Order"||a.parenttype=="Purchase Order")&&frappe.call({method:"erpnext.stock.get_item_details.get_blanket_order_details",args:{args:{item_code:a.item_code,customer:e.customer,supplier:e.supplier,company:e.company,transaction_date:e.transaction_date,blanket_order:a.blanket_order}},callback:function(s){s.message?frappe.run_serially([()=>frappe.model.set_value(t,r,"blanket_order_rate",s.message.blanket_order_rate),()=>i.frm.script_manager.trigger("price_list_rate",t,r)]):frappe.throw(__("Invalid Blanket Order for the selected Customer and Item"))}})}set_reserve_warehouse(){this.autofill_warehouse(this.frm.doc.supplied_items,"reserve_warehouse",this.frm.doc.set_reserve_warehouse)}set_warehouse(){this.autofill_warehouse(this.frm.doc.items,"warehouse",this.frm.doc.set_warehouse)}set_target_warehouse(){this.autofill_warehouse(this.frm.doc.items,"target_warehouse",this.frm.doc.set_target_warehouse)}set_from_warehouse(){this.autofill_warehouse(this.frm.doc.items,"from_warehouse",this.frm.doc.set_from_warehouse)}autofill_warehouse(e,t,r){if(r&&e&&e.length){let i=e[0].doctype;$.each(e||[],function(a,s){frappe.model.set_value(i,s.name,t,r)})}}coupon_code(){var e=this;frappe.run_serially([()=>this.frm.doc.ignore_pricing_rule=1,()=>e.ignore_pricing_rule(),()=>this.frm.doc.ignore_pricing_rule=0,()=>e.apply_pricing_rule()])}};erpnext.show_serial_batch_selector=function(o,e,t,r,i){let a,s,n;o.doc.is_return?["Purchase Receipt","Purchase Invoice"].includes(o.doc.doctype)?(n=!0,a=e.warehouse):["Delivery Note","Sales Invoice"].includes(o.doc.doctype)&&(s=!0):o.doc.doctype=="Stock Entry"?o.doc.purpose=="Material Receipt"?s=!0:(n=!0,a=e.s_warehouse):(n=!0,a=e.warehouse),a||(s?a=["like",""]:n&&(a=["!=",""])),frappe.require("assets/erpnext/js/utils/serial_no_batch_selector.js",function(){new erpnext.SerialNoBatchSelector({frm:o,item:e,warehouse_details:{type:"Warehouse",name:a},callback:t,on_close:r},i)})};erpnext.apply_putaway_rule=(o,e=null)=>{o.doc.company||frappe.throw({message:__("Please select a Company first."),title:__("Mandatory")}),o.doc.items.length&&frappe.call({method:"erpnext.stock.doctype.putaway_rule.putaway_rule.apply_putaway_rule",args:{doctype:o.doctype,items:o.doc.items,company:o.doc.company,sync:!0,purpose:e},callback:t=>{!t.exc&&t.message&&(o.clear_table("items"),t.message.forEach(i=>{delete i.name;let a=o.add_child("items");Object.assign(a,i),o.script_manager.trigger("qty",a.doctype,a.name)}),o.get_field("items").grid.refresh())}})};var fr=qr(_r());frappe.provide("frappe.widget.utils");frappe.provide("frappe.views");frappe.provide("frappe.query_reports");frappe.standard_pages["query-report"]=function(){var o=frappe.container.add_page("query-report");frappe.ui.make_app_page({parent:o,title:__("Query Report"),single_column:!0}),frappe.query_report=new frappe.views.QueryReport({parent:o}),$(o).bind("show",function(){frappe.query_report.show()})};frappe.views.QueryReport=class extends frappe.views.BaseList{show(){this.init().then(()=>this.load())}init(){if(this.init_promise)return this.init_promise;let e=[this.setup_defaults,this.setup_page,this.setup_report_wrapper,this.setup_events].map(t=>t.bind(this));return this.init_promise=frappe.run_serially(e),this.init_promise}setup_defaults(){this.route=frappe.get_route(),this.page_name=frappe.get_route_str(),this.primary_action=null,this.refresh=frappe.utils.throttle(this.refresh,300),this.menu_items=[]}update_url_with_filters(){frappe.get_route_str()==this.page_name&&window.history.replaceState(null,null,this.get_url_with_filters())}get_url_with_filters(){let e=Object.entries(this.get_filter_values()).map(([r,i],a)=>{if(Array.isArray(i)){if(!i.length)return"";i=JSON.stringify(i)}return`${r}=${encodeURIComponent(i)}`}).filter(Boolean).join("&"),t=window.location.href.replace(window.location.search,"");return e&&(t+="?"+e),t}set_default_secondary_action(){this.refresh_button&&this.refresh_button.remove(),this.refresh_button=this.page.add_action_icon("refresh",()=>{this.setup_progress_bar(),this.refresh()})}get_no_result_message(){return`<div class="msg-box no-border">
			<div>
				<img src="/assets/frappe/images/ui-states/list-empty-state.svg" alt="Generic Empty State" class="null-state">
			</div>
			<p>${__("Nothing to show")}</p>
		</div>`}setup_events(){frappe.realtime.on("report_generated",e=>{if(this.toggle_primary_button_disabled(!1),e.report_name)if(this.prepared_report_action="Rebuild",e.name==this.prepared_report_doc_name)this.refresh();else{let t=`Report ${this.report_name} generated.
						<a href="#query-report/${this.report_name}/?prepared_report_name=${e.name}">View</a>`;frappe.show_alert({message:t,indicator:"orange"})}}),this.page.wrapper.on("click","[data-action]",e=>{let t=$(e.currentTarget).data("action"),r=this[t];r.call&&r.call(this,e)})}load(){if(frappe.get_route().length<2){this.toggle_nothing_to_show(!0);return}let e={};e=Object.assign(e,frappe.route_options),this.report_name!==frappe.get_route()[1]?this.load_report(e):frappe.has_route_options()&&this.refresh_report(e)}load_report(e){this.page.clear_inner_toolbar(),this.route=frappe.get_route(),this.page_name=frappe.get_route_str(),this.report_name=this.route[1],this.page_title=__(this.report_name),this.show_save=!1,this.menu_items=this.get_menu_items(),this.datatable=null,this.prepared_report_action="New",frappe.run_serially([()=>this.get_report_doc(),()=>this.get_report_settings(),()=>this.setup_progress_bar(),()=>this.setup_page_head(),()=>this.refresh_report(e),()=>this.add_chart_buttons_to_toolbar(!0),()=>this.add_card_button_to_toolbar(!0)])}add_card_button_to_toolbar(){this.page.add_inner_button(__("Create Card"),()=>{this.add_card_to_dashboard()})}add_chart_buttons_to_toolbar(e){e?(this.create_chart_button&&this.create_chart_button.remove(),this.create_chart_button=this.page.add_button(__("Set Chart"),()=>{this.open_create_chart_dialog()}),(this.chart_fields||this.chart_options)&&(this.add_to_dashboard_button&&this.add_to_dashboard_button.remove(),this.add_to_dashboard_button=this.page.add_button(__("Add Chart to Dashboard"),()=>{this.add_chart_to_dashboard()}))):(this.create_chart_button&&this.create_chart_button.remove(),this.add_to_dashboard_button&&this.add_to_dashboard_button.remove())}add_card_to_dashboard(){let e=frappe.report_utils.get_field_options_from_report(this.columns,this.raw_data),t=frappe.dashboard_utils.get_dashboard_link_field(),r=frappe.boot.developer_mode,i=new frappe.ui.Dialog({title:__("Create Card"),fields:[{fieldname:"report_field",label:__("Field"),fieldtype:"Select",options:e.numeric_fields},{fieldname:"cb_1",fieldtype:"Column Break"},{fieldname:"report_function",label:__("Function"),options:["Sum","Average","Minimum","Maximum"],fieldtype:"Select"},{fieldname:"sb_1",label:__("Add to Dashboard"),fieldtype:"Section Break"},t,{fieldname:"cb_2",fieldtype:"Column Break"},{fieldname:"label",label:__("Card Label"),fieldtype:"Data"}],primary_action_label:__("Add"),primary_action:a=>{a.label||(a.label=`${a.report_function} of ${toTitle(a.report_field)}`),this.create_number_card(a,a.dashboard,a.label,r),i.hide()}});i.show()}add_chart_to_dashboard(){if(this.chart_fields||this.chart_options){let e=frappe.dashboard_utils.get_dashboard_link_field(),t=frappe.boot.developer_mode,r=new frappe.ui.Dialog({title:__("Create Chart"),fields:[{fieldname:"dashboard_chart_name",label:"Chart Name",fieldtype:"Data"},e],primary_action_label:__("Add"),primary_action:i=>{this.create_dashboard_chart(this.chart_fields||this.chart_options,i.dashboard,i.dashboard_chart_name,t),r.hide()}});r.show()}else frappe.msgprint(__("Please Set Chart"))}create_number_card(e,t,r,i){let a={dashboard:t||null,type:"Report",report_name:this.report_name,filters_json:JSON.stringify(this.get_filter_values()),set_standard:i};Object.assign(a,e),this.add_to_dashboard("frappe.desk.doctype.number_card.number_card.create_report_number_card",a,t,r,"Number Card")}create_dashboard_chart(e,t,r,i){let a={dashboard:t||null,chart_type:"Report",report_name:this.report_name,type:e.chart_type||frappe.model.unscrub(e.type),color:e.color,filters_json:JSON.stringify(this.get_filter_values()),custom_options:{},set_standard:i};for(let s in e)s!="data"&&(a.custom_options[s]=e[s]);if(this.chart_fields){let s=toTitle(e.x_field),n=toTitle(e.y_fields[0]);r=r||`${this.report_name}: ${s} vs ${n}`,Object.assign(a,{chart_name:r,x_field:e.x_field,y_axis:e.y_axis_fields.map(_=>({y_field:_.y_field,color:_.color})),use_report_chart:0})}else r=r||this.report_name,Object.assign(a,{chart_name:r,use_report_chart:1});this.add_to_dashboard("frappe.desk.doctype.dashboard_chart.dashboard_chart.create_report_chart",a,t,r,"Dashboard Chart")}add_to_dashboard(e,t,r,i,a){frappe.xcall(e,{args:t}).then(()=>{let s;if(r){let n=`<a href="#dashboard-view/${r}">${r}</a>`;s=__("New {0} {1} added to Dashboard {2}",[__(a),i,n])}else s=__("New {0} {1} created",[__(a),i]);frappe.msgprint(s,__("New {0} Created",[__(a)]))})}refresh_report(e){return this.toggle_message(!0),this.toggle_report(!1),frappe.run_serially([()=>this.setup_filters(),()=>this.set_route_filters(e),()=>this.page.clear_custom_actions(),()=>this.report_settings.onload&&this.report_settings.onload(this),()=>this.refresh()])}get_report_doc(){return frappe.model.with_doc("Report",this.report_name).then(e=>{this.report_doc=e}).then(()=>frappe.model.with_doctype(this.report_doc.ref_doctype))}get_report_settings(){return new Promise((e,t)=>{frappe.query_reports[this.report_name]?(this.report_settings=frappe.query_reports[this.report_name],e()):frappe.xcall("frappe.desk.query_report.get_script",{report_name:this.report_name}).then(r=>{frappe.dom.eval(r.script||""),frappe.after_ajax(()=>{this.report_settings=this.get_local_report_settings(),this.report_settings.html_format=r.html_format,this.report_settings.execution_time=r.execution_time||0,frappe.query_reports[this.report_name]=this.report_settings,this.report_doc.filters&&!this.report_settings.filters&&(this.report_settings.filters=this.report_doc.filters),e()})}).catch(t)})}get_local_report_settings(){let e=this.report_doc.report_type==="Custom Report"?this.report_doc.reference_report:this.report_name;return frappe.query_reports[e]||{}}setup_progress_bar(){let e=0,t=this.report_settings.execution_time||0;t<5||(this.interval=setInterval(function(){e+=1,frappe.show_progress(__("Preparing Report"),e,t)},1e3))}refresh_filters_dependency(){this.filters.forEach(e=>{e.guardian_has_value=!0,e.df.depends_on&&(e.guardian_has_value=this.evaluate_depends_on_value(e.df.depends_on,e.df.label),e.guardian_has_value?e.df.hidden_due_to_dependency&&(e.df.hidden_due_to_dependency=!1,this.toggle_filter_display(e.df.fieldname,!1)):e.df.hidden_due_to_dependency||(e.df.hidden_due_to_dependency=!0,this.toggle_filter_display(e.df.fieldname,!0),e.set_value(e.df.default||null)))})}evaluate_depends_on_value(e,t){let r=null,i=this.get_filter_values();if(i)if(typeof e=="boolean")r=e;else if(e.substr(0,5)=="eval:")try{r=frappe.utils.eval(e.substr(5),{doc:i})}catch(s){frappe.throw(__('Invalid "depends_on" expression set in filter {0}',[t]))}else{var a=i[e];$.isArray(a)?r=!!a.length:r=!!a}return r}setup_filters(){this.clear_filters();let{filters:e=[]}=this.report_settings,t=this.page.page_form;this.filters=e.map(r=>{if(r.fieldtype==="Break")return;let i=this.page.add_field(r,t);return r.default&&i.set_input(r.default),r.get_query&&(i.get_query=r.get_query),r.on_change&&(i.on_change=r.on_change),r.onchange=()=>{this.refresh_filters_dependency();let a=this.get_filter_values();this.previous_filters&&JSON.stringify(this.previous_filters)===JSON.stringify(a)||(this.previous_filters=a,setTimeout(()=>this.previous_filters=null,1e4),i.on_change?i.on_change(this):this.prepared_report?this.reset_report_view():this._no_refresh||this.refresh())},i=Object.assign(i,r),i}).filter(Boolean),this.refresh_filters_dependency(),this.filters.length===0?this.page.hide_form():this.page.show_form()}set_filters(e){this.filters.map(t=>{t.set_input(e[t.fieldname])})}set_route_filters(e){if(e||(e=frappe.route_options),e){let t=Object.keys(e),i=this.filters.filter(a=>t.includes(a.df.fieldname)).map(a=>()=>{let s=e[a.df.fieldname];typeof s=="string"&&s[0]==="["&&(s=JSON.parse(s)),a.set_value(s)});return i.push(()=>{frappe.route_options=null}),frappe.run_serially(i)}}clear_filters(){this.page.clear_fields()}refresh(){this.toggle_message(!0),this.toggle_report(!1);let e=this.get_filter_values(!0);this.show_loading_screen(),this.last_ajax&&this.last_ajax.abort();let t=this.get_query_params();return t.prepared_report_name&&(e.prepared_report_name=t.prepared_report_name),new Promise(r=>{this.last_ajax=frappe.call({method:"frappe.desk.query_report.run",type:"GET",args:{report_name:this.report_name,filters:e,is_tree:this.report_settings.tree,parent_field:this.report_settings.parent_field},callback:r,always:()=>this.page.btn_secondary.prop("disabled",!1)})}).then(r=>{let i=r.message;if(this.hide_status(),clearInterval(this.interval),this.execution_time=i.execution_time||.1,i.prepared_report){if(this.prepared_report=!0,this.prepared_report_document=i.doc,t.prepared_report_name){this.prepared_report_action="Edit";let a=JSON.parse(i.doc.filters);Object.values(this.filters).forEach(function(s){a[s.fieldname]&&s.set_input(a[s.fieldname]),s.input&&(s.input.disabled=!0)})}this.add_prepared_report_buttons(i.doc)}i.report_summary&&(this.$summary.empty(),this.render_summary(i.report_summary)),i.message&&!i.prepared_report&&this.show_status(i.message),this.toggle_message(!1),i.result&&i.result.length?(this.prepare_report_data(i),this.chart_options=this.get_chart_options(i),this.$chart.empty(),this.chart_options?this.render_chart(this.chart_options):(this.$chart.empty(),this.chart_fields&&(this.chart_options=frappe.report_utils.make_chart_options(this.columns,this.raw_data,this.chart_fields),this.chart_options&&this.render_chart(this.chart_options))),this.render_datatable(),this.add_chart_buttons_to_toolbar(!0),this.add_card_button_to_toolbar(),this.$report.show()):(this.data=[],this.toggle_nothing_to_show(!0),this.add_chart_buttons_to_toolbar(!1)),this.show_footer_message(),frappe.hide_progress()}).finally(()=>{this.hide_loading_screen(),this.update_url_with_filters()})}render_summary(e){e.forEach(t=>{frappe.utils.build_summary_item(t).appendTo(this.$summary)}),this.$summary.show()}get_query_params(){let e=frappe.utils.get_query_string(frappe.get_route_str());return frappe.utils.get_query_params(e)}add_prepared_report_buttons(e){if(e){this.page.add_inner_button(__("Download Report"),function(){window.open(frappe.urllib.get_full_url("/api/method/frappe.core.doctype.prepared_report.prepared_report.download_attachment?dn="+encodeURIComponent(e.name)))});let r=__("This report was generated {0}.",[frappe.datetime.comment_when(e.report_end_time)]),i=__("To get the updated report, click on {0}.",[__("Rebuild")]),a=__("See all past reports.");this.show_status(`
				<div class="indicator orange">
					<span>
						${r}
						${i}
						<a href="/app/List/Prepared%20Report?report_name=${this.report_name}"> ${a}</a>
					</span>
				</div>
			`)}this.primary_action_map={New:{label:__("Generate New Report"),click:()=>{this.show_warning_or_generate_report()}},Edit:{label:__("Edit"),click:()=>{frappe.set_route(frappe.get_route())}},Rebuild:{label:__("Rebuild"),click:()=>{this.show_warning_or_generate_report()}}};let t=this.primary_action_map[this.prepared_report_action];(!this.primary_button||this.primary_button.text()!==t.label)&&(this.primary_button=this.page.set_primary_action(t.label,t.click))}toggle_primary_button_disabled(e){this.primary_button.prop("disabled",e)}show_warning_or_generate_report(){frappe.xcall("frappe.core.doctype.prepared_report.prepared_report.get_reports_in_queued_state",{filters:this.get_filter_values(),report_name:this.report_name}).then(e=>{if(this.queued_prepared_reports=e,e.length){let t=this.get_queued_prepared_reports_warning_message(e);this.prepared_report_dialog=frappe.warn(__("Reports already in Queue"),t,()=>this.generate_background_report(),__("Proceed Anyway"),!0),this.prepared_report_dialog.footer.prepend(`
					<button type="button" class="btn btn-sm btn-default pull-left" data-action="delete_old_queued_reports">
						${__("Delete and Generate New")}
					</button>`),frappe.utils.bind_actions_with_object(this.prepared_report_dialog.wrapper,this)}else this.generate_background_report()})}get_queued_prepared_reports_warning_message(e){let t=`/app/List/Prepared Report/List?status=Queued&report_name=${this.report_name}`,r=e.length==1?`<a class="underline" href="${t}">${__("1 Report")}</a>`:`<a class="underline" href="${t}">${__("{0} Reports",[e.length])}</a>`,i=e.length==1?`${__("There is {0} with the same filters already in the queue:",[r])}`:`${__("There are {0} with the same filters already in the queue:",[r])}`,a=`
			<p>
				${__("Are you sure you want to generate a new report?")}
				${i}
			</p>`,s=n=>`<a class="underline" href="/app/prepared-report/${n.name}">${n.name}</a>`;return a+=e.map(s).join(", "),a}delete_old_queued_reports(){this.prepared_report_dialog.hide(),frappe.xcall("frappe.core.doctype.prepared_report.prepared_report.delete_prepared_reports",{reports:this.queued_prepared_reports}).then(()=>this.generate_background_report())}generate_background_report(){if(this.toggle_primary_button_disabled(!0),!this.filters.filter(r=>r.df.reqd).filter(r=>!r.get_value()).length){let r=this.get_filter_values(!0);return new Promise(i=>frappe.call({method:"frappe.desk.query_report.background_enqueue_run",type:"GET",args:{report_name:this.report_name,filters:r},callback:i})).then(i=>{let a=i.message;this.prepared_report_doc_name=a.name;let s=`<a href='/app/prepared-report/${a.name}'>`+__("Report initiated, click to view status")+"</a>";frappe.show_alert({message:s,indicator:"orange"},10),this.toggle_nothing_to_show(!0)})}}prepare_report_data(e){this.raw_data=e,this.columns=this.prepare_columns(e.columns),this.custom_columns=[],this.data=this.prepare_data(e.result),this.linked_doctypes=this.get_linked_doctypes(),this.tree_report=this.data.some(t=>"indent"in t)}render_datatable(){let e=this.data,t=this.columns.filter(r=>!r.hidden);if(this.raw_data.add_total_row&&!this.report_settings.tree&&(e=e.slice(),e.splice(-1,1)),this.$report.show(),this.datatable&&this.datatable.options&&this.datatable.options.showTotalRow===this.raw_data.add_total_row)this.datatable.options.treeView=this.tree_report,this.datatable.refresh(e,t);else{let r={columns:t,data:e,inlineFilters:!0,language:frappe.boot.lang,translations:frappe.utils.datatable.get_translations(),treeView:this.tree_report,layout:"fixed",cellHeight:33,showTotalRow:this.raw_data.add_total_row&&!this.report_settings.tree,direction:frappe.utils.is_rtl()?"rtl":"ltr",hooks:{columnTotal:frappe.utils.report_column_total}};this.report_settings.get_datatable_options&&(r=this.report_settings.get_datatable_options(r)),this.datatable=new fr.default(this.$report[0],r)}typeof this.report_settings.initial_depth=="number"&&this.datatable.rowmanager.setTreeDepth(this.report_settings.initial_depth),this.report_settings.after_datatable_render&&this.report_settings.after_datatable_render(this.datatable)}show_loading_screen(){let e=`<div class="msg-box no-border">
			<div>
				<img src="/assets/frappe/images/ui-states/list-empty-state.svg" alt="Generic Empty State" class="null-state">
			</div>
			<p>${__("Loading")}...</p>
		</div>`;this.$loading.find("div").html(e),this.$report.hide(),this.$loading.show()}hide_loading_screen(){this.$loading.hide()}get_chart_options(e){let t=this.report_settings.get_chart_data?this.report_settings.get_chart_data(e.columns,e.result):e.chart?e.chart:void 0;if(!!(t&&t.data&&t.data.labels&&t.data.labels.length>0))return t.fieldtype&&(t.tooltipOptions={formatTooltipY:r=>frappe.format(r,{fieldtype:t.fieldtype,options:t.options})}),t.axisOptions={shortenYAxisNumbers:1,numberFormatter:frappe.utils.format_chart_axis_number},t.height=280,t}render_chart(e){this.$chart.empty(),this.$chart.show(),this.chart=new frappe.Chart(this.$chart[0],e)}open_create_chart_dialog(){let e=this,t=frappe.report_utils.get_field_options_from_report(this.columns,this.raw_data);function r(s){return s.y_fields=[],s.colors=[],s.y_axis_fields&&s.y_axis_fields.map(n=>{s.y_fields.push(n.y_field),s.colors.push(n.color)}),s.y_fields=s.y_fields.map(n=>n.trim()).filter(Boolean),s}function i(){let s=$(a.fields_dict.chart_preview.wrapper),n=a.get_values(!0);if(n=r(n),n.x_field&&n.y_fields.length){let _=frappe.report_utils.make_chart_options(e.columns,e.raw_data,n);e.chart_fields=n,s.empty(),new frappe.Chart(s[0],_),s.find(".chart-container .title, .chart-container .sub-title").hide(),s.show(),a.fields_dict.create_dashoard_chart.df.hidden=0,a.refresh()}else s[0].innerHTML=`<div class="flex justify-center align-center text-muted" style="height: 120px; display: flex;">
					<div>${__("Please select X and Y fields")}</div>
				</div>`}let a=new frappe.ui.Dialog({title:__("Create Chart"),fields:[{fieldname:"x_field",label:"X Field",fieldtype:"Select",default:e.chart_fields?e.chart_fields.x_field:null,options:t.non_numeric_fields},{fieldname:"cb_1",fieldtype:"Column Break"},{fieldname:"chart_type",label:"Type of Chart",fieldtype:"Select",options:["Bar","Line","Percentage","Pie","Donut"],default:e.chart_fields?e.chart_fields.chart_type:"Bar"},{fieldname:"sb_1",fieldtype:"Section Break",label:"Y Axis"},{fieldname:"y_axis_fields",fieldtype:"Table",fields:[{fieldtype:"Select",fieldname:"y_field",name:"y_field",label:__("Y Field"),options:t.numeric_fields,in_list_view:1},{fieldtype:"Color",fieldname:"color",name:"color",label:__("Color"),in_list_view:1}]},{fieldname:"preview_chart_button",fieldtype:"Button",label:"Preview Chart",click:i},{fieldname:"sb_2",fieldtype:"Section Break",label:"Chart Preview"},{fieldname:"chart_preview",label:"Chart Preview",fieldtype:"HTML"},{fieldname:"create_dashoard_chart",label:"Add Chart to Dashboard",fieldtype:"Button",hidden:1,click:()=>{a.hide(),this.add_chart_to_dashboard()}}],primary_action_label:__("Create"),primary_action:s=>{s=r(s);let n=frappe.report_utils.make_chart_options(this.columns,this.raw_data,s);e.chart_fields=s;let _=t.numeric_fields.filter(m=>m.value==s.y_fields[0])[0].label,f=t.non_numeric_fields.filter(m=>m.value==s.x_field)[0].label;n.title=__("{0}: {1} vs {2}",[this.report_name,_,f]),this.render_chart(n),this.add_chart_buttons_to_toolbar(!0),a.hide()}});a.show(),setTimeout(i,500)}prepare_columns(e){return e.map(t=>{t=frappe.report_utils.prepare_field_from_column(t);let r=(a,s,n,_)=>{if(n.isHeader&&!_&&this.data){let f=1;if(this.report_settings.get_datatable_options){let m=this.report_settings.get_datatable_options({});m&&m.checkboxColumn&&(f=2)}n.colIndex===f&&!a?(a="Total",n={fieldtype:"Data"}):in_list(["Currency","Float"],n.fieldtype)&&(_=this.data[0])}return frappe.format(a,n,{for_print:!1,always_show_decimals:!0},_)},i=null;return t.fieldtype==="Date"&&(i=(a,s)=>{if(!a.content||s.length!==10)return null;let n=frappe.datetime.user_to_obj(s);return[+frappe.datetime.str_to_obj(a.content),+n]}),Object.assign(t,{id:t.fieldname,name:__(t.label,null,`Column of report '${this.report_name}'`),width:parseInt(t.width)||null,editable:!1,compareValue:i,format:(a,s,n,_)=>this.report_settings.formatter?this.report_settings.formatter(a,s,n,_,r):r(a,s,n,_)})})}prepare_data(e){return e.map(t=>{let r={};return Array.isArray(t)?(this.columns.forEach((i,a)=>{r[i.id]=t[a]}),r):t})}get_visible_columns(){return this.datatable.datamanager.getColumns(!0).map(t=>t.id).map(t=>this.columns.find(r=>r.id===t)).filter(Boolean)}get_filter_values(e){let t=this.filters.filter(a=>a.df.reqd||a.df.mandatory),r=t.filter(a=>!a.get_value());if(console.log(t),r=t.filter(a=>console.log(a.get_value())),e&&r.length>0){let a=__("Please set filters");throw this.hide_loading_screen(),this.toggle_message(e,a),"Filter missing"}return e&&this.toggle_message(!1),this.filters.filter(a=>a.get_value()).map(a=>{var s=a.get_value();return a.df.hidden&&(s=a.value),s==="%"&&(s=null),a.df.wildcard_filter&&(s=`%${s}%`),{[a.df.fieldname]:s}}).reduce((a,s)=>(Object.assign(a,s),a),{})}get_filter(e){let t=(this.filters||[]).find(r=>r.df.fieldname===e);return t||console.warn(`[Query Report] Invalid filter: ${e}`),t}get_filter_value(e){let t=this.get_filter(e);return t?t.get_value():null}set_filter_value(e,t){let r={};typeof e=="string"?r[e]=t:r=e,this._no_refresh=!0,Object.keys(r).forEach((i,a,s)=>{let n=r[i];a===s.length-1&&(this._no_refresh=!1),this.get_filter(i).set_value(n)})}set_breadcrumbs(){if(!this.report_doc||!this.report_doc.ref_doctype)return;let e=frappe.get_meta(this.report_doc.ref_doctype);frappe.breadcrumbs.add(e.module)}make_access_log(e,t){frappe.call("frappe.core.doctype.access_log.access_log.make_access_log",{doctype:this.doctype||"",report_name:this.report_name,filters:this.get_filter_values(),file_type:t,method:e})}print_report(e){let t=this.report_settings.html_format||null,r=this.get_filters_html_for_print(),i=e.orientation=="Landscape";this.make_access_log("Print","PDF"),frappe.render_grid({template:e.columns?"print_grid":t,title:__(this.report_name),subtitle:r,print_settings:e,landscape:i,filters:this.get_filter_values(),data:this.get_data_for_print(),columns:this.get_columns_for_print(e,t),original_data:this.data,report:this})}pdf_report(e){let t=frappe.urllib.get_base_url(),r=frappe.boot.print_css,i=e.orientation=="Landscape",a=this.report_settings.html_format||null,s=this.get_columns_for_print(e,a),n=this.get_data_for_print(),_=this.get_filter_values(),f=this.get_filters_html_for_print(),m=e.columns||!a?"print_grid":a,g=frappe.render_template(m,{title:__(this.report_name),subtitle:f,filters:_,data:n,original_data:this.data,columns:s,report:this}),v=frappe.render_template("print_template",{title:__(this.report_name),content:g,base_url:t,print_css:r,print_settings:e,landscape:i,columns:s,lang:frappe.boot.lang,layout_direction:frappe.utils.is_rtl()?"rtl":"ltr"}),C=[],I=0;for(var b of Object.keys(_)){if(I=I+_[b].toString().length,I>200)break;C.push(_[b])}e.report_name=`${__(this.report_name)}_${C.join("_")}.pdf`,frappe.render_pdf(v,e)}get_filters_html_for_print(){let e=this.get_filter_values();return Object.keys(e).map(t=>{let r=frappe.query_report.get_filter(t).df.label,i=e[t];return`<h6>${__(r)}: ${i}</h6>`}).join("")}export_report(){if(this.export_dialog){this.export_dialog.clear(),this.export_dialog.show();return}let e=[{label:__("Select File Format"),fieldname:"file_format",fieldtype:"Select",options:["Excel","CSV"],default:"Excel",reqd:1}];this.tree_report&&e.push({label:__("Include indentation"),fieldname:"include_indentation",fieldtype:"Check"}),this.export_dialog=frappe.prompt(e,({file_format:t,include_indentation:r})=>{if(this.make_access_log("Export",t),t==="CSV"){let i=this.columns.reduce((n,_)=>(_.hidden||n.push(__(_.label)),n),[]),a=this.get_data_for_csv(r),s=[i].concat(a);frappe.tools.downloadify(s,null,this.report_name)}else{let i=this.get_filter_values(!0);frappe.urllib.get_dict("prepared_report_name")&&(i=Object.assign(frappe.urllib.get_dict("prepared_report_name"),i));let a=this.datatable.bodyRenderer.visibleRowIndices;a.length+1===this.data.length&&a.push(a.length);let s={cmd:"frappe.desk.query_report.export_query",report_name:this.report_name,custom_columns:this.custom_columns.length?this.custom_columns:[],file_format_type:t,filters:i,visible_idx:a,include_indentation:r};open_url_post(frappe.request.url,s)}},__("Export Report: {0}",[this.report_name]),__("Download"))}get_data_for_csv(e){let t=this.datatable.bodyRenderer.visibleRows;return this.raw_data.add_total_row&&t.push(this.datatable.bodyRenderer.getTotalRow()),t.map(r=>{let i=this.datatable.datamanager.getStandardColumnCount();return r.slice(i).map((a,s)=>(a.column.fieldtype==="Duration"&&(a.content=frappe.utils.get_formatted_duration(a.content)),e&&s===0&&(a.content="   ".repeat(r.meta.indent)+(a.content||"")),a.content||""))})}get_data_for_print(){if(!this.data.length)return[];let e=this.datatable.datamanager.rowViewOrder.map(t=>{if(this.datatable.bodyRenderer.visibleRowIndices.includes(t))return this.data[t]}).filter(Boolean);if(this.raw_data.add_total_row){let t=this.datatable.bodyRenderer.getTotalRow().reduce((r,i)=>(r[i.column.id]=i.content,r.is_total_row=!0,r),{});e.push(t)}return e}get_columns_for_print(e,t){let r=[];return e&&e.columns?r=this.get_visible_columns().filter(i=>e.columns.includes(i.fieldname)):r=t?this.columns:this.get_visible_columns(),r}get_menu_items(){let e=[{label:__("Refresh"),action:()=>this.refresh(),class:"visible-xs"},{label:__("Edit"),action:()=>frappe.set_route("Form","Report",this.report_name),condition:()=>frappe.user.is_report_manager(),standard:!0},{label:__("Print"),action:()=>{let t=frappe.ui.get_print_settings(!1,r=>this.print_report(r),this.report_doc.letter_head,this.get_visible_columns());this.add_portrait_warning(t)},condition:()=>frappe.model.can_print(this.report_doc.ref_doctype),standard:!0},{label:__("PDF"),action:()=>{let t=frappe.ui.get_print_settings(!1,r=>this.pdf_report(r),this.report_doc.letter_head,this.get_visible_columns());this.add_portrait_warning(t)},condition:()=>frappe.model.can_print(this.report_doc.ref_doctype),standard:!0},{label:__("Export"),action:()=>this.export_report(),condition:()=>frappe.model.can_export(this.report_doc.ref_doctype),standard:!0},{label:__("Setup Auto Email"),action:()=>frappe.set_route("List","Auto Email Report",{report:this.report_name}),standard:!0},{label:__("Add Column"),action:()=>{let t=new frappe.ui.Dialog({title:__("Add Column"),fields:[{fieldtype:"Select",fieldname:"doctype",label:__("From Document Type"),options:this.linked_doctypes.map(r=>({label:r.doctype,value:r.doctype})),change:()=>{let r=t.get_value("doctype");frappe.model.with_doctype(r,()=>{let i=frappe.meta.get_docfields(r).filter(frappe.model.is_value_type).map(a=>({label:a.label,value:a.fieldname}));t.set_df_property("field","options",i.sort(function(a,s){return a.label<s.label?-1:a.label>s.label?1:0}))})}},{fieldtype:"Select",label:__("Field"),fieldname:"field",options:[]},{fieldtype:"Select",label:__("Insert After"),fieldname:"insert_after",options:this.columns.map(r=>r.label)}],primary_action:r=>{let i=[],a=frappe.meta.get_docfield(r.doctype,r.field),s=this.columns.findIndex(n=>n.label===r.insert_after);i.push({fieldname:a.fieldname,fieldtype:a.fieldtype,label:a.label,insert_after_index:s,link_field:this.doctype_field_map[r.doctype],doctype:r.doctype,options:a.options,width:100}),this.custom_columns=this.custom_columns.concat(i),frappe.call({method:"frappe.desk.query_report.get_data_for_custom_field",args:{field:r.field,doctype:r.doctype},callback:n=>{let _=n.message,f=this.doctype_field_map[r.doctype];this.add_custom_column(i,_,f,r.field,s),t.hide()}}),this.set_menu_items()}});t.show()},standard:!0},{label:__("User Permissions"),action:()=>frappe.set_route("List","User Permission",{doctype:"Report",name:this.report_name}),condition:()=>frappe.model.can_set_user_permissions("Report"),standard:!0}];return frappe.user.is_report_manager()&&e.push({label:__("Save"),action:()=>{let t=new frappe.ui.Dialog({title:__("Save Report"),fields:[{fieldtype:"Data",fieldname:"report_name",label:__("Report Name"),default:this.report_doc.is_standard=="No"?this.report_name:"",reqd:!0}],primary_action:r=>{frappe.call({method:"frappe.desk.query_report.save_report",args:{reference_report:this.report_name,report_name:r.report_name,columns:this.get_visible_columns()},callback:function(i){this.show_save=!1,t.hide(),frappe.set_route("query-report",i.message)}})}});t.show()},standard:!0}),e}add_portrait_warning(e){this.columns.length>10&&e.set_df_property("orientation","change",()=>{let r=e.get_value("orientation")==="Portrait"?__("Report with more than 10 columns looks better in Landscape mode."):"";e.set_df_property("orientation","description",r)})}add_custom_column(e,t,r,i,a){let s=this.prepare_columns(e);this.columns.splice(a+1,0,s[0]),this.data.forEach(n=>{n[i]=t[n[r]]}),this.render_datatable()}get_linked_doctypes(){let e=[],t=[],r=new Set;return this.doctype_field_map={},this.columns.forEach(i=>{i.fieldtype=="Link"&&i.options&&i.options!="Currency"?e.push({doctype:i.options,fieldname:i.fieldname}):i.fieldtype=="Dynamic Link"&&i.options&&t.push({link_name:i.options,fieldname:i.fieldname})}),this.data.forEach(i=>{t.forEach(a=>{i[a.link_name]&&r.add(i[a.link_name]+":"+a.fieldname)})}),e=e.concat(Array.from(r).map(i=>{let a=i.split(":");return{doctype:a[0],fieldname:a[1]}})),e.forEach(i=>{this.doctype_field_map[i.doctype]=i.fieldname}),e}setup_report_wrapper(){if(this.$report)return;$(".page-head-content").removeClass("border-bottom");let e=this.page.main.find(".page-form");this.$status=$('<div class="form-message text-muted small"></div>').hide().insertAfter(e),this.$summary=$('<div class="report-summary"></div>').hide().appendTo(this.page.main),this.$chart=$('<div class="chart-wrapper">').hide().appendTo(this.page.main),this.$loading=$(this.message_div("")).hide().appendTo(this.page.main),this.$report=$('<div class="report-wrapper">').appendTo(this.page.main),this.$message=$(this.message_div("")).hide().appendTo(this.page.main)}show_status(e){this.$status.html(e).show()}hide_status(){this.$status.hide()}show_footer_message(){this.$report_footer&&this.$report_footer.remove(),this.$report_footer=$('<div class="report-footer text-muted"></div>').appendTo(this.page.main),this.tree_report&&(this.$tree_footer=$(`<div class="tree-footer col-md-6">
				<button class="btn btn-xs btn-default" data-action="expand_all_rows">
					${__("Expand All")}</button>
				<button class="btn btn-xs btn-default" data-action="collapse_all_rows">
					${__("Collapse All")}</button>
			</div>`),$(this.$report_footer).append(this.$tree_footer),this.$tree_footer.find("[data-action=collapse_all_rows]").show(),this.$tree_footer.find("[data-action=expand_all_rows]").hide());let e=__("For comparison, use >5, <10 or =324. For ranges, use 5:10 (for values between 5 & 10)."),t=__("Execution Time: {0} sec",[this.execution_time||.1]);this.$report_footer.append(`<div class="col-md-12">
			<span">${e}</span><span class="pull-right">${t}</span>
		</div>`)}expand_all_rows(){this.$tree_footer.find("[data-action=expand_all_rows]").hide(),this.datatable.rowmanager.expandAllNodes(),this.$tree_footer.find("[data-action=collapse_all_rows]").show()}collapse_all_rows(){this.$tree_footer.find("[data-action=collapse_all_rows]").hide(),this.datatable.rowmanager.collapseAllNodes(),this.$tree_footer.find("[data-action=expand_all_rows]").show()}message_div(e){return`<div class='flex justify-center align-center text-muted' style='height: 50vh;'>
			<div>${e}</div>
		</div>`}reset_report_view(){this.hide_status(),this.toggle_nothing_to_show(!0),this.refresh()}toggle_nothing_to_show(e){let t=this.prepared_report&&!this.prepared_report_document?__("This is a background report. Please set the appropriate filters and then generate a new one."):this.get_no_result_message();this.toggle_message(e,t),e&&this.prepared_report&&(this.prepared_report_action="New",this.primary_button.is(":visible")||this.add_prepared_report_buttons())}toggle_message(e,t){e?(this.$message.find("div").html(t),this.$message.show()):this.$message.hide()}toggle_filter_display(e,t){this.$page.find(`div[data-fieldname=${e}]`).toggleClass("hide-control",t)}toggle_report(e){this.$report.toggle(e),this.$chart.toggle(e),this.$summary.toggle(e)}get_checked_items(e){return this.datatable.rowmanager.getCheckedRows().reduce((r,i)=>{if(i===void 0)return r;let a=this.data[i];return r.push(e?a.name:a),r},[])}get get_values(){return this.get_filter_values}};frappe.query_reports["Employee Analytics"]={filters:[{fieldname:"company",label:__("Company"),fieldtype:"Link",options:"Company",default:frappe.defaults.get_user_default("Company"),reqd:1},{fieldname:"parameter",label:__("Parameter"),fieldtype:"Select",options:["Branch","Grade","Department","Designation","Employment Type"],default:"Branch",reqd:1}]};frappe.provide("erpnext");frappe.provide("erpnext.utils");$.extend(erpnext,{get_currency:function(o){return!o&&cur_frm&&(o=cur_frm.doc.company),o&&frappe.get_doc(":Company",o).default_currency||frappe.boot.sysdefaults.currency},get_presentation_currency_list:()=>{let e=frappe.boot.docs.filter(t=>t.doctype===":Currency").map(t=>t.name);return e.unshift(""),e},toggle_naming_series:function(){cur_frm.fields_dict.naming_series&&cur_frm.toggle_display("naming_series",!!cur_frm.doc.__islocal)},hide_company:function(){if(cur_frm.fields_dict.company){var o=Object.keys(locals[":Company"]||{});o.length===1?(cur_frm.doc.company||cur_frm.set_value("company",o[0]),cur_frm.toggle_display("company",!1)):erpnext.last_selected_company&&(cur_frm.doc.company||cur_frm.set_value("company",erpnext.last_selected_company))}},is_perpetual_inventory_enabled:function(o){if(o)return frappe.get_doc(":Company",o).enable_perpetual_inventory},stale_rate_allowed:()=>cint(frappe.boot.sysdefaults.allow_stale),setup_serial_or_batch_no:function(){let o=cur_frm.open_grid_row();!o||!o.grid_form.fields_dict.serial_no||o.grid_form.fields_dict.serial_no.get_status()!=="Write"||frappe.model.get_value("Item",{name:o.doc.item_code},["has_serial_no","has_batch_no"],({has_serial_no:e,has_batch_no:t})=>{Object.assign(o.doc,{has_serial_no:e,has_batch_no:t}),e?pr(__("Add Serial No"),o.grid_form.fields_dict.serial_no.$wrapper,this,o):t&&pr(__("Pick Batch No"),o.grid_form.fields_dict.batch_no.$wrapper,this,o)})},route_to_adjustment_jv:o=>{frappe.model.with_doctype("Journal Entry",()=>{let e=frappe.model.get_new_doc("Journal Entry");o.accounts.forEach(t=>{let r=frappe.model.add_child(e,"accounts");r.account=t.account,r.debit_in_account_currency=t.debit_in_account_currency,r.credit_in_account_currency=t.credit_in_account_currency,r.party_type=""}),frappe.set_route("Form","Journal Entry",e.name)})},route_to_pending_reposts:o=>{frappe.set_route("List","Repost Item Valuation",o)}});$.extend(erpnext.utils,{set_party_dashboard_indicators:function(o){if(o.doc.__onload&&o.doc.__onload.dashboard_info){var e=o.doc.__onload.dashboard_info;e.length>1?e.forEach(function(t){erpnext.utils.add_indicator_for_multicompany(o,t)}):e.length===1&&(o.dashboard.add_indicator(__("Annual Billing: {0}",[format_currency(e[0].billing_this_year,e[0].currency)]),"blue"),o.dashboard.add_indicator(__("Total Unpaid: {0}",[format_currency(e[0].total_unpaid,e[0].currency)]),e[0].total_unpaid?"orange":"green"),e[0].loyalty_points&&o.dashboard.add_indicator(__("Loyalty Points: {0}",[e[0].loyalty_points]),"blue"))}},add_indicator_for_multicompany:function(o,e){o.dashboard.stats_area.show(),o.dashboard.stats_area_row.addClass("flex"),o.dashboard.stats_area_row.css("flex-wrap","wrap");var t=e.total_unpaid?"orange":"green",r=$('<div class="flex-column col-xs-6"><div style="margin-top:10px"><h6>'+e.company+'</h6></div><div class="badge-link small" style="margin-bottom:10px"><span class="indicator blue">Annual Billing: '+format_currency(e.billing_this_year,e.currency)+'</span></div><div class="badge-link small" style="margin-bottom:10px"><span class="indicator '+t+'">Total Unpaid: '+format_currency(e.total_unpaid,e.currency)+"</span></div></div>").appendTo(o.dashboard.stats_area_row);return e.loyalty_points&&$('<div class="badge-link small" style="margin-bottom:10px"><span class="indicator blue">Loyalty Points: '+e.loyalty_points+"</span></div>").appendTo(r),r},get_party_name:function(o){var e={Customer:"customer_name",Supplier:"supplier_name",Employee:"employee_name",Member:"member_name"};return e[o]},copy_value_in_all_rows:function(o,e,t,r,i){var a=locals[e][t];if(a[i])for(var s=o[r]||[],n=0;n<s.length;n++)s[n][i]||(s[n][i]=a[i]);refresh_field(r)},get_terms:function(o,e,t){if(o)return frappe.call({method:"erpnext.setup.doctype.terms_and_conditions.terms_and_conditions.get_terms_and_conditions",args:{template_name:o,doc:e},callback:function(r){t(r)}})},make_bank_account:function(o,e){frappe.call({method:"erpnext.accounts.doctype.bank_account.bank_account.make_bank_account",args:{doctype:o,docname:e},freeze:!0,callback:function(t){var r=frappe.model.sync(t.message);frappe.set_route("Form",r[0].doctype,r[0].name)}})},add_dimensions:function(o,e){let t=frappe.query_reports[o].filters;frappe.call({method:"erpnext.accounts.doctype.accounting_dimension.accounting_dimension.get_dimensions",callback:function(r){r.message[0].forEach(a=>{t.some(n=>n.fieldname===a.fieldname)||(console.log("Called"),t.splice(e,0,{fieldname:a.fieldname,label:__(a.label),fieldtype:"MultiSelectList",get_data:function(n){return frappe.db.get_link_options(a.document_type,n)},reqd:1}))})}})},add_inventory_dimensions:function(o,e){let t=frappe.query_reports[o].filters;frappe.call({method:"erpnext.stock.doctype.inventory_dimension.inventory_dimension.get_inventory_dimensions",callback:function(r){r.message&&r.message.length&&r.message.forEach(i=>{let a=t.filter(s=>s.fieldname===i.fieldname);a.length?(a[0].fieldtype="MultiSelectList",a[0].get_data=function(s){return frappe.db.get_link_options(i.doctype,s)}):t.splice(e,0,{fieldname:i.fieldname,label:__(i.doctype),fieldtype:"MultiSelectList",get_data:function(s){return frappe.db.get_link_options(i.doctype,s)}})})}})},make_subscription:function(o,e){frappe.call({method:"frappe.automation.doctype.auto_repeat.auto_repeat.make_auto_repeat",args:{doctype:o,docname:e},callback:function(t){var r=frappe.model.sync(t.message);frappe.set_route("Form",r[0].doctype,r[0].name)}})},make_pricing_rule:function(o,e){frappe.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.make_pricing_rule",args:{doctype:o,docname:e},callback:function(t){var r=frappe.model.sync(t.message);frappe.set_route("Form",r[0].doctype,r[0].name)}})},first_row_is_empty:function(o){return $.isArray(o)&&o.length>0?!o[0].item_code:!1},remove_empty_first_row:function(o,e){let t=o.doc[e];return this.first_row_is_empty(t)&&(o.doc[e]=t.splice(1)),t},get_tree_options:function(o){let e=frappe.model.unscrub(o),t=frappe.defaults.get_user_permissions(),r;return t&&t[e]?r=t[e].map(i=>i.doc):r=$.map(locals[`:${e}`],function(i){return i.name}).sort(),r.filter((i,a,s)=>s.indexOf(i)===a)},get_tree_default:function(o){let e=this.get_tree_options(o);return e.includes(frappe.defaults.get_default(o))?frappe.defaults.get_default(o):e[0]},overrides_parent_value_in_all_rows:function(o,e,t,r,i,a){if(o[a]){let s=o[r]||[];for(let n=0;n<s.length;n++)s[n][i]=o[a];frappe.refresh_field(r)}},create_new_doc:function(o,e){frappe.model.with_doctype(o,function(){var t=frappe.model.get_new_doc(o);for(let[r,i]of Object.entries(e))t[r]=i;frappe.ui.form.make_quick_entry(o,null,null,t)})},check_payments_app:()=>{if(frappe.boot.versions&&!frappe.boot.versions.payments){let o='<a href="https://frappecloud.com/marketplace/apps/payments">Marketplace</a>',e='<a href="https://github.com/frappe/payments/">GitHub</a>',t=__("payments app is not installed. Please install it from {0} or {1}",[o,e]);frappe.msgprint(t)}}});erpnext.utils.select_alternate_items=function(o){let e=o.frm,t=o.warehouse_field||"warehouse",r=o.item_field||"item_code";this.data=[];let i=new frappe.ui.Dialog({title:__("Select Alternate Item"),fields:[{fieldtype:"Section Break",label:__("Items")},{fieldname:"alternative_items",fieldtype:"Table",cannot_add_rows:!0,in_place_edit:!0,data:this.data,get_data:()=>this.data,fields:[{fieldtype:"Data",fieldname:"docname",hidden:1},{fieldtype:"Link",fieldname:"item_code",options:"Item",in_list_view:1,read_only:1,label:__("Item Code")},{fieldtype:"Link",fieldname:"alternate_item",options:"Item",default:"",in_list_view:1,label:__("Alternate Item"),onchange:function(){let a=this.get_value(),s=this.grid_row.on_grid_fields_dict.warehouse.get_value();a&&s&&frappe.call({method:"erpnext.stock.utils.get_latest_stock_qty",args:{item_code:a,warehouse:s},callback:n=>{this.grid_row.on_grid_fields_dict.actual_qty.set_value(n.message||0)}})},get_query:a=>({query:"erpnext.stock.doctype.item_alternative.item_alternative.get_alternative_items",filters:{item_code:a.item_code}})},{fieldtype:"Link",fieldname:"warehouse",options:"Warehouse",default:"",in_list_view:1,label:__("Warehouse"),onchange:function(){let a=this.get_value(),s=this.grid_row.on_grid_fields_dict.item_code.get_value();s&&a&&frappe.call({method:"erpnext.stock.utils.get_latest_stock_qty",args:{item_code:s,warehouse:a},callback:n=>{this.grid_row.on_grid_fields_dict.actual_qty.set_value(n.message||0)}})}},{fieldtype:"Float",fieldname:"actual_qty",default:0,read_only:1,in_list_view:1,label:__("Available Qty")}]}],primary_action:function(){this.get_values().alternative_items.filter(n=>{if(n.alternate_item&&n.item_code!=n.alternate_item)return!0}).forEach(n=>{let _=frappe.get_doc(o.child_doctype,n.docname),f=null;_.doctype==="Work Order Item"?f=_.required_qty:f=_.qty,_[r]=n.alternate_item,frappe.model.set_value(_.doctype,_.name,"qty",f),frappe.model.set_value(_.doctype,_.name,o.original_item_field,n.item_code),e.trigger(r,_.doctype,_.name)}),refresh_field(o.child_docname),this.hide()},primary_action_label:__("Update")});e.doc[o.child_docname].forEach(a=>{(!o.condition||o.condition(a))&&i.fields_dict.alternative_items.df.data.push({docname:a.name,item_code:a[r],warehouse:a[t],actual_qty:a.actual_qty})}),this.data=i.fields_dict.alternative_items.df.data,i.fields_dict.alternative_items.grid.refresh(),i.show()};erpnext.utils.update_child_items=function(o){let e=o.frm,t=typeof o.cannot_add_row=="undefined"?!0:o.cannot_add_row,r=typeof o.cannot_add_row=="undefined"?"items":o.child_docname,i=frappe.get_meta(`${e.doc.doctype} Item`),a=n=>i.fields.find(_=>_.fieldname==n).precision;this.data=e.doc[o.child_docname].map(n=>({docname:n.name,name:n.name,item_code:n.item_code,delivery_date:n.delivery_date,schedule_date:n.schedule_date,conversion_factor:n.conversion_factor,qty:n.qty,rate:n.rate,uom:n.uom}));let s=[{fieldtype:"Data",fieldname:"docname",read_only:1,hidden:1},{fieldtype:"Link",fieldname:"item_code",options:"Item",in_list_view:1,read_only:0,disabled:0,label:__("Item Code"),get_query:function(){let n;return e.doc.doctype=="Sales Order"?n={is_sales_item:1}:e.doc.doctype=="Purchase Order"&&(e.doc.is_subcontracted?e.doc.is_old_subcontracting_flow?n={is_sub_contracted_item:1}:n={is_stock_item:0}:n={is_purchase_item:1}),{query:"erpnext.controllers.queries.item_query",filters:n}}},{fieldtype:"Link",fieldname:"uom",options:"UOM",read_only:0,label:__("UOM"),reqd:1,onchange:function(){frappe.call({method:"erpnext.stock.get_item_details.get_conversion_factor",args:{item_code:this.doc.item_code,uom:this.value},callback:n=>{if(!n.exc){if(this.doc.conversion_factor==n.message.conversion_factor)return;let _=this.doc.docname;dialog.fields_dict.trans_items.df.data.some(f=>{if(f.docname==_)return f.conversion_factor=n.message.conversion_factor,dialog.fields_dict.trans_items.grid.refresh(),!0})}}})}},{fieldtype:"Float",fieldname:"qty",default:0,read_only:0,in_list_view:1,label:__("Qty"),precision:a("qty")},{fieldtype:"Currency",fieldname:"rate",options:"currency",default:0,read_only:0,in_list_view:1,label:__("Rate"),precision:a("rate")}];(e.doc.doctype=="Sales Order"||e.doc.doctype=="Purchase Order")&&(s.splice(2,0,{fieldtype:"Date",fieldname:e.doc.doctype=="Sales Order"?"delivery_date":"schedule_date",in_list_view:1,label:e.doc.doctype=="Sales Order"?__("Delivery Date"):__("Reqd by date"),reqd:1}),s.splice(3,0,{fieldtype:"Float",fieldname:"conversion_factor",in_list_view:1,label:__("Conversion Factor"),precision:a("conversion_factor")})),new frappe.ui.Dialog({title:__("Update Items"),fields:[{fieldname:"trans_items",fieldtype:"Table",label:"Items",cannot_add_rows:t,in_place_edit:!1,reqd:1,data:this.data,get_data:()=>this.data,fields:s}],primary_action:function(){let n=this.get_values().trans_items.filter(_=>!!_.item_code);frappe.call({method:"erpnext.controllers.accounts_controller.update_child_qty_rate",freeze:!0,args:{parent_doctype:e.doc.doctype,trans_items:n,parent_doctype_name:e.doc.name,child_docname:r},callback:function(){e.reload_doc()}}),this.hide(),refresh_field("items")},primary_action_label:__("Update")}).show()};erpnext.utils.map_current_doc=function(o){function e(){if($.isArray(cur_frm.doc.items)&&cur_frm.doc.items.length>0){cur_frm.doc.items[0].item_code||(cur_frm.doc.items=cur_frm.doc.items.splice(1));var r=frappe.meta.get_docfield(cur_frm.doctype,"items").options,i=null;frappe.get_meta(r).fields.forEach(function(n){n.options===o.source_doctype&&(i=n.fieldname)});var a=!1,s={};$.each(cur_frm.doc.items,function(n,_){o.source_name.forEach(function(f){_[i]==f&&(a=!0,s[_.item_code]?s[_.item_code]+=flt(_.qty):s[_.item_code]=flt(_.qty))})}),a&&o.source_name.forEach(function(n){if(frappe.model.with_doc(o.source_doctype,n,function(_){var f=frappe.model.get_doc(o.source_doctype,n);$.each(f.items||[],function(m,g){if(g.qty>flt(s[g.item_code]))return a=!1,!1})}),a){frappe.msgprint(__("You have already selected items from {0} {1}",[o.source_doctype,n]));return}})}return frappe.call({type:"POST",method:"frappe.model.mapper.map_docs",args:{method:o.method,source_names:o.source_name,target_doc:cur_frm.doc,args:o.args},callback:function(n){if(!n.exc){var _=frappe.model.sync(n.message);cur_frm.dirty(),cur_frm.refresh()}}})}let t={};if(o.get_query_filters&&(t.filters=o.get_query_filters),o.get_query_method&&(t.query=o.get_query_method),(t.filters||t.query)&&(o.get_query=()=>t),o.source_doctype){let r=new frappe.ui.form.MultiSelectDialog({doctype:o.source_doctype,target:o.target,date_field:o.date_field||void 0,setters:o.setters,get_query:o.get_query,add_filters_group:1,allow_child_item_selection:o.allow_child_item_selection,child_fieldname:o.child_fieldname,child_columns:o.child_columns,size:o.size,action:function(i,a){let s=i;if(s.length===0){frappe.msgprint(__("Please select {0}",[o.source_doctype]));return}o.source_name=s,o.allow_child_item_selection&&(o.args=a),r.dialog.hide(),e()}});return r}o.source_name&&(o.source_name=[o.source_name],e())};frappe.form.link_formatters.Item=function(o,e){return e&&o&&e.item_name&&e.item_name!==o&&e.item_code===o?o+": "+e.item_name:!o&&e.doctype&&e.item_name?e.item_name:o};frappe.form.link_formatters.Employee=function(o,e){return e&&o&&e.employee_name&&e.employee_name!==o&&e.employee===o?o+": "+e.employee_name:!o&&e.doctype&&e.employee_name?e.employee:o};frappe.form.link_formatters.Project=function(o,e){return e&&o&&e.project_name&&e.project_name!==o&&e.project===o?o+": "+e.project_name:!o&&e.doctype&&e.project_name?e.project:o};$(document).on("app_ready",function(){frappe.datetime.is_timezone_same()||$.each(["Stock Reconciliation","Stock Entry","Stock Ledger Entry","Delivery Note","Purchase Receipt","Sales Invoice"],function(o,e){frappe.ui.form.on(e,"onload",function(t){cur_frm.set_df_property("posting_time","description",frappe.sys_defaults.time_zone)})})});$(document).on("app_ready",function(){frappe.call({method:"erpnext.support.doctype.service_level_agreement.service_level_agreement.get_sla_doctypes",callback:function(o){!o.message||$.each(o.message,function(e,t){frappe.ui.form.on(t,{onload:function(r){!r.doc.service_level_agreement||frappe.call({method:"erpnext.support.doctype.service_level_agreement.service_level_agreement.get_service_level_agreement_filters",args:{doctype:r.doc.doctype,name:r.doc.service_level_agreement,customer:r.doc.customer},callback:function(i){i&&i.message&&(r.set_query("priority",function(){return{filters:{name:["in",i.message.priority]}}}),r.set_query("service_level_agreement",function(){return{filters:{name:["in",i.message.service_level_agreements]}}}))}})},refresh:function(r){if(r.doc.status!=="Closed"&&r.doc.service_level_agreement&&["First Response Due","Resolution Due"].includes(r.doc.agreement_status))frappe.call({method:"frappe.client.get",args:{doctype:"Service Level Agreement",name:r.doc.service_level_agreement},callback:function(i){let a=i.message.pause_sla_on,s=[];if($.each(a,(n,_)=>{s.push(_.status)}),s.includes(r.doc.status)){r.dashboard.clear_headline();let n={indicator:"orange",msg:__("SLA is on hold since {0}",[moment(r.doc.on_hold_since).fromNow(!0)])};r.dashboard.set_headline_alert('<div class="row"><div class="col-xs-12"><span class="indicator whitespace-nowrap '+n.indicator+'"><span>'+n.msg+"</span></span> </div></div>")}else ns(r,i.message.apply_sla_for_resolution)}});else if(r.doc.service_level_agreement){r.dashboard.clear_headline();let i=r.doc.agreement_status=="Fulfilled"?{indicator:"green",msg:"Service Level Agreement has been fulfilled"}:{indicator:"red",msg:"Service Level Agreement Failed"};r.dashboard.set_headline_alert('<div class="row"><div class="col-xs-12"><span class="indicator whitespace-nowrap '+i.indicator+'"><span class="hidden-xs">'+i.msg+"</span></span> </div></div>")}}})})}})});function ns(o,e){o.dashboard.clear_headline();let t;o.doc.first_responded_on?t=hr(o.doc.response_by,o.doc.first_responded_on):t=ur(o.doc.response_by,o.doc.agreement_status);let r=`
		<div class="row">
			<div class="col-xs-12 col-sm-6">
				<span class="indicator whitespace-nowrap ${t.indicator}">
					<span>Time to Respond: ${t.diff_display}</span>
				</span>
			</div>`;if(e){let i;o.doc.resolution_date?i=hr(o.doc.resolution_by,o.doc.resolution_date):i=ur(o.doc.resolution_by,o.doc.agreement_status),r+=`
			<div class="col-xs-12 col-sm-6">
				<span class="indicator whitespace-nowrap ${i.indicator}">
					<span>Time to Resolve: ${i.diff_display}</span>
				</span>
			</div>`}r+="</div>",o.dashboard.set_headline_alert(r)}function ur(o,e){let t=moment(o).diff(moment()),r=t>=44500?moment.duration(t).humanize():"Failed",i=r=="Failed"&&e!="Fulfilled"?"red":"green";return{diff_display:r,indicator:i}}function hr(o,e){return moment(o).diff(moment(e))>=0?{diff_display:"Fulfilled",indicator:"green"}:{diff_display:"Failed",indicator:"red"}}function pr(o,e,t,r){let i=$("<div>").css({"margin-bottom":"10px","margin-top":"10px"}).appendTo(e);$(`<button class="btn btn-sm btn-default">${o}</button>`).appendTo(i).on("click",function(){t.show_serial_batch_selector(r.frm,r.doc,"","",!0)})}})();
/**!
 * Sortable
 * @author	RubaXa   <trash@rubaxa.org>
 * @author	owenm    <owen23355@gmail.com>
 * @license MIT
 */
//# sourceMappingURL=engr.bundle.RFOXWCQZ.js.map
