{
  "version": 3,
  "sources": ["../../../../../apps/engr/engr/public/js/taxes_and_totals.js", "../../../../../apps/engr/engr/public/js/transaction.js"],
  "sourcesContent": ["// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nerpnext.taxes_and_totals = erpnext.payments.extend({\n\tsetup: function() {\n\t\tthis.fetch_round_off_accounts();\n\t},\n\n\tapply_pricing_rule_on_item: function(item) {\n\t\tlet effective_item_rate = item.price_list_rate;\n\t\tlet item_rate = item.rate;\n\t\tif (in_list([\"Sales Order\", \"Quotation\"], item.parenttype) && item.blanket_order_rate) {\n\t\t\teffective_item_rate = item.blanket_order_rate;\n\t\t}\n\t\tif (item.margin_type == \"Percentage\") {\n\t\t\titem.rate_with_margin = flt(effective_item_rate)\n\t\t\t\t+ flt(effective_item_rate) * ( flt(item.margin_rate_or_amount) / 100);\n\t\t} else {\n\t\t\titem.rate_with_margin = flt(effective_item_rate) + flt(item.margin_rate_or_amount);\n\t\t}\n\t\titem.base_rate_with_margin = flt(item.rate_with_margin) * flt(this.frm.doc.conversion_rate);\n\n\t\titem_rate = flt(item.rate_with_margin , precision(\"rate\", item));\n\n\t\tif (item.discount_percentage) {\n\t\t\titem.discount_amount = flt(item.rate_with_margin) * flt(item.discount_percentage) / 100;\n\t\t}\n\n\t\tif (item.discount_amount) {\n\t\t\titem_rate = flt((item.rate_with_margin) - (item.discount_amount), precision('rate', item));\n\t\t\titem.discount_percentage = 100 * flt(item.discount_amount) / flt(item.rate_with_margin);\n\t\t}\n\n\t\tfrappe.model.set_value(item.doctype, item.name, \"rate\", item_rate);\n\t},\n\n\tcalculate_taxes_and_totals: function(update_paid_amount) {\n\t\tthis.discount_amount_applied = false;\n\t\tthis._calculate_taxes_and_totals();\n\t\tthis.calculate_discount_amount();\n\n\t\t// Advance calculation applicable to Sales /Purchase Invoice\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\", \"Purchase Invoice\"], this.frm.doc.doctype)\n\t\t\t&& this.frm.doc.docstatus < 2 && !this.frm.doc.is_return) {\n\t\t\tthis.calculate_total_advance(update_paid_amount);\n\t\t}\n\n\t\tif (in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype) && this.frm.doc.is_pos &&\n\t\t\tthis.frm.doc.is_return) {\n\t\t\tthis.update_paid_amount_for_return();\n\t\t}\n\n\t\t// Sales person's commission\n\t\tif(in_list([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\",\"Proforma Invoice\"], this.frm.doc.doctype)) {\n\t\t\tthis.calculate_commission();\n\t\t\tthis.calculate_contribution();\n\t\t}\n\n\t\t// Update paid amount on return/debit note creation\n\t\tif(this.frm.doc.doctype === \"Purchase Invoice\" && this.frm.doc.is_return\n\t\t\t&& (this.frm.doc.grand_total > this.frm.doc.paid_amount)) {\n\t\t\tthis.frm.doc.paid_amount = flt(this.frm.doc.grand_total, precision(\"grand_total\"));\n\t\t}\n\n\t\tthis.frm.refresh_fields();\n\t},\n\n\tcalculate_discount_amount: function() {\n\t\tif (frappe.meta.get_docfield(this.frm.doc.doctype, \"discount_amount\")) {\n\t\t\tthis.calculate_item_values();\n\t\t\tthis.calculate_net_total();\n\t\t\tthis.set_discount_amount();\n\t\t\tthis.apply_discount_amount();\n\t\t}\n\t},\n\n\t_calculate_taxes_and_totals: function() {\n\t\tthis.validate_conversion_rate();\n\t\tthis.calculate_item_values();\n\t\tthis.initialize_taxes();\n\t\tthis.determine_exclusive_rate();\n\t\tthis.calculate_net_total();\n\t\tthis.calculate_taxes();\n\t\tthis.manipulate_grand_total_for_inclusive_tax();\n\t\tthis.calculate_totals();\n\t\tthis._cleanup();\n\t},\n\n\tvalidate_conversion_rate: function() {\n\t\tthis.frm.doc.conversion_rate = flt(this.frm.doc.conversion_rate, (cur_frm) ? precision(\"conversion_rate\") : 9);\n\t\tvar conversion_rate_label = frappe.meta.get_label(this.frm.doc.doctype, \"conversion_rate\",\n\t\t\tthis.frm.doc.name);\n\t\tvar company_currency = this.get_company_currency();\n\n\t\tif(!this.frm.doc.conversion_rate) {\n\t\t\tif(this.frm.doc.currency == company_currency) {\n\t\t\t\tthis.frm.set_value(\"conversion_rate\", 1);\n\t\t\t} else {\n\t\t\t\tconst subs =  [conversion_rate_label, this.frm.doc.currency, company_currency];\n\t\t\t\tconst err_message = __('{0} is mandatory. Maybe Currency Exchange record is not created for {1} to {2}', subs);\n\t\t\t\tfrappe.throw(err_message);\n\t\t\t}\n\t\t}\n\t},\n\n\tcalculate_item_values: function() {\n\t\tlet me = this;\n\t\tif (!this.discount_amount_applied) {\n\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\t\tfrappe.model.round_floats_in(item);\n\t\t\t\titem.net_rate = item.rate;\n\n\t\t\t\tif ((!item.qty) && me.frm.doc.is_return) {\n\t\t\t\t\titem.amount = flt(item.rate * -1, precision(\"amount\", item));\n\t\t\t\t} \n\t\t\t\telse if (item.uom == 'Percent') {\n\t\t\t\t\titem.amount = flt((item.rate * item.qty)/100, precision(\"amount\", item)); //changes only for civil tech\n\t\t\t\t} else {\n\t\t\t\t\titem.amount = flt(item.rate * item.qty, precision(\"amount\", item));\n\t\t\t\t}\n\n\t\t\t\titem.net_amount = item.amount;\n\t\t\t\titem.item_tax_amount = 0.0;\n\t\t\t\titem.total_weight = flt(item.weight_per_unit * item.stock_qty);\n\n\t\t\t\tme.set_in_company_currency(item, [\"price_list_rate\", \"rate\", \"amount\", \"net_rate\", \"net_amount\"]);\n\t\t\t});\n\t\t}\n\t},\n\n\tset_in_company_currency: function(doc, fields) {\n\t\tvar me = this;\n\t\t$.each(fields, function(i, f) {\n\t\t\tdoc[\"base_\"+f] = flt(flt(doc[f], precision(f, doc)) * me.frm.doc.conversion_rate, precision(\"base_\" + f, doc));\n\t\t});\n\t},\n\n\tinitialize_taxes: function() {\n\t\tvar me = this;\n\n\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\ttax.item_wise_tax_detail = {};\n\t\t\tvar tax_fields = [\"total\", \"tax_amount_after_discount_amount\",\n\t\t\t\t\"tax_amount_for_current_item\", \"grand_total_for_current_item\",\n\t\t\t\t\"tax_fraction_for_current_item\", \"grand_total_fraction_for_current_item\"];\n\n\t\t\tif (cstr(tax.charge_type) != \"Actual\" &&\n\t\t\t\t!(me.discount_amount_applied && me.frm.doc.apply_discount_on==\"Grand Total\")) {\n\t\t\t\ttax_fields.push(\"tax_amount\");\n\t\t\t}\n\n\t\t\t$.each(tax_fields, function(i, fieldname) { tax[fieldname] = 0.0; });\n\n\t\t\tif (!this.discount_amount_applied && cur_frm) {\n\t\t\t\tcur_frm.cscript.validate_taxes_and_charges(tax.doctype, tax.name);\n\t\t\t\tme.validate_inclusive_tax(tax);\n\t\t\t}\n\t\t\tfrappe.model.round_floats_in(tax);\n\t\t});\n\t},\n\n\tfetch_round_off_accounts: function() {\n\t\tlet me = this;\n\t\tfrappe.flags.round_off_applicable_accounts = [];\n\n\t\tif (me.frm.doc.company) {\n\t\t\treturn frappe.call({\n\t\t\t\t\"method\": \"erpnext.controllers.taxes_and_totals.get_round_off_applicable_accounts\",\n\t\t\t\t\"args\": {\n\t\t\t\t\t\"company\": me.frm.doc.company,\n\t\t\t\t\t\"account_list\": frappe.flags.round_off_applicable_accounts\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tfrappe.flags.round_off_applicable_accounts.push(...r.message);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tdetermine_exclusive_rate: function() {\n\t\tvar me = this;\n\n\t\tvar has_inclusive_tax = false;\n\t\t$.each(me.frm.doc[\"taxes\"] || [], function(i, row) {\n\t\t\tif(cint(row.included_in_print_rate)) has_inclusive_tax = true;\n\t\t});\n\t\tif(has_inclusive_tax==false) return;\n\n\t\t$.each(me.frm.doc[\"items\"] || [], function(n, item) {\n\t\t\tvar item_tax_map = me._load_item_tax_rate(item.item_tax_rate);\n\t\t\tvar cumulated_tax_fraction = 0.0;\n\t\t\tvar total_inclusive_tax_amount_per_qty = 0;\n\t\t\t$.each(me.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\tvar current_tax_fraction = me.get_current_tax_fraction(tax, item_tax_map);\n\t\t\t\ttax.tax_fraction_for_current_item = current_tax_fraction[0];\n\t\t\t\tvar inclusive_tax_amount_per_qty = current_tax_fraction[1];\n\n\t\t\t\tif(i==0) {\n\t\t\t\t\ttax.grand_total_fraction_for_current_item = 1 + tax.tax_fraction_for_current_item;\n\t\t\t\t} else {\n\t\t\t\t\ttax.grand_total_fraction_for_current_item =\n\t\t\t\t\t\tme.frm.doc[\"taxes\"][i-1].grand_total_fraction_for_current_item +\n\t\t\t\t\t\ttax.tax_fraction_for_current_item;\n\t\t\t\t}\n\n\t\t\t\tcumulated_tax_fraction += tax.tax_fraction_for_current_item;\n\t\t\t\ttotal_inclusive_tax_amount_per_qty += inclusive_tax_amount_per_qty * flt(item.qty);\n\t\t\t});\n\n\t\t\tif(!me.discount_amount_applied && item.qty && (total_inclusive_tax_amount_per_qty || cumulated_tax_fraction)) {\n\t\t\t\tvar amount = flt(item.amount) - total_inclusive_tax_amount_per_qty;\n\t\t\t\titem.net_amount = flt(amount / (1 + cumulated_tax_fraction));\n\t\t\t\titem.net_rate = item.qty ? flt(item.net_amount / item.qty, precision(\"net_rate\", item)) : 0;\n\n\t\t\t\tme.set_in_company_currency(item, [\"net_rate\", \"net_amount\"]);\n\t\t\t}\n\t\t});\n\t},\n\n\tget_current_tax_fraction: function(tax, item_tax_map) {\n\t\t// Get tax fraction for calculating tax exclusive amount\n\t\t// from tax inclusive amount\n\t\tvar current_tax_fraction = 0.0;\n\t\tvar inclusive_tax_amount_per_qty = 0;\n\n\t\tif(cint(tax.included_in_print_rate)) {\n\t\t\tvar tax_rate = this._get_tax_rate(tax, item_tax_map);\n\n\t\t\tif(tax.charge_type == \"On Net Total\") {\n\t\t\t\tcurrent_tax_fraction = (tax_rate / 100.0);\n\n\t\t\t} else if(tax.charge_type == \"On Previous Row Amount\") {\n\t\t\t\tcurrent_tax_fraction = (tax_rate / 100.0) *\n\t\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].tax_fraction_for_current_item;\n\n\t\t\t} else if(tax.charge_type == \"On Previous Row Total\") {\n\t\t\t\tcurrent_tax_fraction = (tax_rate / 100.0) *\n\t\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].grand_total_fraction_for_current_item;\n\t\t\t} else if (tax.charge_type == \"On Item Quantity\") {\n\t\t\t\tinclusive_tax_amount_per_qty = flt(tax_rate);\n\t\t\t}\n\t\t}\n\n\t\tif(tax.add_deduct_tax && tax.add_deduct_tax == \"Deduct\") {\n\t\t\tcurrent_tax_fraction *= -1;\n\t\t\tinclusive_tax_amount_per_qty *= -1;\n\t\t}\n\t\treturn [current_tax_fraction, inclusive_tax_amount_per_qty];\n\t},\n\n\t_get_tax_rate: function(tax, item_tax_map) {\n\t\treturn (Object.keys(item_tax_map).indexOf(tax.account_head) != -1) ?\n\t\t\tflt(item_tax_map[tax.account_head], precision(\"rate\", tax)) : tax.rate;\n\t},\n\n\tcalculate_net_total: function() {\n\t\tvar me = this;\n\t\tthis.frm.doc.total_qty = this.frm.doc.total = this.frm.doc.base_total = this.frm.doc.net_total = this.frm.doc.base_net_total = 0.0;\n\n\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\tme.frm.doc.total += item.amount;\n\t\t\tme.frm.doc.total_qty += item.qty;\n\t\t\tme.frm.doc.base_total += item.base_amount;\n\t\t\tme.frm.doc.net_total += item.net_amount;\n\t\t\tme.frm.doc.base_net_total += item.base_net_amount;\n\t\t\t});\n\n\t\tfrappe.model.round_floats_in(this.frm.doc, [\"total\", \"base_total\", \"net_total\", \"base_net_total\"]);\n\t},\n\n\tadd_taxes_from_item_tax_template: function(item_tax_map) {\n\t\tlet me = this;\n\n\t\tif (item_tax_map && cint(frappe.defaults.get_default(\"add_taxes_from_item_tax_template\"))) {\n\t\t\tif (typeof (item_tax_map) == \"string\") {\n\t\t\t\titem_tax_map = JSON.parse(item_tax_map);\n\t\t\t}\n\n\t\t\t$.each(item_tax_map, function(tax, rate) {\n\t\t\t\tlet found = (me.frm.doc.taxes || []).find(d => d.account_head === tax);\n\t\t\t\tif (!found) {\n\t\t\t\t\tlet child = frappe.model.add_child(me.frm.doc, \"taxes\");\n\t\t\t\t\tchild.charge_type = \"On Net Total\";\n\t\t\t\t\tchild.account_head = tax;\n\t\t\t\t\tchild.rate = 0;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tcalculate_taxes: function() {\n\t\tvar me = this;\n\t\tthis.frm.doc.rounding_adjustment = 0;\n\t\tvar actual_tax_dict = {};\n\n\t\t// maintain actual tax rate based on idx\n\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\tif (tax.charge_type == \"Actual\") {\n\t\t\t\tactual_tax_dict[tax.idx] = flt(tax.tax_amount, precision(\"tax_amount\", tax));\n\t\t\t}\n\t\t});\n\n\t\t$.each(this.frm.doc[\"items\"] || [], function(n, item) {\n\t\t\tvar item_tax_map = me._load_item_tax_rate(item.item_tax_rate);\n\t\t\t$.each(me.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\t// tax_amount represents the amount of tax for the current step\n\t\t\t\tvar current_tax_amount = me.get_current_tax_amount(item, tax, item_tax_map);\n\n\t\t\t\t// Adjust divisional loss to the last item\n\t\t\t\tif (tax.charge_type == \"Actual\") {\n\t\t\t\t\tactual_tax_dict[tax.idx] -= current_tax_amount;\n\t\t\t\t\tif (n == me.frm.doc[\"items\"].length - 1) {\n\t\t\t\t\t\tcurrent_tax_amount += actual_tax_dict[tax.idx];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// accumulate tax amount into tax.tax_amount\n\t\t\t\tif (tax.charge_type != \"Actual\" &&\n\t\t\t\t\t!(me.discount_amount_applied && me.frm.doc.apply_discount_on==\"Grand Total\")) {\n\t\t\t\t\ttax.tax_amount += current_tax_amount;\n\t\t\t\t}\n\n\t\t\t\t// store tax_amount for current item as it will be used for\n\t\t\t\t// charge type = 'On Previous Row Amount'\n\t\t\t\ttax.tax_amount_for_current_item = current_tax_amount;\n\n\t\t\t\t// tax amount after discount amount\n\t\t\t\ttax.tax_amount_after_discount_amount += current_tax_amount;\n\n\t\t\t\t// for buying\n\t\t\t\tif(tax.category) {\n\t\t\t\t\t// if just for valuation, do not add the tax amount in total\n\t\t\t\t\t// hence, setting it as 0 for further steps\n\t\t\t\t\tcurrent_tax_amount = (tax.category == \"Valuation\") ? 0.0 : current_tax_amount;\n\n\t\t\t\t\tcurrent_tax_amount *= (tax.add_deduct_tax == \"Deduct\") ? -1.0 : 1.0;\n\t\t\t\t}\n\n\t\t\t\t// note: grand_total_for_current_item contains the contribution of\n\t\t\t\t// item's amount, previously applied tax and the current tax on that item\n\t\t\t\tif(i==0) {\n\t\t\t\t\ttax.grand_total_for_current_item = flt(item.net_amount + current_tax_amount);\n\t\t\t\t} else {\n\t\t\t\t\ttax.grand_total_for_current_item =\n\t\t\t\t\t\tflt(me.frm.doc[\"taxes\"][i-1].grand_total_for_current_item + current_tax_amount);\n\t\t\t\t}\n\n\t\t\t\t// set precision in the last item iteration\n\t\t\t\tif (n == me.frm.doc[\"items\"].length - 1) {\n\t\t\t\t\tme.round_off_totals(tax);\n\t\t\t\t\tme.set_in_company_currency(tax,\n\t\t\t\t\t\t[\"tax_amount\", \"tax_amount_after_discount_amount\"]);\n\n\t\t\t\t\tme.round_off_base_values(tax);\n\n\t\t\t\t\t// in tax.total, accumulate grand total for each item\n\t\t\t\t\tme.set_cumulative_total(i, tax);\n\n\t\t\t\t\tme.set_in_company_currency(tax, [\"total\"]);\n\n\t\t\t\t\t// adjust Discount Amount loss in last tax iteration\n\t\t\t\t\tif ((i == me.frm.doc[\"taxes\"].length - 1) && me.discount_amount_applied\n\t\t\t\t\t\t&& me.frm.doc.apply_discount_on == \"Grand Total\" && me.frm.doc.discount_amount) {\n\t\t\t\t\t\tme.frm.doc.rounding_adjustment = flt(me.frm.doc.grand_total -\n\t\t\t\t\t\t\tflt(me.frm.doc.discount_amount) - tax.total, precision(\"rounding_adjustment\"));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t},\n\n\tset_cumulative_total: function(row_idx, tax) {\n\t\tvar tax_amount = tax.tax_amount_after_discount_amount;\n\t\tif (tax.category == 'Valuation') {\n\t\t\ttax_amount = 0;\n\t\t}\n\n\t\tif (tax.add_deduct_tax == \"Deduct\") { tax_amount = -1*tax_amount; }\n\n\t\tif(row_idx==0) {\n\t\t\ttax.total = flt(this.frm.doc.net_total + tax_amount, precision(\"total\", tax));\n\t\t} else {\n\t\t\ttax.total = flt(this.frm.doc[\"taxes\"][row_idx-1].total + tax_amount, precision(\"total\", tax));\n\t\t}\n\t},\n\n\t_load_item_tax_rate: function(item_tax_rate) {\n\t\treturn item_tax_rate ? JSON.parse(item_tax_rate) : {};\n\t},\n\n\tget_current_tax_amount: function(item, tax, item_tax_map) {\n\t\tvar tax_rate = this._get_tax_rate(tax, item_tax_map);\n\t\tvar current_tax_amount = 0.0;\n\n\t\t// To set row_id by default as previous row.\n\t\tif([\"On Previous Row Amount\", \"On Previous Row Total\"].includes(tax.charge_type)) {\n\t\t\tif (tax.idx === 1) {\n\t\t\t\tfrappe.throw(\n\t\t\t\t\t__(\"Cannot select charge type as 'On Previous Row Amount' or 'On Previous Row Total' for first row\"));\n\t\t\t}\n\t\t\tif (!tax.row_id) {\n\t\t\t\ttax.row_id = tax.idx - 1;\n\t\t\t}\n\t\t}\n\t\tif(tax.charge_type == \"Actual\") {\n\t\t\t// distribute the tax amount proportionally to each item row\n\t\t\tvar actual = flt(tax.tax_amount, precision(\"tax_amount\", tax));\n\t\t\tcurrent_tax_amount = this.frm.doc.net_total ?\n\t\t\t\t((item.net_amount / this.frm.doc.net_total) * actual) : 0.0;\n\n\t\t} else if(tax.charge_type == \"On Net Total\") {\n\t\t\tcurrent_tax_amount = (tax_rate / 100.0) * item.net_amount;\n\t\t} else if(tax.charge_type == \"On Previous Row Amount\") {\n\t\t\tcurrent_tax_amount = (tax_rate / 100.0) *\n\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].tax_amount_for_current_item;\n\n\t\t} else if(tax.charge_type == \"On Previous Row Total\") {\n\t\t\tcurrent_tax_amount = (tax_rate / 100.0) *\n\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].grand_total_for_current_item;\n\t\t} else if (tax.charge_type == \"On Item Quantity\") {\n\t\t\tcurrent_tax_amount = tax_rate * item.qty;\n\t\t}\n\n\t\tthis.set_item_wise_tax(item, tax, tax_rate, current_tax_amount);\n\n\t\treturn current_tax_amount;\n\t},\n\n\tset_item_wise_tax: function(item, tax, tax_rate, current_tax_amount) {\n\t\t// store tax breakup for each item\n\t\tlet tax_detail = tax.item_wise_tax_detail;\n\t\tlet key = item.item_code || item.item_name;\n\n\t\tif(typeof (tax_detail) == \"string\") {\n\t\t\ttax.item_wise_tax_detail = JSON.parse(tax.item_wise_tax_detail);\n\t\t\ttax_detail = tax.item_wise_tax_detail;\n\t\t}\n\n\t\tlet item_wise_tax_amount = current_tax_amount * this.frm.doc.conversion_rate;\n\t\tif (tax_detail && tax_detail[key])\n\t\t\titem_wise_tax_amount += tax_detail[key][1];\n\n\t\ttax_detail[key] = [tax_rate, flt(item_wise_tax_amount, precision(\"base_tax_amount\", tax))];\n\t},\n\n\tround_off_totals: function(tax) {\n\t\tif (frappe.flags.round_off_applicable_accounts.includes(tax.account_head)) {\n\t\t\ttax.tax_amount= Math.round(tax.tax_amount);\n\t\t\ttax.tax_amount_after_discount_amount = Math.round(tax.tax_amount_after_discount_amount);\n\t\t}\n\n\t\ttax.tax_amount = flt(tax.tax_amount, precision(\"tax_amount\", tax));\n\t\ttax.tax_amount_after_discount_amount = flt(tax.tax_amount_after_discount_amount, precision(\"tax_amount\", tax));\n\t},\n\n\tround_off_base_values: function(tax) {\n\t\tif (frappe.flags.round_off_applicable_accounts.includes(tax.account_head)) {\n\t\t\ttax.base_tax_amount= Math.round(tax.base_tax_amount);\n\t\t\ttax.base_tax_amount_after_discount_amount = Math.round(tax.base_tax_amount_after_discount_amount);\n\t\t}\n\t},\n\n\tmanipulate_grand_total_for_inclusive_tax: function() {\n\t\tvar me = this;\n\t\t// if fully inclusive taxes and diff\n\t\tif (this.frm.doc[\"taxes\"] && this.frm.doc[\"taxes\"].length) {\n\t\t\tvar any_inclusive_tax = false;\n\t\t\t$.each(this.frm.doc.taxes || [], function(i, d) {\n\t\t\t\tif(cint(d.included_in_print_rate)) any_inclusive_tax = true;\n\t\t\t});\n\t\t\tif (any_inclusive_tax) {\n\t\t\t\tvar last_tax = me.frm.doc[\"taxes\"].slice(-1)[0];\n\t\t\t\tvar non_inclusive_tax_amount = frappe.utils.sum($.map(this.frm.doc.taxes || [],\n\t\t\t\t\tfunction(d) {\n\t\t\t\t\t\tif(!d.included_in_print_rate) {\n\t\t\t\t\t\t\treturn flt(d.tax_amount_after_discount_amount);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t));\n\t\t\t\tvar diff = me.frm.doc.total + non_inclusive_tax_amount\n\t\t\t\t\t- flt(last_tax.total, precision(\"grand_total\"));\n\n\t\t\t\tif(me.discount_amount_applied && me.frm.doc.discount_amount) {\n\t\t\t\t\tdiff -= flt(me.frm.doc.discount_amount);\n\t\t\t\t}\n\n\t\t\t\tdiff = flt(diff, precision(\"rounding_adjustment\"));\n\n\t\t\t\tif ( diff && Math.abs(diff) <= (5.0 / Math.pow(10, precision(\"tax_amount\", last_tax))) ) {\n\t\t\t\t\tme.frm.doc.rounding_adjustment = diff;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tcalculate_totals: function() {\n\t\t// Changing sequence can because of rounding adjustment issue and on-screen discrepancy\n\t\tvar me = this;\n\t\tvar tax_count = this.frm.doc[\"taxes\"] ? this.frm.doc[\"taxes\"].length : 0;\n\t\tthis.frm.doc.grand_total = flt(tax_count\n\t\t\t? this.frm.doc[\"taxes\"][tax_count - 1].total + flt(this.frm.doc.rounding_adjustment)\n\t\t\t: this.frm.doc.net_total);\n\n\t\tif(in_list([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\", \"POS Invoice\", \"Proforma Invoice\"], this.frm.doc.doctype)) {\n\t\t\tthis.frm.doc.base_grand_total = (this.frm.doc.total_taxes_and_charges) ?\n\t\t\t\tflt(this.frm.doc.grand_total * this.frm.doc.conversion_rate) : this.frm.doc.base_net_total;\n\t\t} else {\n\t\t\t// other charges added/deducted\n\t\t\tthis.frm.doc.taxes_and_charges_added = this.frm.doc.taxes_and_charges_deducted = 0.0;\n\t\t\tif(tax_count) {\n\t\t\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\t\tif (in_list([\"Valuation and Total\", \"Total\"], tax.category)) {\n\t\t\t\t\t\tif(tax.add_deduct_tax == \"Add\") {\n\t\t\t\t\t\t\tme.frm.doc.taxes_and_charges_added += flt(tax.tax_amount_after_discount_amount);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tme.frm.doc.taxes_and_charges_deducted += flt(tax.tax_amount_after_discount_amount);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tfrappe.model.round_floats_in(this.frm.doc,\n\t\t\t\t\t[\"taxes_and_charges_added\", \"taxes_and_charges_deducted\"]);\n\t\t\t}\n\n\t\t\tthis.frm.doc.base_grand_total = flt((this.frm.doc.taxes_and_charges_added || this.frm.doc.taxes_and_charges_deducted) ?\n\t\t\t\tflt(this.frm.doc.grand_total * this.frm.doc.conversion_rate) : this.frm.doc.base_net_total);\n\n\t\t\tthis.set_in_company_currency(this.frm.doc,\n\t\t\t\t[\"taxes_and_charges_added\", \"taxes_and_charges_deducted\"]);\n\t\t}\n\n\t\tthis.frm.doc.total_taxes_and_charges = flt(this.frm.doc.grand_total - this.frm.doc.net_total\n\t\t\t- flt(this.frm.doc.rounding_adjustment), precision(\"total_taxes_and_charges\"));\n\n\t\tthis.set_in_company_currency(this.frm.doc, [\"total_taxes_and_charges\", \"rounding_adjustment\"]);\n\n\t\t// Round grand total as per precision\n\t\tfrappe.model.round_floats_in(this.frm.doc, [\"grand_total\", \"base_grand_total\"]);\n\n\t\t// rounded totals\n\t\tthis.set_rounded_total();\n\t},\n\n\tset_rounded_total: function() {\n\t\tvar disable_rounded_total = 0;\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype, \"disable_rounded_total\", this.frm.doc.name)) {\n\t\t\tdisable_rounded_total = this.frm.doc.disable_rounded_total;\n\t\t} else if (frappe.sys_defaults.disable_rounded_total) {\n\t\t\tdisable_rounded_total = frappe.sys_defaults.disable_rounded_total;\n\t\t}\n\n\t\tif (cint(disable_rounded_total)) {\n\t\t\tthis.frm.doc.rounded_total = 0;\n\t\t\tthis.frm.doc.base_rounded_total = 0;\n\t\t\treturn;\n\t\t}\n\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype, \"rounded_total\", this.frm.doc.name)) {\n\t\t\tthis.frm.doc.rounded_total = round_based_on_smallest_currency_fraction(this.frm.doc.grand_total,\n\t\t\t\tthis.frm.doc.currency, precision(\"rounded_total\"));\n\t\t\tthis.frm.doc.rounding_adjustment += flt(this.frm.doc.rounded_total - this.frm.doc.grand_total,\n\t\t\t\tprecision(\"rounding_adjustment\"));\n\n\t\t\tthis.set_in_company_currency(this.frm.doc, [\"rounding_adjustment\", \"rounded_total\"]);\n\t\t}\n\t},\n\n\t_cleanup: function() {\n\t\tthis.frm.doc.base_in_words = this.frm.doc.in_words = \"\";\n\n\t\tif(this.frm.doc[\"items\"] && this.frm.doc[\"items\"].length) {\n\t\t\tif(!frappe.meta.get_docfield(this.frm.doc[\"items\"][0].doctype, \"item_tax_amount\", this.frm.doctype)) {\n\t\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\t\t\tdelete item[\"item_tax_amount\"];\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif(this.frm.doc[\"taxes\"] && this.frm.doc[\"taxes\"].length) {\n\t\t\tvar temporary_fields = [\"tax_amount_for_current_item\", \"grand_total_for_current_item\",\n\t\t\t\t\"tax_fraction_for_current_item\", \"grand_total_fraction_for_current_item\"];\n\n\t\t\tif(!frappe.meta.get_docfield(this.frm.doc[\"taxes\"][0].doctype, \"tax_amount_after_discount_amount\", this.frm.doctype)) {\n\t\t\t\ttemporary_fields.push(\"tax_amount_after_discount_amount\");\n\t\t\t}\n\n\t\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\t$.each(temporary_fields, function(i, fieldname) {\n\t\t\t\t\tdelete tax[fieldname];\n\t\t\t\t});\n\n\t\t\t\ttax.item_wise_tax_detail = JSON.stringify(tax.item_wise_tax_detail);\n\t\t\t});\n\t\t}\n\t},\n\n\tset_discount_amount: function() {\n\t\tif(this.frm.doc.additional_discount_percentage) {\n\t\t\tthis.frm.doc.discount_amount = flt(flt(this.frm.doc[frappe.scrub(this.frm.doc.apply_discount_on)])\n\t\t\t\t* this.frm.doc.additional_discount_percentage / 100, precision(\"discount_amount\"));\n\t\t}\n\t},\n\n\tapply_discount_amount: function() {\n\t\tvar me = this;\n\t\tvar distributed_amount = 0.0;\n\t\tthis.frm.doc.base_discount_amount = 0.0;\n\n\t\tif (this.frm.doc.discount_amount) {\n\t\t\tif(!this.frm.doc.apply_discount_on)\n\t\t\t\tfrappe.throw(__(\"Please select Apply Discount On\"));\n\n\t\t\tthis.frm.doc.base_discount_amount = flt(this.frm.doc.discount_amount * this.frm.doc.conversion_rate,\n\t\t\t\tprecision(\"base_discount_amount\"));\n\n\t\t\tvar total_for_discount_amount = this.get_total_for_discount_amount();\n\t\t\tvar net_total = 0;\n\t\t\t// calculate item amount after Discount Amount\n\t\t\tif (total_for_discount_amount) {\n\t\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\t\t\tdistributed_amount = flt(me.frm.doc.discount_amount) * item.net_amount / total_for_discount_amount;\n\t\t\t\t\titem.net_amount = flt(item.net_amount - distributed_amount,\n\t\t\t\t\t\tprecision(\"base_amount\", item));\n\t\t\t\t\tnet_total += item.net_amount;\n\n\t\t\t\t\t// discount amount rounding loss adjustment if no taxes\n\t\t\t\t\tif ((!(me.frm.doc.taxes || []).length || total_for_discount_amount==me.frm.doc.net_total || (me.frm.doc.apply_discount_on == \"Net Total\"))\n\t\t\t\t\t\t\t&& i == (me.frm.doc.items || []).length - 1) {\n\t\t\t\t\t\tvar discount_amount_loss = flt(me.frm.doc.net_total - net_total\n\t\t\t\t\t\t\t- me.frm.doc.discount_amount, precision(\"net_total\"));\n\t\t\t\t\t\titem.net_amount = flt(item.net_amount + discount_amount_loss,\n\t\t\t\t\t\t\tprecision(\"net_amount\", item));\n\t\t\t\t\t}\n\t\t\t\t\titem.net_rate = item.qty ? flt(item.net_amount / item.qty, precision(\"net_rate\", item)) : 0;\n\t\t\t\t\tme.set_in_company_currency(item, [\"net_rate\", \"net_amount\"]);\n\t\t\t\t});\n\n\t\t\t\tthis.discount_amount_applied = true;\n\t\t\t\tthis._calculate_taxes_and_totals();\n\t\t\t}\n\t\t}\n\t},\n\n\tget_total_for_discount_amount: function() {\n\t\tif(this.frm.doc.apply_discount_on == \"Net Total\") {\n\t\t\treturn this.frm.doc.net_total;\n\t\t} else {\n\t\t\tvar total_actual_tax = 0.0;\n\t\t\tvar actual_taxes_dict = {};\n\n\t\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\tif (in_list([\"Actual\", \"On Item Quantity\"], tax.charge_type)) {\n\t\t\t\t\tvar tax_amount = (tax.category == \"Valuation\") ? 0.0 : tax.tax_amount;\n\t\t\t\t\ttax_amount *= (tax.add_deduct_tax == \"Deduct\") ? -1.0 : 1.0;\n\t\t\t\t\tactual_taxes_dict[tax.idx] = tax_amount;\n\t\t\t\t} else if (actual_taxes_dict[tax.row_id] !== null) {\n\t\t\t\t\tvar actual_tax_amount = flt(actual_taxes_dict[tax.row_id]) * flt(tax.rate) / 100;\n\t\t\t\t\tactual_taxes_dict[tax.idx] = actual_tax_amount;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t$.each(actual_taxes_dict, function(key, value) {\n\t\t\t\tif (value) total_actual_tax += value;\n\t\t\t});\n\n\t\t\treturn flt(this.frm.doc.grand_total - total_actual_tax, precision(\"grand_total\"));\n\t\t}\n\t},\n\n\tcalculate_total_advance: function(update_paid_amount) {\n\t\tvar total_allocated_amount = frappe.utils.sum($.map(this.frm.doc[\"advances\"] || [], function(adv) {\n\t\t\treturn flt(adv.allocated_amount, precision(\"allocated_amount\", adv));\n\t\t}));\n\t\tthis.frm.doc.total_advance = flt(total_allocated_amount, precision(\"total_advance\"));\n\n\t\tthis.calculate_outstanding_amount(update_paid_amount);\n\t},\n\n\tis_internal_invoice: function() {\n\t\tif (['Sales Invoice', 'Purchase Invoice'].includes(this.frm.doc.doctype)) {\n\t\t\tif (this.frm.doc.company === this.frm.doc.represents_company) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t},\n\n\tcalculate_outstanding_amount: function(update_paid_amount) {\n\t\t// NOTE:\n\t\t// paid_amount and write_off_amount is only for POS/Loyalty Point Redemption Invoice\n\t\t// total_advance is only for non POS Invoice\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype) && this.frm.doc.is_return){\n\t\t\tthis.calculate_paid_amount();\n\t\t}\n\n\t\tif (this.frm.doc.is_return || (this.frm.doc.docstatus > 0) || this.is_internal_invoice()) return;\n\n\t\tfrappe.model.round_floats_in(this.frm.doc, [\"grand_total\", \"total_advance\", \"write_off_amount\"]);\n\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\", \"Purchase Invoice\"], this.frm.doc.doctype)) {\n\t\t\tvar grand_total = this.frm.doc.rounded_total || this.frm.doc.grand_total;\n\n\t\t\tif(this.frm.doc.party_account_currency == this.frm.doc.currency) {\n\t\t\t\tvar total_amount_to_pay = flt((grand_total - this.frm.doc.total_advance\n\t\t\t\t\t- this.frm.doc.write_off_amount), precision(\"grand_total\"));\n\t\t\t} else {\n\t\t\t\tvar total_amount_to_pay = flt(\n\t\t\t\t\t(flt(grand_total*this.frm.doc.conversion_rate, precision(\"grand_total\"))\n\t\t\t\t\t\t- this.frm.doc.total_advance - this.frm.doc.base_write_off_amount),\n\t\t\t\t\tprecision(\"base_grand_total\")\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tfrappe.model.round_floats_in(this.frm.doc, [\"paid_amount\"]);\n\t\t\tthis.set_in_company_currency(this.frm.doc, [\"paid_amount\"]);\n\n\t\t\tif(this.frm.refresh_field){\n\t\t\t\tthis.frm.refresh_field(\"paid_amount\");\n\t\t\t\tthis.frm.refresh_field(\"base_paid_amount\");\n\t\t\t}\n\n\t\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype)) {\n\t\t\t\tlet total_amount_for_payment = (this.frm.doc.redeem_loyalty_points && this.frm.doc.loyalty_amount)\n\t\t\t\t\t? flt(total_amount_to_pay - this.frm.doc.loyalty_amount, precision(\"base_grand_total\"))\n\t\t\t\t\t: total_amount_to_pay;\n\t\t\t\tthis.set_default_payment(total_amount_for_payment, update_paid_amount);\n\t\t\t\tthis.calculate_paid_amount();\n\t\t\t}\n\t\t\tthis.calculate_change_amount();\n\n\t\t\tvar paid_amount = (this.frm.doc.party_account_currency == this.frm.doc.currency) ?\n\t\t\t\tthis.frm.doc.paid_amount : this.frm.doc.base_paid_amount;\n\t\t\tthis.frm.doc.outstanding_amount =  flt(total_amount_to_pay - flt(paid_amount) +\n\t\t\t\tflt(this.frm.doc.change_amount * this.frm.doc.conversion_rate), precision(\"outstanding_amount\"));\n\t\t}\n\t},\n\n\tupdate_paid_amount_for_return: function() {\n\t\tvar grand_total = this.frm.doc.rounded_total || this.frm.doc.grand_total;\n\n\t\tif(this.frm.doc.party_account_currency == this.frm.doc.currency) {\n\t\t\tvar total_amount_to_pay = flt((grand_total - this.frm.doc.total_advance\n\t\t\t\t- this.frm.doc.write_off_amount), precision(\"grand_total\"));\n\t\t} else {\n\t\t\tvar total_amount_to_pay = flt(\n\t\t\t\t(flt(grand_total*this.frm.doc.conversion_rate, precision(\"grand_total\"))\n\t\t\t\t\t- this.frm.doc.total_advance - this.frm.doc.base_write_off_amount),\n\t\t\t\tprecision(\"base_grand_total\")\n\t\t\t);\n\t\t}\n\n\t\tthis.frm.doc.payments.find(pay => {\n\t\t\tif (pay.default) {\n\t\t\t\tpay.amount = total_amount_to_pay;\n\t\t\t} else {\n\t\t\t\tpay.amount = 0.0\n\t\t\t}\n\t\t});\n\t\tthis.frm.refresh_fields();\n\n\t\tthis.calculate_paid_amount();\n\t},\n\n\tset_default_payment: function(total_amount_to_pay, update_paid_amount) {\n\t\tvar me = this;\n\t\tvar payment_status = true;\n\t\tif(this.frm.doc.is_pos && (update_paid_amount===undefined || update_paid_amount)) {\n\t\t\t$.each(this.frm.doc['payments'] || [], function(index, data) {\n\t\t\t\tif(data.default && payment_status && total_amount_to_pay > 0) {\n\t\t\t\t\tlet base_amount = flt(total_amount_to_pay, precision(\"base_amount\", data));\n\t\t\t\t\tfrappe.model.set_value(data.doctype, data.name, \"base_amount\", base_amount);\n\t\t\t\t\tlet amount = flt(total_amount_to_pay / me.frm.doc.conversion_rate, precision(\"amount\", data));\n\t\t\t\t\tfrappe.model.set_value(data.doctype, data.name, \"amount\", amount);\n\t\t\t\t\tpayment_status = false;\n\t\t\t\t} else if(me.frm.doc.paid_amount) {\n\t\t\t\t\tfrappe.model.set_value(data.doctype, data.name, \"amount\", 0.0);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tcalculate_paid_amount: function() {\n\t\tvar me = this;\n\t\tvar paid_amount = 0.0;\n\t\tvar base_paid_amount = 0.0;\n\t\tif(this.frm.doc.is_pos) {\n\t\t\t$.each(this.frm.doc['payments'] || [], function(index, data){\n\t\t\t\tdata.base_amount = flt(data.amount * me.frm.doc.conversion_rate, precision(\"base_amount\", data));\n\t\t\t\tpaid_amount += data.amount;\n\t\t\t\tbase_paid_amount += data.base_amount;\n\t\t\t});\n\t\t} else if(!this.frm.doc.is_return){\n\t\t\tthis.frm.doc.payments = [];\n\t\t}\n\t\tif (this.frm.doc.redeem_loyalty_points && this.frm.doc.loyalty_amount) {\n\t\t\tbase_paid_amount += this.frm.doc.loyalty_amount;\n\t\t\tpaid_amount += flt(this.frm.doc.loyalty_amount / me.frm.doc.conversion_rate, precision(\"paid_amount\"));\n\t\t}\n\n\t\tthis.frm.set_value('paid_amount', flt(paid_amount, precision(\"paid_amount\")));\n\t\tthis.frm.set_value('base_paid_amount', flt(base_paid_amount, precision(\"base_paid_amount\")));\n\t},\n\n\tcalculate_change_amount: function(){\n\t\tthis.frm.doc.change_amount = 0.0;\n\t\tthis.frm.doc.base_change_amount = 0.0;\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype)\n\t\t\t&& this.frm.doc.paid_amount > this.frm.doc.grand_total && !this.frm.doc.is_return) {\n\n\t\t\tvar payment_types = $.map(this.frm.doc.payments, function(d) { return d.type; });\n\t\t\tif (in_list(payment_types, 'Cash')) {\n\t\t\t\tvar grand_total = this.frm.doc.rounded_total || this.frm.doc.grand_total;\n\t\t\t\tvar base_grand_total = this.frm.doc.base_rounded_total || this.frm.doc.base_grand_total;\n\n\t\t\t\tthis.frm.doc.change_amount = flt(this.frm.doc.paid_amount - grand_total +\n\t\t\t\t\tthis.frm.doc.write_off_amount, precision(\"change_amount\"));\n\n\t\t\t\tthis.frm.doc.base_change_amount = flt(this.frm.doc.base_paid_amount -\n\t\t\t\t\tbase_grand_total + this.frm.doc.base_write_off_amount,\n\t\t\t\t\tprecision(\"base_change_amount\"));\n\t\t\t}\n\t\t}\n\t},\n\n\tcalculate_write_off_amount: function(){\n\t\tif(this.frm.doc.paid_amount > this.frm.doc.grand_total){\n\t\t\tthis.frm.doc.write_off_amount = flt(this.frm.doc.grand_total - this.frm.doc.paid_amount\n\t\t\t\t+ this.frm.doc.change_amount, precision(\"write_off_amount\"));\n\n\t\t\tthis.frm.doc.base_write_off_amount = flt(this.frm.doc.write_off_amount * this.frm.doc.conversion_rate,\n\t\t\t\tprecision(\"base_write_off_amount\"));\n\t\t}else{\n\t\t\tthis.frm.doc.paid_amount = 0.0;\n\t\t}\n\t\tthis.calculate_outstanding_amount(false);\n\t}\n});\n", "// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nfrappe.provide('erpnext.accounts.dimensions');\n\nerpnext.TransactionController = erpnext.taxes_and_totals.extend({\n\tsetup: function() {\n\t\tthis._super();\n\t\tlet me = this;\n\t\tfrappe.flags.hide_serial_batch_dialog = true;\n\t\tfrappe.ui.form.on(this.frm.doctype + \" Item\", \"rate\", function(frm, cdt, cdn) {\n\t\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\t\tvar has_margin_field = frappe.meta.has_field(cdt, 'margin_type');\n\n\t\t\tfrappe.model.round_floats_in(item, [\"rate\", \"price_list_rate\"]);\n\n\t\t\tif(item.price_list_rate) {\n\t\t\t\tif(item.rate > item.price_list_rate && has_margin_field) {\n\t\t\t\t\t// if rate is greater than price_list_rate, set margin\n\t\t\t\t\t// or set discount\n\t\t\t\t\titem.discount_percentage = 0;\n\t\t\t\t\titem.margin_type = 'Amount';\n\t\t\t\t\titem.margin_rate_or_amount = flt(item.rate - item.price_list_rate,\n\t\t\t\t\t\tprecision(\"margin_rate_or_amount\", item));\n\t\t\t\t\titem.rate_with_margin = item.rate;\n\t\t\t\t} else {\n\t\t\t\t\titem.discount_percentage = flt((1 - item.rate / item.price_list_rate) * 100.0,\n\t\t\t\t\t\tprecision(\"discount_percentage\", item));\n\t\t\t\t\titem.discount_amount = flt(item.price_list_rate) - flt(item.rate);\n\t\t\t\t\titem.margin_type = '';\n\t\t\t\t\titem.margin_rate_or_amount = 0;\n\t\t\t\t\titem.rate_with_margin = 0;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\titem.discount_percentage = 0.0;\n\t\t\t\titem.margin_type = '';\n\t\t\t\titem.margin_rate_or_amount = 0;\n\t\t\t\titem.rate_with_margin = 0;\n\t\t\t}\n\t\t\titem.base_rate_with_margin = item.rate_with_margin * flt(frm.doc.conversion_rate);\n\n\t\t\tcur_frm.cscript.set_gross_profit(item);\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t\tcur_frm.cscript.calculate_stock_uom_rate(frm, cdt, cdn);\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"rate\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"tax_amount\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"row_id\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"included_in_print_rate\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.set_dynamic_labels();\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype, \"apply_discount_on\", function(frm) {\n\t\t\tif(frm.doc.additional_discount_percentage) {\n\t\t\t\tfrm.trigger(\"additional_discount_percentage\");\n\t\t\t} else {\n\t\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t\t}\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype, \"additional_discount_percentage\", function(frm) {\n\t\t\tif(!frm.doc.apply_discount_on) {\n\t\t\t\tfrappe.msgprint(__(\"Please set 'Apply Additional Discount On'\"));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tfrm.via_discount_percentage = true;\n\n\t\t\tif(frm.doc.additional_discount_percentage && frm.doc.discount_amount) {\n\t\t\t\t// Reset discount amount and net / grand total\n\t\t\t\tfrm.doc.discount_amount = 0;\n\t\t\t\tfrm.cscript.calculate_taxes_and_totals();\n\t\t\t}\n\n\t\t\tvar total = flt(frm.doc[frappe.model.scrub(frm.doc.apply_discount_on)]);\n\t\t\tvar discount_amount = flt(total*flt(frm.doc.additional_discount_percentage) / 100,\n\t\t\t\tprecision(\"discount_amount\"));\n\n\t\t\tfrm.set_value(\"discount_amount\", discount_amount)\n\t\t\t\t.then(() => delete frm.via_discount_percentage);\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype, \"discount_amount\", function(frm) {\n\t\t\tfrm.cscript.set_dynamic_labels();\n\n\t\t\tif (!frm.via_discount_percentage) {\n\t\t\t\tfrm.doc.additional_discount_percentage = 0;\n\t\t\t}\n\n\t\t\tfrm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype + \" Item\", {\n\t\t\titems_add: function(frm, cdt, cdn) {\n\t\t\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\t\t\tif (!item.warehouse && frm.doc.set_warehouse) {\n\t\t\t\t\titem.warehouse = frm.doc.set_warehouse;\n\t\t\t\t}\n\n\t\t\t\tif (!item.target_warehouse && frm.doc.set_target_warehouse) {\n\t\t\t\t\titem.target_warehouse = frm.doc.set_target_warehouse;\n\t\t\t\t}\n\n\t\t\t\tif (!item.from_warehouse && frm.doc.set_from_warehouse) {\n\t\t\t\t\titem.from_warehouse = frm.doc.set_from_warehouse;\n\t\t\t\t}\n\n\t\t\t\terpnext.accounts.dimensions.copy_dimension_from_first_row(frm, cdt, cdn, 'items');\n\t\t\t}\n\t\t});\n\n\t\tif(this.frm.fields_dict[\"items\"].grid.get_field('batch_no')) {\n\t\t\tthis.frm.set_query(\"batch_no\", \"items\", function(doc, cdt, cdn) {\n\t\t\t\treturn me.set_query_for_batch(doc, cdt, cdn);\n\t\t\t});\n\t\t}\n\n\t\tif(\n\t\t\tthis.frm.docstatus < 2\n\t\t\t&& this.frm.fields_dict[\"payment_terms_template\"]\n\t\t\t&& this.frm.fields_dict[\"payment_schedule\"]\n\t\t\t&& this.frm.doc.payment_terms_template\n\t\t\t&& !this.frm.doc.payment_schedule.length\n\t\t){\n\t\t\tthis.frm.trigger(\"payment_terms_template\");\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"taxes\"]) {\n\t\t\tthis[\"taxes_remove\"] = this.calculate_taxes_and_totals;\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"items\"]) {\n\t\t\tthis[\"items_remove\"] = this.calculate_net_weight;\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"recurring_print_format\"]) {\n\t\t\tthis.frm.set_query(\"recurring_print_format\", function(doc) {\n\t\t\t\treturn{\n\t\t\t\t\tfilters: [\n\t\t\t\t\t\t['Print Format', 'doc_type', '=', cur_frm.doctype],\n\t\t\t\t\t]\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"return_against\"]) {\n\t\t\tthis.frm.set_query(\"return_against\", function(doc) {\n\t\t\t\tvar filters = {\n\t\t\t\t\t\"docstatus\": 1,\n\t\t\t\t\t\"is_return\": 0,\n\t\t\t\t\t\"company\": doc.company\n\t\t\t\t};\n\t\t\t\tif (me.frm.fields_dict[\"customer\"] && doc.customer) filters[\"customer\"] = doc.customer;\n\t\t\t\tif (me.frm.fields_dict[\"supplier\"] && doc.supplier) filters[\"supplier\"] = doc.supplier;\n\n\t\t\t\treturn {\n\t\t\t\t\tfilters: filters\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\tif (this.frm.fields_dict[\"items\"].grid.get_field(\"expense_account\")) {\n\t\t\tthis.frm.set_query(\"expense_account\", \"items\", function(doc) {\n\t\t\t\treturn {\n\t\t\t\t\tfilters: {\n\t\t\t\t\t\t\"company\": doc.company\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype, \"pricing_rules\")) {\n\t\t\tthis.frm.set_indicator_formatter('pricing_rule', function(doc) {\n\t\t\t\treturn (doc.rule_applied) ? \"green\" : \"red\";\n\t\t\t});\n\t\t}\n\n\t\tlet batch_no_field = this.frm.get_docfield(\"items\", \"batch_no\");\n\t\tif (batch_no_field) {\n\t\t\tbatch_no_field.get_route_options_for_new_doc = function(row) {\n\t\t\t\treturn {\n\t\t\t\t\t\"item\": row.doc.item_code\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\n\t\tif (this.frm.fields_dict[\"items\"].grid.get_field('blanket_order')) {\n\t\t\tthis.frm.set_query(\"blanket_order\", \"items\", function(doc, cdt, cdn) {\n\t\t\t\tvar item = locals[cdt][cdn];\n\t\t\t\treturn {\n\t\t\t\t\tquery: \"erpnext.controllers.queries.get_blanket_orders\",\n\t\t\t\t\tfilters: {\n\t\t\t\t\t\t\"company\": doc.company,\n\t\t\t\t\t\t\"blanket_order_type\": doc.doctype === \"Sales Order\" ? \"Selling\" : \"Purchasing\",\n\t\t\t\t\t\t\"item\": item.item_code\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (this.frm.fields_dict.taxes_and_charges) {\n\t\t\tthis.frm.set_query(\"taxes_and_charges\", function() {\n\t\t\t\treturn {\n\t\t\t\t\tfilters: [\n\t\t\t\t\t\t['company', '=', me.frm.doc.company],\n\t\t\t\t\t\t['docstatus', '!=', 2]\n\t\t\t\t\t]\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t},\n\tonload: function() {\n\t\tvar me = this;\n\t\tif(this.frm.doc.__islocal) {\n\t\t\tvar currency = frappe.defaults.get_user_default(\"currency\");\n\n\t\t\tlet set_value = (fieldname, value) => {\n\t\t\t\tif(me.frm.fields_dict[fieldname] && !me.frm.doc[fieldname]) {\n\t\t\t\t\treturn me.frm.set_value(fieldname, value);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tthis.frm.trigger('set_default_internal_warehouse');\n\n\t\t\treturn frappe.run_serially([\n\t\t\t\t() => set_value('currency', currency),\n\t\t\t\t() => set_value('price_list_currency', currency),\n\t\t\t\t() => set_value('status', 'Draft'),\n\t\t\t\t() => set_value('is_subcontracted', 'No'),\n\t\t\t\t() => {\n\t\t\t\t\tif(this.frm.doc.company && !this.frm.doc.amended_from) {\n\t\t\t\t\t\tthis.frm.trigger(\"company\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t]);\n\t\t}\n\t},\n\n\tis_return: function() {\n\t\tif(!this.frm.doc.is_return && this.frm.doc.return_against) {\n\t\t\tthis.frm.set_value('return_against', '');\n\t\t}\n\t},\n\n\tsetup_quality_inspection: function() {\n\t\tif(!in_list([\"Delivery Note\", \"Sales Invoice\", \"Purchase Receipt\", \"Purchase Invoice\"], this.frm.doc.doctype)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst me = this;\n\t\tif (!this.frm.is_new() && this.frm.doc.docstatus === 0) {\n\t\t\tthis.frm.add_custom_button(__(\"Quality Inspection(s)\"), () => {\n\t\t\t\tme.make_quality_inspection();\n\t\t\t}, __(\"Create\"));\n\t\t\tthis.frm.page.set_inner_btn_group_as_primary(__('Create'));\n\t\t}\n\n\t\tconst inspection_type = in_list([\"Purchase Receipt\", \"Purchase Invoice\"], this.frm.doc.doctype)\n\t\t\t? \"Incoming\" : \"Outgoing\";\n\n\t\tlet quality_inspection_field = this.frm.get_docfield(\"items\", \"quality_inspection\");\n\t\tquality_inspection_field.get_route_options_for_new_doc = function(row) {\n\t\t\tif(me.frm.is_new()) return;\n\t\t\treturn {\n\t\t\t\t\"inspection_type\": inspection_type,\n\t\t\t\t\"reference_type\": me.frm.doc.doctype,\n\t\t\t\t\"reference_name\": me.frm.doc.name,\n\t\t\t\t\"item_code\": row.doc.item_code,\n\t\t\t\t\"description\": row.doc.description,\n\t\t\t\t\"item_serial_no\": row.doc.serial_no ? row.doc.serial_no.split(\"\\n\")[0] : null,\n\t\t\t\t\"batch_no\": row.doc.batch_no\n\t\t\t}\n\t\t}\n\n\t\tthis.frm.set_query(\"quality_inspection\", \"items\", function(doc, cdt, cdn) {\n\t\t\tlet d = locals[cdt][cdn];\n\t\t\treturn {\n\t\t\t\tfilters: {\n\t\t\t\t\tdocstatus: 1,\n\t\t\t\t\tinspection_type: inspection_type,\n\t\t\t\t\treference_name: doc.name,\n\t\t\t\t\titem_code: d.item_code\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\tmake_payment_request: function() {\n\t\tvar me = this;\n\t\tconst payment_request_type = (in_list(['Sales Order', 'Sales Invoice'], this.frm.doc.doctype))\n\t\t\t? \"Inward\" : \"Outward\";\n\n\t\tfrappe.call({\n\t\t\tmethod:\"erpnext.accounts.doctype.payment_request.payment_request.make_payment_request\",\n\t\t\targs: {\n\t\t\t\tdt: me.frm.doc.doctype,\n\t\t\t\tdn: me.frm.doc.name,\n\t\t\t\trecipient_id: me.frm.doc.contact_email,\n\t\t\t\tpayment_request_type: payment_request_type,\n\t\t\t\tparty_type: payment_request_type == 'Outward' ? \"Supplier\" : \"Customer\",\n\t\t\t\tparty: payment_request_type == 'Outward' ? me.frm.doc.supplier : me.frm.doc.customer\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tif(!r.exc){\n\t\t\t\t\tvar doc = frappe.model.sync(r.message);\n\t\t\t\t\tfrappe.set_route(\"Form\", r.message.doctype, r.message.name);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t},\n\n\tonload_post_render: function() {\n\t\tif(this.frm.doc.__islocal && !(this.frm.doc.taxes || []).length\n\t\t\t&& !(this.frm.doc.__onload ? this.frm.doc.__onload.load_after_mapping : false)) {\n\t\t\tfrappe.after_ajax(() => this.apply_default_taxes());\n\t\t} else if(this.frm.doc.__islocal && this.frm.doc.company && this.frm.doc[\"items\"]\n\t\t\t&& !this.frm.doc.is_pos) {\n\t\t\tfrappe.after_ajax(() => this.calculate_taxes_and_totals());\n\t\t}\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype + \" Item\", \"item_code\")) {\n\t\t\tthis.setup_item_selector();\n\t\t\tthis.frm.get_field(\"items\").grid.set_multiple_add(\"item_code\", \"qty\");\n\t\t}\n\t},\n\n\trefresh: function() {\n\t\terpnext.toggle_naming_series();\n\t\terpnext.hide_company();\n\t\tthis.set_dynamic_labels();\n\t\tthis.setup_sms();\n\t\tthis.setup_quality_inspection();\n\t\tlet scan_barcode_field = this.frm.get_field('scan_barcode');\n\t\tif (scan_barcode_field && scan_barcode_field.get_value()) {\n\t\t\tscan_barcode_field.set_value(\"\");\n\t\t\tscan_barcode_field.set_new_description(\"\");\n\n\t\t\tif (frappe.is_mobile()) {\n\t\t\t\tif (scan_barcode_field.$input_wrapper.find('.input-group').length) return;\n\n\t\t\t\tlet $input_group = $('<div class=\"input-group\">');\n\t\t\t\tscan_barcode_field.$input_wrapper.find('.control-input').append($input_group);\n\t\t\t\t$input_group.append(scan_barcode_field.$input);\n\t\t\t\t$(`<span class=\"input-group-btn\" style=\"vertical-align: top\">\n\t\t\t\t\t\t<button class=\"btn btn-default border\" type=\"button\">\n\t\t\t\t\t\t\t<i class=\"fa fa-camera text-muted\"></i>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</span>`)\n\t\t\t\t\t.on('click', '.btn', () => {\n\t\t\t\t\t\tfrappe.barcode.scan_barcode().then(barcode => {\n\t\t\t\t\t\t\tscan_barcode_field.set_value(barcode);\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t\t.appendTo($input_group);\n\t\t\t}\n\t\t}\n\t},\n\n\tscan_barcode: function() {\n\t\tlet scan_barcode_field = this.frm.fields_dict[\"scan_barcode\"];\n\n\t\tlet show_description = function(idx, exist = null) {\n\t\t\tif (exist) {\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tmessage: __('Row #{0}: Qty increased by 1', [idx]),\n\t\t\t\t\tindicator: 'green'\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tmessage: __('Row #{0}: Item added', [idx]),\n\t\t\t\t\tindicator: 'green'\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif(this.frm.doc.scan_barcode) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.selling.page.point_of_sale.point_of_sale.search_for_serial_or_batch_or_barcode_number\",\n\t\t\t\targs: { search_value: this.frm.doc.scan_barcode }\n\t\t\t}).then(r => {\n\t\t\t\tconst data = r && r.message;\n\t\t\t\tif (!data || Object.keys(data).length === 0) {\n\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\tmessage: __('Cannot find Item with this Barcode'),\n\t\t\t\t\t\tindicator: 'red'\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tlet cur_grid = this.frm.fields_dict.items.grid;\n\n\t\t\t\tlet row_to_modify = null;\n\t\t\t\tconst existing_item_row = this.frm.doc.items.find(d => d.item_code === data.item_code);\n\t\t\t\tconst blank_item_row = this.frm.doc.items.find(d => !d.item_code);\n\n\t\t\t\tif (existing_item_row) {\n\t\t\t\t\trow_to_modify = existing_item_row;\n\t\t\t\t} else if (blank_item_row) {\n\t\t\t\t\trow_to_modify = blank_item_row;\n\t\t\t\t}\n\n\t\t\t\tif (!row_to_modify) {\n\t\t\t\t\t// add new row\n\t\t\t\t\trow_to_modify = frappe.model.add_child(this.frm.doc, cur_grid.doctype, 'items');\n\t\t\t\t}\n\n\t\t\t\tshow_description(row_to_modify.idx, row_to_modify.item_code);\n\n\t\t\t\tthis.frm.from_barcode = this.frm.from_barcode ? this.frm.from_barcode + 1 : 1;\n\t\t\t\tfrappe.model.set_value(row_to_modify.doctype, row_to_modify.name, {\n\t\t\t\t\titem_code: data.item_code,\n\t\t\t\t\tqty: (row_to_modify.qty || 0) + 1\n\t\t\t\t});\n\n\t\t\t\t['serial_no', 'batch_no', 'barcode'].forEach(field => {\n\t\t\t\t\tif (data[field] && frappe.meta.has_field(row_to_modify.doctype, field)) {\n\n\t\t\t\t\t\tlet value = (row_to_modify[field] && field === \"serial_no\")\n\t\t\t\t\t\t\t? row_to_modify[field] + '\\n' + data[field] : data[field];\n\n\t\t\t\t\t\tfrappe.model.set_value(row_to_modify.doctype,\n\t\t\t\t\t\t\trow_to_modify.name, field, value);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tscan_barcode_field.set_value('');\n\t\t\t\trefresh_field(\"items\");\n\t\t\t});\n\t\t}\n\t\treturn false;\n\t},\n\n\tapply_default_taxes: function() {\n\t\tvar me = this;\n\t\tvar taxes_and_charges_field = frappe.meta.get_docfield(me.frm.doc.doctype, \"taxes_and_charges\",\n\t\t\tme.frm.doc.name);\n\n\t\tif (!this.frm.doc.taxes_and_charges && this.frm.doc.taxes && this.frm.doc.taxes.length > 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (taxes_and_charges_field) {\n\t\t\treturn frappe.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_default_taxes_and_charges\",\n\t\t\t\targs: {\n\t\t\t\t\t\"master_doctype\": taxes_and_charges_field.options,\n\t\t\t\t\t\"tax_template\": me.frm.doc.taxes_and_charges || \"\",\n\t\t\t\t\t\"company\": me.frm.doc.company\n\t\t\t\t},\n\t\t\t\tdebounce: 2000,\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc && r.message) {\n\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t// directly set in doc, so as not to call triggers\n\t\t\t\t\t\t\t\tif(r.message.taxes_and_charges) {\n\t\t\t\t\t\t\t\t\tme.frm.doc.taxes_and_charges = r.message.taxes_and_charges;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t// set taxes table\n\t\t\t\t\t\t\t\tif(r.message.taxes) {\n\t\t\t\t\t\t\t\t\tme.frm.set_value(\"taxes\", r.message.taxes);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t() => me.set_dynamic_labels(),\n\t\t\t\t\t\t\t() => me.calculate_taxes_and_totals()\n\t\t\t\t\t\t]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tsetup_sms: function() {\n\t\tvar me = this;\n\t\tlet blacklist = ['Purchase Invoice', 'BOM'];\n\t\tif(this.frm.doc.docstatus===1 && !in_list([\"Lost\", \"Stopped\", \"Closed\"], this.frm.doc.status)\n\t\t\t&& !blacklist.includes(this.frm.doctype)) {\n\t\t\tthis.frm.page.add_menu_item(__('Send SMS'), function() { me.send_sms(); });\n\t\t}\n\t},\n\n\tsend_sms: function() {\n\t\tvar sms_man = new erpnext.SMSManager(this.frm.doc);\n\t},\n\n\tbarcode: function(doc, cdt, cdn) {\n\t\tvar d = locals[cdt][cdn];\n\t\tif(d.barcode==\"\" || d.barcode==null) {\n\t\t\t// barcode cleared, remove item\n\t\t\td.item_code = \"\";\n\t\t}\n\n\t\tthis.frm.from_barcode = this.frm.from_barcode ? this.frm.from_barcode + 1 : 1;\n\t\tthis.item_code(doc, cdt, cdn);\n\t},\n\n\titem_code: function(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tvar update_stock = 0, show_batch_dialog = 0;\n\t\tif(['Sales Invoice'].includes(this.frm.doc.doctype)) {\n\t\t\tupdate_stock = cint(me.frm.doc.update_stock);\n\t\t\tshow_batch_dialog = update_stock;\n\n\t\t} else if((this.frm.doc.doctype === 'Purchase Receipt' && me.frm.doc.is_return) ||\n\t\t\tthis.frm.doc.doctype === 'Delivery Note') {\n\t\t\tshow_batch_dialog = 1;\n\t\t}\n\t\t// clear barcode if setting item (else barcode will take priority)\n\t\tif (this.frm.from_barcode == 0) {\n\t\t\titem.barcode = null;\n\t\t}\n\t\tthis.frm.from_barcode = this.frm.from_barcode - 1 >= 0 ? this.frm.from_barcode - 1 : 0;\n\n\n\t\tif(item.item_code || item.barcode || item.serial_no) {\n\t\t\tif(!this.validate_company_and_party()) {\n\t\t\t\tthis.frm.fields_dict[\"items\"].grid.grid_rows[item.idx - 1].remove();\n\t\t\t} else {\n\t\t\t\treturn this.frm.call({\n\t\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_item_details\",\n\t\t\t\t\tchild: item,\n\t\t\t\t\targs: {\n\t\t\t\t\t\tdoc: me.frm.doc,\n\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\titem_code: item.item_code,\n\t\t\t\t\t\t\tbarcode: item.barcode,\n\t\t\t\t\t\t\tserial_no: item.serial_no,\n\t\t\t\t\t\t\tbatch_no: item.batch_no,\n\t\t\t\t\t\t\tset_warehouse: me.frm.doc.set_warehouse,\n\t\t\t\t\t\t\twarehouse: item.warehouse,\n\t\t\t\t\t\t\tcustomer: me.frm.doc.customer || me.frm.doc.party_name,\n\t\t\t\t\t\t\tquotation_to: me.frm.doc.quotation_to,\n\t\t\t\t\t\t\tsupplier: me.frm.doc.supplier,\n\t\t\t\t\t\t\tcurrency: me.frm.doc.currency,\n\t\t\t\t\t\t\tupdate_stock: update_stock,\n\t\t\t\t\t\t\tconversion_rate: me.frm.doc.conversion_rate,\n\t\t\t\t\t\t\tprice_list: me.frm.doc.selling_price_list || me.frm.doc.buying_price_list,\n\t\t\t\t\t\t\tprice_list_currency: me.frm.doc.price_list_currency,\n\t\t\t\t\t\t\tplc_conversion_rate: me.frm.doc.plc_conversion_rate,\n\t\t\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\t\t\torder_type: me.frm.doc.order_type,\n\t\t\t\t\t\t\tis_pos: cint(me.frm.doc.is_pos),\n\t\t\t\t\t\t\tis_return: cint(me.frm.doc.is_return),\n\t\t\t\t\t\t\tis_subcontracted: me.frm.doc.is_subcontracted,\n\t\t\t\t\t\t\ttransaction_date: me.frm.doc.transaction_date || me.frm.doc.posting_date,\n\t\t\t\t\t\t\tignore_pricing_rule: me.frm.doc.ignore_pricing_rule,\n\t\t\t\t\t\t\tdoctype: me.frm.doc.doctype,\n\t\t\t\t\t\t\tname: me.frm.doc.name,\n\t\t\t\t\t\t\tproject: item.project || me.frm.doc.project,\n\t\t\t\t\t\t\tqty: item.qty || 1,\n\t\t\t\t\t\t\tnet_rate: item.rate,\n\t\t\t\t\t\t\tstock_qty: item.stock_qty,\n\t\t\t\t\t\t\tconversion_factor: item.conversion_factor,\n\t\t\t\t\t\t\tweight_per_unit: item.weight_per_unit,\n\t\t\t\t\t\t\tweight_uom: item.weight_uom,\n\t\t\t\t\t\t\tmanufacturer: item.manufacturer,\n\t\t\t\t\t\t\tstock_uom: item.stock_uom,\n\t\t\t\t\t\t\tpos_profile: cint(me.frm.doc.is_pos) ? me.frm.doc.pos_profile : '',\n\t\t\t\t\t\t\tcost_center: item.cost_center,\n\t\t\t\t\t\t\ttax_category: me.frm.doc.tax_category,\n\t\t\t\t\t\t\titem_tax_template: item.item_tax_template,\n\t\t\t\t\t\t\tchild_docname: item.name\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\n\t\t\t\t\tcallback: function(r) {\n\t\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tvar d = locals[cdt][cdn];\n\t\t\t\t\t\t\t\t\tme.add_taxes_from_item_tax_template(d.item_tax_rate);\n\t\t\t\t\t\t\t\t\tif (d.free_item_data) {\n\t\t\t\t\t\t\t\t\t\tme.apply_product_discount(d);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\t// for internal customer instead of pricing rule directly apply valuation rate on item\n\t\t\t\t\t\t\t\t\tif (me.frm.doc.is_internal_customer || me.frm.doc.is_internal_supplier) {\n\t\t\t\t\t\t\t\t\t\tme.get_incoming_rate(item, me.frm.posting_date, me.frm.posting_time,\n\t\t\t\t\t\t\t\t\t\t\tme.frm.doc.doctype, me.frm.doc.company);\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tme.frm.script_manager.trigger(\"price_list_rate\", cdt, cdn);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif (me.frm.doc.is_internal_customer || me.frm.doc.is_internal_supplier) {\n\t\t\t\t\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => me.toggle_conversion_factor(item),\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif (show_batch_dialog)\n\t\t\t\t\t\t\t\t\t\treturn frappe.db.get_value(\"Item\", item.item_code, [\"has_batch_no\", \"has_serial_no\"])\n\t\t\t\t\t\t\t\t\t\t\t.then((r) => {\n\t\t\t\t\t\t\t\t\t\t\t\tif (r.message &&\n\t\t\t\t\t\t\t\t\t\t\t\t(r.message.has_batch_no || r.message.has_serial_no)) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfrappe.flags.hide_serial_batch_dialog = false;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\t// check if batch serial selector is disabled or not\n\t\t\t\t\t\t\t\t\tif (show_batch_dialog && !frappe.flags.hide_serial_batch_dialog)\n\t\t\t\t\t\t\t\t\t\treturn frappe.db.get_single_value('Stock Settings', 'disable_serial_no_and_batch_selector')\n\t\t\t\t\t\t\t\t\t\t\t.then((value) => {\n\t\t\t\t\t\t\t\t\t\t\t\tif (value) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfrappe.flags.hide_serial_batch_dialog = true;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif(show_batch_dialog && !frappe.flags.hide_serial_batch_dialog) {\n\t\t\t\t\t\t\t\t\t\tvar d = locals[cdt][cdn];\n\t\t\t\t\t\t\t\t\t\t$.each(r.message, function(k, v) {\n\t\t\t\t\t\t\t\t\t\t\tif(!d[k]) d[k] = v;\n\t\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\t\tif (d.has_batch_no && d.has_serial_no) {\n\t\t\t\t\t\t\t\t\t\t\td.batch_no = undefined;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\terpnext.show_serial_batch_selector(me.frm, d, (item) => {\n\t\t\t\t\t\t\t\t\t\t\tme.frm.script_manager.trigger('qty', item.doctype, item.name);\n\t\t\t\t\t\t\t\t\t\t\tif (!me.frm.doc.set_warehouse)\n\t\t\t\t\t\t\t\t\t\t\t\tme.frm.script_manager.trigger('warehouse', item.doctype, item.name);\n\t\t\t\t\t\t\t\t\t\t}, undefined, !frappe.flags.hide_serial_batch_dialog);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => me.conversion_factor(doc, cdt, cdn, true),\n\t\t\t\t\t\t\t\t() => me.remove_pricing_rule(item),\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif (item.apply_rule_on_other_items) {\n\t\t\t\t\t\t\t\t\t\tlet key = item.name;\n\t\t\t\t\t\t\t\t\t\tme.apply_rule_on_other_items({key: item});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tvar company_currency = me.get_company_currency();\n\t\t\t\t\t\t\t\t\tme.update_item_grid_labels(company_currency);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\tprice_list_rate: function(doc, cdt, cdn) {\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tfrappe.model.round_floats_in(item, [\"price_list_rate\", \"discount_percentage\"]);\n\n\t\t// check if child doctype is Sales Order Item/Qutation Item and calculate the rate\n\t\tif (in_list([\"Quotation Item\", \"Sales Order Item\", \"Delivery Note Item\", \"Sales Invoice Item\", \"POS Invoice Item\", \"Purchase Invoice Item\", \"Purchase Order Item\", \"Purchase Receipt Item\",\"Proforma Invoice Item\"]), cdt)\n\t\t\tthis.apply_pricing_rule_on_item(item);\n\t\telse\n\t\t\titem.rate = flt(item.price_list_rate * (1 - item.discount_percentage / 100.0),\n\t\t\t\tprecision(\"rate\", item));\n\n\t\tthis.calculate_taxes_and_totals();\n\t},\n\n\tmargin_rate_or_amount: function(doc, cdt, cdn) {\n\t\t// calculated the revised total margin and rate on margin rate changes\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\tthis.apply_pricing_rule_on_item(item);\n\t\tthis.calculate_taxes_and_totals();\n\t\tcur_frm.refresh_fields();\n\t},\n\n\tmargin_type: function(doc, cdt, cdn) {\n\t\t// calculate the revised total margin and rate on margin type changes\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\tif (!item.margin_type) {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"margin_rate_or_amount\", 0);\n\t\t} else {\n\t\t\tthis.apply_pricing_rule_on_item(item, doc, cdt, cdn);\n\t\t\tthis.calculate_taxes_and_totals();\n\t\t\tcur_frm.refresh_fields();\n\t\t}\n\t},\n\n\tget_incoming_rate: function(item, posting_date, posting_time, voucher_type, company) {\n\n\t\tlet item_args = {\n\t\t\t'item_code': item.item_code,\n\t\t\t'warehouse': in_list('Purchase Receipt', 'Purchase Invoice') ? item.from_warehouse : item.warehouse,\n\t\t\t'posting_date': posting_date,\n\t\t\t'posting_time': posting_time,\n\t\t\t'qty': item.qty * item.conversion_factor,\n\t\t\t'serial_no': item.serial_no,\n\t\t\t'voucher_type': voucher_type,\n\t\t\t'company': company,\n\t\t\t'allow_zero_valuation_rate': item.allow_zero_valuation_rate\n\t\t}\n\n\t\tfrappe.call({\n\t\t\tmethod: 'erpnext.stock.utils.get_incoming_rate',\n\t\t\targs: {\n\t\t\t\targs: item_args\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tfrappe.model.set_value(item.doctype, item.name, 'rate', r.message * item.conversion_factor);\n\t\t\t}\n\t\t});\n\t},\n\n\tserial_no: function(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\n\t\tif (item && item.doctype === 'Purchase Receipt Item Supplied') {\n\t\t\treturn;\n\t\t}\n\n\t\tif (item && item.serial_no) {\n\t\t\tif (!item.item_code) {\n\t\t\t\tthis.frm.trigger(\"item_code\", cdt, cdn);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Replacing all occurences of comma with carriage return\n\t\t\t\titem.serial_no = item.serial_no.replace(/,/g, '\\n');\n\t\t\t\titem.conversion_factor = item.conversion_factor || 1;\n\t\t\t\trefresh_field(\"serial_no\", item.name, item.parentfield);\n\t\t\t\tif (!doc.is_return && cint(frappe.user_defaults.set_qty_in_transactions_based_on_serial_no_input)) {\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tme.update_qty(cdt, cdn);\n\t\t\t\t\t}, 10000);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tupdate_qty: function(cdt, cdn) {\n\t\tvar valid_serial_nos = [];\n\t\tvar serialnos = [];\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tserialnos = item.serial_no.split(\"\\n\");\n\t\tfor (var i = 0; i < serialnos.length; i++) {\n\t\t\tif (serialnos[i] != \"\") {\n\t\t\t\tvalid_serial_nos.push(serialnos[i]);\n\t\t\t}\n\t\t}\n\t\tfrappe.model.set_value(item.doctype, item.name,\n\t\t\t\"qty\", valid_serial_nos.length / item.conversion_factor);\n\t\tfrappe.model.set_value(item.doctype, item.name, \"stock_qty\", valid_serial_nos.length);\n\t},\n\n\tvalidate: function() {\n\t\tthis.calculate_taxes_and_totals(false);\n\t},\n\n\tupdate_stock: function() {\n\t\tthis.frm.trigger('set_default_internal_warehouse');\n\t},\n\n\tset_default_internal_warehouse: function() {\n\t\tlet me = this;\n\t\tif ((this.frm.doc.doctype === 'Sales Invoice' && me.frm.doc.update_stock)\n\t\t\t|| this.frm.doc.doctype == 'Delivery Note') {\n\t\t\tif (this.frm.doc.is_internal_customer && this.frm.doc.company === this.frm.doc.represents_company) {\n\t\t\t\tfrappe.db.get_value('Company', this.frm.doc.company, 'default_in_transit_warehouse', function(value) {\n\t\t\t\t\tme.frm.set_value('set_target_warehouse', value.default_in_transit_warehouse);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif ((this.frm.doc.doctype === 'Purchase Invoice' && me.frm.doc.update_stock)\n\t\t\t|| this.frm.doc.doctype == 'Purchase Receipt') {\n\t\t\tif (this.frm.doc.is_internal_supplier && this.frm.doc.company === this.frm.doc.represents_company) {\n\t\t\t\tfrappe.db.get_value('Company', this.frm.doc.company, 'default_in_transit_warehouse', function(value) {\n\t\t\t\t\tme.frm.set_value('set_from_warehouse', value.default_in_transit_warehouse);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\tcompany: function() {\n\t\tvar me = this;\n\t\tvar set_pricing = function() {\n\t\t\tif(me.frm.doc.company && me.frm.fields_dict.currency) {\n\t\t\t\tvar company_currency = me.get_company_currency();\n\t\t\t\tvar company_doc = frappe.get_doc(\":Company\", me.frm.doc.company);\n\n\t\t\t\tif (!me.frm.doc.currency) {\n\t\t\t\t\tme.frm.set_value(\"currency\", company_currency);\n\t\t\t\t}\n\n\t\t\t\tif (me.frm.doc.currency == company_currency) {\n\t\t\t\t\tme.frm.set_value(\"conversion_rate\", 1.0);\n\t\t\t\t}\n\t\t\t\tif (me.frm.doc.price_list_currency == company_currency) {\n\t\t\t\t\tme.frm.set_value('plc_conversion_rate', 1.0);\n\t\t\t\t}\n\t\t\t\tif (company_doc.default_letter_head) {\n\t\t\t\t\tif(me.frm.fields_dict.letter_head) {\n\t\t\t\t\t\tme.frm.set_value(\"letter_head\", company_doc.default_letter_head);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlet selling_doctypes_for_tc = [\"Sales Invoice\", \"Quotation\", \"Sales Order\", \"Delivery Note\",\"Proforma Invoice\"];\n\t\t\t\tif (company_doc.default_selling_terms && frappe.meta.has_field(me.frm.doc.doctype, \"tc_name\") &&\n\t\t\t\tselling_doctypes_for_tc.indexOf(me.frm.doc.doctype) != -1) {\n\t\t\t\t\tme.frm.set_value(\"tc_name\", company_doc.default_selling_terms);\n\t\t\t\t}\n\t\t\t\tlet buying_doctypes_for_tc = [\"Request for Quotation\", \"Supplier Quotation\", \"Purchase Order\",\n\t\t\t\t\t\"Material Request\", \"Purchase Receipt\"];\n\t\t\t\t// Purchase Invoice is excluded as per issue #3345\n\t\t\t\tif (company_doc.default_buying_terms && frappe.meta.has_field(me.frm.doc.doctype, \"tc_name\") &&\n\t\t\t\tbuying_doctypes_for_tc.indexOf(me.frm.doc.doctype) != -1) {\n\t\t\t\t\tme.frm.set_value(\"tc_name\", company_doc.default_buying_terms);\n\t\t\t\t}\n\n\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t() => me.frm.script_manager.trigger(\"currency\"),\n\t\t\t\t\t() => me.update_item_tax_map(),\n\t\t\t\t\t() => me.apply_default_taxes(),\n\t\t\t\t\t() => me.apply_pricing_rule()\n\t\t\t\t]);\n\t\t\t}\n\t\t}\n\n\t\tvar set_party_account = function(set_pricing) {\n\t\t\tif (in_list([\"Sales Invoice\", \"Purchase Invoice\"], me.frm.doc.doctype)) {\n\t\t\t\tif(me.frm.doc.doctype==\"Sales Invoice\") {\n\t\t\t\t\tvar party_type = \"Customer\";\n\t\t\t\t\tvar party_account_field = 'debit_to';\n\t\t\t\t} else {\n\t\t\t\t\tvar party_type = \"Supplier\";\n\t\t\t\t\tvar party_account_field = 'credit_to';\n\t\t\t\t}\n\n\t\t\t\tvar party = me.frm.doc[frappe.model.scrub(party_type)];\n\t\t\t\tif(party && me.frm.doc.company) {\n\t\t\t\t\treturn frappe.call({\n\t\t\t\t\t\tmethod: \"erpnext.accounts.party.get_party_account\",\n\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\t\t\tparty_type: party_type,\n\t\t\t\t\t\t\tparty: party\n\t\t\t\t\t\t},\n\t\t\t\t\t\tcallback: function(r) {\n\t\t\t\t\t\t\tif(!r.exc && r.message) {\n\t\t\t\t\t\t\t\tme.frm.set_value(party_account_field, r.message);\n\t\t\t\t\t\t\t\tset_pricing();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tset_pricing();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tset_pricing();\n\t\t\t}\n\n\t\t}\n\n\t\tif (frappe.meta.get_docfield(this.frm.doctype, \"shipping_address\") &&\n\t\t\tin_list(['Purchase Order', 'Purchase Receipt', 'Purchase Invoice'], this.frm.doctype)) {\n\t\t\terpnext.utils.get_shipping_address(this.frm, function(){\n\t\t\t\tset_party_account(set_pricing);\n\t\t\t});\n\n\t\t\t// Get default company billing address in Purchase Invoice, Order and Receipt\n\t\t\tfrappe.call({\n\t\t\t\t'method': 'frappe.contacts.doctype.address.address.get_default_address',\n\t\t\t\t'args': {\n\t\t\t\t\t'doctype': 'Company',\n\t\t\t\t\t'name': this.frm.doc.company\n\t\t\t\t},\n\t\t\t\t'callback': function(r) {\n\t\t\t\t\tme.frm.set_value('billing_address', r.message);\n\t\t\t\t}\n\t\t\t});\n\n\t\t} else {\n\t\t\tset_party_account(set_pricing);\n\t\t}\n\n\t\tif(this.frm.doc.company) {\n\t\t\terpnext.last_selected_company = this.frm.doc.company;\n\t\t}\n\t},\n\n\ttransaction_date: function() {\n\t\tif (this.frm.doc.transaction_date) {\n\t\t\tthis.frm.transaction_date = this.frm.doc.transaction_date;\n\t\t\tfrappe.ui.form.trigger(this.frm.doc.doctype, \"currency\");\n\t\t}\n\t},\n\n\tposting_date: function() {\n\t\tvar me = this;\n\t\tif (this.frm.doc.posting_date) {\n\t\t\tthis.frm.posting_date = this.frm.doc.posting_date;\n\n\t\t\tif ((this.frm.doc.doctype == \"Sales Invoice\" && this.frm.doc.customer) ||\n\t\t\t\t(this.frm.doc.doctype == \"Purchase Invoice\" && this.frm.doc.supplier)) {\n\t\t\t\treturn frappe.call({\n\t\t\t\t\tmethod: \"erpnext.accounts.party.get_due_date\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\t\"posting_date\": me.frm.doc.posting_date,\n\t\t\t\t\t\t\"party_type\": me.frm.doc.doctype == \"Sales Invoice\" ? \"Customer\" : \"Supplier\",\n\t\t\t\t\t\t\"bill_date\": me.frm.doc.bill_date,\n\t\t\t\t\t\t\"party\": me.frm.doc.doctype == \"Sales Invoice\" ? me.frm.doc.customer : me.frm.doc.supplier,\n\t\t\t\t\t\t\"company\": me.frm.doc.company\n\t\t\t\t\t},\n\t\t\t\t\tcallback: function(r, rt) {\n\t\t\t\t\t\tif(r.message) {\n\t\t\t\t\t\t\tme.frm.doc.due_date = r.message;\n\t\t\t\t\t\t\trefresh_field(\"due_date\");\n\t\t\t\t\t\t\tfrappe.ui.form.trigger(me.frm.doc.doctype, \"currency\");\n\t\t\t\t\t\t\tme.recalculate_terms();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tfrappe.ui.form.trigger(me.frm.doc.doctype, \"currency\");\n\t\t\t}\n\t\t}\n\t},\n\n\tdue_date: function() {\n\t\t// due_date is to be changed, payment terms template and/or payment schedule must\n\t\t// be removed as due_date is automatically changed based on payment terms\n\t\tif (this.frm.doc.due_date && !this.frm.updating_party_details && !this.frm.doc.is_pos) {\n\t\t\tif (this.frm.doc.payment_terms_template ||\n\t\t\t\t(this.frm.doc.payment_schedule && this.frm.doc.payment_schedule.length)) {\n\t\t\t\tvar message1 = \"\";\n\t\t\t\tvar message2 = \"\";\n\t\t\t\tvar final_message = __(\"Please clear the\") + \" \";\n\n\t\t\t\tif (this.frm.doc.payment_terms_template) {\n\t\t\t\t\tmessage1 = __(\"selected Payment Terms Template\");\n\t\t\t\t\tfinal_message = final_message + message1;\n\t\t\t\t}\n\n\t\t\t\tif ((this.frm.doc.payment_schedule || []).length) {\n\t\t\t\t\tmessage2 = __(\"Payment Schedule Table\");\n\t\t\t\t\tif (message1.length !== 0) message2 = \" and \" + message2;\n\t\t\t\t\tfinal_message = final_message + message2;\n\t\t\t\t}\n\t\t\t\tfrappe.msgprint(final_message);\n\t\t\t}\n\t\t}\n\t},\n\n\tbill_date: function() {\n\t\tthis.posting_date();\n\t},\n\n\trecalculate_terms: function() {\n\t\tconst doc = this.frm.doc;\n\t\tif (doc.payment_terms_template) {\n\t\t\tthis.payment_terms_template();\n\t\t} else if (doc.payment_schedule) {\n\t\t\tconst me = this;\n\t\t\tdoc.payment_schedule.forEach(\n\t\t\t\tfunction(term) {\n\t\t\t\t\tif (term.payment_term) {\n\t\t\t\t\t\tme.payment_term(doc, term.doctype, term.name);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfrappe.model.set_value(\n\t\t\t\t\t\t\tterm.doctype, term.name, 'due_date',\n\t\t\t\t\t\t\tdoc.posting_date || doc.transaction_date\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t},\n\n\tget_company_currency: function() {\n\t\treturn erpnext.get_currency(this.frm.doc.company);\n\t},\n\n\tcontact_person: function() {\n\t\terpnext.utils.get_contact_details(this.frm);\n\t},\n\n\tcurrency: function() {\n\t\t/* manqala 19/09/2016: let the translation date be whichever of the transaction_date or posting_date is available */\n\t\tvar transaction_date = this.frm.doc.transaction_date || this.frm.doc.posting_date;\n\t\t/* end manqala */\n\t\tvar me = this;\n\t\tthis.set_dynamic_labels();\n\t\tvar company_currency = this.get_company_currency();\n\t\t// Added `ignore_pricing_rule` to determine if document is loading after mapping from another doc\n\t\tif(this.frm.doc.currency && this.frm.doc.currency !== company_currency\n\t\t\t\t&& !this.frm.doc.ignore_pricing_rule) {\n\n\t\t\tthis.get_exchange_rate(transaction_date, this.frm.doc.currency, company_currency,\n\t\t\t\tfunction(exchange_rate) {\n\t\t\t\t\tif(exchange_rate != me.frm.doc.conversion_rate) {\n\t\t\t\t\t\tme.set_margin_amount_based_on_currency(exchange_rate);\n\t\t\t\t\t\tme.set_actual_charges_based_on_currency(exchange_rate);\n\t\t\t\t\t\tme.frm.set_value(\"conversion_rate\", exchange_rate);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t} else {\n\t\t\tthis.conversion_rate();\n\t\t}\n\t},\n\n\tconversion_rate: function() {\n\t\tconst me = this.frm;\n\t\tif(this.frm.doc.currency === this.get_company_currency()) {\n\t\t\tthis.frm.set_value(\"conversion_rate\", 1.0);\n\t\t}\n\t\tif(this.frm.doc.currency === this.frm.doc.price_list_currency &&\n\t\t\tthis.frm.doc.plc_conversion_rate !== this.frm.doc.conversion_rate) {\n\t\t\tthis.frm.set_value(\"plc_conversion_rate\", this.frm.doc.conversion_rate);\n\t\t}\n\n\t\tif(flt(this.frm.doc.conversion_rate)>0.0) {\n\t\t\tif(this.frm.doc.ignore_pricing_rule) {\n\t\t\t\tthis.calculate_taxes_and_totals();\n\t\t\t} else if (!this.in_apply_price_list){\n\t\t\t\tthis.apply_price_list();\n\t\t\t}\n\n\t\t}\n\t\t// Make read only if Accounts Settings doesn't allow stale rates\n\t\tthis.frm.set_df_property(\"conversion_rate\", \"read_only\", erpnext.stale_rate_allowed() ? 0 : 1);\n\t},\n\n\tshipping_rule: function() {\n\t\tvar me = this;\n\t\tif(this.frm.doc.shipping_rule) {\n\t\t\treturn this.frm.call({\n\t\t\t\tdoc: this.frm.doc,\n\t\t\t\tmethod: \"apply_shipping_rule\",\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}).fail(() => this.frm.set_value('shipping_rule', ''));\n\t\t}\n\t\telse {\n\t\t\tme.calculate_taxes_and_totals();\n\t\t}\n\t},\n\n\tset_margin_amount_based_on_currency: function(exchange_rate) {\n\t\tif (in_list([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\", \"Purchase Invoice\", \"Purchase Order\", \"Purchase Receipt\",\"Proforma Invoice\"]), this.frm.doc.doctype) {\n\t\t\tvar me = this;\n\t\t\t$.each(this.frm.doc.items || [], function(i, d) {\n\t\t\t\tif(d.margin_type == \"Amount\") {\n\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"margin_rate_or_amount\",\n\t\t\t\t\t\tflt(d.margin_rate_or_amount) / flt(exchange_rate));\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tset_actual_charges_based_on_currency: function(exchange_rate) {\n\t\tvar me = this;\n\t\t$.each(this.frm.doc.taxes || [], function(i, d) {\n\t\t\tif(d.charge_type == \"Actual\") {\n\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"tax_amount\",\n\t\t\t\t\tflt(d.tax_amount) / flt(exchange_rate));\n\t\t\t}\n\t\t});\n\t},\n\n\tget_exchange_rate: function(transaction_date, from_currency, to_currency, callback) {\n\t\tvar args;\n\t\tif ([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\",\"Proforma Invoice\"].includes(this.frm.doctype)) {\n\t\t\targs = \"for_selling\";\n\t\t}\n\t\telse if ([\"Purchase Order\", \"Purchase Receipt\", \"Purchase Invoice\"].includes(this.frm.doctype)) {\n\t\t\targs = \"for_buying\";\n\t\t}\n\n\t\tif (!transaction_date || !from_currency || !to_currency) return;\n\t\treturn frappe.call({\n\t\t\tmethod: \"erpnext.setup.utils.get_exchange_rate\",\n\t\t\targs: {\n\t\t\t\ttransaction_date: transaction_date,\n\t\t\t\tfrom_currency: from_currency,\n\t\t\t\tto_currency: to_currency,\n\t\t\t\targs: args\n\t\t\t},\n\t\t\tfreeze: true,\n\t\t\tfreeze_message: __(\"Fetching exchange rates ...\"),\n\t\t\tcallback: function(r) {\n\t\t\t\tcallback(flt(r.message));\n\t\t\t}\n\t\t});\n\t},\n\n\tprice_list_currency: function() {\n\t\tvar me=this;\n\t\tthis.set_dynamic_labels();\n\n\t\tvar company_currency = this.get_company_currency();\n\t\t// Added `ignore_pricing_rule` to determine if document is loading after mapping from another doc\n\t\tif(this.frm.doc.price_list_currency !== company_currency  && !this.frm.doc.ignore_pricing_rule) {\n\t\t\tthis.get_exchange_rate(this.frm.doc.posting_date, this.frm.doc.price_list_currency, company_currency,\n\t\t\t\tfunction(exchange_rate) {\n\t\t\t\t\tme.frm.set_value(\"plc_conversion_rate\", exchange_rate);\n\t\t\t\t});\n\t\t} else {\n\t\t\tthis.plc_conversion_rate();\n\t\t}\n\t},\n\n\tplc_conversion_rate: function() {\n\t\tif(this.frm.doc.price_list_currency === this.get_company_currency()) {\n\t\t\tthis.frm.set_value(\"plc_conversion_rate\", 1.0);\n\t\t} else if(this.frm.doc.price_list_currency === this.frm.doc.currency\n\t\t\t&& this.frm.doc.plc_conversion_rate && cint(this.frm.doc.plc_conversion_rate) != 1 &&\n\t\t\tcint(this.frm.doc.plc_conversion_rate) != cint(this.frm.doc.conversion_rate)) {\n\t\t\tthis.frm.set_value(\"conversion_rate\", this.frm.doc.plc_conversion_rate);\n\t\t}\n\n\t\tif(!this.in_apply_price_list) {\n\t\t\tthis.apply_price_list(null, true);\n\t\t}\n\t},\n\n\tuom: function(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tif(item.item_code && item.uom) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_conversion_factor\",\n\t\t\t\targs: {\n\t\t\t\t\titem_code: item.item_code,\n\t\t\t\t\tuom: item.uom\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, 'conversion_factor', r.message.conversion_factor);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tme.calculate_stock_uom_rate(doc, cdt, cdn);\n\t},\n\n\tconversion_factor: function(doc, cdt, cdn, dont_fetch_price_list_rate) {\n\t\tif(frappe.meta.get_docfield(cdt, \"stock_qty\", cdn)) {\n\t\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\t\tfrappe.model.round_floats_in(item, [\"qty\", \"conversion_factor\"]);\n\t\t\titem.stock_qty = flt(item.qty * item.conversion_factor, precision(\"stock_qty\", item));\n\t\t\trefresh_field(\"stock_qty\", item.name, item.parentfield);\n\t\t\tthis.toggle_conversion_factor(item);\n\n\t\t\tif(doc.doctype != \"Material Request\") {\n\t\t\t\titem.total_weight = flt(item.stock_qty * item.weight_per_unit);\n\t\t\t\trefresh_field(\"total_weight\", item.name, item.parentfield);\n\t\t\t\tthis.calculate_net_weight();\n\t\t\t}\n\n\t\t\t// for handling customization not to fetch price list rate\n\t\t\tif(frappe.flags.dont_fetch_price_list_rate) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tif (!dont_fetch_price_list_rate &&\n\t\t\t\tfrappe.meta.has_field(doc.doctype, \"price_list_currency\")) {\n\t\t\t\tthis.apply_price_list(item, true);\n\t\t\t}\n\t\t\tthis.calculate_stock_uom_rate(doc, cdt, cdn);\n\t\t}\n\t},\n\n\tbatch_no: function(doc, cdt, cdn) {\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\tthis.apply_price_list(item, true);\n\t},\n\n\ttoggle_conversion_factor: function(item) {\n\t\t// toggle read only property for conversion factor field if the uom and stock uom are same\n\t\tif(this.frm.get_field('items').grid.fields_map.conversion_factor) {\n\t\t\tthis.frm.fields_dict.items.grid.toggle_enable(\"conversion_factor\",\n\t\t\t\t((item.uom != item.stock_uom) && !frappe.meta.get_docfield(cur_frm.fields_dict.items.grid.doctype, \"conversion_factor\").read_only)? true: false);\n\t\t}\n\n\t},\n\n\tqty: function(doc, cdt, cdn) {\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\tthis.conversion_factor(doc, cdt, cdn, true);\n\t\tthis.calculate_stock_uom_rate(doc, cdt, cdn);\n\t\tthis.apply_pricing_rule(item, true);\n\t},\n\n\tcalculate_stock_uom_rate: function(doc, cdt, cdn) {\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\titem.stock_uom_rate = flt(item.rate)/flt(item.conversion_factor);\n\t\trefresh_field(\"stock_uom_rate\", item.name, item.parentfield);\n\t},\n\tservice_stop_date: function(frm, cdt, cdn) {\n\t\tvar child = locals[cdt][cdn];\n\n\t\tif(child.service_stop_date) {\n\t\t\tlet start_date = Date.parse(child.service_start_date);\n\t\t\tlet end_date = Date.parse(child.service_end_date);\n\t\t\tlet stop_date = Date.parse(child.service_stop_date);\n\n\t\t\tif(stop_date < start_date) {\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"service_stop_date\", \"\");\n\t\t\t\tfrappe.throw(__(\"Service Stop Date cannot be before Service Start Date\"));\n\t\t\t} else if (stop_date > end_date) {\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"service_stop_date\", \"\");\n\t\t\t\tfrappe.throw(__(\"Service Stop Date cannot be after Service End Date\"));\n\t\t\t}\n\t\t}\n\t},\n\n\tservice_start_date: function(frm, cdt, cdn) {\n\t\tvar child = locals[cdt][cdn];\n\n\t\tif(child.service_start_date) {\n\t\t\tfrappe.call({\n\t\t\t\t\"method\": \"erpnext.stock.get_item_details.calculate_service_end_date\",\n\t\t\t\targs: {\"args\": child},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"service_end_date\", r.message.service_end_date);\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\n\tcalculate_net_weight: function(){\n\t\t/* Calculate Total Net Weight then further applied shipping rule to calculate shipping charges.*/\n\t\tvar me = this;\n\t\tthis.frm.doc.total_net_weight= 0.0;\n\n\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\tme.frm.doc.total_net_weight += flt(item.total_weight);\n\t\t});\n\t\trefresh_field(\"total_net_weight\");\n\t\tthis.shipping_rule();\n\t},\n\n\tset_dynamic_labels: function() {\n\t\t// What TODO? should we make price list system non-mandatory?\n\t\tthis.frm.toggle_reqd(\"plc_conversion_rate\",\n\t\t\t!!(this.frm.doc.price_list_name && this.frm.doc.price_list_currency));\n\n\t\tvar company_currency = this.get_company_currency();\n\t\tthis.change_form_labels(company_currency);\n\t\tthis.change_grid_labels(company_currency);\n\t\tthis.frm.refresh_fields();\n\t},\n\n\tchange_form_labels: function(company_currency) {\n\t\tvar me = this;\n\n\t\tthis.frm.set_currency_labels([\"base_total\", \"base_net_total\", \"base_total_taxes_and_charges\",\n\t\t\t\"base_discount_amount\", \"base_grand_total\", \"base_rounded_total\", \"base_in_words\",\n\t\t\t\"base_taxes_and_charges_added\", \"base_taxes_and_charges_deducted\", \"total_amount_to_pay\",\n\t\t\t\"base_paid_amount\", \"base_write_off_amount\", \"base_change_amount\", \"base_operating_cost\",\n\t\t\t\"base_raw_material_cost\", \"base_total_cost\", \"base_scrap_material_cost\",\n\t\t\t\"base_rounding_adjustment\"], company_currency);\n\n\t\tthis.frm.set_currency_labels([\"total\", \"net_total\", \"total_taxes_and_charges\", \"discount_amount\",\n\t\t\t\"grand_total\", \"taxes_and_charges_added\", \"taxes_and_charges_deducted\",\n\t\t\t\"rounded_total\", \"in_words\", \"paid_amount\", \"write_off_amount\", \"operating_cost\",\n\t\t\t\"scrap_material_cost\", \"rounding_adjustment\", \"raw_material_cost\",\n\t\t\t\"total_cost\"], this.frm.doc.currency);\n\n\t\tthis.frm.set_currency_labels([\"outstanding_amount\", \"total_advance\"],\n\t\t\tthis.frm.doc.party_account_currency);\n\n\t\tcur_frm.set_df_property(\"conversion_rate\", \"description\", \"1 \" + this.frm.doc.currency\n\t\t\t+ \" = [?] \" + company_currency);\n\n\t\tif(this.frm.doc.price_list_currency && this.frm.doc.price_list_currency!=company_currency) {\n\t\t\tcur_frm.set_df_property(\"plc_conversion_rate\", \"description\", \"1 \"\n\t\t\t\t+ this.frm.doc.price_list_currency + \" = [?] \" + company_currency);\n\t\t}\n\n\t\t// toggle fields\n\t\tthis.frm.toggle_display([\"conversion_rate\", \"base_total\", \"base_net_total\",\n\t\t\t\"base_total_taxes_and_charges\", \"base_taxes_and_charges_added\", \"base_taxes_and_charges_deducted\",\n\t\t\t\"base_grand_total\", \"base_rounded_total\", \"base_in_words\", \"base_discount_amount\",\n\t\t\t\"base_paid_amount\", \"base_write_off_amount\", \"base_operating_cost\", \"base_raw_material_cost\",\n\t\t\t\"base_total_cost\", \"base_scrap_material_cost\", \"base_rounding_adjustment\"],\n\t\tthis.frm.doc.currency != company_currency);\n\n\t\tthis.frm.toggle_display([\"plc_conversion_rate\", \"price_list_currency\"],\n\t\t\tthis.frm.doc.price_list_currency != company_currency);\n\n\t\tvar show = cint(cur_frm.doc.discount_amount) ||\n\t\t\t\t((cur_frm.doc.taxes || []).filter(function(d) {return d.included_in_print_rate===1}).length);\n\n\t\tif(frappe.meta.get_docfield(cur_frm.doctype, \"net_total\"))\n\t\t\tcur_frm.toggle_display(\"net_total\", show);\n\n\t\tif(frappe.meta.get_docfield(cur_frm.doctype, \"base_net_total\"))\n\t\t\tcur_frm.toggle_display(\"base_net_total\", (show && (me.frm.doc.currency != company_currency)));\n\n\t},\n\n\tchange_grid_labels: function(company_currency) {\n\t\tvar me = this;\n\n\t\tthis.update_item_grid_labels(company_currency);\n\n\t\tthis.toggle_item_grid_columns(company_currency);\n\n\t\tif (this.frm.doc.operations && this.frm.doc.operations.length > 0) {\n\t\t\tthis.frm.set_currency_labels([\"operating_cost\", \"hour_rate\"], this.frm.doc.currency, \"operations\");\n\t\t\tthis.frm.set_currency_labels([\"base_operating_cost\", \"base_hour_rate\"], company_currency, \"operations\");\n\n\t\t\tvar item_grid = this.frm.fields_dict[\"operations\"].grid;\n\t\t\t$.each([\"base_operating_cost\", \"base_hour_rate\"], function(i, fname) {\n\t\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\t\titem_grid.set_column_disp(fname, me.frm.doc.currency != company_currency);\n\t\t\t});\n\t\t}\n\n\t\tif (this.frm.doc.scrap_items && this.frm.doc.scrap_items.length > 0) {\n\t\t\tthis.frm.set_currency_labels([\"rate\", \"amount\"], this.frm.doc.currency, \"scrap_items\");\n\t\t\tthis.frm.set_currency_labels([\"base_rate\", \"base_amount\"], company_currency, \"scrap_items\");\n\n\t\t\tvar item_grid = this.frm.fields_dict[\"scrap_items\"].grid;\n\t\t\t$.each([\"base_rate\", \"base_amount\"], function(i, fname) {\n\t\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\t\titem_grid.set_column_disp(fname, me.frm.doc.currency != company_currency);\n\t\t\t});\n\t\t}\n\n\t\tif (this.frm.doc.taxes && this.frm.doc.taxes.length > 0) {\n\t\t\tthis.frm.set_currency_labels([\"tax_amount\", \"total\", \"tax_amount_after_discount\"], this.frm.doc.currency, \"taxes\");\n\n\t\t\tthis.frm.set_currency_labels([\"base_tax_amount\", \"base_total\", \"base_tax_amount_after_discount\"], company_currency, \"taxes\");\n\t\t}\n\n\t\tif (this.frm.doc.advances && this.frm.doc.advances.length > 0) {\n\t\t\tthis.frm.set_currency_labels([\"advance_amount\", \"allocated_amount\"],\n\t\t\t\tthis.frm.doc.party_account_currency, \"advances\");\n\t\t}\n\n\t\tthis.update_payment_schedule_grid_labels(company_currency);\n\t},\n\n\tupdate_item_grid_labels: function(company_currency) {\n\t\tthis.frm.set_currency_labels([\n\t\t\t\"base_rate\", \"base_net_rate\", \"base_price_list_rate\",\n\t\t\t\"base_amount\", \"base_net_amount\", \"base_rate_with_margin\"\n\t\t], company_currency, \"items\");\n\n\t\tthis.frm.set_currency_labels([\n\t\t\t\"rate\", \"net_rate\", \"price_list_rate\", \"amount\",\n\t\t\t\"net_amount\", \"stock_uom_rate\", \"rate_with_margin\"\n\t\t], this.frm.doc.currency, \"items\");\n\t},\n\n\tupdate_payment_schedule_grid_labels: function(company_currency) {\n\t\tconst me = this;\n\t\tif (this.frm.doc.payment_schedule && this.frm.doc.payment_schedule.length > 0) {\n\t\t\tthis.frm.set_currency_labels([\"base_payment_amount\", \"base_outstanding\", \"base_paid_amount\"],\n\t\t\t\tcompany_currency, \"payment_schedule\");\n\t\t\tthis.frm.set_currency_labels([\"payment_amount\", \"outstanding\", \"paid_amount\"],\n\t\t\t\tthis.frm.doc.currency, \"payment_schedule\");\n\n\t\t\tvar schedule_grid = this.frm.fields_dict[\"payment_schedule\"].grid;\n\t\t\t$.each([\"base_payment_amount\", \"base_outstanding\", \"base_paid_amount\"], function(i, fname) {\n\t\t\t\tif (frappe.meta.get_docfield(schedule_grid.doctype, fname))\n\t\t\t\t\tschedule_grid.set_column_disp(fname, me.frm.doc.currency != company_currency);\n\t\t\t});\n\t\t}\n\t},\n\n\ttoggle_item_grid_columns: function(company_currency) {\n\t\tconst me = this;\n\t\t// toggle columns\n\t\tvar item_grid = this.frm.fields_dict[\"items\"].grid;\n\t\t$.each([\"base_rate\", \"base_price_list_rate\", \"base_amount\", \"base_rate_with_margin\"], function(i, fname) {\n\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\titem_grid.set_column_disp(fname, me.frm.doc.currency != company_currency);\n\t\t});\n\n\t\tvar show = (cint(cur_frm.doc.discount_amount)) ||\n\t\t\t((cur_frm.doc.taxes || []).filter(function(d) {return d.included_in_print_rate===1}).length);\n\n\t\t$.each([\"net_rate\", \"net_amount\"], function(i, fname) {\n\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\titem_grid.set_column_disp(fname, show);\n\t\t});\n\n\t\t$.each([\"base_net_rate\", \"base_net_amount\"], function(i, fname) {\n\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\titem_grid.set_column_disp(fname, (show && (me.frm.doc.currency != company_currency)));\n\t\t});\n\t},\n\n\trecalculate: function() {\n\t\tthis.calculate_taxes_and_totals();\n\t},\n\n\trecalculate_values: function() {\n\t\tthis.calculate_taxes_and_totals();\n\t},\n\n\tcalculate_charges: function() {\n\t\tthis.calculate_taxes_and_totals();\n\t},\n\n\tignore_pricing_rule: function() {\n\t\tif(this.frm.doc.ignore_pricing_rule) {\n\t\t\tvar me = this;\n\t\t\tvar item_list = [];\n\n\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, d) {\n\t\t\t\tif (d.item_code && !d.is_free_item) {\n\t\t\t\t\titem_list.push({\n\t\t\t\t\t\t\"doctype\": d.doctype,\n\t\t\t\t\t\t\"name\": d.name,\n\t\t\t\t\t\t\"item_code\": d.item_code,\n\t\t\t\t\t\t\"pricing_rules\": d.pricing_rules,\n\t\t\t\t\t\t\"parenttype\": d.parenttype,\n\t\t\t\t\t\t\"parent\": d.parent\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.accounts.doctype.pricing_rule.pricing_rule.remove_pricing_rules\",\n\t\t\t\targs: { item_list: item_list },\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif (!r.exc && r.message) {\n\t\t\t\t\t\tr.message.forEach(row_item => {\n\t\t\t\t\t\t\tme.remove_pricing_rule(row_item);\n\t\t\t\t\t\t});\n\t\t\t\t\t\tme._set_values_for_item_list(r.message);\n\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t\tif(me.frm.doc.apply_discount_on) me.frm.trigger(\"apply_discount_on\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tthis.apply_pricing_rule();\n\t\t}\n\t},\n\n\tapply_pricing_rule: function(item, calculate_taxes_and_totals) {\n\t\tvar me = this;\n\t\tvar args = this._get_args(item);\n\t\tif (!(args.items && args.items.length)) {\n\t\t\tif(calculate_taxes_and_totals) me.calculate_taxes_and_totals();\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.frm.call({\n\t\t\tmethod: \"erpnext.accounts.doctype.pricing_rule.pricing_rule.apply_pricing_rule\",\n\t\t\targs: {\targs: args, doc: me.frm.doc },\n\t\t\tcallback: function(r) {\n\t\t\t\tif (!r.exc && r.message) {\n\t\t\t\t\tme._set_values_for_item_list(r.message);\n\t\t\t\t\tif(item) me.set_gross_profit(item);\n\t\t\t\t\tif(me.frm.doc.apply_discount_on) me.frm.trigger(\"apply_discount_on\")\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\t_get_args: function(item) {\n\t\tvar me = this;\n\t\treturn {\n\t\t\t\"items\": this._get_item_list(item),\n\t\t\t\"customer\": me.frm.doc.customer || me.frm.doc.party_name,\n\t\t\t\"quotation_to\": me.frm.doc.quotation_to,\n\t\t\t\"customer_group\": me.frm.doc.customer_group,\n\t\t\t\"territory\": me.frm.doc.territory,\n\t\t\t\"supplier\": me.frm.doc.supplier,\n\t\t\t\"supplier_group\": me.frm.doc.supplier_group,\n\t\t\t\"currency\": me.frm.doc.currency,\n\t\t\t\"conversion_rate\": me.frm.doc.conversion_rate,\n\t\t\t\"price_list\": me.frm.doc.selling_price_list || me.frm.doc.buying_price_list,\n\t\t\t\"price_list_currency\": me.frm.doc.price_list_currency,\n\t\t\t\"plc_conversion_rate\": me.frm.doc.plc_conversion_rate,\n\t\t\t\"company\": me.frm.doc.company,\n\t\t\t\"transaction_date\": me.frm.doc.transaction_date || me.frm.doc.posting_date,\n\t\t\t\"campaign\": me.frm.doc.campaign,\n\t\t\t\"sales_partner\": me.frm.doc.sales_partner,\n\t\t\t\"ignore_pricing_rule\": me.frm.doc.ignore_pricing_rule,\n\t\t\t\"doctype\": me.frm.doc.doctype,\n\t\t\t\"name\": me.frm.doc.name,\n\t\t\t\"is_return\": cint(me.frm.doc.is_return),\n\t\t\t\"update_stock\": in_list(['Sales Invoice', 'Purchase Invoice'], me.frm.doc.doctype) ? cint(me.frm.doc.update_stock) : 0,\n\t\t\t\"conversion_factor\": me.frm.doc.conversion_factor,\n\t\t\t\"pos_profile\": me.frm.doc.doctype == 'Sales Invoice' ? me.frm.doc.pos_profile : '',\n\t\t\t\"coupon_code\": me.frm.doc.coupon_code\n\t\t};\n\t},\n\n\t_get_item_list: function(item) {\n\t\tvar item_list = [];\n\t\tvar append_item = function(d) {\n\t\t\tif (d.item_code) {\n\t\t\t\titem_list.push({\n\t\t\t\t\t\"doctype\": d.doctype,\n\t\t\t\t\t\"name\": d.name,\n\t\t\t\t\t\"child_docname\": d.name,\n\t\t\t\t\t\"item_code\": d.item_code,\n\t\t\t\t\t\"item_group\": d.item_group,\n\t\t\t\t\t\"brand\": d.brand,\n\t\t\t\t\t\"qty\": d.qty,\n\t\t\t\t\t\"stock_qty\": d.stock_qty,\n\t\t\t\t\t\"uom\": d.uom,\n\t\t\t\t\t\"stock_uom\": d.stock_uom,\n\t\t\t\t\t\"parenttype\": d.parenttype,\n\t\t\t\t\t\"parent\": d.parent,\n\t\t\t\t\t\"pricing_rules\": d.pricing_rules,\n\t\t\t\t\t\"warehouse\": d.warehouse,\n\t\t\t\t\t\"serial_no\": d.serial_no,\n\t\t\t\t\t\"batch_no\": d.batch_no,\n\t\t\t\t\t\"price_list_rate\": d.price_list_rate,\n\t\t\t\t\t\"conversion_factor\": d.conversion_factor || 1.0\n\t\t\t\t});\n\n\t\t\t\t// if doctype is Quotation Item / Sales Order Iten then add Margin Type and rate in item_list\n\t\t\t\tif (in_list([\"Quotation Item\", \"Sales Order Item\", \"Delivery Note Item\", \"Sales Invoice Item\",  \"Purchase Invoice Item\", \"Purchase Order Item\", \"Purchase Receipt Item\",\"Proforma Invoice Item\"]), d.doctype) {\n\t\t\t\t\titem_list[0][\"margin_type\"] = d.margin_type;\n\t\t\t\t\titem_list[0][\"margin_rate_or_amount\"] = d.margin_rate_or_amount;\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tif (item) {\n\t\t\tappend_item(item);\n\t\t} else {\n\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, d) {\n\t\t\t\tappend_item(d);\n\t\t\t});\n\t\t}\n\t\treturn item_list;\n\t},\n\n\t_set_values_for_item_list: function(children) {\n\t\tvar me = this;\n\t\tvar price_list_rate_changed = false;\n\t\tvar items_rule_dict = {};\n\n\t\tfor(var i=0, l=children.length; i<l; i++) {\n\t\t\tvar d = children[i];\n\t\t\tvar existing_pricing_rule = frappe.model.get_value(d.doctype, d.name, \"pricing_rules\");\n\t\t\tfor(var k in d) {\n\t\t\t\tvar v = d[k];\n\t\t\t\tif ([\"doctype\", \"name\"].indexOf(k)===-1) {\n\t\t\t\t\tif(k==\"price_list_rate\") {\n\t\t\t\t\t\tif(flt(v) != flt(d.price_list_rate)) price_list_rate_changed = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (k !== 'free_item_data') {\n\t\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, k, v);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// if pricing rule set as blank from an existing value, apply price_list\n\t\t\tif(!me.frm.doc.ignore_pricing_rule && existing_pricing_rule && !d.pricing_rules) {\n\t\t\t\tme.apply_price_list(frappe.get_doc(d.doctype, d.name));\n\t\t\t} else if(!d.pricing_rules) {\n\t\t\t\tme.remove_pricing_rule(frappe.get_doc(d.doctype, d.name));\n\t\t\t}\n\n\t\t\tif (d.free_item_data) {\n\t\t\t\tme.apply_product_discount(d);\n\t\t\t}\n\n\t\t\tif (d.apply_rule_on_other_items) {\n\t\t\t\titems_rule_dict[d.name] = d;\n\t\t\t}\n\t\t}\n\n\t\tme.apply_rule_on_other_items(items_rule_dict);\n\n\t\tif(!price_list_rate_changed) me.calculate_taxes_and_totals();\n\t},\n\n\tapply_rule_on_other_items: function(args) {\n\t\tconst me = this;\n\t\tconst fields = [\"discount_percentage\", \"pricing_rules\", \"discount_amount\", \"rate\"];\n\n\t\tfor(var k in args) {\n\t\t\tlet data = args[k];\n\n\t\t\tif (data && data.apply_rule_on_other_items) {\n\t\t\t\tme.frm.doc.items.forEach(d => {\n\t\t\t\t\tif (in_list(data.apply_rule_on_other_items, d[data.apply_rule_on])) {\n\t\t\t\t\t\tfor(var k in data) {\n\t\t\t\t\t\t\tif (in_list(fields, k) && data[k] && (data.price_or_product_discount === 'price' || k === 'pricing_rules')) {\n\t\t\t\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, k, data[k]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\tapply_product_discount: function(args) {\n\t\tconst items = this.frm.doc.items.filter(d => (d.is_free_item)) || [];\n\n\t\tconst exist_items = items.map(row => (row.item_code, row.pricing_rules));\n\n\t\targs.free_item_data.forEach(pr_row => {\n\t\t\tlet row_to_modify = {};\n\t\t\tif (!items || !in_list(exist_items, (pr_row.item_code, pr_row.pricing_rules))) {\n\n\t\t\t\trow_to_modify = frappe.model.add_child(this.frm.doc,\n\t\t\t\t\tthis.frm.doc.doctype + ' Item', 'items');\n\n\t\t\t} else if(items) {\n\t\t\t\trow_to_modify = items.filter(d => (d.item_code === pr_row.item_code\n\t\t\t\t\t&& d.pricing_rules === pr_row.pricing_rules))[0];\n\t\t\t}\n\n\t\t\tfor (let key in pr_row) {\n\t\t\t\trow_to_modify[key] = pr_row[key];\n\t\t\t}\n\t\t});\n\n\t\t// free_item_data is a temporary variable\n\t\targs.free_item_data = '';\n\t\trefresh_field('items');\n\t},\n\n\tapply_price_list: function(item, reset_plc_conversion) {\n\t\t// We need to reset plc_conversion_rate sometimes because the call to\n\t\t// `erpnext.stock.get_item_details.apply_price_list` is sensitive to its value\n\t\tif (!reset_plc_conversion) {\n\t\t\tthis.frm.set_value(\"plc_conversion_rate\", \"\");\n\t\t}\n\n\t\tvar me = this;\n\t\tvar args = this._get_args(item);\n\t\tif (!((args.items && args.items.length) || args.price_list)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (me.in_apply_price_list == true) return;\n\n\t\tme.in_apply_price_list = true;\n\t\treturn this.frm.call({\n\t\t\tmethod: \"erpnext.stock.get_item_details.apply_price_list\",\n\t\t\targs: {\targs: args },\n\t\t\tcallback: function(r) {\n\t\t\t\tif (!r.exc) {\n\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t() => me.frm.set_value(\"price_list_currency\", r.message.parent.price_list_currency),\n\t\t\t\t\t\t() => me.frm.set_value(\"plc_conversion_rate\", r.message.parent.plc_conversion_rate),\n\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\tif(args.items.length) {\n\t\t\t\t\t\t\t\tme._set_values_for_item_list(r.message.children);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t() => { me.in_apply_price_list = false; }\n\t\t\t\t\t]);\n\n\t\t\t\t} else {\n\t\t\t\t\tme.in_apply_price_list = false;\n\t\t\t\t}\n\t\t\t}\n\t\t}).always(() => {\n\t\t\tme.in_apply_price_list = false;\n\t\t});\n\t},\n\n\tremove_pricing_rule: function(item) {\n\t\tlet me = this;\n\t\tconst fields = [\"discount_percentage\",\n\t\t\t\"discount_amount\", \"margin_rate_or_amount\", \"rate_with_margin\"];\n\n\t\tif(item.remove_free_item) {\n\t\t\tvar items = [];\n\n\t\t\tme.frm.doc.items.forEach(d => {\n\t\t\t\tif(d.item_code != item.remove_free_item || !d.is_free_item) {\n\t\t\t\t\titems.push(d);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tme.frm.doc.items = items;\n\t\t\trefresh_field('items');\n\t\t} else if(item.applied_on_items && item.apply_on) {\n\t\t\tconst applied_on_items = item.applied_on_items.split(',');\n\t\t\tme.frm.doc.items.forEach(row => {\n\t\t\t\tif(applied_on_items.includes(row[item.apply_on])) {\n\t\t\t\t\tfields.forEach(f => {\n\t\t\t\t\t\trow[f] = 0;\n\t\t\t\t\t});\n\n\t\t\t\t\t[\"pricing_rules\", \"margin_type\"].forEach(field => {\n\t\t\t\t\t\tif (row[field]) {\n\t\t\t\t\t\t\trow[field] = '';\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tme.trigger_price_list_rate();\n\t\t}\n\t},\n\n\ttrigger_price_list_rate: function() {\n\t\tvar me  = this;\n\n\t\tthis.frm.doc.items.forEach(child_row => {\n\t\t\tme.frm.script_manager.trigger(\"price_list_rate\",\n\t\t\t\tchild_row.doctype, child_row.name);\n\t\t})\n\t},\n\n\tvalidate_company_and_party: function() {\n\t\tvar me = this;\n\t\tvar valid = true;\n\n\t\t$.each([\"company\", \"customer\"], function(i, fieldname) {\n\t\t\tif(frappe.meta.has_field(me.frm.doc.doctype, fieldname) && me.frm.doc.doctype != \"Purchase Order\") {\n\t\t\t\tif (!me.frm.doc[fieldname]) {\n\t\t\t\t\tfrappe.msgprint(__(\"Please specify\") + \": \" +\n\t\t\t\t\t\tfrappe.meta.get_label(me.frm.doc.doctype, fieldname, me.frm.doc.name) +\n\t\t\t\t\t\t\". \" + __(\"It is needed to fetch Item Details.\"));\n\t\t\t\t\tvalid = false;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\treturn valid;\n\t},\n\n\tget_terms: function() {\n\t\tvar me = this;\n\n\t\terpnext.utils.get_terms(this.frm.doc.tc_name, this.frm.doc, function(r) {\n\t\t\tif(!r.exc) {\n\t\t\t\tme.frm.set_value(\"terms\", r.message);\n\t\t\t}\n\t\t});\n\t},\n\n\ttaxes_and_charges: function() {\n\t\tvar me = this;\n\t\tif(this.frm.doc.taxes_and_charges) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_taxes_and_charges\",\n\t\t\t\targs: {\n\t\t\t\t\t\"master_doctype\": frappe.meta.get_docfield(this.frm.doc.doctype, \"taxes_and_charges\",\n\t\t\t\t\t\tthis.frm.doc.name).options,\n\t\t\t\t\t\"master_name\": this.frm.doc.taxes_and_charges\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\tif(me.frm.doc.shipping_rule && me.frm.doc.taxes) {\n\t\t\t\t\t\t\tfor (let tax of r.message) {\n\t\t\t\t\t\t\t\tme.frm.add_child(\"taxes\", tax);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\trefresh_field(\"taxes\");\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tme.frm.set_value(\"taxes\", r.message);\n\t\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\ttax_category: function() {\n\t\tvar me = this;\n\t\tif(me.frm.updating_party_details) return;\n\n\t\tfrappe.run_serially([\n\t\t\t() => this.update_item_tax_map(),\n\t\t\t() => erpnext.utils.set_taxes(this.frm, \"tax_category\"),\n\t\t]);\n\t},\n\n\tupdate_item_tax_map: function() {\n\t\tlet me = this;\n\t\tlet item_codes = [];\n\t\tlet item_rates = {};\n\t\tlet item_tax_templates = {};\n\n\t\t$.each(this.frm.doc.items || [], function(i, item) {\n\t\t\tif (item.item_code) {\n\t\t\t\t// Use combination of name and item code in case same item is added multiple times\n\t\t\t\titem_codes.push([item.item_code, item.name]);\n\t\t\t\titem_rates[item.name] = item.net_rate;\n\t\t\t\titem_tax_templates[item.name] = item.item_tax_template;\n\t\t\t}\n\t\t});\n\n\t\tif (item_codes.length) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_item_tax_info\",\n\t\t\t\targs: {\n\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\ttax_category: cstr(me.frm.doc.tax_category),\n\t\t\t\t\titem_codes: item_codes,\n\t\t\t\t\titem_rates: item_rates,\n\t\t\t\t\titem_tax_templates: item_tax_templates\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif (!r.exc) {\n\t\t\t\t\t\t$.each(me.frm.doc.items || [], function(i, item) {\n\t\t\t\t\t\t\tif (item.name && r.message.hasOwnProperty(item.name) && r.message[item.name].item_tax_template) {\n\t\t\t\t\t\t\t\titem.item_tax_template = r.message[item.name].item_tax_template;\n\t\t\t\t\t\t\t\titem.item_tax_rate = r.message[item.name].item_tax_rate;\n\t\t\t\t\t\t\t\tme.add_taxes_from_item_tax_template(item.item_tax_rate);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\titem_tax_template: function(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tif(me.frm.updating_party_details) return;\n\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\n\t\tif(item.item_tax_template) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_item_tax_map\",\n\t\t\t\targs: {\n\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\titem_tax_template: item.item_tax_template,\n\t\t\t\t\tas_json: true\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\titem.item_tax_rate = r.message;\n\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\titem.item_tax_rate = \"{}\";\n\t\t\tme.calculate_taxes_and_totals();\n\t\t}\n\t},\n\n\n\n\tis_recurring: function() {\n\t\t// set default values for recurring documents\n\t\tif(this.frm.doc.is_recurring && this.frm.doc.__islocal) {\n\t\t\tfrappe.msgprint(__(\"Please set recurring after saving\"));\n\t\t\tthis.frm.set_value('is_recurring', 0);\n\t\t\treturn;\n\t\t}\n\n\t\tif(this.frm.doc.is_recurring) {\n\t\t\tif(!this.frm.doc.recurring_id) {\n\t\t\t\tthis.frm.set_value('recurring_id', this.frm.doc.name);\n\t\t\t}\n\n\t\t\tvar owner_email = this.frm.doc.owner==\"Administrator\"\n\t\t\t\t? frappe.user_info(\"Administrator\").email\n\t\t\t\t: this.frm.doc.owner;\n\n\t\t\tthis.frm.doc.notification_email_address = $.map([cstr(owner_email),\n\t\t\t\tcstr(this.frm.doc.contact_email)], function(v) { return v || null; }).join(\", \");\n\t\t\tthis.frm.doc.repeat_on_day_of_month = frappe.datetime.str_to_obj(this.frm.doc.posting_date).getDate();\n\t\t}\n\n\t\trefresh_many([\"notification_email_address\", \"repeat_on_day_of_month\"]);\n\t},\n\n\tfrom_date: function() {\n\t\t// set to_date\n\t\tif(this.frm.doc.from_date) {\n\t\t\tvar recurring_type_map = {'Monthly': 1, 'Quarterly': 3, 'Half-yearly': 6,\n\t\t\t\t'Yearly': 12};\n\n\t\t\tvar months = recurring_type_map[this.frm.doc.recurring_type];\n\t\t\tif(months) {\n\t\t\t\tvar to_date = frappe.datetime.add_months(this.frm.doc.from_date,\n\t\t\t\t\tmonths);\n\t\t\t\tthis.frm.doc.to_date = frappe.datetime.add_days(to_date, -1);\n\t\t\t\trefresh_field('to_date');\n\t\t\t}\n\t\t}\n\t},\n\n\tset_gross_profit: function(item) {\n\t\tif ([\"Sales Order\", \"Quotation\",\"Proforma Invoice\"].includes(this.frm.doc.doctype) && item.valuation_rate) {\n\t\t\tvar rate = flt(item.rate) * flt(this.frm.doc.conversion_rate || 1);\n\t\t\titem.gross_profit = flt(((rate - item.valuation_rate) * item.stock_qty), precision(\"amount\", item));\n\t\t}\n\t},\n\n\tsetup_item_selector: function() {\n\t\t// TODO: remove item selector\n\n\t\treturn;\n\t\t// if(!this.item_selector) {\n\t\t// \tthis.item_selector = new erpnext.ItemSelector({frm: this.frm});\n\t\t// }\n\t},\n\n\tget_advances: function() {\n\t\tif(!this.frm.is_return) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"set_advances\",\n\t\t\t\tdoc: this.frm.doc,\n\t\t\t\tcallback: function(r, rt) {\n\t\t\t\t\trefresh_field(\"advances\");\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\n\tmake_payment_entry: function() {\n\t\treturn frappe.call({\n\t\t\tmethod: cur_frm.cscript.get_method_for_payment(),\n\t\t\targs: {\n\t\t\t\t\"dt\": cur_frm.doc.doctype,\n\t\t\t\t\"dn\": cur_frm.doc.name\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tvar doclist = frappe.model.sync(r.message);\n\t\t\t\tfrappe.set_route(\"Form\", doclist[0].doctype, doclist[0].name);\n\t\t\t\t// cur_frm.refresh_fields()\n\t\t\t}\n\t\t});\n\t},\n\n\tmake_quality_inspection: function () {\n\t\tlet data = [];\n\t\tconst fields = [\n\t\t\t{\n\t\t\t\tlabel: \"Items\",\n\t\t\t\tfieldtype: \"Table\",\n\t\t\t\tfieldname: \"items\",\n\t\t\t\tcannot_add_rows: true,\n\t\t\t\tin_place_edit: true,\n\t\t\t\tdata: data,\n\t\t\t\tget_data: () => {\n\t\t\t\t\treturn data;\n\t\t\t\t},\n\t\t\t\tfields: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Data\",\n\t\t\t\t\t\tfieldname: \"docname\",\n\t\t\t\t\t\thidden: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Read Only\",\n\t\t\t\t\t\tfieldname: \"item_code\",\n\t\t\t\t\t\tlabel: __(\"Item Code\"),\n\t\t\t\t\t\tin_list_view: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Read Only\",\n\t\t\t\t\t\tfieldname: \"item_name\",\n\t\t\t\t\t\tlabel: __(\"Item Name\"),\n\t\t\t\t\t\tin_list_view: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Float\",\n\t\t\t\t\t\tfieldname: \"qty\",\n\t\t\t\t\t\tlabel: __(\"Accepted Quantity\"),\n\t\t\t\t\t\tin_list_view: true,\n\t\t\t\t\t\tread_only: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Float\",\n\t\t\t\t\t\tfieldname: \"sample_size\",\n\t\t\t\t\t\tlabel: __(\"Sample Size\"),\n\t\t\t\t\t\treqd: true,\n\t\t\t\t\t\tin_list_view: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Data\",\n\t\t\t\t\t\tfieldname: \"description\",\n\t\t\t\t\t\tlabel: __(\"Description\"),\n\t\t\t\t\t\thidden: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Data\",\n\t\t\t\t\t\tfieldname: \"serial_no\",\n\t\t\t\t\t\tlabel: __(\"Serial No\"),\n\t\t\t\t\t\thidden: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Data\",\n\t\t\t\t\t\tfieldname: \"batch_no\",\n\t\t\t\t\t\tlabel: __(\"Batch No\"),\n\t\t\t\t\t\thidden: true\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t}\n\t\t];\n\n\t\tconst me = this;\n\t\tconst dialog = new frappe.ui.Dialog({\n\t\t\ttitle: __(\"Select Items for Quality Inspection\"),\n\t\t\tfields: fields,\n\t\t\tprimary_action: function () {\n\t\t\t\tconst data = dialog.get_values();\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"erpnext.controllers.stock_controller.make_quality_inspections\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\tdoctype: me.frm.doc.doctype,\n\t\t\t\t\t\tdocname: me.frm.doc.name,\n\t\t\t\t\t\titems: data.items\n\t\t\t\t\t},\n\t\t\t\t\tfreeze: true,\n\t\t\t\t\tcallback: function (r) {\n\t\t\t\t\t\tif (r.message.length > 0) {\n\t\t\t\t\t\t\tif (r.message.length === 1) {\n\t\t\t\t\t\t\t\tfrappe.set_route(\"Form\", \"Quality Inspection\", r.message[0]);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tfrappe.route_options = {\n\t\t\t\t\t\t\t\t\t\"reference_type\": me.frm.doc.doctype,\n\t\t\t\t\t\t\t\t\t\"reference_name\": me.frm.doc.name\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\tfrappe.set_route(\"List\", \"Quality Inspection\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdialog.hide();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\tprimary_action_label: __(\"Create\")\n\t\t});\n\n\t\tthis.frm.doc.items.forEach(item => {\n\t\t\tif (!item.quality_inspection) {\n\t\t\t\tlet dialog_items = dialog.fields_dict.items;\n\t\t\t\tdialog_items.df.data.push({\n\t\t\t\t\t\"docname\": item.name,\n\t\t\t\t\t\"item_code\": item.item_code,\n\t\t\t\t\t\"item_name\": item.item_name,\n\t\t\t\t\t\"qty\": item.qty,\n\t\t\t\t\t\"description\": item.description,\n\t\t\t\t\t\"serial_no\": item.serial_no,\n\t\t\t\t\t\"batch_no\": item.batch_no\n\t\t\t\t});\n\t\t\t\tdialog_items.grid.refresh();\n\t\t\t}\n\t\t});\n\n\t\tdata = dialog.fields_dict.items.df.data;\n\t\tif (!data.length) {\n\t\t\tfrappe.msgprint(__(\"All items in this document already have a linked Quality Inspection.\"));\n\t\t} else {\n\t\t\tdialog.show();\n\t\t}\n\t},\n\n\tget_method_for_payment: function(){\n\t\tvar method = \"erpnext.accounts.doctype.payment_entry.payment_entry.get_payment_entry\";\n\t\tif(cur_frm.doc.__onload && cur_frm.doc.__onload.make_payment_via_journal_entry){\n\t\t\tif(in_list(['Sales Invoice', 'Purchase Invoice'],  cur_frm.doc.doctype)){\n\t\t\t\tmethod = \"erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_invoice\";\n\t\t\t}else {\n\t\t\t\tmethod= \"erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_order\";\n\t\t\t}\n\t\t}\n\n\t\treturn method\n\t},\n\n\tset_query_for_batch: function(doc, cdt, cdn) {\n\t\t// Show item's batches in the dropdown of batch no\n\n\t\tvar me = this;\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\n\t\tif(!item.item_code) {\n\t\t\tfrappe.throw(__(\"Please enter Item Code to get batch no\"));\n\t\t} else if (doc.doctype == \"Purchase Receipt\" ||\n\t\t\t(doc.doctype == \"Purchase Invoice\" && doc.update_stock)) {\n\t\t\treturn {\n\t\t\t\tfilters: {'item': item.item_code}\n\t\t\t}\n\t\t} else {\n\t\t\tlet filters = {\n\t\t\t\t'item_code': item.item_code,\n\t\t\t\t'posting_date': me.frm.doc.posting_date || frappe.datetime.nowdate(),\n\t\t\t}\n\n\t\t\tif (doc.is_return) {\n\t\t\t\tfilters[\"is_return\"] = 1;\n\t\t\t}\n\n\t\t\tif (item.warehouse) filters[\"warehouse\"] = item.warehouse;\n\n\t\t\treturn {\n\t\t\t\tquery : \"erpnext.controllers.queries.get_batch_no\",\n\t\t\t\tfilters: filters\n\t\t\t}\n\t\t}\n\t},\n\n\tset_query_for_item_tax_template: function(doc, cdt, cdn) {\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tif(!item.item_code) {\n\t\t\treturn doc.company ? {filters: {company: doc.company}} : {};\n\t\t} else {\n\t\t\tlet filters = {\n\t\t\t\t'item_code': item.item_code,\n\t\t\t\t'valid_from': [\"<=\", doc.transaction_date || doc.bill_date || doc.posting_date],\n\t\t\t\t'item_group': item.item_group,\n\t\t\t}\n\n\t\t\tif (doc.tax_category)\n\t\t\t\tfilters['tax_category'] = doc.tax_category;\n\t\t\tif (doc.company)\n\t\t\t\tfilters['company'] = doc.company;\n\t\t\treturn {\n\t\t\t\tquery: \"erpnext.controllers.queries.get_tax_template\",\n\t\t\t\tfilters: filters\n\t\t\t}\n\t\t}\n\t},\n\n\tpayment_terms_template: function() {\n\t\tvar me = this;\n\t\tconst doc = this.frm.doc;\n\t\tif(doc.payment_terms_template && doc.doctype !== 'Delivery Note') {\n\t\t\tvar posting_date = doc.posting_date || doc.transaction_date;\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_payment_terms\",\n\t\t\t\targs: {\n\t\t\t\t\tterms_template: doc.payment_terms_template,\n\t\t\t\t\tposting_date: posting_date,\n\t\t\t\t\tgrand_total: doc.rounded_total || doc.grand_total,\n\t\t\t\t\tbase_grand_total: doc.base_rounded_total || doc.base_grand_total,\n\t\t\t\t\tbill_date: doc.bill_date\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(r.message && !r.exc) {\n\t\t\t\t\t\tme.frm.set_value(\"payment_schedule\", r.message);\n\t\t\t\t\t\tconst company_currency = me.get_company_currency();\n\t\t\t\t\t\tme.update_payment_schedule_grid_labels(company_currency);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\n\tpayment_term: function(doc, cdt, cdn) {\n\t\tconst me = this;\n\t\tvar row = locals[cdt][cdn];\n\t\tif(row.payment_term) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_payment_term_details\",\n\t\t\t\targs: {\n\t\t\t\t\tterm: row.payment_term,\n\t\t\t\t\tbill_date: this.frm.doc.bill_date,\n\t\t\t\t\tposting_date: this.frm.doc.posting_date || this.frm.doc.transaction_date,\n\t\t\t\t\tgrand_total: this.frm.doc.rounded_total || this.frm.doc.grand_total,\n\t\t\t\t\tbase_grand_total: this.frm.doc.base_rounded_total || this.frm.doc.base_grand_total\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(r.message && !r.exc) {\n\t\t\t\t\t\tfor (var d in r.message) {\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, d, r.message[d]);\n\t\t\t\t\t\t\tconst company_currency = me.get_company_currency();\n\t\t\t\t\t\t\tme.update_payment_schedule_grid_labels(company_currency);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\n\tagainst_blanket_order: function(doc, cdt, cdn) {\n\t\tvar item = locals[cdt][cdn];\n\t\tif(!item.against_blanket_order) {\n\t\t\tfrappe.model.set_value(this.frm.doctype + \" Item\", item.name, \"blanket_order\", null);\n\t\t\tfrappe.model.set_value(this.frm.doctype + \" Item\", item.name, \"blanket_order_rate\", 0.00);\n\t\t}\n\t},\n\n\tblanket_order: function(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tvar item = locals[cdt][cdn];\n\t\tif (item.blanket_order && (item.parenttype==\"Sales Order\" || item.parenttype==\"Purchase Order\")) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_blanket_order_details\",\n\t\t\t\targs: {\n\t\t\t\t\targs:{\n\t\t\t\t\t\titem_code: item.item_code,\n\t\t\t\t\t\tcustomer: doc.customer,\n\t\t\t\t\t\tsupplier: doc.supplier,\n\t\t\t\t\t\tcompany: doc.company,\n\t\t\t\t\t\ttransaction_date: doc.transaction_date,\n\t\t\t\t\t\tblanket_order: item.blanket_order\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif (!r.message) {\n\t\t\t\t\t\tfrappe.throw(__(\"Invalid Blanket Order for the selected Customer and Item\"));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t() => frappe.model.set_value(cdt, cdn, \"blanket_order_rate\", r.message.blanket_order_rate),\n\t\t\t\t\t\t\t() => me.frm.script_manager.trigger(\"price_list_rate\", cdt, cdn)\n\t\t\t\t\t\t]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\n\tset_reserve_warehouse: function() {\n\t\tthis.autofill_warehouse(this.frm.doc.supplied_items, \"reserve_warehouse\", this.frm.doc.set_reserve_warehouse);\n\t},\n\n\tset_warehouse: function() {\n\t\tthis.autofill_warehouse(this.frm.doc.items, \"warehouse\", this.frm.doc.set_warehouse);\n\t},\n\n\tset_target_warehouse: function() {\n\t\tthis.autofill_warehouse(this.frm.doc.items, \"target_warehouse\", this.frm.doc.set_target_warehouse);\n\t},\n\n\tset_from_warehouse: function() {\n\t\tthis.autofill_warehouse(this.frm.doc.items, \"from_warehouse\", this.frm.doc.set_from_warehouse);\n\t},\n\n\tautofill_warehouse : function (child_table, warehouse_field, warehouse) {\n\t\tif (warehouse && child_table && child_table.length) {\n\t\t\tlet doctype = child_table[0].doctype;\n\t\t\t$.each(child_table || [], function(i, item) {\n\t\t\t\tfrappe.model.set_value(doctype, item.name, warehouse_field, warehouse);\n\t\t\t});\n\t\t}\n\t},\n\n\tcoupon_code: function() {\n\t\tvar me = this;\n\t\tfrappe.run_serially([\n\t\t\t() => this.frm.doc.ignore_pricing_rule=1,\n\t\t\t() => me.ignore_pricing_rule(),\n\t\t\t() => this.frm.doc.ignore_pricing_rule=0,\n\t\t\t() => me.apply_pricing_rule()\n\t\t]);\n\t}\n});\n\nerpnext.show_serial_batch_selector = function (frm, d, callback, on_close, show_dialog) {\n\tlet warehouse, receiving_stock, existing_stock;\n\tif (frm.doc.is_return) {\n\t\tif ([\"Purchase Receipt\", \"Purchase Invoice\"].includes(frm.doc.doctype)) {\n\t\t\texisting_stock = true;\n\t\t\twarehouse = d.warehouse;\n\t\t} else if ([\"Delivery Note\", \"Sales Invoice\"].includes(frm.doc.doctype)) {\n\t\t\treceiving_stock = true;\n\t\t}\n\t} else {\n\t\tif (frm.doc.doctype == \"Stock Entry\") {\n\t\t\tif (frm.doc.purpose == \"Material Receipt\") {\n\t\t\t\treceiving_stock = true;\n\t\t\t} else {\n\t\t\t\texisting_stock = true;\n\t\t\t\twarehouse = d.s_warehouse;\n\t\t\t}\n\t\t} else {\n\t\t\texisting_stock = true;\n\t\t\twarehouse = d.warehouse;\n\t\t}\n\t}\n\n\tif (!warehouse) {\n\t\tif (receiving_stock) {\n\t\t\twarehouse = [\"like\", \"\"];\n\t\t} else if (existing_stock) {\n\t\t\twarehouse = [\"!=\", \"\"];\n\t\t}\n\t}\n\n\tfrappe.require(\"assets/erpnext/js/utils/serial_no_batch_selector.js\", function() {\n\t\tnew erpnext.SerialNoBatchSelector({\n\t\t\tfrm: frm,\n\t\t\titem: d,\n\t\t\twarehouse_details: {\n\t\t\t\ttype: \"Warehouse\",\n\t\t\t\tname: warehouse\n\t\t\t},\n\t\t\tcallback: callback,\n\t\t\ton_close: on_close\n\t\t}, show_dialog);\n\t});\n}\n\nerpnext.apply_putaway_rule = (frm, purpose=null) => {\n\tif (!frm.doc.company) {\n\t\tfrappe.throw({message: __(\"Please select a Company first.\"), title: __(\"Mandatory\")});\n\t}\n\tif (!frm.doc.items.length) return;\n\n\tfrappe.call({\n\t\tmethod: \"erpnext.stock.doctype.putaway_rule.putaway_rule.apply_putaway_rule\",\n\t\targs: {\n\t\t\tdoctype: frm.doctype,\n\t\t\titems: frm.doc.items,\n\t\t\tcompany: frm.doc.company,\n\t\t\tsync: true,\n\t\t\tpurpose: purpose\n\t\t},\n\t\tcallback: (result) => {\n\t\t\tif (!result.exc && result.message) {\n\t\t\t\tfrm.clear_table(\"items\");\n\n\t\t\t\tlet items =  result.message;\n\t\t\t\titems.forEach((row) => {\n\t\t\t\t\tdelete row[\"name\"]; // dont overwrite name from server side\n\t\t\t\t\tlet child = frm.add_child(\"items\");\n\t\t\t\t\tObject.assign(child, row);\n\t\t\t\t\tfrm.script_manager.trigger(\"qty\", child.doctype, child.name);\n\t\t\t\t});\n\t\t\t\tfrm.get_field(\"items\").grid.refresh();\n\t\t\t}\n\t\t}\n\t});\n};\n"],
  "mappings": ";;AAGA,UAAQ,mBAAmB,QAAQ,SAAS,OAAO;AAAA,IAClD,OAAO,WAAW;AACjB,WAAK,yBAAyB;AAAA,IAC/B;AAAA,IAEA,4BAA4B,SAAS,MAAM;AAC1C,UAAI,sBAAsB,KAAK;AAC/B,UAAI,YAAY,KAAK;AACrB,UAAI,QAAQ,CAAC,eAAe,WAAW,GAAG,KAAK,UAAU,KAAK,KAAK,oBAAoB;AACtF,8BAAsB,KAAK;AAAA,MAC5B;AACA,UAAI,KAAK,eAAe,cAAc;AACrC,aAAK,mBAAmB,IAAI,mBAAmB,IAC5C,IAAI,mBAAmB,IAAM,KAAI,KAAK,qBAAqB,IAAI;AAAA,MACnE,OAAO;AACN,aAAK,mBAAmB,IAAI,mBAAmB,IAAI,IAAI,KAAK,qBAAqB;AAAA,MAClF;AACA,WAAK,wBAAwB,IAAI,KAAK,gBAAgB,IAAI,IAAI,KAAK,IAAI,IAAI,eAAe;AAE1F,kBAAY,IAAI,KAAK,kBAAmB,UAAU,QAAQ,IAAI,CAAC;AAE/D,UAAI,KAAK,qBAAqB;AAC7B,aAAK,kBAAkB,IAAI,KAAK,gBAAgB,IAAI,IAAI,KAAK,mBAAmB,IAAI;AAAA,MACrF;AAEA,UAAI,KAAK,iBAAiB;AACzB,oBAAY,IAAK,KAAK,mBAAqB,KAAK,iBAAkB,UAAU,QAAQ,IAAI,CAAC;AACzF,aAAK,sBAAsB,MAAM,IAAI,KAAK,eAAe,IAAI,IAAI,KAAK,gBAAgB;AAAA,MACvF;AAEA,aAAO,MAAM,UAAU,KAAK,SAAS,KAAK,MAAM,QAAQ,SAAS;AAAA,IAClE;AAAA,IAEA,4BAA4B,SAAS,oBAAoB;AACxD,WAAK,0BAA0B;AAC/B,WAAK,4BAA4B;AACjC,WAAK,0BAA0B;AAG/B,UAAG,QAAQ,CAAC,iBAAiB,eAAe,kBAAkB,GAAG,KAAK,IAAI,IAAI,OAAO,KACjF,KAAK,IAAI,IAAI,YAAY,KAAK,CAAC,KAAK,IAAI,IAAI,WAAW;AAC1D,aAAK,wBAAwB,kBAAkB;AAAA,MAChD;AAEA,UAAI,QAAQ,CAAC,iBAAiB,aAAa,GAAG,KAAK,IAAI,IAAI,OAAO,KAAK,KAAK,IAAI,IAAI,UACnF,KAAK,IAAI,IAAI,WAAW;AACxB,aAAK,8BAA8B;AAAA,MACpC;AAGA,UAAG,QAAQ,CAAC,aAAa,eAAe,iBAAiB,iBAAgB,kBAAkB,GAAG,KAAK,IAAI,IAAI,OAAO,GAAG;AACpH,aAAK,qBAAqB;AAC1B,aAAK,uBAAuB;AAAA,MAC7B;AAGA,UAAG,KAAK,IAAI,IAAI,YAAY,sBAAsB,KAAK,IAAI,IAAI,aAC1D,KAAK,IAAI,IAAI,cAAc,KAAK,IAAI,IAAI,aAAc;AAC1D,aAAK,IAAI,IAAI,cAAc,IAAI,KAAK,IAAI,IAAI,aAAa,UAAU,aAAa,CAAC;AAAA,MAClF;AAEA,WAAK,IAAI,eAAe;AAAA,IACzB;AAAA,IAEA,2BAA2B,WAAW;AACrC,UAAI,OAAO,KAAK,aAAa,KAAK,IAAI,IAAI,SAAS,iBAAiB,GAAG;AACtE,aAAK,sBAAsB;AAC3B,aAAK,oBAAoB;AACzB,aAAK,oBAAoB;AACzB,aAAK,sBAAsB;AAAA,MAC5B;AAAA,IACD;AAAA,IAEA,6BAA6B,WAAW;AACvC,WAAK,yBAAyB;AAC9B,WAAK,sBAAsB;AAC3B,WAAK,iBAAiB;AACtB,WAAK,yBAAyB;AAC9B,WAAK,oBAAoB;AACzB,WAAK,gBAAgB;AACrB,WAAK,yCAAyC;AAC9C,WAAK,iBAAiB;AACtB,WAAK,SAAS;AAAA,IACf;AAAA,IAEA,0BAA0B,WAAW;AACpC,WAAK,IAAI,IAAI,kBAAkB,IAAI,KAAK,IAAI,IAAI,iBAAkB,UAAW,UAAU,iBAAiB,IAAI,CAAC;AAC7G,UAAI,wBAAwB,OAAO,KAAK,UAAU,KAAK,IAAI,IAAI,SAAS,mBACvE,KAAK,IAAI,IAAI,IAAI;AAClB,UAAI,mBAAmB,KAAK,qBAAqB;AAEjD,UAAG,CAAC,KAAK,IAAI,IAAI,iBAAiB;AACjC,YAAG,KAAK,IAAI,IAAI,YAAY,kBAAkB;AAC7C,eAAK,IAAI,UAAU,mBAAmB,CAAC;AAAA,QACxC,OAAO;AACN,gBAAM,OAAQ,CAAC,uBAAuB,KAAK,IAAI,IAAI,UAAU,gBAAgB;AAC7E,gBAAM,cAAc,GAAG,kFAAkF,IAAI;AAC7G,iBAAO,MAAM,WAAW;AAAA,QACzB;AAAA,MACD;AAAA,IACD;AAAA,IAEA,uBAAuB,WAAW;AACjC,UAAI,KAAK;AACT,UAAI,CAAC,KAAK,yBAAyB;AAClC,UAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,MAAM;AACrD,iBAAO,MAAM,gBAAgB,IAAI;AACjC,eAAK,WAAW,KAAK;AAErB,cAAK,CAAC,KAAK,OAAQ,GAAG,IAAI,IAAI,WAAW;AACxC,iBAAK,SAAS,IAAI,KAAK,OAAO,IAAI,UAAU,UAAU,IAAI,CAAC;AAAA,UAC5D,WACS,KAAK,OAAO,WAAW;AAC/B,iBAAK,SAAS,IAAK,KAAK,OAAO,KAAK,MAAK,KAAK,UAAU,UAAU,IAAI,CAAC;AAAA,UACxE,OAAO;AACN,iBAAK,SAAS,IAAI,KAAK,OAAO,KAAK,KAAK,UAAU,UAAU,IAAI,CAAC;AAAA,UAClE;AAEA,eAAK,aAAa,KAAK;AACvB,eAAK,kBAAkB;AACvB,eAAK,eAAe,IAAI,KAAK,kBAAkB,KAAK,SAAS;AAE7D,aAAG,wBAAwB,MAAM,CAAC,mBAAmB,QAAQ,UAAU,YAAY,YAAY,CAAC;AAAA,QACjG,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,yBAAyB,SAAS,KAAK,QAAQ;AAC9C,UAAI,KAAK;AACT,QAAE,KAAK,QAAQ,SAAS,GAAG,GAAG;AAC7B,YAAI,UAAQ,KAAK,IAAI,IAAI,IAAI,IAAI,UAAU,GAAG,GAAG,CAAC,IAAI,GAAG,IAAI,IAAI,iBAAiB,UAAU,UAAU,GAAG,GAAG,CAAC;AAAA,MAC9G,CAAC;AAAA,IACF;AAAA,IAEA,kBAAkB,WAAW;AAC5B,UAAI,KAAK;AAET,QAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,KAAK;AACpD,YAAI,uBAAuB,CAAC;AAC5B,YAAI,aAAa;AAAA,UAAC;AAAA,UAAS;AAAA,UAC1B;AAAA,UAA+B;AAAA,UAC/B;AAAA,UAAiC;AAAA,QAAuC;AAEzE,YAAI,KAAK,IAAI,WAAW,KAAK,YAC5B,CAAE,IAAG,2BAA2B,GAAG,IAAI,IAAI,qBAAmB,gBAAgB;AAC9E,qBAAW,KAAK,YAAY;AAAA,QAC7B;AAEA,UAAE,KAAK,YAAY,SAAS,IAAG,WAAW;AAAE,cAAI,aAAa;AAAA,QAAK,CAAC;AAEnE,YAAI,CAAC,KAAK,2BAA2B,SAAS;AAC7C,kBAAQ,QAAQ,2BAA2B,IAAI,SAAS,IAAI,IAAI;AAChE,aAAG,uBAAuB,GAAG;AAAA,QAC9B;AACA,eAAO,MAAM,gBAAgB,GAAG;AAAA,MACjC,CAAC;AAAA,IACF;AAAA,IAEA,0BAA0B,WAAW;AACpC,UAAI,KAAK;AACT,aAAO,MAAM,gCAAgC,CAAC;AAE9C,UAAI,GAAG,IAAI,IAAI,SAAS;AACvB,eAAO,OAAO,KAAK;AAAA,UAClB,UAAU;AAAA,UACV,QAAQ;AAAA,YACP,WAAW,GAAG,IAAI,IAAI;AAAA,YACtB,gBAAgB,OAAO,MAAM;AAAA,UAC9B;AAAA,UACA,UAAU,SAAS,GAAG;AACrB,mBAAO,MAAM,8BAA8B,KAAK,GAAG,EAAE,OAAO;AAAA,UAC7D;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,0BAA0B,WAAW;AACpC,UAAI,KAAK;AAET,UAAI,oBAAoB;AACxB,QAAE,KAAK,GAAG,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,KAAK;AAClD,YAAG,KAAK,IAAI,sBAAsB;AAAG,8BAAoB;AAAA,MAC1D,CAAC;AACD,UAAG,qBAAmB;AAAO;AAE7B,QAAE,KAAK,GAAG,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,MAAM;AACnD,YAAI,eAAe,GAAG,oBAAoB,KAAK,aAAa;AAC5D,YAAI,yBAAyB;AAC7B,YAAI,qCAAqC;AACzC,UAAE,KAAK,GAAG,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,KAAK;AAClD,cAAI,uBAAuB,GAAG,yBAAyB,KAAK,YAAY;AACxE,cAAI,gCAAgC,qBAAqB;AACzD,cAAI,+BAA+B,qBAAqB;AAExD,cAAG,KAAG,GAAG;AACR,gBAAI,wCAAwC,IAAI,IAAI;AAAA,UACrD,OAAO;AACN,gBAAI,wCACH,GAAG,IAAI,IAAI,SAAS,IAAE,GAAG,wCACzB,IAAI;AAAA,UACN;AAEA,oCAA0B,IAAI;AAC9B,gDAAsC,+BAA+B,IAAI,KAAK,GAAG;AAAA,QAClF,CAAC;AAED,YAAG,CAAC,GAAG,2BAA2B,KAAK,OAAQ,uCAAsC,yBAAyB;AAC7G,cAAI,SAAS,IAAI,KAAK,MAAM,IAAI;AAChC,eAAK,aAAa,IAAI,SAAU,KAAI,uBAAuB;AAC3D,eAAK,WAAW,KAAK,MAAM,IAAI,KAAK,aAAa,KAAK,KAAK,UAAU,YAAY,IAAI,CAAC,IAAI;AAE1F,aAAG,wBAAwB,MAAM,CAAC,YAAY,YAAY,CAAC;AAAA,QAC5D;AAAA,MACD,CAAC;AAAA,IACF;AAAA,IAEA,0BAA0B,SAAS,KAAK,cAAc;AAGrD,UAAI,uBAAuB;AAC3B,UAAI,+BAA+B;AAEnC,UAAG,KAAK,IAAI,sBAAsB,GAAG;AACpC,YAAI,WAAW,KAAK,cAAc,KAAK,YAAY;AAEnD,YAAG,IAAI,eAAe,gBAAgB;AACrC,iCAAwB,WAAW;AAAA,QAEpC,WAAU,IAAI,eAAe,0BAA0B;AACtD,iCAAwB,WAAW,MAClC,KAAK,IAAI,IAAI,SAAS,KAAK,IAAI,MAAM,IAAI,GAAG;AAAA,QAE9C,WAAU,IAAI,eAAe,yBAAyB;AACrD,iCAAwB,WAAW,MAClC,KAAK,IAAI,IAAI,SAAS,KAAK,IAAI,MAAM,IAAI,GAAG;AAAA,QAC9C,WAAW,IAAI,eAAe,oBAAoB;AACjD,yCAA+B,IAAI,QAAQ;AAAA,QAC5C;AAAA,MACD;AAEA,UAAG,IAAI,kBAAkB,IAAI,kBAAkB,UAAU;AACxD,gCAAwB;AACxB,wCAAgC;AAAA,MACjC;AACA,aAAO,CAAC,sBAAsB,4BAA4B;AAAA,IAC3D;AAAA,IAEA,eAAe,SAAS,KAAK,cAAc;AAC1C,aAAQ,OAAO,KAAK,YAAY,EAAE,QAAQ,IAAI,YAAY,KAAK,KAC9D,IAAI,aAAa,IAAI,eAAe,UAAU,QAAQ,GAAG,CAAC,IAAI,IAAI;AAAA,IACpE;AAAA,IAEA,qBAAqB,WAAW;AAC/B,UAAI,KAAK;AACT,WAAK,IAAI,IAAI,YAAY,KAAK,IAAI,IAAI,QAAQ,KAAK,IAAI,IAAI,aAAa,KAAK,IAAI,IAAI,YAAY,KAAK,IAAI,IAAI,iBAAiB;AAE/H,QAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,MAAM;AACrD,WAAG,IAAI,IAAI,SAAS,KAAK;AACzB,WAAG,IAAI,IAAI,aAAa,KAAK;AAC7B,WAAG,IAAI,IAAI,cAAc,KAAK;AAC9B,WAAG,IAAI,IAAI,aAAa,KAAK;AAC7B,WAAG,IAAI,IAAI,kBAAkB,KAAK;AAAA,MAClC,CAAC;AAEF,aAAO,MAAM,gBAAgB,KAAK,IAAI,KAAK,CAAC,SAAS,cAAc,aAAa,gBAAgB,CAAC;AAAA,IAClG;AAAA,IAEA,kCAAkC,SAAS,cAAc;AACxD,UAAI,KAAK;AAET,UAAI,gBAAgB,KAAK,OAAO,SAAS,YAAY,kCAAkC,CAAC,GAAG;AAC1F,YAAI,OAAQ,gBAAiB,UAAU;AACtC,yBAAe,KAAK,MAAM,YAAY;AAAA,QACvC;AAEA,UAAE,KAAK,cAAc,SAAS,KAAK,MAAM;AACxC,cAAI,QAAS,IAAG,IAAI,IAAI,SAAS,CAAC,GAAG,KAAK,OAAK,EAAE,iBAAiB,GAAG;AACrE,cAAI,CAAC,OAAO;AACX,gBAAI,QAAQ,OAAO,MAAM,UAAU,GAAG,IAAI,KAAK,OAAO;AACtD,kBAAM,cAAc;AACpB,kBAAM,eAAe;AACrB,kBAAM,OAAO;AAAA,UACd;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,iBAAiB,WAAW;AAC3B,UAAI,KAAK;AACT,WAAK,IAAI,IAAI,sBAAsB;AACnC,UAAI,kBAAkB,CAAC;AAGvB,QAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,KAAK;AACpD,YAAI,IAAI,eAAe,UAAU;AAChC,0BAAgB,IAAI,OAAO,IAAI,IAAI,YAAY,UAAU,cAAc,GAAG,CAAC;AAAA,QAC5E;AAAA,MACD,CAAC;AAED,QAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,MAAM;AACrD,YAAI,eAAe,GAAG,oBAAoB,KAAK,aAAa;AAC5D,UAAE,KAAK,GAAG,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,KAAK;AAElD,cAAI,qBAAqB,GAAG,uBAAuB,MAAM,KAAK,YAAY;AAG1E,cAAI,IAAI,eAAe,UAAU;AAChC,4BAAgB,IAAI,QAAQ;AAC5B,gBAAI,KAAK,GAAG,IAAI,IAAI,SAAS,SAAS,GAAG;AACxC,oCAAsB,gBAAgB,IAAI;AAAA,YAC3C;AAAA,UACD;AAGA,cAAI,IAAI,eAAe,YACtB,CAAE,IAAG,2BAA2B,GAAG,IAAI,IAAI,qBAAmB,gBAAgB;AAC9E,gBAAI,cAAc;AAAA,UACnB;AAIA,cAAI,8BAA8B;AAGlC,cAAI,oCAAoC;AAGxC,cAAG,IAAI,UAAU;AAGhB,iCAAsB,IAAI,YAAY,cAAe,IAAM;AAE3D,kCAAuB,IAAI,kBAAkB,WAAY,KAAO;AAAA,UACjE;AAIA,cAAG,KAAG,GAAG;AACR,gBAAI,+BAA+B,IAAI,KAAK,aAAa,kBAAkB;AAAA,UAC5E,OAAO;AACN,gBAAI,+BACH,IAAI,GAAG,IAAI,IAAI,SAAS,IAAE,GAAG,+BAA+B,kBAAkB;AAAA,UAChF;AAGA,cAAI,KAAK,GAAG,IAAI,IAAI,SAAS,SAAS,GAAG;AACxC,eAAG,iBAAiB,GAAG;AACvB,eAAG,wBAAwB,KAC1B,CAAC,cAAc,kCAAkC,CAAC;AAEnD,eAAG,sBAAsB,GAAG;AAG5B,eAAG,qBAAqB,GAAG,GAAG;AAE9B,eAAG,wBAAwB,KAAK,CAAC,OAAO,CAAC;AAGzC,gBAAK,KAAK,GAAG,IAAI,IAAI,SAAS,SAAS,KAAM,GAAG,2BAC5C,GAAG,IAAI,IAAI,qBAAqB,iBAAiB,GAAG,IAAI,IAAI,iBAAiB;AAChF,iBAAG,IAAI,IAAI,sBAAsB,IAAI,GAAG,IAAI,IAAI,cAC/C,IAAI,GAAG,IAAI,IAAI,eAAe,IAAI,IAAI,OAAO,UAAU,qBAAqB,CAAC;AAAA,YAC/E;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF,CAAC;AAAA,IACF;AAAA,IAEA,sBAAsB,SAAS,SAAS,KAAK;AAC5C,UAAI,aAAa,IAAI;AACrB,UAAI,IAAI,YAAY,aAAa;AAChC,qBAAa;AAAA,MACd;AAEA,UAAI,IAAI,kBAAkB,UAAU;AAAE,qBAAa,KAAG;AAAA,MAAY;AAElE,UAAG,WAAS,GAAG;AACd,YAAI,QAAQ,IAAI,KAAK,IAAI,IAAI,YAAY,YAAY,UAAU,SAAS,GAAG,CAAC;AAAA,MAC7E,OAAO;AACN,YAAI,QAAQ,IAAI,KAAK,IAAI,IAAI,SAAS,UAAQ,GAAG,QAAQ,YAAY,UAAU,SAAS,GAAG,CAAC;AAAA,MAC7F;AAAA,IACD;AAAA,IAEA,qBAAqB,SAAS,eAAe;AAC5C,aAAO,gBAAgB,KAAK,MAAM,aAAa,IAAI,CAAC;AAAA,IACrD;AAAA,IAEA,wBAAwB,SAAS,MAAM,KAAK,cAAc;AACzD,UAAI,WAAW,KAAK,cAAc,KAAK,YAAY;AACnD,UAAI,qBAAqB;AAGzB,UAAG,CAAC,0BAA0B,uBAAuB,EAAE,SAAS,IAAI,WAAW,GAAG;AACjF,YAAI,IAAI,QAAQ,GAAG;AAClB,iBAAO,MACN,GAAG,gGAAgG,CAAC;AAAA,QACtG;AACA,YAAI,CAAC,IAAI,QAAQ;AAChB,cAAI,SAAS,IAAI,MAAM;AAAA,QACxB;AAAA,MACD;AACA,UAAG,IAAI,eAAe,UAAU;AAE/B,YAAI,SAAS,IAAI,IAAI,YAAY,UAAU,cAAc,GAAG,CAAC;AAC7D,6BAAqB,KAAK,IAAI,IAAI,YAC/B,KAAK,aAAa,KAAK,IAAI,IAAI,YAAa,SAAU;AAAA,MAE1D,WAAU,IAAI,eAAe,gBAAgB;AAC5C,6BAAsB,WAAW,MAAS,KAAK;AAAA,MAChD,WAAU,IAAI,eAAe,0BAA0B;AACtD,6BAAsB,WAAW,MAChC,KAAK,IAAI,IAAI,SAAS,KAAK,IAAI,MAAM,IAAI,GAAG;AAAA,MAE9C,WAAU,IAAI,eAAe,yBAAyB;AACrD,6BAAsB,WAAW,MAChC,KAAK,IAAI,IAAI,SAAS,KAAK,IAAI,MAAM,IAAI,GAAG;AAAA,MAC9C,WAAW,IAAI,eAAe,oBAAoB;AACjD,6BAAqB,WAAW,KAAK;AAAA,MACtC;AAEA,WAAK,kBAAkB,MAAM,KAAK,UAAU,kBAAkB;AAE9D,aAAO;AAAA,IACR;AAAA,IAEA,mBAAmB,SAAS,MAAM,KAAK,UAAU,oBAAoB;AAEpE,UAAI,aAAa,IAAI;AACrB,UAAI,MAAM,KAAK,aAAa,KAAK;AAEjC,UAAG,OAAQ,cAAe,UAAU;AACnC,YAAI,uBAAuB,KAAK,MAAM,IAAI,oBAAoB;AAC9D,qBAAa,IAAI;AAAA,MAClB;AAEA,UAAI,uBAAuB,qBAAqB,KAAK,IAAI,IAAI;AAC7D,UAAI,cAAc,WAAW;AAC5B,gCAAwB,WAAW,KAAK;AAEzC,iBAAW,OAAO,CAAC,UAAU,IAAI,sBAAsB,UAAU,mBAAmB,GAAG,CAAC,CAAC;AAAA,IAC1F;AAAA,IAEA,kBAAkB,SAAS,KAAK;AAC/B,UAAI,OAAO,MAAM,8BAA8B,SAAS,IAAI,YAAY,GAAG;AAC1E,YAAI,aAAY,KAAK,MAAM,IAAI,UAAU;AACzC,YAAI,mCAAmC,KAAK,MAAM,IAAI,gCAAgC;AAAA,MACvF;AAEA,UAAI,aAAa,IAAI,IAAI,YAAY,UAAU,cAAc,GAAG,CAAC;AACjE,UAAI,mCAAmC,IAAI,IAAI,kCAAkC,UAAU,cAAc,GAAG,CAAC;AAAA,IAC9G;AAAA,IAEA,uBAAuB,SAAS,KAAK;AACpC,UAAI,OAAO,MAAM,8BAA8B,SAAS,IAAI,YAAY,GAAG;AAC1E,YAAI,kBAAiB,KAAK,MAAM,IAAI,eAAe;AACnD,YAAI,wCAAwC,KAAK,MAAM,IAAI,qCAAqC;AAAA,MACjG;AAAA,IACD;AAAA,IAEA,0CAA0C,WAAW;AACpD,UAAI,KAAK;AAET,UAAI,KAAK,IAAI,IAAI,YAAY,KAAK,IAAI,IAAI,SAAS,QAAQ;AAC1D,YAAI,oBAAoB;AACxB,UAAE,KAAK,KAAK,IAAI,IAAI,SAAS,CAAC,GAAG,SAAS,GAAG,GAAG;AAC/C,cAAG,KAAK,EAAE,sBAAsB;AAAG,gCAAoB;AAAA,QACxD,CAAC;AACD,YAAI,mBAAmB;AACtB,cAAI,WAAW,GAAG,IAAI,IAAI,SAAS,MAAM,EAAE,EAAE;AAC7C,cAAI,2BAA2B,OAAO,MAAM,IAAI,EAAE,IAAI,KAAK,IAAI,IAAI,SAAS,CAAC,GAC5E,SAAS,GAAG;AACX,gBAAG,CAAC,EAAE,wBAAwB;AAC7B,qBAAO,IAAI,EAAE,gCAAgC;AAAA,YAC9C;AAAA,UACD,CACD,CAAC;AACD,cAAI,OAAO,GAAG,IAAI,IAAI,QAAQ,2BAC3B,IAAI,SAAS,OAAO,UAAU,aAAa,CAAC;AAE/C,cAAG,GAAG,2BAA2B,GAAG,IAAI,IAAI,iBAAiB;AAC5D,oBAAQ,IAAI,GAAG,IAAI,IAAI,eAAe;AAAA,UACvC;AAEA,iBAAO,IAAI,MAAM,UAAU,qBAAqB,CAAC;AAEjD,cAAK,QAAQ,KAAK,IAAI,IAAI,KAAM,IAAM,KAAK,IAAI,IAAI,UAAU,cAAc,QAAQ,CAAC,GAAK;AACxF,eAAG,IAAI,IAAI,sBAAsB;AAAA,UAClC;AAAA,QACD;AAAA,MACD;AAAA,IACD;AAAA,IAEA,kBAAkB,WAAW;AAE5B,UAAI,KAAK;AACT,UAAI,YAAY,KAAK,IAAI,IAAI,WAAW,KAAK,IAAI,IAAI,SAAS,SAAS;AACvE,WAAK,IAAI,IAAI,cAAc,IAAI,YAC5B,KAAK,IAAI,IAAI,SAAS,YAAY,GAAG,QAAQ,IAAI,KAAK,IAAI,IAAI,mBAAmB,IACjF,KAAK,IAAI,IAAI,SAAS;AAEzB,UAAG,QAAQ,CAAC,aAAa,eAAe,iBAAiB,iBAAiB,eAAe,kBAAkB,GAAG,KAAK,IAAI,IAAI,OAAO,GAAG;AACpI,aAAK,IAAI,IAAI,mBAAoB,KAAK,IAAI,IAAI,0BAC7C,IAAI,KAAK,IAAI,IAAI,cAAc,KAAK,IAAI,IAAI,eAAe,IAAI,KAAK,IAAI,IAAI;AAAA,MAC9E,OAAO;AAEN,aAAK,IAAI,IAAI,0BAA0B,KAAK,IAAI,IAAI,6BAA6B;AACjF,YAAG,WAAW;AACb,YAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,KAAK;AACpD,gBAAI,QAAQ,CAAC,uBAAuB,OAAO,GAAG,IAAI,QAAQ,GAAG;AAC5D,kBAAG,IAAI,kBAAkB,OAAO;AAC/B,mBAAG,IAAI,IAAI,2BAA2B,IAAI,IAAI,gCAAgC;AAAA,cAC/E,OAAO;AACN,mBAAG,IAAI,IAAI,8BAA8B,IAAI,IAAI,gCAAgC;AAAA,cAClF;AAAA,YACD;AAAA,UACD,CAAC;AAED,iBAAO,MAAM,gBAAgB,KAAK,IAAI,KACrC,CAAC,2BAA2B,4BAA4B,CAAC;AAAA,QAC3D;AAEA,aAAK,IAAI,IAAI,mBAAmB,IAAK,KAAK,IAAI,IAAI,2BAA2B,KAAK,IAAI,IAAI,6BACzF,IAAI,KAAK,IAAI,IAAI,cAAc,KAAK,IAAI,IAAI,eAAe,IAAI,KAAK,IAAI,IAAI,cAAc;AAE3F,aAAK,wBAAwB,KAAK,IAAI,KACrC,CAAC,2BAA2B,4BAA4B,CAAC;AAAA,MAC3D;AAEA,WAAK,IAAI,IAAI,0BAA0B,IAAI,KAAK,IAAI,IAAI,cAAc,KAAK,IAAI,IAAI,YAChF,IAAI,KAAK,IAAI,IAAI,mBAAmB,GAAG,UAAU,yBAAyB,CAAC;AAE9E,WAAK,wBAAwB,KAAK,IAAI,KAAK,CAAC,2BAA2B,qBAAqB,CAAC;AAG7F,aAAO,MAAM,gBAAgB,KAAK,IAAI,KAAK,CAAC,eAAe,kBAAkB,CAAC;AAG9E,WAAK,kBAAkB;AAAA,IACxB;AAAA,IAEA,mBAAmB,WAAW;AAC7B,UAAI,wBAAwB;AAC5B,UAAG,OAAO,KAAK,aAAa,KAAK,IAAI,IAAI,SAAS,yBAAyB,KAAK,IAAI,IAAI,IAAI,GAAG;AAC9F,gCAAwB,KAAK,IAAI,IAAI;AAAA,MACtC,WAAW,OAAO,aAAa,uBAAuB;AACrD,gCAAwB,OAAO,aAAa;AAAA,MAC7C;AAEA,UAAI,KAAK,qBAAqB,GAAG;AAChC,aAAK,IAAI,IAAI,gBAAgB;AAC7B,aAAK,IAAI,IAAI,qBAAqB;AAClC;AAAA,MACD;AAEA,UAAG,OAAO,KAAK,aAAa,KAAK,IAAI,IAAI,SAAS,iBAAiB,KAAK,IAAI,IAAI,IAAI,GAAG;AACtF,aAAK,IAAI,IAAI,gBAAgB,0CAA0C,KAAK,IAAI,IAAI,aACnF,KAAK,IAAI,IAAI,UAAU,UAAU,eAAe,CAAC;AAClD,aAAK,IAAI,IAAI,uBAAuB,IAAI,KAAK,IAAI,IAAI,gBAAgB,KAAK,IAAI,IAAI,aACjF,UAAU,qBAAqB,CAAC;AAEjC,aAAK,wBAAwB,KAAK,IAAI,KAAK,CAAC,uBAAuB,eAAe,CAAC;AAAA,MACpF;AAAA,IACD;AAAA,IAEA,UAAU,WAAW;AACpB,WAAK,IAAI,IAAI,gBAAgB,KAAK,IAAI,IAAI,WAAW;AAErD,UAAG,KAAK,IAAI,IAAI,YAAY,KAAK,IAAI,IAAI,SAAS,QAAQ;AACzD,YAAG,CAAC,OAAO,KAAK,aAAa,KAAK,IAAI,IAAI,SAAS,GAAG,SAAS,mBAAmB,KAAK,IAAI,OAAO,GAAG;AACpG,YAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,MAAM;AACrD,mBAAO,KAAK;AAAA,UACb,CAAC;AAAA,QACF;AAAA,MACD;AAEA,UAAG,KAAK,IAAI,IAAI,YAAY,KAAK,IAAI,IAAI,SAAS,QAAQ;AACzD,YAAI,mBAAmB;AAAA,UAAC;AAAA,UAA+B;AAAA,UACtD;AAAA,UAAiC;AAAA,QAAuC;AAEzE,YAAG,CAAC,OAAO,KAAK,aAAa,KAAK,IAAI,IAAI,SAAS,GAAG,SAAS,oCAAoC,KAAK,IAAI,OAAO,GAAG;AACrH,2BAAiB,KAAK,kCAAkC;AAAA,QACzD;AAEA,UAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,KAAK;AACpD,YAAE,KAAK,kBAAkB,SAAS,IAAG,WAAW;AAC/C,mBAAO,IAAI;AAAA,UACZ,CAAC;AAED,cAAI,uBAAuB,KAAK,UAAU,IAAI,oBAAoB;AAAA,QACnE,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,qBAAqB,WAAW;AAC/B,UAAG,KAAK,IAAI,IAAI,gCAAgC;AAC/C,aAAK,IAAI,IAAI,kBAAkB,IAAI,IAAI,KAAK,IAAI,IAAI,OAAO,MAAM,KAAK,IAAI,IAAI,iBAAiB,EAAE,IAC9F,KAAK,IAAI,IAAI,iCAAiC,KAAK,UAAU,iBAAiB,CAAC;AAAA,MACnF;AAAA,IACD;AAAA,IAEA,uBAAuB,WAAW;AACjC,UAAI,KAAK;AACT,UAAI,qBAAqB;AACzB,WAAK,IAAI,IAAI,uBAAuB;AAEpC,UAAI,KAAK,IAAI,IAAI,iBAAiB;AACjC,YAAG,CAAC,KAAK,IAAI,IAAI;AAChB,iBAAO,MAAM,GAAG,iCAAiC,CAAC;AAEnD,aAAK,IAAI,IAAI,uBAAuB,IAAI,KAAK,IAAI,IAAI,kBAAkB,KAAK,IAAI,IAAI,iBACnF,UAAU,sBAAsB,CAAC;AAElC,YAAI,4BAA4B,KAAK,8BAA8B;AACnE,YAAI,YAAY;AAEhB,YAAI,2BAA2B;AAC9B,YAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,MAAM;AACrD,iCAAqB,IAAI,GAAG,IAAI,IAAI,eAAe,IAAI,KAAK,aAAa;AACzE,iBAAK,aAAa,IAAI,KAAK,aAAa,oBACvC,UAAU,eAAe,IAAI,CAAC;AAC/B,yBAAa,KAAK;AAGlB,gBAAK,EAAE,IAAG,IAAI,IAAI,SAAS,CAAC,GAAG,UAAU,6BAA2B,GAAG,IAAI,IAAI,aAAc,GAAG,IAAI,IAAI,qBAAqB,gBACxH,KAAM,IAAG,IAAI,IAAI,SAAS,CAAC,GAAG,SAAS,GAAG;AAC9C,kBAAI,uBAAuB,IAAI,GAAG,IAAI,IAAI,YAAY,YACnD,GAAG,IAAI,IAAI,iBAAiB,UAAU,WAAW,CAAC;AACrD,mBAAK,aAAa,IAAI,KAAK,aAAa,sBACvC,UAAU,cAAc,IAAI,CAAC;AAAA,YAC/B;AACA,iBAAK,WAAW,KAAK,MAAM,IAAI,KAAK,aAAa,KAAK,KAAK,UAAU,YAAY,IAAI,CAAC,IAAI;AAC1F,eAAG,wBAAwB,MAAM,CAAC,YAAY,YAAY,CAAC;AAAA,UAC5D,CAAC;AAED,eAAK,0BAA0B;AAC/B,eAAK,4BAA4B;AAAA,QAClC;AAAA,MACD;AAAA,IACD;AAAA,IAEA,+BAA+B,WAAW;AACzC,UAAG,KAAK,IAAI,IAAI,qBAAqB,aAAa;AACjD,eAAO,KAAK,IAAI,IAAI;AAAA,MACrB,OAAO;AACN,YAAI,mBAAmB;AACvB,YAAI,oBAAoB,CAAC;AAEzB,UAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,KAAK;AACpD,cAAI,QAAQ,CAAC,UAAU,kBAAkB,GAAG,IAAI,WAAW,GAAG;AAC7D,gBAAI,aAAc,IAAI,YAAY,cAAe,IAAM,IAAI;AAC3D,0BAAe,IAAI,kBAAkB,WAAY,KAAO;AACxD,8BAAkB,IAAI,OAAO;AAAA,UAC9B,WAAW,kBAAkB,IAAI,YAAY,MAAM;AAClD,gBAAI,oBAAoB,IAAI,kBAAkB,IAAI,OAAO,IAAI,IAAI,IAAI,IAAI,IAAI;AAC7E,8BAAkB,IAAI,OAAO;AAAA,UAC9B;AAAA,QACD,CAAC;AAED,UAAE,KAAK,mBAAmB,SAAS,KAAK,OAAO;AAC9C,cAAI;AAAO,gCAAoB;AAAA,QAChC,CAAC;AAED,eAAO,IAAI,KAAK,IAAI,IAAI,cAAc,kBAAkB,UAAU,aAAa,CAAC;AAAA,MACjF;AAAA,IACD;AAAA,IAEA,yBAAyB,SAAS,oBAAoB;AACrD,UAAI,yBAAyB,OAAO,MAAM,IAAI,EAAE,IAAI,KAAK,IAAI,IAAI,eAAe,CAAC,GAAG,SAAS,KAAK;AACjG,eAAO,IAAI,IAAI,kBAAkB,UAAU,oBAAoB,GAAG,CAAC;AAAA,MACpE,CAAC,CAAC;AACF,WAAK,IAAI,IAAI,gBAAgB,IAAI,wBAAwB,UAAU,eAAe,CAAC;AAEnF,WAAK,6BAA6B,kBAAkB;AAAA,IACrD;AAAA,IAEA,qBAAqB,WAAW;AAC/B,UAAI,CAAC,iBAAiB,kBAAkB,EAAE,SAAS,KAAK,IAAI,IAAI,OAAO,GAAG;AACzE,YAAI,KAAK,IAAI,IAAI,YAAY,KAAK,IAAI,IAAI,oBAAoB;AAC7D,iBAAO;AAAA,QACR;AAAA,MACD;AACA,aAAO;AAAA,IACR;AAAA,IAEA,8BAA8B,SAAS,oBAAoB;AAI1D,UAAG,QAAQ,CAAC,iBAAiB,aAAa,GAAG,KAAK,IAAI,IAAI,OAAO,KAAK,KAAK,IAAI,IAAI,WAAU;AAC5F,aAAK,sBAAsB;AAAA,MAC5B;AAEA,UAAI,KAAK,IAAI,IAAI,aAAc,KAAK,IAAI,IAAI,YAAY,KAAM,KAAK,oBAAoB;AAAG;AAE1F,aAAO,MAAM,gBAAgB,KAAK,IAAI,KAAK,CAAC,eAAe,iBAAiB,kBAAkB,CAAC;AAE/F,UAAG,QAAQ,CAAC,iBAAiB,eAAe,kBAAkB,GAAG,KAAK,IAAI,IAAI,OAAO,GAAG;AACvF,YAAI,cAAc,KAAK,IAAI,IAAI,iBAAiB,KAAK,IAAI,IAAI;AAE7D,YAAG,KAAK,IAAI,IAAI,0BAA0B,KAAK,IAAI,IAAI,UAAU;AAChE,cAAI,sBAAsB,IAAK,cAAc,KAAK,IAAI,IAAI,gBACvD,KAAK,IAAI,IAAI,kBAAmB,UAAU,aAAa,CAAC;AAAA,QAC5D,OAAO;AACN,cAAI,sBAAsB,IACxB,IAAI,cAAY,KAAK,IAAI,IAAI,iBAAiB,UAAU,aAAa,CAAC,IACpE,KAAK,IAAI,IAAI,gBAAgB,KAAK,IAAI,IAAI,uBAC7C,UAAU,kBAAkB,CAC7B;AAAA,QACD;AAEA,eAAO,MAAM,gBAAgB,KAAK,IAAI,KAAK,CAAC,aAAa,CAAC;AAC1D,aAAK,wBAAwB,KAAK,IAAI,KAAK,CAAC,aAAa,CAAC;AAE1D,YAAG,KAAK,IAAI,eAAc;AACzB,eAAK,IAAI,cAAc,aAAa;AACpC,eAAK,IAAI,cAAc,kBAAkB;AAAA,QAC1C;AAEA,YAAG,QAAQ,CAAC,iBAAiB,aAAa,GAAG,KAAK,IAAI,IAAI,OAAO,GAAG;AACnE,cAAI,2BAA4B,KAAK,IAAI,IAAI,yBAAyB,KAAK,IAAI,IAAI,iBAChF,IAAI,sBAAsB,KAAK,IAAI,IAAI,gBAAgB,UAAU,kBAAkB,CAAC,IACpF;AACH,eAAK,oBAAoB,0BAA0B,kBAAkB;AACrE,eAAK,sBAAsB;AAAA,QAC5B;AACA,aAAK,wBAAwB;AAE7B,YAAI,cAAe,KAAK,IAAI,IAAI,0BAA0B,KAAK,IAAI,IAAI,WACtE,KAAK,IAAI,IAAI,cAAc,KAAK,IAAI,IAAI;AACzC,aAAK,IAAI,IAAI,qBAAsB,IAAI,sBAAsB,IAAI,WAAW,IAC3E,IAAI,KAAK,IAAI,IAAI,gBAAgB,KAAK,IAAI,IAAI,eAAe,GAAG,UAAU,oBAAoB,CAAC;AAAA,MACjG;AAAA,IACD;AAAA,IAEA,+BAA+B,WAAW;AACzC,UAAI,cAAc,KAAK,IAAI,IAAI,iBAAiB,KAAK,IAAI,IAAI;AAE7D,UAAG,KAAK,IAAI,IAAI,0BAA0B,KAAK,IAAI,IAAI,UAAU;AAChE,YAAI,sBAAsB,IAAK,cAAc,KAAK,IAAI,IAAI,gBACvD,KAAK,IAAI,IAAI,kBAAmB,UAAU,aAAa,CAAC;AAAA,MAC5D,OAAO;AACN,YAAI,sBAAsB,IACxB,IAAI,cAAY,KAAK,IAAI,IAAI,iBAAiB,UAAU,aAAa,CAAC,IACpE,KAAK,IAAI,IAAI,gBAAgB,KAAK,IAAI,IAAI,uBAC7C,UAAU,kBAAkB,CAC7B;AAAA,MACD;AAEA,WAAK,IAAI,IAAI,SAAS,KAAK,SAAO;AACjC,YAAI,IAAI,SAAS;AAChB,cAAI,SAAS;AAAA,QACd,OAAO;AACN,cAAI,SAAS;AAAA,QACd;AAAA,MACD,CAAC;AACD,WAAK,IAAI,eAAe;AAExB,WAAK,sBAAsB;AAAA,IAC5B;AAAA,IAEA,qBAAqB,SAAS,qBAAqB,oBAAoB;AACtE,UAAI,KAAK;AACT,UAAI,iBAAiB;AACrB,UAAG,KAAK,IAAI,IAAI,UAAW,wBAAqB,UAAa,qBAAqB;AACjF,UAAE,KAAK,KAAK,IAAI,IAAI,eAAe,CAAC,GAAG,SAAS,OAAO,MAAM;AAC5D,cAAG,KAAK,WAAW,kBAAkB,sBAAsB,GAAG;AAC7D,gBAAI,cAAc,IAAI,qBAAqB,UAAU,eAAe,IAAI,CAAC;AACzE,mBAAO,MAAM,UAAU,KAAK,SAAS,KAAK,MAAM,eAAe,WAAW;AAC1E,gBAAI,SAAS,IAAI,sBAAsB,GAAG,IAAI,IAAI,iBAAiB,UAAU,UAAU,IAAI,CAAC;AAC5F,mBAAO,MAAM,UAAU,KAAK,SAAS,KAAK,MAAM,UAAU,MAAM;AAChE,6BAAiB;AAAA,UAClB,WAAU,GAAG,IAAI,IAAI,aAAa;AACjC,mBAAO,MAAM,UAAU,KAAK,SAAS,KAAK,MAAM,UAAU,CAAG;AAAA,UAC9D;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,uBAAuB,WAAW;AACjC,UAAI,KAAK;AACT,UAAI,cAAc;AAClB,UAAI,mBAAmB;AACvB,UAAG,KAAK,IAAI,IAAI,QAAQ;AACvB,UAAE,KAAK,KAAK,IAAI,IAAI,eAAe,CAAC,GAAG,SAAS,OAAO,MAAK;AAC3D,eAAK,cAAc,IAAI,KAAK,SAAS,GAAG,IAAI,IAAI,iBAAiB,UAAU,eAAe,IAAI,CAAC;AAC/F,yBAAe,KAAK;AACpB,8BAAoB,KAAK;AAAA,QAC1B,CAAC;AAAA,MACF,WAAU,CAAC,KAAK,IAAI,IAAI,WAAU;AACjC,aAAK,IAAI,IAAI,WAAW,CAAC;AAAA,MAC1B;AACA,UAAI,KAAK,IAAI,IAAI,yBAAyB,KAAK,IAAI,IAAI,gBAAgB;AACtE,4BAAoB,KAAK,IAAI,IAAI;AACjC,uBAAe,IAAI,KAAK,IAAI,IAAI,iBAAiB,GAAG,IAAI,IAAI,iBAAiB,UAAU,aAAa,CAAC;AAAA,MACtG;AAEA,WAAK,IAAI,UAAU,eAAe,IAAI,aAAa,UAAU,aAAa,CAAC,CAAC;AAC5E,WAAK,IAAI,UAAU,oBAAoB,IAAI,kBAAkB,UAAU,kBAAkB,CAAC,CAAC;AAAA,IAC5F;AAAA,IAEA,yBAAyB,WAAU;AAClC,WAAK,IAAI,IAAI,gBAAgB;AAC7B,WAAK,IAAI,IAAI,qBAAqB;AAClC,UAAG,QAAQ,CAAC,iBAAiB,aAAa,GAAG,KAAK,IAAI,IAAI,OAAO,KAC7D,KAAK,IAAI,IAAI,cAAc,KAAK,IAAI,IAAI,eAAe,CAAC,KAAK,IAAI,IAAI,WAAW;AAEnF,YAAI,gBAAgB,EAAE,IAAI,KAAK,IAAI,IAAI,UAAU,SAAS,GAAG;AAAE,iBAAO,EAAE;AAAA,QAAM,CAAC;AAC/E,YAAI,QAAQ,eAAe,MAAM,GAAG;AACnC,cAAI,cAAc,KAAK,IAAI,IAAI,iBAAiB,KAAK,IAAI,IAAI;AAC7D,cAAI,mBAAmB,KAAK,IAAI,IAAI,sBAAsB,KAAK,IAAI,IAAI;AAEvE,eAAK,IAAI,IAAI,gBAAgB,IAAI,KAAK,IAAI,IAAI,cAAc,cAC3D,KAAK,IAAI,IAAI,kBAAkB,UAAU,eAAe,CAAC;AAE1D,eAAK,IAAI,IAAI,qBAAqB,IAAI,KAAK,IAAI,IAAI,mBAClD,mBAAmB,KAAK,IAAI,IAAI,uBAChC,UAAU,oBAAoB,CAAC;AAAA,QACjC;AAAA,MACD;AAAA,IACD;AAAA,IAEA,4BAA4B,WAAU;AACrC,UAAG,KAAK,IAAI,IAAI,cAAc,KAAK,IAAI,IAAI,aAAY;AACtD,aAAK,IAAI,IAAI,mBAAmB,IAAI,KAAK,IAAI,IAAI,cAAc,KAAK,IAAI,IAAI,cACzE,KAAK,IAAI,IAAI,eAAe,UAAU,kBAAkB,CAAC;AAE5D,aAAK,IAAI,IAAI,wBAAwB,IAAI,KAAK,IAAI,IAAI,mBAAmB,KAAK,IAAI,IAAI,iBACrF,UAAU,uBAAuB,CAAC;AAAA,MACpC,OAAK;AACJ,aAAK,IAAI,IAAI,cAAc;AAAA,MAC5B;AACA,WAAK,6BAA6B,KAAK;AAAA,IACxC;AAAA,EACD,CAAC;;;ACj0BD,SAAO,QAAQ,6BAA6B;AAE5C,UAAQ,wBAAwB,QAAQ,iBAAiB,OAAO;AAAA,IAC/D,OAAO,WAAW;AACjB,WAAK,OAAO;AACZ,UAAI,KAAK;AACT,aAAO,MAAM,2BAA2B;AACxC,aAAO,GAAG,KAAK,GAAG,KAAK,IAAI,UAAU,SAAS,QAAQ,SAAS,KAAK,KAAK,KAAK;AAC7E,YAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,YAAI,mBAAmB,OAAO,KAAK,UAAU,KAAK,aAAa;AAE/D,eAAO,MAAM,gBAAgB,MAAM,CAAC,QAAQ,iBAAiB,CAAC;AAE9D,YAAG,KAAK,iBAAiB;AACxB,cAAG,KAAK,OAAO,KAAK,mBAAmB,kBAAkB;AAGxD,iBAAK,sBAAsB;AAC3B,iBAAK,cAAc;AACnB,iBAAK,wBAAwB,IAAI,KAAK,OAAO,KAAK,iBACjD,UAAU,yBAAyB,IAAI,CAAC;AACzC,iBAAK,mBAAmB,KAAK;AAAA,UAC9B,OAAO;AACN,iBAAK,sBAAsB,IAAK,KAAI,KAAK,OAAO,KAAK,mBAAmB,KACvE,UAAU,uBAAuB,IAAI,CAAC;AACvC,iBAAK,kBAAkB,IAAI,KAAK,eAAe,IAAI,IAAI,KAAK,IAAI;AAChE,iBAAK,cAAc;AACnB,iBAAK,wBAAwB;AAC7B,iBAAK,mBAAmB;AAAA,UACzB;AAAA,QACD,OAAO;AACN,eAAK,sBAAsB;AAC3B,eAAK,cAAc;AACnB,eAAK,wBAAwB;AAC7B,eAAK,mBAAmB;AAAA,QACzB;AACA,aAAK,wBAAwB,KAAK,mBAAmB,IAAI,IAAI,IAAI,eAAe;AAEhF,gBAAQ,QAAQ,iBAAiB,IAAI;AACrC,gBAAQ,QAAQ,2BAA2B;AAC3C,gBAAQ,QAAQ,yBAAyB,KAAK,KAAK,GAAG;AAAA,MACvD,CAAC;AAED,aAAO,GAAG,KAAK,GAAG,KAAK,IAAI,QAAQ,WAAW,QAAQ,SAAS,KAAK,KAAK,KAAK;AAC7E,gBAAQ,QAAQ,2BAA2B;AAAA,MAC5C,CAAC;AAED,aAAO,GAAG,KAAK,GAAG,KAAK,IAAI,QAAQ,WAAW,cAAc,SAAS,KAAK,KAAK,KAAK;AACnF,gBAAQ,QAAQ,2BAA2B;AAAA,MAC5C,CAAC;AAED,aAAO,GAAG,KAAK,GAAG,KAAK,IAAI,QAAQ,WAAW,UAAU,SAAS,KAAK,KAAK,KAAK;AAC/E,gBAAQ,QAAQ,2BAA2B;AAAA,MAC5C,CAAC;AAED,aAAO,GAAG,KAAK,GAAG,KAAK,IAAI,QAAQ,WAAW,0BAA0B,SAAS,KAAK,KAAK,KAAK;AAC/F,gBAAQ,QAAQ,mBAAmB;AACnC,gBAAQ,QAAQ,2BAA2B;AAAA,MAC5C,CAAC;AAED,aAAO,GAAG,KAAK,GAAG,KAAK,IAAI,SAAS,qBAAqB,SAAS,KAAK;AACtE,YAAG,IAAI,IAAI,gCAAgC;AAC1C,cAAI,QAAQ,gCAAgC;AAAA,QAC7C,OAAO;AACN,kBAAQ,QAAQ,2BAA2B;AAAA,QAC5C;AAAA,MACD,CAAC;AAED,aAAO,GAAG,KAAK,GAAG,KAAK,IAAI,SAAS,kCAAkC,SAAS,KAAK;AACnF,YAAG,CAAC,IAAI,IAAI,mBAAmB;AAC9B,iBAAO,SAAS,GAAG,2CAA2C,CAAC;AAC/D;AAAA,QACD;AAEA,YAAI,0BAA0B;AAE9B,YAAG,IAAI,IAAI,kCAAkC,IAAI,IAAI,iBAAiB;AAErE,cAAI,IAAI,kBAAkB;AAC1B,cAAI,QAAQ,2BAA2B;AAAA,QACxC;AAEA,YAAI,QAAQ,IAAI,IAAI,IAAI,OAAO,MAAM,MAAM,IAAI,IAAI,iBAAiB,EAAE;AACtE,YAAI,kBAAkB,IAAI,QAAM,IAAI,IAAI,IAAI,8BAA8B,IAAI,KAC7E,UAAU,iBAAiB,CAAC;AAE7B,YAAI,UAAU,mBAAmB,eAAe,EAC9C,KAAK,MAAM,OAAO,IAAI,uBAAuB;AAAA,MAChD,CAAC;AAED,aAAO,GAAG,KAAK,GAAG,KAAK,IAAI,SAAS,mBAAmB,SAAS,KAAK;AACpE,YAAI,QAAQ,mBAAmB;AAE/B,YAAI,CAAC,IAAI,yBAAyB;AACjC,cAAI,IAAI,iCAAiC;AAAA,QAC1C;AAEA,YAAI,QAAQ,2BAA2B;AAAA,MACxC,CAAC;AAED,aAAO,GAAG,KAAK,GAAG,KAAK,IAAI,UAAU,SAAS;AAAA,QAC7C,WAAW,SAAS,KAAK,KAAK,KAAK;AAClC,cAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,cAAI,CAAC,KAAK,aAAa,IAAI,IAAI,eAAe;AAC7C,iBAAK,YAAY,IAAI,IAAI;AAAA,UAC1B;AAEA,cAAI,CAAC,KAAK,oBAAoB,IAAI,IAAI,sBAAsB;AAC3D,iBAAK,mBAAmB,IAAI,IAAI;AAAA,UACjC;AAEA,cAAI,CAAC,KAAK,kBAAkB,IAAI,IAAI,oBAAoB;AACvD,iBAAK,iBAAiB,IAAI,IAAI;AAAA,UAC/B;AAEA,kBAAQ,SAAS,WAAW,8BAA8B,KAAK,KAAK,KAAK,OAAO;AAAA,QACjF;AAAA,MACD,CAAC;AAED,UAAG,KAAK,IAAI,YAAY,SAAS,KAAK,UAAU,UAAU,GAAG;AAC5D,aAAK,IAAI,UAAU,YAAY,SAAS,SAAS,KAAK,KAAK,KAAK;AAC/D,iBAAO,GAAG,oBAAoB,KAAK,KAAK,GAAG;AAAA,QAC5C,CAAC;AAAA,MACF;AAEA,UACC,KAAK,IAAI,YAAY,KAClB,KAAK,IAAI,YAAY,6BACrB,KAAK,IAAI,YAAY,uBACrB,KAAK,IAAI,IAAI,0BACb,CAAC,KAAK,IAAI,IAAI,iBAAiB,QAClC;AACA,aAAK,IAAI,QAAQ,wBAAwB;AAAA,MAC1C;AAEA,UAAG,KAAK,IAAI,YAAY,UAAU;AACjC,aAAK,kBAAkB,KAAK;AAAA,MAC7B;AAEA,UAAG,KAAK,IAAI,YAAY,UAAU;AACjC,aAAK,kBAAkB,KAAK;AAAA,MAC7B;AAEA,UAAG,KAAK,IAAI,YAAY,2BAA2B;AAClD,aAAK,IAAI,UAAU,0BAA0B,SAAS,KAAK;AAC1D,iBAAM;AAAA,YACL,SAAS;AAAA,cACR,CAAC,gBAAgB,YAAY,KAAK,QAAQ,OAAO;AAAA,YAClD;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AAEA,UAAG,KAAK,IAAI,YAAY,mBAAmB;AAC1C,aAAK,IAAI,UAAU,kBAAkB,SAAS,KAAK;AAClD,cAAI,UAAU;AAAA,YACb,aAAa;AAAA,YACb,aAAa;AAAA,YACb,WAAW,IAAI;AAAA,UAChB;AACA,cAAI,GAAG,IAAI,YAAY,eAAe,IAAI;AAAU,oBAAQ,cAAc,IAAI;AAC9E,cAAI,GAAG,IAAI,YAAY,eAAe,IAAI;AAAU,oBAAQ,cAAc,IAAI;AAE9E,iBAAO;AAAA,YACN;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AAEA,UAAI,KAAK,IAAI,YAAY,SAAS,KAAK,UAAU,iBAAiB,GAAG;AACpE,aAAK,IAAI,UAAU,mBAAmB,SAAS,SAAS,KAAK;AAC5D,iBAAO;AAAA,YACN,SAAS;AAAA,cACR,WAAW,IAAI;AAAA,YAChB;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AAEA,UAAG,OAAO,KAAK,aAAa,KAAK,IAAI,IAAI,SAAS,eAAe,GAAG;AACnE,aAAK,IAAI,wBAAwB,gBAAgB,SAAS,KAAK;AAC9D,iBAAQ,IAAI,eAAgB,UAAU;AAAA,QACvC,CAAC;AAAA,MACF;AAEA,UAAI,iBAAiB,KAAK,IAAI,aAAa,SAAS,UAAU;AAC9D,UAAI,gBAAgB;AACnB,uBAAe,gCAAgC,SAAS,KAAK;AAC5D,iBAAO;AAAA,YACN,QAAQ,IAAI,IAAI;AAAA,UACjB;AAAA,QACD;AAAA,MACD;AAEA,UAAI,KAAK,IAAI,YAAY,SAAS,KAAK,UAAU,eAAe,GAAG;AAClE,aAAK,IAAI,UAAU,iBAAiB,SAAS,SAAS,KAAK,KAAK,KAAK;AACpE,cAAI,OAAO,OAAO,KAAK;AACvB,iBAAO;AAAA,YACN,OAAO;AAAA,YACP,SAAS;AAAA,cACR,WAAW,IAAI;AAAA,cACf,sBAAsB,IAAI,YAAY,gBAAgB,YAAY;AAAA,cAClE,QAAQ,KAAK;AAAA,YACd;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AAEA,UAAI,KAAK,IAAI,YAAY,mBAAmB;AAC3C,aAAK,IAAI,UAAU,qBAAqB,WAAW;AAClD,iBAAO;AAAA,YACN,SAAS;AAAA,cACR,CAAC,WAAW,KAAK,GAAG,IAAI,IAAI,OAAO;AAAA,cACnC,CAAC,aAAa,MAAM,CAAC;AAAA,YACtB;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IAED;AAAA,IACA,QAAQ,WAAW;AAClB,UAAI,KAAK;AACT,UAAG,KAAK,IAAI,IAAI,WAAW;AAC1B,YAAI,WAAW,OAAO,SAAS,iBAAiB,UAAU;AAE1D,YAAI,YAAY,CAAC,WAAW,UAAU;AACrC,cAAG,GAAG,IAAI,YAAY,cAAc,CAAC,GAAG,IAAI,IAAI,YAAY;AAC3D,mBAAO,GAAG,IAAI,UAAU,WAAW,KAAK;AAAA,UACzC;AAAA,QACD;AAEA,aAAK,IAAI,QAAQ,gCAAgC;AAEjD,eAAO,OAAO,aAAa;AAAA,UAC1B,MAAM,UAAU,YAAY,QAAQ;AAAA,UACpC,MAAM,UAAU,uBAAuB,QAAQ;AAAA,UAC/C,MAAM,UAAU,UAAU,OAAO;AAAA,UACjC,MAAM,UAAU,oBAAoB,IAAI;AAAA,UACxC,MAAM;AACL,gBAAG,KAAK,IAAI,IAAI,WAAW,CAAC,KAAK,IAAI,IAAI,cAAc;AACtD,mBAAK,IAAI,QAAQ,SAAS;AAAA,YAC3B;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,WAAW,WAAW;AACrB,UAAG,CAAC,KAAK,IAAI,IAAI,aAAa,KAAK,IAAI,IAAI,gBAAgB;AAC1D,aAAK,IAAI,UAAU,kBAAkB,EAAE;AAAA,MACxC;AAAA,IACD;AAAA,IAEA,0BAA0B,WAAW;AACpC,UAAG,CAAC,QAAQ,CAAC,iBAAiB,iBAAiB,oBAAoB,kBAAkB,GAAG,KAAK,IAAI,IAAI,OAAO,GAAG;AAC9G;AAAA,MACD;AAEA,YAAM,KAAK;AACX,UAAI,CAAC,KAAK,IAAI,OAAO,KAAK,KAAK,IAAI,IAAI,cAAc,GAAG;AACvD,aAAK,IAAI,kBAAkB,GAAG,uBAAuB,GAAG,MAAM;AAC7D,aAAG,wBAAwB;AAAA,QAC5B,GAAG,GAAG,QAAQ,CAAC;AACf,aAAK,IAAI,KAAK,+BAA+B,GAAG,QAAQ,CAAC;AAAA,MAC1D;AAEA,YAAM,kBAAkB,QAAQ,CAAC,oBAAoB,kBAAkB,GAAG,KAAK,IAAI,IAAI,OAAO,IAC3F,aAAa;AAEhB,UAAI,2BAA2B,KAAK,IAAI,aAAa,SAAS,oBAAoB;AAClF,+BAAyB,gCAAgC,SAAS,KAAK;AACtE,YAAG,GAAG,IAAI,OAAO;AAAG;AACpB,eAAO;AAAA,UACN,mBAAmB;AAAA,UACnB,kBAAkB,GAAG,IAAI,IAAI;AAAA,UAC7B,kBAAkB,GAAG,IAAI,IAAI;AAAA,UAC7B,aAAa,IAAI,IAAI;AAAA,UACrB,eAAe,IAAI,IAAI;AAAA,UACvB,kBAAkB,IAAI,IAAI,YAAY,IAAI,IAAI,UAAU,MAAM,IAAI,EAAE,KAAK;AAAA,UACzE,YAAY,IAAI,IAAI;AAAA,QACrB;AAAA,MACD;AAEA,WAAK,IAAI,UAAU,sBAAsB,SAAS,SAAS,KAAK,KAAK,KAAK;AACzE,YAAI,IAAI,OAAO,KAAK;AACpB,eAAO;AAAA,UACN,SAAS;AAAA,YACR,WAAW;AAAA,YACX;AAAA,YACA,gBAAgB,IAAI;AAAA,YACpB,WAAW,EAAE;AAAA,UACd;AAAA,QACD;AAAA,MACD,CAAC;AAAA,IACF;AAAA,IAEA,sBAAsB,WAAW;AAChC,UAAI,KAAK;AACT,YAAM,uBAAwB,QAAQ,CAAC,eAAe,eAAe,GAAG,KAAK,IAAI,IAAI,OAAO,IACzF,WAAW;AAEd,aAAO,KAAK;AAAA,QACX,QAAO;AAAA,QACP,MAAM;AAAA,UACL,IAAI,GAAG,IAAI,IAAI;AAAA,UACf,IAAI,GAAG,IAAI,IAAI;AAAA,UACf,cAAc,GAAG,IAAI,IAAI;AAAA,UACzB;AAAA,UACA,YAAY,wBAAwB,YAAY,aAAa;AAAA,UAC7D,OAAO,wBAAwB,YAAY,GAAG,IAAI,IAAI,WAAW,GAAG,IAAI,IAAI;AAAA,QAC7E;AAAA,QACA,UAAU,SAAS,GAAG;AACrB,cAAG,CAAC,EAAE,KAAI;AACT,gBAAI,MAAM,OAAO,MAAM,KAAK,EAAE,OAAO;AACrC,mBAAO,UAAU,QAAQ,EAAE,QAAQ,SAAS,EAAE,QAAQ,IAAI;AAAA,UAC3D;AAAA,QACD;AAAA,MACD,CAAC;AAAA,IACF;AAAA,IAEA,oBAAoB,WAAW;AAC9B,UAAG,KAAK,IAAI,IAAI,aAAa,CAAE,MAAK,IAAI,IAAI,SAAS,CAAC,GAAG,UACrD,CAAE,MAAK,IAAI,IAAI,WAAW,KAAK,IAAI,IAAI,SAAS,qBAAqB,QAAQ;AAChF,eAAO,WAAW,MAAM,KAAK,oBAAoB,CAAC;AAAA,MACnD,WAAU,KAAK,IAAI,IAAI,aAAa,KAAK,IAAI,IAAI,WAAW,KAAK,IAAI,IAAI,YACrE,CAAC,KAAK,IAAI,IAAI,QAAQ;AACzB,eAAO,WAAW,MAAM,KAAK,2BAA2B,CAAC;AAAA,MAC1D;AACA,UAAG,OAAO,KAAK,aAAa,KAAK,IAAI,IAAI,UAAU,SAAS,WAAW,GAAG;AACzE,aAAK,oBAAoB;AACzB,aAAK,IAAI,UAAU,OAAO,EAAE,KAAK,iBAAiB,aAAa,KAAK;AAAA,MACrE;AAAA,IACD;AAAA,IAEA,SAAS,WAAW;AACnB,cAAQ,qBAAqB;AAC7B,cAAQ,aAAa;AACrB,WAAK,mBAAmB;AACxB,WAAK,UAAU;AACf,WAAK,yBAAyB;AAC9B,UAAI,qBAAqB,KAAK,IAAI,UAAU,cAAc;AAC1D,UAAI,sBAAsB,mBAAmB,UAAU,GAAG;AACzD,2BAAmB,UAAU,EAAE;AAC/B,2BAAmB,oBAAoB,EAAE;AAEzC,YAAI,OAAO,UAAU,GAAG;AACvB,cAAI,mBAAmB,eAAe,KAAK,cAAc,EAAE;AAAQ;AAEnE,cAAI,eAAe,EAAE,2BAA2B;AAChD,6BAAmB,eAAe,KAAK,gBAAgB,EAAE,OAAO,YAAY;AAC5E,uBAAa,OAAO,mBAAmB,MAAM;AAC7C,YAAE;AAAA;AAAA;AAAA;AAAA,aAIO,EACP,GAAG,SAAS,QAAQ,MAAM;AAC1B,mBAAO,QAAQ,aAAa,EAAE,KAAK,aAAW;AAC7C,iCAAmB,UAAU,OAAO;AAAA,YACrC,CAAC;AAAA,UACF,CAAC,EACA,SAAS,YAAY;AAAA,QACxB;AAAA,MACD;AAAA,IACD;AAAA,IAEA,cAAc,WAAW;AACxB,UAAI,qBAAqB,KAAK,IAAI,YAAY;AAE9C,UAAI,mBAAmB,SAAS,KAAK,QAAQ,MAAM;AAClD,YAAI,OAAO;AACV,iBAAO,WAAW;AAAA,YACjB,SAAS,GAAG,gCAAgC,CAAC,GAAG,CAAC;AAAA,YACjD,WAAW;AAAA,UACZ,CAAC;AAAA,QACF,OAAO;AACN,iBAAO,WAAW;AAAA,YACjB,SAAS,GAAG,wBAAwB,CAAC,GAAG,CAAC;AAAA,YACzC,WAAW;AAAA,UACZ,CAAC;AAAA,QACF;AAAA,MACD;AAEA,UAAG,KAAK,IAAI,IAAI,cAAc;AAC7B,eAAO,KAAK;AAAA,UACX,QAAQ;AAAA,UACR,MAAM,EAAE,cAAc,KAAK,IAAI,IAAI,aAAa;AAAA,QACjD,CAAC,EAAE,KAAK,OAAK;AACZ,gBAAM,OAAO,KAAK,EAAE;AACpB,cAAI,CAAC,QAAQ,OAAO,KAAK,IAAI,EAAE,WAAW,GAAG;AAC5C,mBAAO,WAAW;AAAA,cACjB,SAAS,GAAG,oCAAoC;AAAA,cAChD,WAAW;AAAA,YACZ,CAAC;AACD;AAAA,UACD;AAEA,cAAI,WAAW,KAAK,IAAI,YAAY,MAAM;AAE1C,cAAI,gBAAgB;AACpB,gBAAM,oBAAoB,KAAK,IAAI,IAAI,MAAM,KAAK,OAAK,EAAE,cAAc,KAAK,SAAS;AACrF,gBAAM,iBAAiB,KAAK,IAAI,IAAI,MAAM,KAAK,OAAK,CAAC,EAAE,SAAS;AAEhE,cAAI,mBAAmB;AACtB,4BAAgB;AAAA,UACjB,WAAW,gBAAgB;AAC1B,4BAAgB;AAAA,UACjB;AAEA,cAAI,CAAC,eAAe;AAEnB,4BAAgB,OAAO,MAAM,UAAU,KAAK,IAAI,KAAK,SAAS,SAAS,OAAO;AAAA,UAC/E;AAEA,2BAAiB,cAAc,KAAK,cAAc,SAAS;AAE3D,eAAK,IAAI,eAAe,KAAK,IAAI,eAAe,KAAK,IAAI,eAAe,IAAI;AAC5E,iBAAO,MAAM,UAAU,cAAc,SAAS,cAAc,MAAM;AAAA,YACjE,WAAW,KAAK;AAAA,YAChB,KAAM,eAAc,OAAO,KAAK;AAAA,UACjC,CAAC;AAED,WAAC,aAAa,YAAY,SAAS,EAAE,QAAQ,WAAS;AACrD,gBAAI,KAAK,UAAU,OAAO,KAAK,UAAU,cAAc,SAAS,KAAK,GAAG;AAEvE,kBAAI,QAAS,cAAc,UAAU,UAAU,cAC5C,cAAc,SAAS,OAAO,KAAK,SAAS,KAAK;AAEpD,qBAAO,MAAM,UAAU,cAAc,SACpC,cAAc,MAAM,OAAO,KAAK;AAAA,YAClC;AAAA,UACD,CAAC;AAED,6BAAmB,UAAU,EAAE;AAC/B,wBAAc,OAAO;AAAA,QACtB,CAAC;AAAA,MACF;AACA,aAAO;AAAA,IACR;AAAA,IAEA,qBAAqB,WAAW;AAC/B,UAAI,KAAK;AACT,UAAI,0BAA0B,OAAO,KAAK,aAAa,GAAG,IAAI,IAAI,SAAS,qBAC1E,GAAG,IAAI,IAAI,IAAI;AAEhB,UAAI,CAAC,KAAK,IAAI,IAAI,qBAAqB,KAAK,IAAI,IAAI,SAAS,KAAK,IAAI,IAAI,MAAM,SAAS,GAAG;AAC3F;AAAA,MACD;AAEA,UAAI,yBAAyB;AAC5B,eAAO,OAAO,KAAK;AAAA,UAClB,QAAQ;AAAA,UACR,MAAM;AAAA,YACL,kBAAkB,wBAAwB;AAAA,YAC1C,gBAAgB,GAAG,IAAI,IAAI,qBAAqB;AAAA,YAChD,WAAW,GAAG,IAAI,IAAI;AAAA,UACvB;AAAA,UACA,UAAU;AAAA,UACV,UAAU,SAAS,GAAG;AACrB,gBAAG,CAAC,EAAE,OAAO,EAAE,SAAS;AACvB,qBAAO,aAAa;AAAA,gBACnB,MAAM;AAEL,sBAAG,EAAE,QAAQ,mBAAmB;AAC/B,uBAAG,IAAI,IAAI,oBAAoB,EAAE,QAAQ;AAAA,kBAC1C;AAGA,sBAAG,EAAE,QAAQ,OAAO;AACnB,uBAAG,IAAI,UAAU,SAAS,EAAE,QAAQ,KAAK;AAAA,kBAC1C;AAAA,gBACD;AAAA,gBACA,MAAM,GAAG,mBAAmB;AAAA,gBAC5B,MAAM,GAAG,2BAA2B;AAAA,cACrC,CAAC;AAAA,YACF;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,WAAW,WAAW;AACrB,UAAI,KAAK;AACT,UAAI,YAAY,CAAC,oBAAoB,KAAK;AAC1C,UAAG,KAAK,IAAI,IAAI,cAAY,KAAK,CAAC,QAAQ,CAAC,QAAQ,WAAW,QAAQ,GAAG,KAAK,IAAI,IAAI,MAAM,KACxF,CAAC,UAAU,SAAS,KAAK,IAAI,OAAO,GAAG;AAC1C,aAAK,IAAI,KAAK,cAAc,GAAG,UAAU,GAAG,WAAW;AAAE,aAAG,SAAS;AAAA,QAAG,CAAC;AAAA,MAC1E;AAAA,IACD;AAAA,IAEA,UAAU,WAAW;AACpB,UAAI,UAAU,IAAI,QAAQ,WAAW,KAAK,IAAI,GAAG;AAAA,IAClD;AAAA,IAEA,SAAS,SAAS,KAAK,KAAK,KAAK;AAChC,UAAI,IAAI,OAAO,KAAK;AACpB,UAAG,EAAE,WAAS,MAAM,EAAE,WAAS,MAAM;AAEpC,UAAE,YAAY;AAAA,MACf;AAEA,WAAK,IAAI,eAAe,KAAK,IAAI,eAAe,KAAK,IAAI,eAAe,IAAI;AAC5E,WAAK,UAAU,KAAK,KAAK,GAAG;AAAA,IAC7B;AAAA,IAEA,WAAW,SAAS,KAAK,KAAK,KAAK;AAClC,UAAI,KAAK;AACT,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,UAAI,eAAe,GAAG,oBAAoB;AAC1C,UAAG,CAAC,eAAe,EAAE,SAAS,KAAK,IAAI,IAAI,OAAO,GAAG;AACpD,uBAAe,KAAK,GAAG,IAAI,IAAI,YAAY;AAC3C,4BAAoB;AAAA,MAErB,WAAW,KAAK,IAAI,IAAI,YAAY,sBAAsB,GAAG,IAAI,IAAI,aACpE,KAAK,IAAI,IAAI,YAAY,iBAAiB;AAC1C,4BAAoB;AAAA,MACrB;AAEA,UAAI,KAAK,IAAI,gBAAgB,GAAG;AAC/B,aAAK,UAAU;AAAA,MAChB;AACA,WAAK,IAAI,eAAe,KAAK,IAAI,eAAe,KAAK,IAAI,KAAK,IAAI,eAAe,IAAI;AAGrF,UAAG,KAAK,aAAa,KAAK,WAAW,KAAK,WAAW;AACpD,YAAG,CAAC,KAAK,2BAA2B,GAAG;AACtC,eAAK,IAAI,YAAY,SAAS,KAAK,UAAU,KAAK,MAAM,GAAG,OAAO;AAAA,QACnE,OAAO;AACN,iBAAO,KAAK,IAAI,KAAK;AAAA,YACpB,QAAQ;AAAA,YACR,OAAO;AAAA,YACP,MAAM;AAAA,cACL,KAAK,GAAG,IAAI;AAAA,cACZ,MAAM;AAAA,gBACL,WAAW,KAAK;AAAA,gBAChB,SAAS,KAAK;AAAA,gBACd,WAAW,KAAK;AAAA,gBAChB,UAAU,KAAK;AAAA,gBACf,eAAe,GAAG,IAAI,IAAI;AAAA,gBAC1B,WAAW,KAAK;AAAA,gBAChB,UAAU,GAAG,IAAI,IAAI,YAAY,GAAG,IAAI,IAAI;AAAA,gBAC5C,cAAc,GAAG,IAAI,IAAI;AAAA,gBACzB,UAAU,GAAG,IAAI,IAAI;AAAA,gBACrB,UAAU,GAAG,IAAI,IAAI;AAAA,gBACrB;AAAA,gBACA,iBAAiB,GAAG,IAAI,IAAI;AAAA,gBAC5B,YAAY,GAAG,IAAI,IAAI,sBAAsB,GAAG,IAAI,IAAI;AAAA,gBACxD,qBAAqB,GAAG,IAAI,IAAI;AAAA,gBAChC,qBAAqB,GAAG,IAAI,IAAI;AAAA,gBAChC,SAAS,GAAG,IAAI,IAAI;AAAA,gBACpB,YAAY,GAAG,IAAI,IAAI;AAAA,gBACvB,QAAQ,KAAK,GAAG,IAAI,IAAI,MAAM;AAAA,gBAC9B,WAAW,KAAK,GAAG,IAAI,IAAI,SAAS;AAAA,gBACpC,kBAAkB,GAAG,IAAI,IAAI;AAAA,gBAC7B,kBAAkB,GAAG,IAAI,IAAI,oBAAoB,GAAG,IAAI,IAAI;AAAA,gBAC5D,qBAAqB,GAAG,IAAI,IAAI;AAAA,gBAChC,SAAS,GAAG,IAAI,IAAI;AAAA,gBACpB,MAAM,GAAG,IAAI,IAAI;AAAA,gBACjB,SAAS,KAAK,WAAW,GAAG,IAAI,IAAI;AAAA,gBACpC,KAAK,KAAK,OAAO;AAAA,gBACjB,UAAU,KAAK;AAAA,gBACf,WAAW,KAAK;AAAA,gBAChB,mBAAmB,KAAK;AAAA,gBACxB,iBAAiB,KAAK;AAAA,gBACtB,YAAY,KAAK;AAAA,gBACjB,cAAc,KAAK;AAAA,gBACnB,WAAW,KAAK;AAAA,gBAChB,aAAa,KAAK,GAAG,IAAI,IAAI,MAAM,IAAI,GAAG,IAAI,IAAI,cAAc;AAAA,gBAChE,aAAa,KAAK;AAAA,gBAClB,cAAc,GAAG,IAAI,IAAI;AAAA,gBACzB,mBAAmB,KAAK;AAAA,gBACxB,eAAe,KAAK;AAAA,cACrB;AAAA,YACD;AAAA,YAEA,UAAU,SAAS,GAAG;AACrB,kBAAG,CAAC,EAAE,KAAK;AACV,uBAAO,aAAa;AAAA,kBACnB,MAAM;AACL,wBAAI,IAAI,OAAO,KAAK;AACpB,uBAAG,iCAAiC,EAAE,aAAa;AACnD,wBAAI,EAAE,gBAAgB;AACrB,yBAAG,uBAAuB,CAAC;AAAA,oBAC5B;AAAA,kBACD;AAAA,kBACA,MAAM;AAEL,wBAAI,GAAG,IAAI,IAAI,wBAAwB,GAAG,IAAI,IAAI,sBAAsB;AACvE,yBAAG,kBAAkB,MAAM,GAAG,IAAI,cAAc,GAAG,IAAI,cACtD,GAAG,IAAI,IAAI,SAAS,GAAG,IAAI,IAAI,OAAO;AAAA,oBACxC,OAAO;AACN,yBAAG,IAAI,eAAe,QAAQ,mBAAmB,KAAK,GAAG;AAAA,oBAC1D;AAAA,kBACD;AAAA,kBACA,MAAM;AACL,wBAAI,GAAG,IAAI,IAAI,wBAAwB,GAAG,IAAI,IAAI,sBAAsB;AACvE,yBAAG,2BAA2B;AAAA,oBAC/B;AAAA,kBACD;AAAA,kBACA,MAAM,GAAG,yBAAyB,IAAI;AAAA,kBACtC,MAAM;AACL,wBAAI;AACH,6BAAO,OAAO,GAAG,UAAU,QAAQ,KAAK,WAAW,CAAC,gBAAgB,eAAe,CAAC,EAClF,KAAK,CAAC,OAAM;AACZ,4BAAI,GAAE,WACL,IAAE,QAAQ,gBAAgB,GAAE,QAAQ,gBAAgB;AACpD,iCAAO,MAAM,2BAA2B;AAAA,wBACzC;AAAA,sBACD,CAAC;AAAA,kBACJ;AAAA,kBACA,MAAM;AAEL,wBAAI,qBAAqB,CAAC,OAAO,MAAM;AACtC,6BAAO,OAAO,GAAG,iBAAiB,kBAAkB,sCAAsC,EACxF,KAAK,CAAC,UAAU;AAChB,4BAAI,OAAO;AACV,iCAAO,MAAM,2BAA2B;AAAA,wBACzC;AAAA,sBACD,CAAC;AAAA,kBACJ;AAAA,kBACA,MAAM;AACL,wBAAG,qBAAqB,CAAC,OAAO,MAAM,0BAA0B;AAC/D,0BAAI,IAAI,OAAO,KAAK;AACpB,wBAAE,KAAK,EAAE,SAAS,SAAS,GAAG,GAAG;AAChC,4BAAG,CAAC,EAAE;AAAI,4BAAE,KAAK;AAAA,sBAClB,CAAC;AAED,0BAAI,EAAE,gBAAgB,EAAE,eAAe;AACtC,0BAAE,WAAW;AAAA,sBACd;AAEA,8BAAQ,2BAA2B,GAAG,KAAK,GAAG,CAAC,UAAS;AACvD,2BAAG,IAAI,eAAe,QAAQ,OAAO,MAAK,SAAS,MAAK,IAAI;AAC5D,4BAAI,CAAC,GAAG,IAAI,IAAI;AACf,6BAAG,IAAI,eAAe,QAAQ,aAAa,MAAK,SAAS,MAAK,IAAI;AAAA,sBACpE,GAAG,QAAW,CAAC,OAAO,MAAM,wBAAwB;AAAA,oBACrD;AAAA,kBACD;AAAA,kBACA,MAAM,GAAG,kBAAkB,KAAK,KAAK,KAAK,IAAI;AAAA,kBAC9C,MAAM,GAAG,oBAAoB,IAAI;AAAA,kBACjC,MAAM;AACL,wBAAI,KAAK,2BAA2B;AACnC,0BAAI,MAAM,KAAK;AACf,yBAAG,0BAA0B,EAAC,KAAK,KAAI,CAAC;AAAA,oBACzC;AAAA,kBACD;AAAA,kBACA,MAAM;AACL,wBAAI,mBAAmB,GAAG,qBAAqB;AAC/C,uBAAG,wBAAwB,gBAAgB;AAAA,kBAC5C;AAAA,gBACD,CAAC;AAAA,cACF;AAAA,YACD;AAAA,UACD,CAAC;AAAA,QACF;AAAA,MACD;AAAA,IACD;AAAA,IAEA,iBAAiB,SAAS,KAAK,KAAK,KAAK;AACxC,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,aAAO,MAAM,gBAAgB,MAAM,CAAC,mBAAmB,qBAAqB,CAAC;AAG7E,UAAI,QAAQ,CAAC,kBAAkB,oBAAoB,sBAAsB,sBAAsB,oBAAoB,yBAAyB,uBAAuB,yBAAwB,uBAAuB,CAAC,GAAG;AACrN,aAAK,2BAA2B,IAAI;AAAA;AAEpC,aAAK,OAAO,IAAI,KAAK,kBAAmB,KAAI,KAAK,sBAAsB,MACtE,UAAU,QAAQ,IAAI,CAAC;AAEzB,WAAK,2BAA2B;AAAA,IACjC;AAAA,IAEA,uBAAuB,SAAS,KAAK,KAAK,KAAK;AAE9C,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,WAAK,2BAA2B,IAAI;AACpC,WAAK,2BAA2B;AAChC,cAAQ,eAAe;AAAA,IACxB;AAAA,IAEA,aAAa,SAAS,KAAK,KAAK,KAAK;AAEpC,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,UAAI,CAAC,KAAK,aAAa;AACtB,eAAO,MAAM,UAAU,KAAK,KAAK,yBAAyB,CAAC;AAAA,MAC5D,OAAO;AACN,aAAK,2BAA2B,MAAM,KAAK,KAAK,GAAG;AACnD,aAAK,2BAA2B;AAChC,gBAAQ,eAAe;AAAA,MACxB;AAAA,IACD;AAAA,IAEA,mBAAmB,SAAS,MAAM,cAAc,cAAc,cAAc,SAAS;AAEpF,UAAI,YAAY;AAAA,QACf,aAAa,KAAK;AAAA,QAClB,aAAa,QAAQ,oBAAoB,kBAAkB,IAAI,KAAK,iBAAiB,KAAK;AAAA,QAC1F,gBAAgB;AAAA,QAChB,gBAAgB;AAAA,QAChB,OAAO,KAAK,MAAM,KAAK;AAAA,QACvB,aAAa,KAAK;AAAA,QAClB,gBAAgB;AAAA,QAChB,WAAW;AAAA,QACX,6BAA6B,KAAK;AAAA,MACnC;AAEA,aAAO,KAAK;AAAA,QACX,QAAQ;AAAA,QACR,MAAM;AAAA,UACL,MAAM;AAAA,QACP;AAAA,QACA,UAAU,SAAS,GAAG;AACrB,iBAAO,MAAM,UAAU,KAAK,SAAS,KAAK,MAAM,QAAQ,EAAE,UAAU,KAAK,iBAAiB;AAAA,QAC3F;AAAA,MACD,CAAC;AAAA,IACF;AAAA,IAEA,WAAW,SAAS,KAAK,KAAK,KAAK;AAClC,UAAI,KAAK;AACT,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAElC,UAAI,QAAQ,KAAK,YAAY,kCAAkC;AAC9D;AAAA,MACD;AAEA,UAAI,QAAQ,KAAK,WAAW;AAC3B,YAAI,CAAC,KAAK,WAAW;AACpB,eAAK,IAAI,QAAQ,aAAa,KAAK,GAAG;AAAA,QACvC,OACK;AAEJ,eAAK,YAAY,KAAK,UAAU,QAAQ,MAAM,IAAI;AAClD,eAAK,oBAAoB,KAAK,qBAAqB;AACnD,wBAAc,aAAa,KAAK,MAAM,KAAK,WAAW;AACtD,cAAI,CAAC,IAAI,aAAa,KAAK,OAAO,cAAc,gDAAgD,GAAG;AAClG,uBAAW,MAAM;AAChB,iBAAG,WAAW,KAAK,GAAG;AAAA,YACvB,GAAG,GAAK;AAAA,UACT;AAAA,QACD;AAAA,MACD;AAAA,IACD;AAAA,IAEA,YAAY,SAAS,KAAK,KAAK;AAC9B,UAAI,mBAAmB,CAAC;AACxB,UAAI,YAAY,CAAC;AACjB,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,kBAAY,KAAK,UAAU,MAAM,IAAI;AACrC,eAAS,IAAI,GAAG,IAAI,UAAU,QAAQ,KAAK;AAC1C,YAAI,UAAU,MAAM,IAAI;AACvB,2BAAiB,KAAK,UAAU,EAAE;AAAA,QACnC;AAAA,MACD;AACA,aAAO,MAAM,UAAU,KAAK,SAAS,KAAK,MACzC,OAAO,iBAAiB,SAAS,KAAK,iBAAiB;AACxD,aAAO,MAAM,UAAU,KAAK,SAAS,KAAK,MAAM,aAAa,iBAAiB,MAAM;AAAA,IACrF;AAAA,IAEA,UAAU,WAAW;AACpB,WAAK,2BAA2B,KAAK;AAAA,IACtC;AAAA,IAEA,cAAc,WAAW;AACxB,WAAK,IAAI,QAAQ,gCAAgC;AAAA,IAClD;AAAA,IAEA,gCAAgC,WAAW;AAC1C,UAAI,KAAK;AACT,UAAK,KAAK,IAAI,IAAI,YAAY,mBAAmB,GAAG,IAAI,IAAI,gBACxD,KAAK,IAAI,IAAI,WAAW,iBAAiB;AAC5C,YAAI,KAAK,IAAI,IAAI,wBAAwB,KAAK,IAAI,IAAI,YAAY,KAAK,IAAI,IAAI,oBAAoB;AAClG,iBAAO,GAAG,UAAU,WAAW,KAAK,IAAI,IAAI,SAAS,gCAAgC,SAAS,OAAO;AACpG,eAAG,IAAI,UAAU,wBAAwB,MAAM,4BAA4B;AAAA,UAC5E,CAAC;AAAA,QACF;AAAA,MACD;AAEA,UAAK,KAAK,IAAI,IAAI,YAAY,sBAAsB,GAAG,IAAI,IAAI,gBAC3D,KAAK,IAAI,IAAI,WAAW,oBAAoB;AAC/C,YAAI,KAAK,IAAI,IAAI,wBAAwB,KAAK,IAAI,IAAI,YAAY,KAAK,IAAI,IAAI,oBAAoB;AAClG,iBAAO,GAAG,UAAU,WAAW,KAAK,IAAI,IAAI,SAAS,gCAAgC,SAAS,OAAO;AACpG,eAAG,IAAI,UAAU,sBAAsB,MAAM,4BAA4B;AAAA,UAC1E,CAAC;AAAA,QACF;AAAA,MACD;AAAA,IACD;AAAA,IAEA,SAAS,WAAW;AACnB,UAAI,KAAK;AACT,UAAI,cAAc,WAAW;AAC5B,YAAG,GAAG,IAAI,IAAI,WAAW,GAAG,IAAI,YAAY,UAAU;AACrD,cAAI,mBAAmB,GAAG,qBAAqB;AAC/C,cAAI,cAAc,OAAO,QAAQ,YAAY,GAAG,IAAI,IAAI,OAAO;AAE/D,cAAI,CAAC,GAAG,IAAI,IAAI,UAAU;AACzB,eAAG,IAAI,UAAU,YAAY,gBAAgB;AAAA,UAC9C;AAEA,cAAI,GAAG,IAAI,IAAI,YAAY,kBAAkB;AAC5C,eAAG,IAAI,UAAU,mBAAmB,CAAG;AAAA,UACxC;AACA,cAAI,GAAG,IAAI,IAAI,uBAAuB,kBAAkB;AACvD,eAAG,IAAI,UAAU,uBAAuB,CAAG;AAAA,UAC5C;AACA,cAAI,YAAY,qBAAqB;AACpC,gBAAG,GAAG,IAAI,YAAY,aAAa;AAClC,iBAAG,IAAI,UAAU,eAAe,YAAY,mBAAmB;AAAA,YAChE;AAAA,UACD;AACA,cAAI,0BAA0B,CAAC,iBAAiB,aAAa,eAAe,iBAAgB,kBAAkB;AAC9G,cAAI,YAAY,yBAAyB,OAAO,KAAK,UAAU,GAAG,IAAI,IAAI,SAAS,SAAS,KAC5F,wBAAwB,QAAQ,GAAG,IAAI,IAAI,OAAO,KAAK,IAAI;AAC1D,eAAG,IAAI,UAAU,WAAW,YAAY,qBAAqB;AAAA,UAC9D;AACA,cAAI,yBAAyB;AAAA,YAAC;AAAA,YAAyB;AAAA,YAAsB;AAAA,YAC5E;AAAA,YAAoB;AAAA,UAAkB;AAEvC,cAAI,YAAY,wBAAwB,OAAO,KAAK,UAAU,GAAG,IAAI,IAAI,SAAS,SAAS,KAC3F,uBAAuB,QAAQ,GAAG,IAAI,IAAI,OAAO,KAAK,IAAI;AACzD,eAAG,IAAI,UAAU,WAAW,YAAY,oBAAoB;AAAA,UAC7D;AAEA,iBAAO,aAAa;AAAA,YACnB,MAAM,GAAG,IAAI,eAAe,QAAQ,UAAU;AAAA,YAC9C,MAAM,GAAG,oBAAoB;AAAA,YAC7B,MAAM,GAAG,oBAAoB;AAAA,YAC7B,MAAM,GAAG,mBAAmB;AAAA,UAC7B,CAAC;AAAA,QACF;AAAA,MACD;AAEA,UAAI,oBAAoB,SAAS,cAAa;AAC7C,YAAI,QAAQ,CAAC,iBAAiB,kBAAkB,GAAG,GAAG,IAAI,IAAI,OAAO,GAAG;AACvE,cAAG,GAAG,IAAI,IAAI,WAAS,iBAAiB;AACvC,gBAAI,aAAa;AACjB,gBAAI,sBAAsB;AAAA,UAC3B,OAAO;AACN,gBAAI,aAAa;AACjB,gBAAI,sBAAsB;AAAA,UAC3B;AAEA,cAAI,QAAQ,GAAG,IAAI,IAAI,OAAO,MAAM,MAAM,UAAU;AACpD,cAAG,SAAS,GAAG,IAAI,IAAI,SAAS;AAC/B,mBAAO,OAAO,KAAK;AAAA,cAClB,QAAQ;AAAA,cACR,MAAM;AAAA,gBACL,SAAS,GAAG,IAAI,IAAI;AAAA,gBACpB;AAAA,gBACA;AAAA,cACD;AAAA,cACA,UAAU,SAAS,GAAG;AACrB,oBAAG,CAAC,EAAE,OAAO,EAAE,SAAS;AACvB,qBAAG,IAAI,UAAU,qBAAqB,EAAE,OAAO;AAC/C,+BAAY;AAAA,gBACb;AAAA,cACD;AAAA,YACD,CAAC;AAAA,UACF,OAAO;AACN,yBAAY;AAAA,UACb;AAAA,QACD,OAAO;AACN,uBAAY;AAAA,QACb;AAAA,MAED;AAEA,UAAI,OAAO,KAAK,aAAa,KAAK,IAAI,SAAS,kBAAkB,KAChE,QAAQ,CAAC,kBAAkB,oBAAoB,kBAAkB,GAAG,KAAK,IAAI,OAAO,GAAG;AACvF,gBAAQ,MAAM,qBAAqB,KAAK,KAAK,WAAU;AACtD,4BAAkB,WAAW;AAAA,QAC9B,CAAC;AAGD,eAAO,KAAK;AAAA,UACX,UAAU;AAAA,UACV,QAAQ;AAAA,YACP,WAAW;AAAA,YACX,QAAQ,KAAK,IAAI,IAAI;AAAA,UACtB;AAAA,UACA,YAAY,SAAS,GAAG;AACvB,eAAG,IAAI,UAAU,mBAAmB,EAAE,OAAO;AAAA,UAC9C;AAAA,QACD,CAAC;AAAA,MAEF,OAAO;AACN,0BAAkB,WAAW;AAAA,MAC9B;AAEA,UAAG,KAAK,IAAI,IAAI,SAAS;AACxB,gBAAQ,wBAAwB,KAAK,IAAI,IAAI;AAAA,MAC9C;AAAA,IACD;AAAA,IAEA,kBAAkB,WAAW;AAC5B,UAAI,KAAK,IAAI,IAAI,kBAAkB;AAClC,aAAK,IAAI,mBAAmB,KAAK,IAAI,IAAI;AACzC,eAAO,GAAG,KAAK,QAAQ,KAAK,IAAI,IAAI,SAAS,UAAU;AAAA,MACxD;AAAA,IACD;AAAA,IAEA,cAAc,WAAW;AACxB,UAAI,KAAK;AACT,UAAI,KAAK,IAAI,IAAI,cAAc;AAC9B,aAAK,IAAI,eAAe,KAAK,IAAI,IAAI;AAErC,YAAK,KAAK,IAAI,IAAI,WAAW,mBAAmB,KAAK,IAAI,IAAI,YAC3D,KAAK,IAAI,IAAI,WAAW,sBAAsB,KAAK,IAAI,IAAI,UAAW;AACvE,iBAAO,OAAO,KAAK;AAAA,YAClB,QAAQ;AAAA,YACR,MAAM;AAAA,cACL,gBAAgB,GAAG,IAAI,IAAI;AAAA,cAC3B,cAAc,GAAG,IAAI,IAAI,WAAW,kBAAkB,aAAa;AAAA,cACnE,aAAa,GAAG,IAAI,IAAI;AAAA,cACxB,SAAS,GAAG,IAAI,IAAI,WAAW,kBAAkB,GAAG,IAAI,IAAI,WAAW,GAAG,IAAI,IAAI;AAAA,cAClF,WAAW,GAAG,IAAI,IAAI;AAAA,YACvB;AAAA,YACA,UAAU,SAAS,GAAG,IAAI;AACzB,kBAAG,EAAE,SAAS;AACb,mBAAG,IAAI,IAAI,WAAW,EAAE;AACxB,8BAAc,UAAU;AACxB,uBAAO,GAAG,KAAK,QAAQ,GAAG,IAAI,IAAI,SAAS,UAAU;AACrD,mBAAG,kBAAkB;AAAA,cACtB;AAAA,YACD;AAAA,UACD,CAAC;AAAA,QACF,OAAO;AACN,iBAAO,GAAG,KAAK,QAAQ,GAAG,IAAI,IAAI,SAAS,UAAU;AAAA,QACtD;AAAA,MACD;AAAA,IACD;AAAA,IAEA,UAAU,WAAW;AAGpB,UAAI,KAAK,IAAI,IAAI,YAAY,CAAC,KAAK,IAAI,0BAA0B,CAAC,KAAK,IAAI,IAAI,QAAQ;AACtF,YAAI,KAAK,IAAI,IAAI,0BACf,KAAK,IAAI,IAAI,oBAAoB,KAAK,IAAI,IAAI,iBAAiB,QAAS;AACzE,cAAI,WAAW;AACf,cAAI,WAAW;AACf,cAAI,gBAAgB,GAAG,kBAAkB,IAAI;AAE7C,cAAI,KAAK,IAAI,IAAI,wBAAwB;AACxC,uBAAW,GAAG,iCAAiC;AAC/C,4BAAgB,gBAAgB;AAAA,UACjC;AAEA,cAAK,MAAK,IAAI,IAAI,oBAAoB,CAAC,GAAG,QAAQ;AACjD,uBAAW,GAAG,wBAAwB;AACtC,gBAAI,SAAS,WAAW;AAAG,yBAAW,UAAU;AAChD,4BAAgB,gBAAgB;AAAA,UACjC;AACA,iBAAO,SAAS,aAAa;AAAA,QAC9B;AAAA,MACD;AAAA,IACD;AAAA,IAEA,WAAW,WAAW;AACrB,WAAK,aAAa;AAAA,IACnB;AAAA,IAEA,mBAAmB,WAAW;AAC7B,YAAM,MAAM,KAAK,IAAI;AACrB,UAAI,IAAI,wBAAwB;AAC/B,aAAK,uBAAuB;AAAA,MAC7B,WAAW,IAAI,kBAAkB;AAChC,cAAM,KAAK;AACX,YAAI,iBAAiB,QACpB,SAAS,MAAM;AACd,cAAI,KAAK,cAAc;AACtB,eAAG,aAAa,KAAK,KAAK,SAAS,KAAK,IAAI;AAAA,UAC7C,OAAO;AACN,mBAAO,MAAM,UACZ,KAAK,SAAS,KAAK,MAAM,YACzB,IAAI,gBAAgB,IAAI,gBACzB;AAAA,UACD;AAAA,QACD,CACD;AAAA,MACD;AAAA,IACD;AAAA,IAEA,sBAAsB,WAAW;AAChC,aAAO,QAAQ,aAAa,KAAK,IAAI,IAAI,OAAO;AAAA,IACjD;AAAA,IAEA,gBAAgB,WAAW;AAC1B,cAAQ,MAAM,oBAAoB,KAAK,GAAG;AAAA,IAC3C;AAAA,IAEA,UAAU,WAAW;AAEpB,UAAI,mBAAmB,KAAK,IAAI,IAAI,oBAAoB,KAAK,IAAI,IAAI;AAErE,UAAI,KAAK;AACT,WAAK,mBAAmB;AACxB,UAAI,mBAAmB,KAAK,qBAAqB;AAEjD,UAAG,KAAK,IAAI,IAAI,YAAY,KAAK,IAAI,IAAI,aAAa,oBACjD,CAAC,KAAK,IAAI,IAAI,qBAAqB;AAEvC,aAAK,kBAAkB,kBAAkB,KAAK,IAAI,IAAI,UAAU,kBAC/D,SAAS,eAAe;AACvB,cAAG,iBAAiB,GAAG,IAAI,IAAI,iBAAiB;AAC/C,eAAG,oCAAoC,aAAa;AACpD,eAAG,qCAAqC,aAAa;AACrD,eAAG,IAAI,UAAU,mBAAmB,aAAa;AAAA,UAClD;AAAA,QACD,CAAC;AAAA,MACH,OAAO;AACN,aAAK,gBAAgB;AAAA,MACtB;AAAA,IACD;AAAA,IAEA,iBAAiB,WAAW;AAC3B,YAAM,KAAK,KAAK;AAChB,UAAG,KAAK,IAAI,IAAI,aAAa,KAAK,qBAAqB,GAAG;AACzD,aAAK,IAAI,UAAU,mBAAmB,CAAG;AAAA,MAC1C;AACA,UAAG,KAAK,IAAI,IAAI,aAAa,KAAK,IAAI,IAAI,uBACzC,KAAK,IAAI,IAAI,wBAAwB,KAAK,IAAI,IAAI,iBAAiB;AACnE,aAAK,IAAI,UAAU,uBAAuB,KAAK,IAAI,IAAI,eAAe;AAAA,MACvE;AAEA,UAAG,IAAI,KAAK,IAAI,IAAI,eAAe,IAAE,GAAK;AACzC,YAAG,KAAK,IAAI,IAAI,qBAAqB;AACpC,eAAK,2BAA2B;AAAA,QACjC,WAAW,CAAC,KAAK,qBAAoB;AACpC,eAAK,iBAAiB;AAAA,QACvB;AAAA,MAED;AAEA,WAAK,IAAI,gBAAgB,mBAAmB,aAAa,QAAQ,mBAAmB,IAAI,IAAI,CAAC;AAAA,IAC9F;AAAA,IAEA,eAAe,WAAW;AACzB,UAAI,KAAK;AACT,UAAG,KAAK,IAAI,IAAI,eAAe;AAC9B,eAAO,KAAK,IAAI,KAAK;AAAA,UACpB,KAAK,KAAK,IAAI;AAAA,UACd,QAAQ;AAAA,UACR,UAAU,SAAS,GAAG;AACrB,gBAAG,CAAC,EAAE,KAAK;AACV,iBAAG,2BAA2B;AAAA,YAC/B;AAAA,UACD;AAAA,QACD,CAAC,EAAE,KAAK,MAAM,KAAK,IAAI,UAAU,iBAAiB,EAAE,CAAC;AAAA,MACtD,OACK;AACJ,WAAG,2BAA2B;AAAA,MAC/B;AAAA,IACD;AAAA,IAEA,qCAAqC,SAAS,eAAe;AAC5D,UAAI,QAAQ,CAAC,aAAa,eAAe,iBAAiB,iBAAiB,oBAAoB,kBAAkB,oBAAmB,kBAAkB,CAAC,GAAG,KAAK,IAAI,IAAI,SAAS;AAC/K,YAAI,KAAK;AACT,UAAE,KAAK,KAAK,IAAI,IAAI,SAAS,CAAC,GAAG,SAAS,GAAG,GAAG;AAC/C,cAAG,EAAE,eAAe,UAAU;AAC7B,mBAAO,MAAM,UAAU,EAAE,SAAS,EAAE,MAAM,yBACzC,IAAI,EAAE,qBAAqB,IAAI,IAAI,aAAa,CAAC;AAAA,UACnD;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,sCAAsC,SAAS,eAAe;AAC7D,UAAI,KAAK;AACT,QAAE,KAAK,KAAK,IAAI,IAAI,SAAS,CAAC,GAAG,SAAS,GAAG,GAAG;AAC/C,YAAG,EAAE,eAAe,UAAU;AAC7B,iBAAO,MAAM,UAAU,EAAE,SAAS,EAAE,MAAM,cACzC,IAAI,EAAE,UAAU,IAAI,IAAI,aAAa,CAAC;AAAA,QACxC;AAAA,MACD,CAAC;AAAA,IACF;AAAA,IAEA,mBAAmB,SAAS,kBAAkB,eAAe,aAAa,UAAU;AACnF,UAAI;AACJ,UAAI,CAAC,aAAa,eAAe,iBAAiB,iBAAgB,kBAAkB,EAAE,SAAS,KAAK,IAAI,OAAO,GAAG;AACjH,eAAO;AAAA,MACR,WACS,CAAC,kBAAkB,oBAAoB,kBAAkB,EAAE,SAAS,KAAK,IAAI,OAAO,GAAG;AAC/F,eAAO;AAAA,MACR;AAEA,UAAI,CAAC,oBAAoB,CAAC,iBAAiB,CAAC;AAAa;AACzD,aAAO,OAAO,KAAK;AAAA,QAClB,QAAQ;AAAA,QACR,MAAM;AAAA,UACL;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QACD;AAAA,QACA,QAAQ;AAAA,QACR,gBAAgB,GAAG,6BAA6B;AAAA,QAChD,UAAU,SAAS,GAAG;AACrB,mBAAS,IAAI,EAAE,OAAO,CAAC;AAAA,QACxB;AAAA,MACD,CAAC;AAAA,IACF;AAAA,IAEA,qBAAqB,WAAW;AAC/B,UAAI,KAAG;AACP,WAAK,mBAAmB;AAExB,UAAI,mBAAmB,KAAK,qBAAqB;AAEjD,UAAG,KAAK,IAAI,IAAI,wBAAwB,oBAAqB,CAAC,KAAK,IAAI,IAAI,qBAAqB;AAC/F,aAAK,kBAAkB,KAAK,IAAI,IAAI,cAAc,KAAK,IAAI,IAAI,qBAAqB,kBACnF,SAAS,eAAe;AACvB,aAAG,IAAI,UAAU,uBAAuB,aAAa;AAAA,QACtD,CAAC;AAAA,MACH,OAAO;AACN,aAAK,oBAAoB;AAAA,MAC1B;AAAA,IACD;AAAA,IAEA,qBAAqB,WAAW;AAC/B,UAAG,KAAK,IAAI,IAAI,wBAAwB,KAAK,qBAAqB,GAAG;AACpE,aAAK,IAAI,UAAU,uBAAuB,CAAG;AAAA,MAC9C,WAAU,KAAK,IAAI,IAAI,wBAAwB,KAAK,IAAI,IAAI,YACxD,KAAK,IAAI,IAAI,uBAAuB,KAAK,KAAK,IAAI,IAAI,mBAAmB,KAAK,KACjF,KAAK,KAAK,IAAI,IAAI,mBAAmB,KAAK,KAAK,KAAK,IAAI,IAAI,eAAe,GAAG;AAC9E,aAAK,IAAI,UAAU,mBAAmB,KAAK,IAAI,IAAI,mBAAmB;AAAA,MACvE;AAEA,UAAG,CAAC,KAAK,qBAAqB;AAC7B,aAAK,iBAAiB,MAAM,IAAI;AAAA,MACjC;AAAA,IACD;AAAA,IAEA,KAAK,SAAS,KAAK,KAAK,KAAK;AAC5B,UAAI,KAAK;AACT,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,UAAG,KAAK,aAAa,KAAK,KAAK;AAC9B,eAAO,KAAK,IAAI,KAAK;AAAA,UACpB,QAAQ;AAAA,UACR,MAAM;AAAA,YACL,WAAW,KAAK;AAAA,YAChB,KAAK,KAAK;AAAA,UACX;AAAA,UACA,UAAU,SAAS,GAAG;AACrB,gBAAG,CAAC,EAAE,KAAK;AACV,qBAAO,MAAM,UAAU,KAAK,KAAK,qBAAqB,EAAE,QAAQ,iBAAiB;AAAA,YAClF;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AACA,SAAG,yBAAyB,KAAK,KAAK,GAAG;AAAA,IAC1C;AAAA,IAEA,mBAAmB,SAAS,KAAK,KAAK,KAAK,4BAA4B;AACtE,UAAG,OAAO,KAAK,aAAa,KAAK,aAAa,GAAG,GAAG;AACnD,YAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,eAAO,MAAM,gBAAgB,MAAM,CAAC,OAAO,mBAAmB,CAAC;AAC/D,aAAK,YAAY,IAAI,KAAK,MAAM,KAAK,mBAAmB,UAAU,aAAa,IAAI,CAAC;AACpF,sBAAc,aAAa,KAAK,MAAM,KAAK,WAAW;AACtD,aAAK,yBAAyB,IAAI;AAElC,YAAG,IAAI,WAAW,oBAAoB;AACrC,eAAK,eAAe,IAAI,KAAK,YAAY,KAAK,eAAe;AAC7D,wBAAc,gBAAgB,KAAK,MAAM,KAAK,WAAW;AACzD,eAAK,qBAAqB;AAAA,QAC3B;AAGA,YAAG,OAAO,MAAM,4BAA4B;AAC3C;AAAA,QACD;AAEA,YAAI,CAAC,8BACJ,OAAO,KAAK,UAAU,IAAI,SAAS,qBAAqB,GAAG;AAC3D,eAAK,iBAAiB,MAAM,IAAI;AAAA,QACjC;AACA,aAAK,yBAAyB,KAAK,KAAK,GAAG;AAAA,MAC5C;AAAA,IACD;AAAA,IAEA,UAAU,SAAS,KAAK,KAAK,KAAK;AACjC,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,WAAK,iBAAiB,MAAM,IAAI;AAAA,IACjC;AAAA,IAEA,0BAA0B,SAAS,MAAM;AAExC,UAAG,KAAK,IAAI,UAAU,OAAO,EAAE,KAAK,WAAW,mBAAmB;AACjE,aAAK,IAAI,YAAY,MAAM,KAAK,cAAc,qBAC3C,KAAK,OAAO,KAAK,aAAc,CAAC,OAAO,KAAK,aAAa,QAAQ,YAAY,MAAM,KAAK,SAAS,mBAAmB,EAAE,YAAY,OAAM,KAAK;AAAA,MACjJ;AAAA,IAED;AAAA,IAEA,KAAK,SAAS,KAAK,KAAK,KAAK;AAC5B,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,WAAK,kBAAkB,KAAK,KAAK,KAAK,IAAI;AAC1C,WAAK,yBAAyB,KAAK,KAAK,GAAG;AAC3C,WAAK,mBAAmB,MAAM,IAAI;AAAA,IACnC;AAAA,IAEA,0BAA0B,SAAS,KAAK,KAAK,KAAK;AACjD,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,WAAK,iBAAiB,IAAI,KAAK,IAAI,IAAE,IAAI,KAAK,iBAAiB;AAC/D,oBAAc,kBAAkB,KAAK,MAAM,KAAK,WAAW;AAAA,IAC5D;AAAA,IACA,mBAAmB,SAAS,KAAK,KAAK,KAAK;AAC1C,UAAI,QAAQ,OAAO,KAAK;AAExB,UAAG,MAAM,mBAAmB;AAC3B,YAAI,aAAa,KAAK,MAAM,MAAM,kBAAkB;AACpD,YAAI,WAAW,KAAK,MAAM,MAAM,gBAAgB;AAChD,YAAI,YAAY,KAAK,MAAM,MAAM,iBAAiB;AAElD,YAAG,YAAY,YAAY;AAC1B,iBAAO,MAAM,UAAU,KAAK,KAAK,qBAAqB,EAAE;AACxD,iBAAO,MAAM,GAAG,uDAAuD,CAAC;AAAA,QACzE,WAAW,YAAY,UAAU;AAChC,iBAAO,MAAM,UAAU,KAAK,KAAK,qBAAqB,EAAE;AACxD,iBAAO,MAAM,GAAG,oDAAoD,CAAC;AAAA,QACtE;AAAA,MACD;AAAA,IACD;AAAA,IAEA,oBAAoB,SAAS,KAAK,KAAK,KAAK;AAC3C,UAAI,QAAQ,OAAO,KAAK;AAExB,UAAG,MAAM,oBAAoB;AAC5B,eAAO,KAAK;AAAA,UACX,UAAU;AAAA,UACV,MAAM,EAAC,QAAQ,MAAK;AAAA,UACpB,UAAU,SAAS,GAAG;AACrB,mBAAO,MAAM,UAAU,KAAK,KAAK,oBAAoB,EAAE,QAAQ,gBAAgB;AAAA,UAChF;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,sBAAsB,WAAU;AAE/B,UAAI,KAAK;AACT,WAAK,IAAI,IAAI,mBAAkB;AAE/B,QAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,MAAM;AACrD,WAAG,IAAI,IAAI,oBAAoB,IAAI,KAAK,YAAY;AAAA,MACrD,CAAC;AACD,oBAAc,kBAAkB;AAChC,WAAK,cAAc;AAAA,IACpB;AAAA,IAEA,oBAAoB,WAAW;AAE9B,WAAK,IAAI,YAAY,uBACpB,CAAC,CAAE,MAAK,IAAI,IAAI,mBAAmB,KAAK,IAAI,IAAI,oBAAoB;AAErE,UAAI,mBAAmB,KAAK,qBAAqB;AACjD,WAAK,mBAAmB,gBAAgB;AACxC,WAAK,mBAAmB,gBAAgB;AACxC,WAAK,IAAI,eAAe;AAAA,IACzB;AAAA,IAEA,oBAAoB,SAAS,kBAAkB;AAC9C,UAAI,KAAK;AAET,WAAK,IAAI,oBAAoB;AAAA,QAAC;AAAA,QAAc;AAAA,QAAkB;AAAA,QAC7D;AAAA,QAAwB;AAAA,QAAoB;AAAA,QAAsB;AAAA,QAClE;AAAA,QAAgC;AAAA,QAAmC;AAAA,QACnE;AAAA,QAAoB;AAAA,QAAyB;AAAA,QAAsB;AAAA,QACnE;AAAA,QAA0B;AAAA,QAAmB;AAAA,QAC7C;AAAA,MAA0B,GAAG,gBAAgB;AAE9C,WAAK,IAAI,oBAAoB;AAAA,QAAC;AAAA,QAAS;AAAA,QAAa;AAAA,QAA2B;AAAA,QAC9E;AAAA,QAAe;AAAA,QAA2B;AAAA,QAC1C;AAAA,QAAiB;AAAA,QAAY;AAAA,QAAe;AAAA,QAAoB;AAAA,QAChE;AAAA,QAAuB;AAAA,QAAuB;AAAA,QAC9C;AAAA,MAAY,GAAG,KAAK,IAAI,IAAI,QAAQ;AAErC,WAAK,IAAI,oBAAoB,CAAC,sBAAsB,eAAe,GAClE,KAAK,IAAI,IAAI,sBAAsB;AAEpC,cAAQ,gBAAgB,mBAAmB,eAAe,OAAO,KAAK,IAAI,IAAI,WAC3E,YAAY,gBAAgB;AAE/B,UAAG,KAAK,IAAI,IAAI,uBAAuB,KAAK,IAAI,IAAI,uBAAqB,kBAAkB;AAC1F,gBAAQ,gBAAgB,uBAAuB,eAAe,OAC3D,KAAK,IAAI,IAAI,sBAAsB,YAAY,gBAAgB;AAAA,MACnE;AAGA,WAAK,IAAI,eAAe;AAAA,QAAC;AAAA,QAAmB;AAAA,QAAc;AAAA,QACzD;AAAA,QAAgC;AAAA,QAAgC;AAAA,QAChE;AAAA,QAAoB;AAAA,QAAsB;AAAA,QAAiB;AAAA,QAC3D;AAAA,QAAoB;AAAA,QAAyB;AAAA,QAAuB;AAAA,QACpE;AAAA,QAAmB;AAAA,QAA4B;AAAA,MAA0B,GAC1E,KAAK,IAAI,IAAI,YAAY,gBAAgB;AAEzC,WAAK,IAAI,eAAe,CAAC,uBAAuB,qBAAqB,GACpE,KAAK,IAAI,IAAI,uBAAuB,gBAAgB;AAErD,UAAI,OAAO,KAAK,QAAQ,IAAI,eAAe,KACvC,SAAQ,IAAI,SAAS,CAAC,GAAG,OAAO,SAAS,GAAG;AAAC,eAAO,EAAE,2BAAyB;AAAA,MAAC,CAAC,EAAE;AAEvF,UAAG,OAAO,KAAK,aAAa,QAAQ,SAAS,WAAW;AACvD,gBAAQ,eAAe,aAAa,IAAI;AAEzC,UAAG,OAAO,KAAK,aAAa,QAAQ,SAAS,gBAAgB;AAC5D,gBAAQ,eAAe,kBAAmB,QAAS,GAAG,IAAI,IAAI,YAAY,gBAAkB;AAAA,IAE9F;AAAA,IAEA,oBAAoB,SAAS,kBAAkB;AAC9C,UAAI,KAAK;AAET,WAAK,wBAAwB,gBAAgB;AAE7C,WAAK,yBAAyB,gBAAgB;AAE9C,UAAI,KAAK,IAAI,IAAI,cAAc,KAAK,IAAI,IAAI,WAAW,SAAS,GAAG;AAClE,aAAK,IAAI,oBAAoB,CAAC,kBAAkB,WAAW,GAAG,KAAK,IAAI,IAAI,UAAU,YAAY;AACjG,aAAK,IAAI,oBAAoB,CAAC,uBAAuB,gBAAgB,GAAG,kBAAkB,YAAY;AAEtG,YAAI,YAAY,KAAK,IAAI,YAAY,cAAc;AACnD,UAAE,KAAK,CAAC,uBAAuB,gBAAgB,GAAG,SAAS,GAAG,OAAO;AACpE,cAAG,OAAO,KAAK,aAAa,UAAU,SAAS,KAAK;AACnD,sBAAU,gBAAgB,OAAO,GAAG,IAAI,IAAI,YAAY,gBAAgB;AAAA,QAC1E,CAAC;AAAA,MACF;AAEA,UAAI,KAAK,IAAI,IAAI,eAAe,KAAK,IAAI,IAAI,YAAY,SAAS,GAAG;AACpE,aAAK,IAAI,oBAAoB,CAAC,QAAQ,QAAQ,GAAG,KAAK,IAAI,IAAI,UAAU,aAAa;AACrF,aAAK,IAAI,oBAAoB,CAAC,aAAa,aAAa,GAAG,kBAAkB,aAAa;AAE1F,YAAI,YAAY,KAAK,IAAI,YAAY,eAAe;AACpD,UAAE,KAAK,CAAC,aAAa,aAAa,GAAG,SAAS,GAAG,OAAO;AACvD,cAAG,OAAO,KAAK,aAAa,UAAU,SAAS,KAAK;AACnD,sBAAU,gBAAgB,OAAO,GAAG,IAAI,IAAI,YAAY,gBAAgB;AAAA,QAC1E,CAAC;AAAA,MACF;AAEA,UAAI,KAAK,IAAI,IAAI,SAAS,KAAK,IAAI,IAAI,MAAM,SAAS,GAAG;AACxD,aAAK,IAAI,oBAAoB,CAAC,cAAc,SAAS,2BAA2B,GAAG,KAAK,IAAI,IAAI,UAAU,OAAO;AAEjH,aAAK,IAAI,oBAAoB,CAAC,mBAAmB,cAAc,gCAAgC,GAAG,kBAAkB,OAAO;AAAA,MAC5H;AAEA,UAAI,KAAK,IAAI,IAAI,YAAY,KAAK,IAAI,IAAI,SAAS,SAAS,GAAG;AAC9D,aAAK,IAAI,oBAAoB,CAAC,kBAAkB,kBAAkB,GACjE,KAAK,IAAI,IAAI,wBAAwB,UAAU;AAAA,MACjD;AAEA,WAAK,oCAAoC,gBAAgB;AAAA,IAC1D;AAAA,IAEA,yBAAyB,SAAS,kBAAkB;AACnD,WAAK,IAAI,oBAAoB;AAAA,QAC5B;AAAA,QAAa;AAAA,QAAiB;AAAA,QAC9B;AAAA,QAAe;AAAA,QAAmB;AAAA,MACnC,GAAG,kBAAkB,OAAO;AAE5B,WAAK,IAAI,oBAAoB;AAAA,QAC5B;AAAA,QAAQ;AAAA,QAAY;AAAA,QAAmB;AAAA,QACvC;AAAA,QAAc;AAAA,QAAkB;AAAA,MACjC,GAAG,KAAK,IAAI,IAAI,UAAU,OAAO;AAAA,IAClC;AAAA,IAEA,qCAAqC,SAAS,kBAAkB;AAC/D,YAAM,KAAK;AACX,UAAI,KAAK,IAAI,IAAI,oBAAoB,KAAK,IAAI,IAAI,iBAAiB,SAAS,GAAG;AAC9E,aAAK,IAAI,oBAAoB,CAAC,uBAAuB,oBAAoB,kBAAkB,GAC1F,kBAAkB,kBAAkB;AACrC,aAAK,IAAI,oBAAoB,CAAC,kBAAkB,eAAe,aAAa,GAC3E,KAAK,IAAI,IAAI,UAAU,kBAAkB;AAE1C,YAAI,gBAAgB,KAAK,IAAI,YAAY,oBAAoB;AAC7D,UAAE,KAAK,CAAC,uBAAuB,oBAAoB,kBAAkB,GAAG,SAAS,GAAG,OAAO;AAC1F,cAAI,OAAO,KAAK,aAAa,cAAc,SAAS,KAAK;AACxD,0BAAc,gBAAgB,OAAO,GAAG,IAAI,IAAI,YAAY,gBAAgB;AAAA,QAC9E,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,0BAA0B,SAAS,kBAAkB;AACpD,YAAM,KAAK;AAEX,UAAI,YAAY,KAAK,IAAI,YAAY,SAAS;AAC9C,QAAE,KAAK,CAAC,aAAa,wBAAwB,eAAe,uBAAuB,GAAG,SAAS,GAAG,OAAO;AACxG,YAAG,OAAO,KAAK,aAAa,UAAU,SAAS,KAAK;AACnD,oBAAU,gBAAgB,OAAO,GAAG,IAAI,IAAI,YAAY,gBAAgB;AAAA,MAC1E,CAAC;AAED,UAAI,OAAQ,KAAK,QAAQ,IAAI,eAAe,KACzC,SAAQ,IAAI,SAAS,CAAC,GAAG,OAAO,SAAS,GAAG;AAAC,eAAO,EAAE,2BAAyB;AAAA,MAAC,CAAC,EAAE;AAEtF,QAAE,KAAK,CAAC,YAAY,YAAY,GAAG,SAAS,GAAG,OAAO;AACrD,YAAG,OAAO,KAAK,aAAa,UAAU,SAAS,KAAK;AACnD,oBAAU,gBAAgB,OAAO,IAAI;AAAA,MACvC,CAAC;AAED,QAAE,KAAK,CAAC,iBAAiB,iBAAiB,GAAG,SAAS,GAAG,OAAO;AAC/D,YAAG,OAAO,KAAK,aAAa,UAAU,SAAS,KAAK;AACnD,oBAAU,gBAAgB,OAAQ,QAAS,GAAG,IAAI,IAAI,YAAY,gBAAkB;AAAA,MACtF,CAAC;AAAA,IACF;AAAA,IAEA,aAAa,WAAW;AACvB,WAAK,2BAA2B;AAAA,IACjC;AAAA,IAEA,oBAAoB,WAAW;AAC9B,WAAK,2BAA2B;AAAA,IACjC;AAAA,IAEA,mBAAmB,WAAW;AAC7B,WAAK,2BAA2B;AAAA,IACjC;AAAA,IAEA,qBAAqB,WAAW;AAC/B,UAAG,KAAK,IAAI,IAAI,qBAAqB;AACpC,YAAI,KAAK;AACT,YAAI,YAAY,CAAC;AAEjB,UAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,GAAG;AAClD,cAAI,EAAE,aAAa,CAAC,EAAE,cAAc;AACnC,sBAAU,KAAK;AAAA,cACd,WAAW,EAAE;AAAA,cACb,QAAQ,EAAE;AAAA,cACV,aAAa,EAAE;AAAA,cACf,iBAAiB,EAAE;AAAA,cACnB,cAAc,EAAE;AAAA,cAChB,UAAU,EAAE;AAAA,YACb,CAAC;AAAA,UACF;AAAA,QACD,CAAC;AACD,eAAO,KAAK,IAAI,KAAK;AAAA,UACpB,QAAQ;AAAA,UACR,MAAM,EAAE,UAAqB;AAAA,UAC7B,UAAU,SAAS,GAAG;AACrB,gBAAI,CAAC,EAAE,OAAO,EAAE,SAAS;AACxB,gBAAE,QAAQ,QAAQ,cAAY;AAC7B,mBAAG,oBAAoB,QAAQ;AAAA,cAChC,CAAC;AACD,iBAAG,0BAA0B,EAAE,OAAO;AACtC,iBAAG,2BAA2B;AAC9B,kBAAG,GAAG,IAAI,IAAI;AAAmB,mBAAG,IAAI,QAAQ,mBAAmB;AAAA,YACpE;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF,OAAO;AACN,aAAK,mBAAmB;AAAA,MACzB;AAAA,IACD;AAAA,IAEA,oBAAoB,SAAS,MAAM,4BAA4B;AAC9D,UAAI,KAAK;AACT,UAAI,OAAO,KAAK,UAAU,IAAI;AAC9B,UAAI,CAAE,MAAK,SAAS,KAAK,MAAM,SAAS;AACvC,YAAG;AAA4B,aAAG,2BAA2B;AAC7D;AAAA,MACD;AAEA,aAAO,KAAK,IAAI,KAAK;AAAA,QACpB,QAAQ;AAAA,QACR,MAAM,EAAE,MAAY,KAAK,GAAG,IAAI,IAAI;AAAA,QACpC,UAAU,SAAS,GAAG;AACrB,cAAI,CAAC,EAAE,OAAO,EAAE,SAAS;AACxB,eAAG,0BAA0B,EAAE,OAAO;AACtC,gBAAG;AAAM,iBAAG,iBAAiB,IAAI;AACjC,gBAAG,GAAG,IAAI,IAAI;AAAmB,iBAAG,IAAI,QAAQ,mBAAmB;AAAA,UACpE;AAAA,QACD;AAAA,MACD,CAAC;AAAA,IACF;AAAA,IAEA,WAAW,SAAS,MAAM;AACzB,UAAI,KAAK;AACT,aAAO;AAAA,QACN,SAAS,KAAK,eAAe,IAAI;AAAA,QACjC,YAAY,GAAG,IAAI,IAAI,YAAY,GAAG,IAAI,IAAI;AAAA,QAC9C,gBAAgB,GAAG,IAAI,IAAI;AAAA,QAC3B,kBAAkB,GAAG,IAAI,IAAI;AAAA,QAC7B,aAAa,GAAG,IAAI,IAAI;AAAA,QACxB,YAAY,GAAG,IAAI,IAAI;AAAA,QACvB,kBAAkB,GAAG,IAAI,IAAI;AAAA,QAC7B,YAAY,GAAG,IAAI,IAAI;AAAA,QACvB,mBAAmB,GAAG,IAAI,IAAI;AAAA,QAC9B,cAAc,GAAG,IAAI,IAAI,sBAAsB,GAAG,IAAI,IAAI;AAAA,QAC1D,uBAAuB,GAAG,IAAI,IAAI;AAAA,QAClC,uBAAuB,GAAG,IAAI,IAAI;AAAA,QAClC,WAAW,GAAG,IAAI,IAAI;AAAA,QACtB,oBAAoB,GAAG,IAAI,IAAI,oBAAoB,GAAG,IAAI,IAAI;AAAA,QAC9D,YAAY,GAAG,IAAI,IAAI;AAAA,QACvB,iBAAiB,GAAG,IAAI,IAAI;AAAA,QAC5B,uBAAuB,GAAG,IAAI,IAAI;AAAA,QAClC,WAAW,GAAG,IAAI,IAAI;AAAA,QACtB,QAAQ,GAAG,IAAI,IAAI;AAAA,QACnB,aAAa,KAAK,GAAG,IAAI,IAAI,SAAS;AAAA,QACtC,gBAAgB,QAAQ,CAAC,iBAAiB,kBAAkB,GAAG,GAAG,IAAI,IAAI,OAAO,IAAI,KAAK,GAAG,IAAI,IAAI,YAAY,IAAI;AAAA,QACrH,qBAAqB,GAAG,IAAI,IAAI;AAAA,QAChC,eAAe,GAAG,IAAI,IAAI,WAAW,kBAAkB,GAAG,IAAI,IAAI,cAAc;AAAA,QAChF,eAAe,GAAG,IAAI,IAAI;AAAA,MAC3B;AAAA,IACD;AAAA,IAEA,gBAAgB,SAAS,MAAM;AAC9B,UAAI,YAAY,CAAC;AACjB,UAAI,cAAc,SAAS,GAAG;AAC7B,YAAI,EAAE,WAAW;AAChB,oBAAU,KAAK;AAAA,YACd,WAAW,EAAE;AAAA,YACb,QAAQ,EAAE;AAAA,YACV,iBAAiB,EAAE;AAAA,YACnB,aAAa,EAAE;AAAA,YACf,cAAc,EAAE;AAAA,YAChB,SAAS,EAAE;AAAA,YACX,OAAO,EAAE;AAAA,YACT,aAAa,EAAE;AAAA,YACf,OAAO,EAAE;AAAA,YACT,aAAa,EAAE;AAAA,YACf,cAAc,EAAE;AAAA,YAChB,UAAU,EAAE;AAAA,YACZ,iBAAiB,EAAE;AAAA,YACnB,aAAa,EAAE;AAAA,YACf,aAAa,EAAE;AAAA,YACf,YAAY,EAAE;AAAA,YACd,mBAAmB,EAAE;AAAA,YACrB,qBAAqB,EAAE,qBAAqB;AAAA,UAC7C,CAAC;AAGD,cAAI,QAAQ,CAAC,kBAAkB,oBAAoB,sBAAsB,sBAAuB,yBAAyB,uBAAuB,yBAAwB,uBAAuB,CAAC,GAAG,EAAE,SAAS;AAC7M,sBAAU,GAAG,iBAAiB,EAAE;AAChC,sBAAU,GAAG,2BAA2B,EAAE;AAAA,UAC3C;AAAA,QACD;AAAA,MACD;AAEA,UAAI,MAAM;AACT,oBAAY,IAAI;AAAA,MACjB,OAAO;AACN,UAAE,KAAK,KAAK,IAAI,IAAI,YAAY,CAAC,GAAG,SAAS,GAAG,GAAG;AAClD,sBAAY,CAAC;AAAA,QACd,CAAC;AAAA,MACF;AACA,aAAO;AAAA,IACR;AAAA,IAEA,2BAA2B,SAAS,UAAU;AAC7C,UAAI,KAAK;AACT,UAAI,0BAA0B;AAC9B,UAAI,kBAAkB,CAAC;AAEvB,eAAQ,IAAE,GAAG,IAAE,SAAS,QAAQ,IAAE,GAAG,KAAK;AACzC,YAAI,IAAI,SAAS;AACjB,YAAI,wBAAwB,OAAO,MAAM,UAAU,EAAE,SAAS,EAAE,MAAM,eAAe;AACrF,iBAAQ,KAAK,GAAG;AACf,cAAI,IAAI,EAAE;AACV,cAAI,CAAC,WAAW,MAAM,EAAE,QAAQ,CAAC,MAAI,IAAI;AACxC,gBAAG,KAAG,mBAAmB;AACxB,kBAAG,IAAI,CAAC,KAAK,IAAI,EAAE,eAAe;AAAG,0CAA0B;AAAA,YAChE;AAEA,gBAAI,MAAM,kBAAkB;AAC3B,qBAAO,MAAM,UAAU,EAAE,SAAS,EAAE,MAAM,GAAG,CAAC;AAAA,YAC/C;AAAA,UACD;AAAA,QACD;AAGA,YAAG,CAAC,GAAG,IAAI,IAAI,uBAAuB,yBAAyB,CAAC,EAAE,eAAe;AAChF,aAAG,iBAAiB,OAAO,QAAQ,EAAE,SAAS,EAAE,IAAI,CAAC;AAAA,QACtD,WAAU,CAAC,EAAE,eAAe;AAC3B,aAAG,oBAAoB,OAAO,QAAQ,EAAE,SAAS,EAAE,IAAI,CAAC;AAAA,QACzD;AAEA,YAAI,EAAE,gBAAgB;AACrB,aAAG,uBAAuB,CAAC;AAAA,QAC5B;AAEA,YAAI,EAAE,2BAA2B;AAChC,0BAAgB,EAAE,QAAQ;AAAA,QAC3B;AAAA,MACD;AAEA,SAAG,0BAA0B,eAAe;AAE5C,UAAG,CAAC;AAAyB,WAAG,2BAA2B;AAAA,IAC5D;AAAA,IAEA,2BAA2B,SAAS,MAAM;AACzC,YAAM,KAAK;AACX,YAAM,SAAS,CAAC,uBAAuB,iBAAiB,mBAAmB,MAAM;AAEjF,eAAQ,KAAK,MAAM;AAClB,YAAI,OAAO,KAAK;AAEhB,YAAI,QAAQ,KAAK,2BAA2B;AAC3C,aAAG,IAAI,IAAI,MAAM,QAAQ,OAAK;AAC7B,gBAAI,QAAQ,KAAK,2BAA2B,EAAE,KAAK,cAAc,GAAG;AACnE,uBAAQ,MAAK,MAAM;AAClB,oBAAI,QAAQ,QAAQ,EAAC,KAAK,KAAK,OAAO,MAAK,8BAA8B,WAAW,OAAM,kBAAkB;AAC3G,yBAAO,MAAM,UAAU,EAAE,SAAS,EAAE,MAAM,IAAG,KAAK,GAAE;AAAA,gBACrD;AAAA,cACD;AAAA,YACD;AAAA,UACD,CAAC;AAAA,QACF;AAAA,MACD;AAAA,IACD;AAAA,IAEA,wBAAwB,SAAS,MAAM;AACtC,YAAM,QAAQ,KAAK,IAAI,IAAI,MAAM,OAAO,OAAM,EAAE,YAAa,KAAK,CAAC;AAEnE,YAAM,cAAc,MAAM,IAAI,SAAQ,KAAI,WAAW,IAAI,cAAc;AAEvE,WAAK,eAAe,QAAQ,YAAU;AACrC,YAAI,gBAAgB,CAAC;AACrB,YAAI,CAAC,SAAS,CAAC,QAAQ,aAAc,QAAO,WAAW,OAAO,cAAc,GAAG;AAE9E,0BAAgB,OAAO,MAAM,UAAU,KAAK,IAAI,KAC/C,KAAK,IAAI,IAAI,UAAU,SAAS,OAAO;AAAA,QAEzC,WAAU,OAAO;AAChB,0BAAgB,MAAM,OAAO,OAAM,EAAE,cAAc,OAAO,aACtD,EAAE,kBAAkB,OAAO,aAAc,EAAE;AAAA,QAChD;AAEA,iBAAS,OAAO,QAAQ;AACvB,wBAAc,OAAO,OAAO;AAAA,QAC7B;AAAA,MACD,CAAC;AAGD,WAAK,iBAAiB;AACtB,oBAAc,OAAO;AAAA,IACtB;AAAA,IAEA,kBAAkB,SAAS,MAAM,sBAAsB;AAGtD,UAAI,CAAC,sBAAsB;AAC1B,aAAK,IAAI,UAAU,uBAAuB,EAAE;AAAA,MAC7C;AAEA,UAAI,KAAK;AACT,UAAI,OAAO,KAAK,UAAU,IAAI;AAC9B,UAAI,CAAG,MAAK,SAAS,KAAK,MAAM,UAAW,KAAK,aAAa;AAC5D;AAAA,MACD;AAEA,UAAI,GAAG,uBAAuB;AAAM;AAEpC,SAAG,sBAAsB;AACzB,aAAO,KAAK,IAAI,KAAK;AAAA,QACpB,QAAQ;AAAA,QACR,MAAM,EAAE,KAAW;AAAA,QACnB,UAAU,SAAS,GAAG;AACrB,cAAI,CAAC,EAAE,KAAK;AACX,mBAAO,aAAa;AAAA,cACnB,MAAM,GAAG,IAAI,UAAU,uBAAuB,EAAE,QAAQ,OAAO,mBAAmB;AAAA,cAClF,MAAM,GAAG,IAAI,UAAU,uBAAuB,EAAE,QAAQ,OAAO,mBAAmB;AAAA,cAClF,MAAM;AACL,oBAAG,KAAK,MAAM,QAAQ;AACrB,qBAAG,0BAA0B,EAAE,QAAQ,QAAQ;AAAA,gBAChD;AAAA,cACD;AAAA,cACA,MAAM;AAAE,mBAAG,sBAAsB;AAAA,cAAO;AAAA,YACzC,CAAC;AAAA,UAEF,OAAO;AACN,eAAG,sBAAsB;AAAA,UAC1B;AAAA,QACD;AAAA,MACD,CAAC,EAAE,OAAO,MAAM;AACf,WAAG,sBAAsB;AAAA,MAC1B,CAAC;AAAA,IACF;AAAA,IAEA,qBAAqB,SAAS,MAAM;AACnC,UAAI,KAAK;AACT,YAAM,SAAS;AAAA,QAAC;AAAA,QACf;AAAA,QAAmB;AAAA,QAAyB;AAAA,MAAkB;AAE/D,UAAG,KAAK,kBAAkB;AACzB,YAAI,QAAQ,CAAC;AAEb,WAAG,IAAI,IAAI,MAAM,QAAQ,OAAK;AAC7B,cAAG,EAAE,aAAa,KAAK,oBAAoB,CAAC,EAAE,cAAc;AAC3D,kBAAM,KAAK,CAAC;AAAA,UACb;AAAA,QACD,CAAC;AAED,WAAG,IAAI,IAAI,QAAQ;AACnB,sBAAc,OAAO;AAAA,MACtB,WAAU,KAAK,oBAAoB,KAAK,UAAU;AACjD,cAAM,mBAAmB,KAAK,iBAAiB,MAAM,GAAG;AACxD,WAAG,IAAI,IAAI,MAAM,QAAQ,SAAO;AAC/B,cAAG,iBAAiB,SAAS,IAAI,KAAK,SAAS,GAAG;AACjD,mBAAO,QAAQ,OAAK;AACnB,kBAAI,KAAK;AAAA,YACV,CAAC;AAED,aAAC,iBAAiB,aAAa,EAAE,QAAQ,WAAS;AACjD,kBAAI,IAAI,QAAQ;AACf,oBAAI,SAAS;AAAA,cACd;AAAA,YACD,CAAC;AAAA,UACF;AAAA,QACD,CAAC;AAED,WAAG,wBAAwB;AAAA,MAC5B;AAAA,IACD;AAAA,IAEA,yBAAyB,WAAW;AACnC,UAAI,KAAM;AAEV,WAAK,IAAI,IAAI,MAAM,QAAQ,eAAa;AACvC,WAAG,IAAI,eAAe,QAAQ,mBAC7B,UAAU,SAAS,UAAU,IAAI;AAAA,MACnC,CAAC;AAAA,IACF;AAAA,IAEA,4BAA4B,WAAW;AACtC,UAAI,KAAK;AACT,UAAI,QAAQ;AAEZ,QAAE,KAAK,CAAC,WAAW,UAAU,GAAG,SAAS,GAAG,WAAW;AACtD,YAAG,OAAO,KAAK,UAAU,GAAG,IAAI,IAAI,SAAS,SAAS,KAAK,GAAG,IAAI,IAAI,WAAW,kBAAkB;AAClG,cAAI,CAAC,GAAG,IAAI,IAAI,YAAY;AAC3B,mBAAO,SAAS,GAAG,gBAAgB,IAAI,OACtC,OAAO,KAAK,UAAU,GAAG,IAAI,IAAI,SAAS,WAAW,GAAG,IAAI,IAAI,IAAI,IACpE,OAAO,GAAG,qCAAqC,CAAC;AACjD,oBAAQ;AAAA,UACT;AAAA,QACD;AAAA,MACD,CAAC;AACD,aAAO;AAAA,IACR;AAAA,IAEA,WAAW,WAAW;AACrB,UAAI,KAAK;AAET,cAAQ,MAAM,UAAU,KAAK,IAAI,IAAI,SAAS,KAAK,IAAI,KAAK,SAAS,GAAG;AACvE,YAAG,CAAC,EAAE,KAAK;AACV,aAAG,IAAI,UAAU,SAAS,EAAE,OAAO;AAAA,QACpC;AAAA,MACD,CAAC;AAAA,IACF;AAAA,IAEA,mBAAmB,WAAW;AAC7B,UAAI,KAAK;AACT,UAAG,KAAK,IAAI,IAAI,mBAAmB;AAClC,eAAO,KAAK,IAAI,KAAK;AAAA,UACpB,QAAQ;AAAA,UACR,MAAM;AAAA,YACL,kBAAkB,OAAO,KAAK,aAAa,KAAK,IAAI,IAAI,SAAS,qBAChE,KAAK,IAAI,IAAI,IAAI,EAAE;AAAA,YACpB,eAAe,KAAK,IAAI,IAAI;AAAA,UAC7B;AAAA,UACA,UAAU,SAAS,GAAG;AACrB,gBAAG,CAAC,EAAE,KAAK;AACV,kBAAG,GAAG,IAAI,IAAI,iBAAiB,GAAG,IAAI,IAAI,OAAO;AAChD,yBAAS,OAAO,EAAE,SAAS;AAC1B,qBAAG,IAAI,UAAU,SAAS,GAAG;AAAA,gBAC9B;AAEA,8BAAc,OAAO;AAAA,cACtB,OAAO;AACN,mBAAG,IAAI,UAAU,SAAS,EAAE,OAAO;AACnC,mBAAG,2BAA2B;AAAA,cAC/B;AAAA,YACD;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,cAAc,WAAW;AACxB,UAAI,KAAK;AACT,UAAG,GAAG,IAAI;AAAwB;AAElC,aAAO,aAAa;AAAA,QACnB,MAAM,KAAK,oBAAoB;AAAA,QAC/B,MAAM,QAAQ,MAAM,UAAU,KAAK,KAAK,cAAc;AAAA,MACvD,CAAC;AAAA,IACF;AAAA,IAEA,qBAAqB,WAAW;AAC/B,UAAI,KAAK;AACT,UAAI,aAAa,CAAC;AAClB,UAAI,aAAa,CAAC;AAClB,UAAI,qBAAqB,CAAC;AAE1B,QAAE,KAAK,KAAK,IAAI,IAAI,SAAS,CAAC,GAAG,SAAS,GAAG,MAAM;AAClD,YAAI,KAAK,WAAW;AAEnB,qBAAW,KAAK,CAAC,KAAK,WAAW,KAAK,IAAI,CAAC;AAC3C,qBAAW,KAAK,QAAQ,KAAK;AAC7B,6BAAmB,KAAK,QAAQ,KAAK;AAAA,QACtC;AAAA,MACD,CAAC;AAED,UAAI,WAAW,QAAQ;AACtB,eAAO,KAAK,IAAI,KAAK;AAAA,UACpB,QAAQ;AAAA,UACR,MAAM;AAAA,YACL,SAAS,GAAG,IAAI,IAAI;AAAA,YACpB,cAAc,KAAK,GAAG,IAAI,IAAI,YAAY;AAAA,YAC1C;AAAA,YACA;AAAA,YACA;AAAA,UACD;AAAA,UACA,UAAU,SAAS,GAAG;AACrB,gBAAI,CAAC,EAAE,KAAK;AACX,gBAAE,KAAK,GAAG,IAAI,IAAI,SAAS,CAAC,GAAG,SAAS,GAAG,MAAM;AAChD,oBAAI,KAAK,QAAQ,EAAE,QAAQ,eAAe,KAAK,IAAI,KAAK,EAAE,QAAQ,KAAK,MAAM,mBAAmB;AAC/F,uBAAK,oBAAoB,EAAE,QAAQ,KAAK,MAAM;AAC9C,uBAAK,gBAAgB,EAAE,QAAQ,KAAK,MAAM;AAC1C,qBAAG,iCAAiC,KAAK,aAAa;AAAA,gBACvD;AAAA,cACD,CAAC;AAAA,YACF;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,mBAAmB,SAAS,KAAK,KAAK,KAAK;AAC1C,UAAI,KAAK;AACT,UAAG,GAAG,IAAI;AAAwB;AAElC,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAElC,UAAG,KAAK,mBAAmB;AAC1B,eAAO,KAAK,IAAI,KAAK;AAAA,UACpB,QAAQ;AAAA,UACR,MAAM;AAAA,YACL,SAAS,GAAG,IAAI,IAAI;AAAA,YACpB,mBAAmB,KAAK;AAAA,YACxB,SAAS;AAAA,UACV;AAAA,UACA,UAAU,SAAS,GAAG;AACrB,gBAAG,CAAC,EAAE,KAAK;AACV,mBAAK,gBAAgB,EAAE;AACvB,iBAAG,2BAA2B;AAAA,YAC/B;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF,OAAO;AACN,aAAK,gBAAgB;AACrB,WAAG,2BAA2B;AAAA,MAC/B;AAAA,IACD;AAAA,IAIA,cAAc,WAAW;AAExB,UAAG,KAAK,IAAI,IAAI,gBAAgB,KAAK,IAAI,IAAI,WAAW;AACvD,eAAO,SAAS,GAAG,mCAAmC,CAAC;AACvD,aAAK,IAAI,UAAU,gBAAgB,CAAC;AACpC;AAAA,MACD;AAEA,UAAG,KAAK,IAAI,IAAI,cAAc;AAC7B,YAAG,CAAC,KAAK,IAAI,IAAI,cAAc;AAC9B,eAAK,IAAI,UAAU,gBAAgB,KAAK,IAAI,IAAI,IAAI;AAAA,QACrD;AAEA,YAAI,cAAc,KAAK,IAAI,IAAI,SAAO,kBACnC,OAAO,UAAU,eAAe,EAAE,QAClC,KAAK,IAAI,IAAI;AAEhB,aAAK,IAAI,IAAI,6BAA6B,EAAE,IAAI;AAAA,UAAC,KAAK,WAAW;AAAA,UAChE,KAAK,KAAK,IAAI,IAAI,aAAa;AAAA,QAAC,GAAG,SAAS,GAAG;AAAE,iBAAO,KAAK;AAAA,QAAM,CAAC,EAAE,KAAK,IAAI;AAChF,aAAK,IAAI,IAAI,yBAAyB,OAAO,SAAS,WAAW,KAAK,IAAI,IAAI,YAAY,EAAE,QAAQ;AAAA,MACrG;AAEA,mBAAa,CAAC,8BAA8B,wBAAwB,CAAC;AAAA,IACtE;AAAA,IAEA,WAAW,WAAW;AAErB,UAAG,KAAK,IAAI,IAAI,WAAW;AAC1B,YAAI,qBAAqB;AAAA,UAAC,WAAW;AAAA,UAAG,aAAa;AAAA,UAAG,eAAe;AAAA,UACtE,UAAU;AAAA,QAAE;AAEb,YAAI,SAAS,mBAAmB,KAAK,IAAI,IAAI;AAC7C,YAAG,QAAQ;AACV,cAAI,UAAU,OAAO,SAAS,WAAW,KAAK,IAAI,IAAI,WACrD,MAAM;AACP,eAAK,IAAI,IAAI,UAAU,OAAO,SAAS,SAAS,SAAS,EAAE;AAC3D,wBAAc,SAAS;AAAA,QACxB;AAAA,MACD;AAAA,IACD;AAAA,IAEA,kBAAkB,SAAS,MAAM;AAChC,UAAI,CAAC,eAAe,aAAY,kBAAkB,EAAE,SAAS,KAAK,IAAI,IAAI,OAAO,KAAK,KAAK,gBAAgB;AAC1G,YAAI,OAAO,IAAI,KAAK,IAAI,IAAI,IAAI,KAAK,IAAI,IAAI,mBAAmB,CAAC;AACjE,aAAK,eAAe,IAAM,QAAO,KAAK,kBAAkB,KAAK,WAAY,UAAU,UAAU,IAAI,CAAC;AAAA,MACnG;AAAA,IACD;AAAA,IAEA,qBAAqB,WAAW;AAG/B;AAAA,IAID;AAAA,IAEA,cAAc,WAAW;AACxB,UAAG,CAAC,KAAK,IAAI,WAAW;AACvB,eAAO,KAAK,IAAI,KAAK;AAAA,UACpB,QAAQ;AAAA,UACR,KAAK,KAAK,IAAI;AAAA,UACd,UAAU,SAAS,GAAG,IAAI;AACzB,0BAAc,UAAU;AAAA,UACzB;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,oBAAoB,WAAW;AAC9B,aAAO,OAAO,KAAK;AAAA,QAClB,QAAQ,QAAQ,QAAQ,uBAAuB;AAAA,QAC/C,MAAM;AAAA,UACL,MAAM,QAAQ,IAAI;AAAA,UAClB,MAAM,QAAQ,IAAI;AAAA,QACnB;AAAA,QACA,UAAU,SAAS,GAAG;AACrB,cAAI,UAAU,OAAO,MAAM,KAAK,EAAE,OAAO;AACzC,iBAAO,UAAU,QAAQ,QAAQ,GAAG,SAAS,QAAQ,GAAG,IAAI;AAAA,QAE7D;AAAA,MACD,CAAC;AAAA,IACF;AAAA,IAEA,yBAAyB,WAAY;AACpC,UAAI,OAAO,CAAC;AACZ,YAAM,SAAS;AAAA,QACd;AAAA,UACC,OAAO;AAAA,UACP,WAAW;AAAA,UACX,WAAW;AAAA,UACX,iBAAiB;AAAA,UACjB,eAAe;AAAA,UACf;AAAA,UACA,UAAU,MAAM;AACf,mBAAO;AAAA,UACR;AAAA,UACA,QAAQ;AAAA,YACP;AAAA,cACC,WAAW;AAAA,cACX,WAAW;AAAA,cACX,QAAQ;AAAA,YACT;AAAA,YACA;AAAA,cACC,WAAW;AAAA,cACX,WAAW;AAAA,cACX,OAAO,GAAG,WAAW;AAAA,cACrB,cAAc;AAAA,YACf;AAAA,YACA;AAAA,cACC,WAAW;AAAA,cACX,WAAW;AAAA,cACX,OAAO,GAAG,WAAW;AAAA,cACrB,cAAc;AAAA,YACf;AAAA,YACA;AAAA,cACC,WAAW;AAAA,cACX,WAAW;AAAA,cACX,OAAO,GAAG,mBAAmB;AAAA,cAC7B,cAAc;AAAA,cACd,WAAW;AAAA,YACZ;AAAA,YACA;AAAA,cACC,WAAW;AAAA,cACX,WAAW;AAAA,cACX,OAAO,GAAG,aAAa;AAAA,cACvB,MAAM;AAAA,cACN,cAAc;AAAA,YACf;AAAA,YACA;AAAA,cACC,WAAW;AAAA,cACX,WAAW;AAAA,cACX,OAAO,GAAG,aAAa;AAAA,cACvB,QAAQ;AAAA,YACT;AAAA,YACA;AAAA,cACC,WAAW;AAAA,cACX,WAAW;AAAA,cACX,OAAO,GAAG,WAAW;AAAA,cACrB,QAAQ;AAAA,YACT;AAAA,YACA;AAAA,cACC,WAAW;AAAA,cACX,WAAW;AAAA,cACX,OAAO,GAAG,UAAU;AAAA,cACpB,QAAQ;AAAA,YACT;AAAA,UACD;AAAA,QACD;AAAA,MACD;AAEA,YAAM,KAAK;AACX,YAAM,SAAS,IAAI,OAAO,GAAG,OAAO;AAAA,QACnC,OAAO,GAAG,qCAAqC;AAAA,QAC/C;AAAA,QACA,gBAAgB,WAAY;AAC3B,gBAAM,QAAO,OAAO,WAAW;AAC/B,iBAAO,KAAK;AAAA,YACX,QAAQ;AAAA,YACR,MAAM;AAAA,cACL,SAAS,GAAG,IAAI,IAAI;AAAA,cACpB,SAAS,GAAG,IAAI,IAAI;AAAA,cACpB,OAAO,MAAK;AAAA,YACb;AAAA,YACA,QAAQ;AAAA,YACR,UAAU,SAAU,GAAG;AACtB,kBAAI,EAAE,QAAQ,SAAS,GAAG;AACzB,oBAAI,EAAE,QAAQ,WAAW,GAAG;AAC3B,yBAAO,UAAU,QAAQ,sBAAsB,EAAE,QAAQ,EAAE;AAAA,gBAC5D,OAAO;AACN,yBAAO,gBAAgB;AAAA,oBACtB,kBAAkB,GAAG,IAAI,IAAI;AAAA,oBAC7B,kBAAkB,GAAG,IAAI,IAAI;AAAA,kBAC9B;AACA,yBAAO,UAAU,QAAQ,oBAAoB;AAAA,gBAC9C;AAAA,cACD;AACA,qBAAO,KAAK;AAAA,YACb;AAAA,UACD,CAAC;AAAA,QACF;AAAA,QACA,sBAAsB,GAAG,QAAQ;AAAA,MAClC,CAAC;AAED,WAAK,IAAI,IAAI,MAAM,QAAQ,UAAQ;AAClC,YAAI,CAAC,KAAK,oBAAoB;AAC7B,cAAI,eAAe,OAAO,YAAY;AACtC,uBAAa,GAAG,KAAK,KAAK;AAAA,YACzB,WAAW,KAAK;AAAA,YAChB,aAAa,KAAK;AAAA,YAClB,aAAa,KAAK;AAAA,YAClB,OAAO,KAAK;AAAA,YACZ,eAAe,KAAK;AAAA,YACpB,aAAa,KAAK;AAAA,YAClB,YAAY,KAAK;AAAA,UAClB,CAAC;AACD,uBAAa,KAAK,QAAQ;AAAA,QAC3B;AAAA,MACD,CAAC;AAED,aAAO,OAAO,YAAY,MAAM,GAAG;AACnC,UAAI,CAAC,KAAK,QAAQ;AACjB,eAAO,SAAS,GAAG,sEAAsE,CAAC;AAAA,MAC3F,OAAO;AACN,eAAO,KAAK;AAAA,MACb;AAAA,IACD;AAAA,IAEA,wBAAwB,WAAU;AACjC,UAAI,SAAS;AACb,UAAG,QAAQ,IAAI,YAAY,QAAQ,IAAI,SAAS,gCAA+B;AAC9E,YAAG,QAAQ,CAAC,iBAAiB,kBAAkB,GAAI,QAAQ,IAAI,OAAO,GAAE;AACvE,mBAAS;AAAA,QACV,OAAM;AACL,mBAAQ;AAAA,QACT;AAAA,MACD;AAEA,aAAO;AAAA,IACR;AAAA,IAEA,qBAAqB,SAAS,KAAK,KAAK,KAAK;AAG5C,UAAI,KAAK;AACT,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAElC,UAAG,CAAC,KAAK,WAAW;AACnB,eAAO,MAAM,GAAG,wCAAwC,CAAC;AAAA,MAC1D,WAAW,IAAI,WAAW,sBACxB,IAAI,WAAW,sBAAsB,IAAI,cAAe;AACzD,eAAO;AAAA,UACN,SAAS,EAAC,QAAQ,KAAK,UAAS;AAAA,QACjC;AAAA,MACD,OAAO;AACN,YAAI,UAAU;AAAA,UACb,aAAa,KAAK;AAAA,UAClB,gBAAgB,GAAG,IAAI,IAAI,gBAAgB,OAAO,SAAS,QAAQ;AAAA,QACpE;AAEA,YAAI,IAAI,WAAW;AAClB,kBAAQ,eAAe;AAAA,QACxB;AAEA,YAAI,KAAK;AAAW,kBAAQ,eAAe,KAAK;AAEhD,eAAO;AAAA,UACN,OAAQ;AAAA,UACR;AAAA,QACD;AAAA,MACD;AAAA,IACD;AAAA,IAEA,iCAAiC,SAAS,KAAK,KAAK,KAAK;AACxD,UAAI,OAAO,OAAO,QAAQ,KAAK,GAAG;AAClC,UAAG,CAAC,KAAK,WAAW;AACnB,eAAO,IAAI,UAAU,EAAC,SAAS,EAAC,SAAS,IAAI,QAAO,EAAC,IAAI,CAAC;AAAA,MAC3D,OAAO;AACN,YAAI,UAAU;AAAA,UACb,aAAa,KAAK;AAAA,UAClB,cAAc,CAAC,MAAM,IAAI,oBAAoB,IAAI,aAAa,IAAI,YAAY;AAAA,UAC9E,cAAc,KAAK;AAAA,QACpB;AAEA,YAAI,IAAI;AACP,kBAAQ,kBAAkB,IAAI;AAC/B,YAAI,IAAI;AACP,kBAAQ,aAAa,IAAI;AAC1B,eAAO;AAAA,UACN,OAAO;AAAA,UACP;AAAA,QACD;AAAA,MACD;AAAA,IACD;AAAA,IAEA,wBAAwB,WAAW;AAClC,UAAI,KAAK;AACT,YAAM,MAAM,KAAK,IAAI;AACrB,UAAG,IAAI,0BAA0B,IAAI,YAAY,iBAAiB;AACjE,YAAI,eAAe,IAAI,gBAAgB,IAAI;AAC3C,eAAO,KAAK;AAAA,UACX,QAAQ;AAAA,UACR,MAAM;AAAA,YACL,gBAAgB,IAAI;AAAA,YACpB;AAAA,YACA,aAAa,IAAI,iBAAiB,IAAI;AAAA,YACtC,kBAAkB,IAAI,sBAAsB,IAAI;AAAA,YAChD,WAAW,IAAI;AAAA,UAChB;AAAA,UACA,UAAU,SAAS,GAAG;AACrB,gBAAG,EAAE,WAAW,CAAC,EAAE,KAAK;AACvB,iBAAG,IAAI,UAAU,oBAAoB,EAAE,OAAO;AAC9C,oBAAM,mBAAmB,GAAG,qBAAqB;AACjD,iBAAG,oCAAoC,gBAAgB;AAAA,YACxD;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,cAAc,SAAS,KAAK,KAAK,KAAK;AACrC,YAAM,KAAK;AACX,UAAI,MAAM,OAAO,KAAK;AACtB,UAAG,IAAI,cAAc;AACpB,eAAO,KAAK;AAAA,UACX,QAAQ;AAAA,UACR,MAAM;AAAA,YACL,MAAM,IAAI;AAAA,YACV,WAAW,KAAK,IAAI,IAAI;AAAA,YACxB,cAAc,KAAK,IAAI,IAAI,gBAAgB,KAAK,IAAI,IAAI;AAAA,YACxD,aAAa,KAAK,IAAI,IAAI,iBAAiB,KAAK,IAAI,IAAI;AAAA,YACxD,kBAAkB,KAAK,IAAI,IAAI,sBAAsB,KAAK,IAAI,IAAI;AAAA,UACnE;AAAA,UACA,UAAU,SAAS,GAAG;AACrB,gBAAG,EAAE,WAAW,CAAC,EAAE,KAAK;AACvB,uBAAS,KAAK,EAAE,SAAS;AACxB,uBAAO,MAAM,UAAU,KAAK,KAAK,GAAG,EAAE,QAAQ,EAAE;AAChD,sBAAM,mBAAmB,GAAG,qBAAqB;AACjD,mBAAG,oCAAoC,gBAAgB;AAAA,cACxD;AAAA,YACD;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,uBAAuB,SAAS,KAAK,KAAK,KAAK;AAC9C,UAAI,OAAO,OAAO,KAAK;AACvB,UAAG,CAAC,KAAK,uBAAuB;AAC/B,eAAO,MAAM,UAAU,KAAK,IAAI,UAAU,SAAS,KAAK,MAAM,iBAAiB,IAAI;AACnF,eAAO,MAAM,UAAU,KAAK,IAAI,UAAU,SAAS,KAAK,MAAM,sBAAsB,CAAI;AAAA,MACzF;AAAA,IACD;AAAA,IAEA,eAAe,SAAS,KAAK,KAAK,KAAK;AACtC,UAAI,KAAK;AACT,UAAI,OAAO,OAAO,KAAK;AACvB,UAAI,KAAK,iBAAkB,MAAK,cAAY,iBAAiB,KAAK,cAAY,mBAAmB;AAChG,eAAO,KAAK;AAAA,UACX,QAAQ;AAAA,UACR,MAAM;AAAA,YACL,MAAK;AAAA,cACJ,WAAW,KAAK;AAAA,cAChB,UAAU,IAAI;AAAA,cACd,UAAU,IAAI;AAAA,cACd,SAAS,IAAI;AAAA,cACb,kBAAkB,IAAI;AAAA,cACtB,eAAe,KAAK;AAAA,YACrB;AAAA,UACD;AAAA,UACA,UAAU,SAAS,GAAG;AACrB,gBAAI,CAAC,EAAE,SAAS;AACf,qBAAO,MAAM,GAAG,0DAA0D,CAAC;AAAA,YAC5E,OAAO;AACN,qBAAO,aAAa;AAAA,gBACnB,MAAM,OAAO,MAAM,UAAU,KAAK,KAAK,sBAAsB,EAAE,QAAQ,kBAAkB;AAAA,gBACzF,MAAM,GAAG,IAAI,eAAe,QAAQ,mBAAmB,KAAK,GAAG;AAAA,cAChE,CAAC;AAAA,YACF;AAAA,UACD;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,uBAAuB,WAAW;AACjC,WAAK,mBAAmB,KAAK,IAAI,IAAI,gBAAgB,qBAAqB,KAAK,IAAI,IAAI,qBAAqB;AAAA,IAC7G;AAAA,IAEA,eAAe,WAAW;AACzB,WAAK,mBAAmB,KAAK,IAAI,IAAI,OAAO,aAAa,KAAK,IAAI,IAAI,aAAa;AAAA,IACpF;AAAA,IAEA,sBAAsB,WAAW;AAChC,WAAK,mBAAmB,KAAK,IAAI,IAAI,OAAO,oBAAoB,KAAK,IAAI,IAAI,oBAAoB;AAAA,IAClG;AAAA,IAEA,oBAAoB,WAAW;AAC9B,WAAK,mBAAmB,KAAK,IAAI,IAAI,OAAO,kBAAkB,KAAK,IAAI,IAAI,kBAAkB;AAAA,IAC9F;AAAA,IAEA,oBAAqB,SAAU,aAAa,iBAAiB,WAAW;AACvE,UAAI,aAAa,eAAe,YAAY,QAAQ;AACnD,YAAI,UAAU,YAAY,GAAG;AAC7B,UAAE,KAAK,eAAe,CAAC,GAAG,SAAS,GAAG,MAAM;AAC3C,iBAAO,MAAM,UAAU,SAAS,KAAK,MAAM,iBAAiB,SAAS;AAAA,QACtE,CAAC;AAAA,MACF;AAAA,IACD;AAAA,IAEA,aAAa,WAAW;AACvB,UAAI,KAAK;AACT,aAAO,aAAa;AAAA,QACnB,MAAM,KAAK,IAAI,IAAI,sBAAoB;AAAA,QACvC,MAAM,GAAG,oBAAoB;AAAA,QAC7B,MAAM,KAAK,IAAI,IAAI,sBAAoB;AAAA,QACvC,MAAM,GAAG,mBAAmB;AAAA,MAC7B,CAAC;AAAA,IACF;AAAA,EACD,CAAC;AAED,UAAQ,6BAA6B,SAAU,KAAK,GAAG,UAAU,UAAU,aAAa;AACvF,QAAI,WAAW,iBAAiB;AAChC,QAAI,IAAI,IAAI,WAAW;AACtB,UAAI,CAAC,oBAAoB,kBAAkB,EAAE,SAAS,IAAI,IAAI,OAAO,GAAG;AACvE,yBAAiB;AACjB,oBAAY,EAAE;AAAA,MACf,WAAW,CAAC,iBAAiB,eAAe,EAAE,SAAS,IAAI,IAAI,OAAO,GAAG;AACxE,0BAAkB;AAAA,MACnB;AAAA,IACD,OAAO;AACN,UAAI,IAAI,IAAI,WAAW,eAAe;AACrC,YAAI,IAAI,IAAI,WAAW,oBAAoB;AAC1C,4BAAkB;AAAA,QACnB,OAAO;AACN,2BAAiB;AACjB,sBAAY,EAAE;AAAA,QACf;AAAA,MACD,OAAO;AACN,yBAAiB;AACjB,oBAAY,EAAE;AAAA,MACf;AAAA,IACD;AAEA,QAAI,CAAC,WAAW;AACf,UAAI,iBAAiB;AACpB,oBAAY,CAAC,QAAQ,EAAE;AAAA,MACxB,WAAW,gBAAgB;AAC1B,oBAAY,CAAC,MAAM,EAAE;AAAA,MACtB;AAAA,IACD;AAEA,WAAO,QAAQ,uDAAuD,WAAW;AAChF,UAAI,QAAQ,sBAAsB;AAAA,QACjC;AAAA,QACA,MAAM;AAAA,QACN,mBAAmB;AAAA,UAClB,MAAM;AAAA,UACN,MAAM;AAAA,QACP;AAAA,QACA;AAAA,QACA;AAAA,MACD,GAAG,WAAW;AAAA,IACf,CAAC;AAAA,EACF;AAEA,UAAQ,qBAAqB,CAAC,KAAK,UAAQ,SAAS;AACnD,QAAI,CAAC,IAAI,IAAI,SAAS;AACrB,aAAO,MAAM,EAAC,SAAS,GAAG,gCAAgC,GAAG,OAAO,GAAG,WAAW,EAAC,CAAC;AAAA,IACrF;AACA,QAAI,CAAC,IAAI,IAAI,MAAM;AAAQ;AAE3B,WAAO,KAAK;AAAA,MACX,QAAQ;AAAA,MACR,MAAM;AAAA,QACL,SAAS,IAAI;AAAA,QACb,OAAO,IAAI,IAAI;AAAA,QACf,SAAS,IAAI,IAAI;AAAA,QACjB,MAAM;AAAA,QACN;AAAA,MACD;AAAA,MACA,UAAU,CAAC,WAAW;AACrB,YAAI,CAAC,OAAO,OAAO,OAAO,SAAS;AAClC,cAAI,YAAY,OAAO;AAEvB,cAAI,QAAS,OAAO;AACpB,gBAAM,QAAQ,CAAC,QAAQ;AACtB,mBAAO,IAAI;AACX,gBAAI,QAAQ,IAAI,UAAU,OAAO;AACjC,mBAAO,OAAO,OAAO,GAAG;AACxB,gBAAI,eAAe,QAAQ,OAAO,MAAM,SAAS,MAAM,IAAI;AAAA,UAC5D,CAAC;AACD,cAAI,UAAU,OAAO,EAAE,KAAK,QAAQ;AAAA,QACrC;AAAA,MACD;AAAA,IACD,CAAC;AAAA,EACF;",
  "names": []
}
