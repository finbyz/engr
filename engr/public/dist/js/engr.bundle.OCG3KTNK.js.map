{
  "version": 3,
  "sources": ["../../../../../apps/engr/engr/public/js/taxes_and_totals.js", "../../../../../apps/engr/engr/public/js/transaction.js", "../../../../../apps/engr/engr/public/js/doctype_js/sales_invoice.js"],
  "sourcesContent": ["// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nerpnext.taxes_and_totals = class TaxesAndTotals extends erpnext.payments {\n\tsetup() {\n\t\tthis.fetch_round_off_accounts();\n\t}\n\n\tapply_pricing_rule_on_item(item) {\n\t\tlet effective_item_rate = item.price_list_rate;\n\t\tlet item_rate = item.rate;\n\t\tif (in_list([\"Sales Order\", \"Quotation\"], item.parenttype) && item.blanket_order_rate) {\n\t\t\teffective_item_rate = item.blanket_order_rate;\n\t\t}\n\t\tif (item.margin_type == \"Percentage\") {\n\t\t\titem.rate_with_margin = flt(effective_item_rate)\n\t\t\t\t+ flt(effective_item_rate) * ( flt(item.margin_rate_or_amount) / 100);\n\t\t} else {\n\t\t\titem.rate_with_margin = flt(effective_item_rate) + flt(item.margin_rate_or_amount);\n\t\t}\n\t\titem.base_rate_with_margin = flt(item.rate_with_margin) * flt(this.frm.doc.conversion_rate);\n\n\t\titem_rate = flt(item.rate_with_margin , precision(\"rate\", item));\n\n\t\tif (item.discount_percentage) {\n\t\t\titem.discount_amount = flt(item.rate_with_margin) * flt(item.discount_percentage) / 100;\n\t\t}\n\n\t\tif (item.discount_amount) {\n\t\t\titem_rate = flt((item.rate_with_margin) - (item.discount_amount), precision('rate', item));\n\t\t\titem.discount_percentage = 100 * flt(item.discount_amount) / flt(item.rate_with_margin);\n\t\t}\n\n\t\tfrappe.model.set_value(item.doctype, item.name, \"rate\", item_rate);\n\t}\n\n\tcalculate_taxes_and_totals(update_paid_amount) {\n\t\tthis.discount_amount_applied = false;\n\t\tthis._calculate_taxes_and_totals();\n\t\tthis.calculate_discount_amount();\n\n\t\t// Advance calculation applicable to Sales /Purchase Invoice\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\", \"Purchase Invoice\"], this.frm.doc.doctype)\n\t\t\t&& this.frm.doc.docstatus < 2 && !this.frm.doc.is_return) {\n\t\t\tthis.calculate_total_advance(update_paid_amount);\n\t\t}\n\n\t\tif (in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype) && this.frm.doc.is_pos &&\n\t\t\tthis.frm.doc.is_return) {\n\t\t\tthis.update_paid_amount_for_return();\n\t\t}\n\n\t\t// Sales person's commission\n\t\tif(in_list([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\",\"Proforma Invoice\"], this.frm.doc.doctype)) {\n\t\t\tthis.calculate_commission();\n\t\t\tthis.calculate_contribution();\n\t\t}\n\n\t\t// Update paid amount on return/debit note creation\n\t\tif(this.frm.doc.doctype === \"Purchase Invoice\" && this.frm.doc.is_return\n\t\t\t&& (this.frm.doc.grand_total > this.frm.doc.paid_amount)) {\n\t\t\tthis.frm.doc.paid_amount = flt(this.frm.doc.grand_total, precision(\"grand_total\"));\n\t\t}\n\n\t\tthis.frm.refresh_fields();\n\t}\n\n\tcalculate_discount_amount () {\n\t\tif (frappe.meta.get_docfield(this.frm.doc.doctype, \"discount_amount\")) {\n\t\t\tthis.calculate_item_values();\n\t\t\tthis.calculate_net_total();\n\t\t\tthis.set_discount_amount();\n\t\t\tthis.apply_discount_amount();\n\t\t}\n\t}\n\n\t_calculate_taxes_and_totals() {\n\t\tthis.validate_conversion_rate();\n\t\tthis.calculate_item_values();\n\t\tthis.initialize_taxes();\n\t\tthis.determine_exclusive_rate();\n\t\tthis.calculate_net_total();\n\t\tthis.calculate_taxes();\n\t\tthis.manipulate_grand_total_for_inclusive_tax();\n\t\tthis.calculate_totals();\n\t\tthis._cleanup();\n\t}\n\n\tvalidate_conversion_rate() {\n\t\tthis.frm.doc.conversion_rate = flt(this.frm.doc.conversion_rate, (cur_frm) ? precision(\"conversion_rate\") : 9);\n\t\tvar conversion_rate_label = frappe.meta.get_label(this.frm.doc.doctype, \"conversion_rate\",\n\t\t\tthis.frm.doc.name);\n\t\tvar company_currency = this.get_company_currency();\n\n\t\tif(!this.frm.doc.conversion_rate) {\n\t\t\tif(this.frm.doc.currency == company_currency) {\n\t\t\t\tthis.frm.set_value(\"conversion_rate\", 1);\n\t\t\t} else {\n\t\t\t\tconst subs =  [conversion_rate_label, this.frm.doc.currency, company_currency];\n\t\t\t\tconst err_message = __('{0} is mandatory. Maybe Currency Exchange record is not created for {1} to {2}', subs);\n\t\t\t\tfrappe.throw(err_message);\n\t\t\t}\n\t\t}\n\t}\n\n\tcalculate_item_values() {\n\t\tlet me = this;\n\t\tif (!this.discount_amount_applied) {\n\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\t\tfrappe.model.round_floats_in(item);\n\t\t\t\titem.net_rate = item.rate;\n\n\t\t\t\tif ((!item.qty) && me.frm.doc.is_return) {\n\t\t\t\t\titem.amount = flt(item.rate * -1, precision(\"amount\", item));\n\t\t\t\t} else {\n\t\t\t\t\titem.amount = flt(item.rate * item.qty, precision(\"amount\", item));\n\t\t\t\t}\n\n\t\t\t\titem.net_amount = item.amount;\n\t\t\t\titem.item_tax_amount = 0.0;\n\t\t\t\titem.total_weight = flt(item.weight_per_unit * item.stock_qty);\n\n\t\t\t\tme.set_in_company_currency(item, [\"price_list_rate\", \"rate\", \"amount\", \"net_rate\", \"net_amount\"]);\n\t\t\t});\n\t\t}\n\t}\n\n\tset_in_company_currency(doc, fields) {\n\t\tvar me = this;\n\t\t$.each(fields, function(i, f) {\n\t\t\tdoc[\"base_\"+f] = flt(flt(doc[f], precision(f, doc)) * me.frm.doc.conversion_rate, precision(\"base_\" + f, doc));\n\t\t});\n\t}\n\n\tinitialize_taxes() {\n\t\tvar me = this;\n\n\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\ttax.item_wise_tax_detail = {};\n\t\t\tvar tax_fields = [\"total\", \"tax_amount_after_discount_amount\",\n\t\t\t\t\"tax_amount_for_current_item\", \"grand_total_for_current_item\",\n\t\t\t\t\"tax_fraction_for_current_item\", \"grand_total_fraction_for_current_item\"];\n\n\t\t\tif (cstr(tax.charge_type) != \"Actual\" &&\n\t\t\t\t!(me.discount_amount_applied && me.frm.doc.apply_discount_on==\"Grand Total\")) {\n\t\t\t\ttax_fields.push(\"tax_amount\");\n\t\t\t}\n\n\t\t\t$.each(tax_fields, function(i, fieldname) { tax[fieldname] = 0.0; });\n\n\t\t\tif (!this.discount_amount_applied && cur_frm) {\n\t\t\t\tcur_frm.cscript.validate_taxes_and_charges(tax.doctype, tax.name);\n\t\t\t\tme.validate_inclusive_tax(tax);\n\t\t\t}\n\t\t\tfrappe.model.round_floats_in(tax);\n\t\t});\n\t}\n\n\tfetch_round_off_accounts() {\n\t\tlet me = this;\n\t\tfrappe.flags.round_off_applicable_accounts = [];\n\n\t\tif (me.frm.doc.company) {\n\t\t\treturn frappe.call({\n\t\t\t\t\"method\": \"erpnext.controllers.taxes_and_totals.get_round_off_applicable_accounts\",\n\t\t\t\t\"args\": {\n\t\t\t\t\t\"company\": me.frm.doc.company,\n\t\t\t\t\t\"account_list\": frappe.flags.round_off_applicable_accounts\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tfrappe.flags.round_off_applicable_accounts.push(...r.message);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tdetermine_exclusive_rate() {\n\t\tvar me = this;\n\n\t\tvar has_inclusive_tax = false;\n\t\t$.each(me.frm.doc[\"taxes\"] || [], function(i, row) {\n\t\t\tif(cint(row.included_in_print_rate)) has_inclusive_tax = true;\n\t\t});\n\t\tif(has_inclusive_tax==false) return;\n\n\t\t$.each(me.frm.doc[\"items\"] || [], function(n, item) {\n\t\t\tvar item_tax_map = me._load_item_tax_rate(item.item_tax_rate);\n\t\t\tvar cumulated_tax_fraction = 0.0;\n\t\t\tvar total_inclusive_tax_amount_per_qty = 0;\n\t\t\t$.each(me.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\tvar current_tax_fraction = me.get_current_tax_fraction(tax, item_tax_map);\n\t\t\t\ttax.tax_fraction_for_current_item = current_tax_fraction[0];\n\t\t\t\tvar inclusive_tax_amount_per_qty = current_tax_fraction[1];\n\n\t\t\t\tif(i==0) {\n\t\t\t\t\ttax.grand_total_fraction_for_current_item = 1 + tax.tax_fraction_for_current_item;\n\t\t\t\t} else {\n\t\t\t\t\ttax.grand_total_fraction_for_current_item =\n\t\t\t\t\t\tme.frm.doc[\"taxes\"][i-1].grand_total_fraction_for_current_item +\n\t\t\t\t\t\ttax.tax_fraction_for_current_item;\n\t\t\t\t}\n\n\t\t\t\tcumulated_tax_fraction += tax.tax_fraction_for_current_item;\n\t\t\t\ttotal_inclusive_tax_amount_per_qty += inclusive_tax_amount_per_qty * flt(item.qty);\n\t\t\t});\n\n\t\t\tif(!me.discount_amount_applied && item.qty && (total_inclusive_tax_amount_per_qty || cumulated_tax_fraction)) {\n\t\t\t\tvar amount = flt(item.amount) - total_inclusive_tax_amount_per_qty;\n\t\t\t\titem.net_amount = flt(amount / (1 + cumulated_tax_fraction));\n\t\t\t\titem.net_rate = item.qty ? flt(item.net_amount / item.qty, precision(\"net_rate\", item)) : 0;\n\n\t\t\t\tme.set_in_company_currency(item, [\"net_rate\", \"net_amount\"]);\n\t\t\t}\n\t\t});\n\t}\n\n\tget_current_tax_fraction(tax, item_tax_map) {\n\t\t// Get tax fraction for calculating tax exclusive amount\n\t\t// from tax inclusive amount\n\t\tvar current_tax_fraction = 0.0;\n\t\tvar inclusive_tax_amount_per_qty = 0;\n\n\t\tif(cint(tax.included_in_print_rate)) {\n\t\t\tvar tax_rate = this._get_tax_rate(tax, item_tax_map);\n\n\t\t\tif(tax.charge_type == \"On Net Total\") {\n\t\t\t\tcurrent_tax_fraction = (tax_rate / 100.0);\n\n\t\t\t} else if(tax.charge_type == \"On Previous Row Amount\") {\n\t\t\t\tcurrent_tax_fraction = (tax_rate / 100.0) *\n\t\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].tax_fraction_for_current_item;\n\n\t\t\t} else if(tax.charge_type == \"On Previous Row Total\") {\n\t\t\t\tcurrent_tax_fraction = (tax_rate / 100.0) *\n\t\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].grand_total_fraction_for_current_item;\n\t\t\t} else if (tax.charge_type == \"On Item Quantity\") {\n\t\t\t\tinclusive_tax_amount_per_qty = flt(tax_rate);\n\t\t\t}\n\t\t}\n\n\t\tif(tax.add_deduct_tax && tax.add_deduct_tax == \"Deduct\") {\n\t\t\tcurrent_tax_fraction *= -1;\n\t\t\tinclusive_tax_amount_per_qty *= -1;\n\t\t}\n\t\treturn [current_tax_fraction, inclusive_tax_amount_per_qty];\n\t}\n\n\t_get_tax_rate(tax, item_tax_map) {\n\t\treturn (Object.keys(item_tax_map).indexOf(tax.account_head) != -1) ?\n\t\t\tflt(item_tax_map[tax.account_head], precision(\"rate\", tax)) : tax.rate;\n\t}\n\n\tcalculate_net_total() {\n\t\tvar me = this;\n\t\tthis.frm.doc.total_qty = this.frm.doc.total = this.frm.doc.base_total = this.frm.doc.net_total = this.frm.doc.base_net_total = 0.0;\n\n\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\tme.frm.doc.total += item.amount;\n\t\t\tme.frm.doc.total_qty += item.qty;\n\t\t\tme.frm.doc.base_total += item.base_amount;\n\t\t\tme.frm.doc.net_total += item.net_amount;\n\t\t\tme.frm.doc.base_net_total += item.base_net_amount;\n\t\t\t});\n\n\t\tfrappe.model.round_floats_in(this.frm.doc, [\"total\", \"base_total\", \"net_total\", \"base_net_total\"]);\n\t}\n\n\tadd_taxes_from_item_tax_template(item_tax_map) {\n\t\tlet me = this;\n\n\t\tif (item_tax_map && cint(frappe.defaults.get_default(\"add_taxes_from_item_tax_template\"))) {\n\t\t\tif (typeof (item_tax_map) == \"string\") {\n\t\t\t\titem_tax_map = JSON.parse(item_tax_map);\n\t\t\t}\n\n\t\t\t$.each(item_tax_map, function(tax, rate) {\n\t\t\t\tlet found = (me.frm.doc.taxes || []).find(d => d.account_head === tax);\n\t\t\t\tif (!found) {\n\t\t\t\t\tlet child = frappe.model.add_child(me.frm.doc, \"taxes\");\n\t\t\t\t\tchild.charge_type = \"On Net Total\";\n\t\t\t\t\tchild.account_head = tax;\n\t\t\t\t\tchild.rate = 0;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tcalculate_taxes() {\n\t\tvar me = this;\n\t\tthis.frm.doc.rounding_adjustment = 0;\n\t\tvar actual_tax_dict = {};\n\n\t\t// maintain actual tax rate based on idx\n\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\tif (tax.charge_type == \"Actual\") {\n\t\t\t\tactual_tax_dict[tax.idx] = flt(tax.tax_amount, precision(\"tax_amount\", tax));\n\t\t\t}\n\t\t});\n\n\t\t$.each(this.frm.doc[\"items\"] || [], function(n, item) {\n\t\t\tvar item_tax_map = me._load_item_tax_rate(item.item_tax_rate);\n\t\t\t$.each(me.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\t// tax_amount represents the amount of tax for the current step\n\t\t\t\tvar current_tax_amount = me.get_current_tax_amount(item, tax, item_tax_map);\n\n\t\t\t\t// Adjust divisional loss to the last item\n\t\t\t\tif (tax.charge_type == \"Actual\") {\n\t\t\t\t\tactual_tax_dict[tax.idx] -= current_tax_amount;\n\t\t\t\t\tif (n == me.frm.doc[\"items\"].length - 1) {\n\t\t\t\t\t\tcurrent_tax_amount += actual_tax_dict[tax.idx];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// accumulate tax amount into tax.tax_amount\n\t\t\t\tif (tax.charge_type != \"Actual\" &&\n\t\t\t\t\t!(me.discount_amount_applied && me.frm.doc.apply_discount_on==\"Grand Total\")) {\n\t\t\t\t\ttax.tax_amount += current_tax_amount;\n\t\t\t\t}\n\n\t\t\t\t// store tax_amount for current item as it will be used for\n\t\t\t\t// charge type = 'On Previous Row Amount'\n\t\t\t\ttax.tax_amount_for_current_item = current_tax_amount;\n\n\t\t\t\t// tax amount after discount amount\n\t\t\t\ttax.tax_amount_after_discount_amount += current_tax_amount;\n\n\t\t\t\t// for buying\n\t\t\t\tif(tax.category) {\n\t\t\t\t\t// if just for valuation, do not add the tax amount in total\n\t\t\t\t\t// hence, setting it as 0 for further steps\n\t\t\t\t\tcurrent_tax_amount = (tax.category == \"Valuation\") ? 0.0 : current_tax_amount;\n\n\t\t\t\t\tcurrent_tax_amount *= (tax.add_deduct_tax == \"Deduct\") ? -1.0 : 1.0;\n\t\t\t\t}\n\n\t\t\t\t// note: grand_total_for_current_item contains the contribution of\n\t\t\t\t// item's amount, previously applied tax and the current tax on that item\n\t\t\t\tif(i==0) {\n\t\t\t\t\ttax.grand_total_for_current_item = flt(item.net_amount + current_tax_amount);\n\t\t\t\t} else {\n\t\t\t\t\ttax.grand_total_for_current_item =\n\t\t\t\t\t\tflt(me.frm.doc[\"taxes\"][i-1].grand_total_for_current_item + current_tax_amount);\n\t\t\t\t}\n\n\t\t\t\t// set precision in the last item iteration\n\t\t\t\tif (n == me.frm.doc[\"items\"].length - 1) {\n\t\t\t\t\tme.round_off_totals(tax);\n\t\t\t\t\tme.set_in_company_currency(tax,\n\t\t\t\t\t\t[\"tax_amount\", \"tax_amount_after_discount_amount\"]);\n\n\t\t\t\t\tme.round_off_base_values(tax);\n\n\t\t\t\t\t// in tax.total, accumulate grand total for each item\n\t\t\t\t\tme.set_cumulative_total(i, tax);\n\n\t\t\t\t\tme.set_in_company_currency(tax, [\"total\"]);\n\n\t\t\t\t\t// adjust Discount Amount loss in last tax iteration\n\t\t\t\t\tif ((i == me.frm.doc[\"taxes\"].length - 1) && me.discount_amount_applied\n\t\t\t\t\t\t&& me.frm.doc.apply_discount_on == \"Grand Total\" && me.frm.doc.discount_amount) {\n\t\t\t\t\t\tme.frm.doc.rounding_adjustment = flt(me.frm.doc.grand_total -\n\t\t\t\t\t\t\tflt(me.frm.doc.discount_amount) - tax.total, precision(\"rounding_adjustment\"));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tset_cumulative_total(row_idx, tax) {\n\t\tvar tax_amount = tax.tax_amount_after_discount_amount;\n\t\tif (tax.category == 'Valuation') {\n\t\t\ttax_amount = 0;\n\t\t}\n\n\t\tif (tax.add_deduct_tax == \"Deduct\") { tax_amount = -1*tax_amount; }\n\n\t\tif(row_idx==0) {\n\t\t\ttax.total = flt(this.frm.doc.net_total + tax_amount, precision(\"total\", tax));\n\t\t} else {\n\t\t\ttax.total = flt(this.frm.doc[\"taxes\"][row_idx-1].total + tax_amount, precision(\"total\", tax));\n\t\t}\n\t}\n\n\t_load_item_tax_rate(item_tax_rate) {\n\t\treturn item_tax_rate ? JSON.parse(item_tax_rate) : {};\n\t}\n\n\tget_current_tax_amount(item, tax, item_tax_map) {\n\t\tvar tax_rate = this._get_tax_rate(tax, item_tax_map);\n\t\tvar current_tax_amount = 0.0;\n\n\t\t// To set row_id by default as previous row.\n\t\tif([\"On Previous Row Amount\", \"On Previous Row Total\"].includes(tax.charge_type)) {\n\t\t\tif (tax.idx === 1) {\n\t\t\t\tfrappe.throw(\n\t\t\t\t\t__(\"Cannot select charge type as 'On Previous Row Amount' or 'On Previous Row Total' for first row\"));\n\t\t\t}\n\t\t\tif (!tax.row_id) {\n\t\t\t\ttax.row_id = tax.idx - 1;\n\t\t\t}\n\t\t}\n\t\tif(tax.charge_type == \"Actual\") {\n\t\t\t// distribute the tax amount proportionally to each item row\n\t\t\tvar actual = flt(tax.tax_amount, precision(\"tax_amount\", tax));\n\t\t\tcurrent_tax_amount = this.frm.doc.net_total ?\n\t\t\t\t((item.net_amount / this.frm.doc.net_total) * actual) : 0.0;\n\n\t\t} else if(tax.charge_type == \"On Net Total\") {\n\t\t\tcurrent_tax_amount = (tax_rate / 100.0) * item.net_amount;\n\t\t} else if(tax.charge_type == \"On Previous Row Amount\") {\n\t\t\tcurrent_tax_amount = (tax_rate / 100.0) *\n\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].tax_amount_for_current_item;\n\n\t\t} else if(tax.charge_type == \"On Previous Row Total\") {\n\t\t\tcurrent_tax_amount = (tax_rate / 100.0) *\n\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].grand_total_for_current_item;\n\t\t} else if (tax.charge_type == \"On Item Quantity\") {\n\t\t\tcurrent_tax_amount = tax_rate * item.qty;\n\t\t}\n\n\t\tthis.set_item_wise_tax(item, tax, tax_rate, current_tax_amount);\n\n\t\treturn current_tax_amount;\n\t}\n\n\tset_item_wise_tax(item, tax, tax_rate, current_tax_amount) {\n\t\t// store tax breakup for each item\n\t\tlet tax_detail = tax.item_wise_tax_detail;\n\t\tlet key = item.item_code || item.item_name;\n\n\t\tif(typeof (tax_detail) == \"string\") {\n\t\t\ttax.item_wise_tax_detail = JSON.parse(tax.item_wise_tax_detail);\n\t\t\ttax_detail = tax.item_wise_tax_detail;\n\t\t}\n\n\t\tlet item_wise_tax_amount = current_tax_amount * this.frm.doc.conversion_rate;\n\t\tif (tax_detail && tax_detail[key])\n\t\t\titem_wise_tax_amount += tax_detail[key][1];\n\n\t\ttax_detail[key] = [tax_rate, flt(item_wise_tax_amount, precision(\"base_tax_amount\", tax))];\n\t}\n\n\tround_off_totals(tax) {\n\t\tif (frappe.flags.round_off_applicable_accounts.includes(tax.account_head)) {\n\t\t\ttax.tax_amount= Math.round(tax.tax_amount);\n\t\t\ttax.tax_amount_after_discount_amount = Math.round(tax.tax_amount_after_discount_amount);\n\t\t}\n\n\t\ttax.tax_amount = flt(tax.tax_amount, precision(\"tax_amount\", tax));\n\t\ttax.tax_amount_after_discount_amount = flt(tax.tax_amount_after_discount_amount, precision(\"tax_amount\", tax));\n\t}\n\n\tround_off_base_values(tax) {\n\t\tif (frappe.flags.round_off_applicable_accounts.includes(tax.account_head)) {\n\t\t\ttax.base_tax_amount= Math.round(tax.base_tax_amount);\n\t\t\ttax.base_tax_amount_after_discount_amount = Math.round(tax.base_tax_amount_after_discount_amount);\n\t\t}\n\t}\n\n\tmanipulate_grand_total_for_inclusive_tax() {\n\t\tvar me = this;\n\t\t// if fully inclusive taxes and diff\n\t\tif (this.frm.doc[\"taxes\"] && this.frm.doc[\"taxes\"].length) {\n\t\t\tvar any_inclusive_tax = false;\n\t\t\t$.each(this.frm.doc.taxes || [], function(i, d) {\n\t\t\t\tif(cint(d.included_in_print_rate)) any_inclusive_tax = true;\n\t\t\t});\n\t\t\tif (any_inclusive_tax) {\n\t\t\t\tvar last_tax = me.frm.doc[\"taxes\"].slice(-1)[0];\n\t\t\t\tvar non_inclusive_tax_amount = frappe.utils.sum($.map(this.frm.doc.taxes || [],\n\t\t\t\t\tfunction(d) {\n\t\t\t\t\t\tif(!d.included_in_print_rate) {\n\t\t\t\t\t\t\treturn flt(d.tax_amount_after_discount_amount);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t));\n\t\t\t\tvar diff = me.frm.doc.total + non_inclusive_tax_amount\n\t\t\t\t\t- flt(last_tax.total, precision(\"grand_total\"));\n\n\t\t\t\tif(me.discount_amount_applied && me.frm.doc.discount_amount) {\n\t\t\t\t\tdiff -= flt(me.frm.doc.discount_amount);\n\t\t\t\t}\n\n\t\t\t\tdiff = flt(diff, precision(\"rounding_adjustment\"));\n\n\t\t\t\tif ( diff && Math.abs(diff) <= (5.0 / Math.pow(10, precision(\"tax_amount\", last_tax))) ) {\n\t\t\t\t\tme.frm.doc.rounding_adjustment = diff;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tcalculate_totals() {\n\t\t// Changing sequence can because of rounding adjustment issue and on-screen discrepancy\n\t\tvar me = this;\n\t\tvar tax_count = this.frm.doc[\"taxes\"] ? this.frm.doc[\"taxes\"].length : 0;\n\t\tthis.frm.doc.grand_total = flt(tax_count\n\t\t\t? this.frm.doc[\"taxes\"][tax_count - 1].total + flt(this.frm.doc.rounding_adjustment)\n\t\t\t: this.frm.doc.net_total);\n\n\t\tif(in_list([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\", \"POS Invoice\", \"Proforma Invoice\"], this.frm.doc.doctype)) {\n\t\t\tthis.frm.doc.base_grand_total = (this.frm.doc.total_taxes_and_charges) ?\n\t\t\t\tflt(this.frm.doc.grand_total * this.frm.doc.conversion_rate) : this.frm.doc.base_net_total;\n\t\t} else {\n\t\t\t// other charges added/deducted\n\t\t\tthis.frm.doc.taxes_and_charges_added = this.frm.doc.taxes_and_charges_deducted = 0.0;\n\t\t\tif(tax_count) {\n\t\t\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\t\tif (in_list([\"Valuation and Total\", \"Total\"], tax.category)) {\n\t\t\t\t\t\tif(tax.add_deduct_tax == \"Add\") {\n\t\t\t\t\t\t\tme.frm.doc.taxes_and_charges_added += flt(tax.tax_amount_after_discount_amount);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tme.frm.doc.taxes_and_charges_deducted += flt(tax.tax_amount_after_discount_amount);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tfrappe.model.round_floats_in(this.frm.doc,\n\t\t\t\t\t[\"taxes_and_charges_added\", \"taxes_and_charges_deducted\"]);\n\t\t\t}\n\n\t\t\tthis.frm.doc.base_grand_total = flt((this.frm.doc.taxes_and_charges_added || this.frm.doc.taxes_and_charges_deducted) ?\n\t\t\t\tflt(this.frm.doc.grand_total * this.frm.doc.conversion_rate) : this.frm.doc.base_net_total);\n\n\t\t\tthis.set_in_company_currency(this.frm.doc,\n\t\t\t\t[\"taxes_and_charges_added\", \"taxes_and_charges_deducted\"]);\n\t\t}\n\n\t\tthis.frm.doc.total_taxes_and_charges = flt(this.frm.doc.grand_total - this.frm.doc.net_total\n\t\t\t- flt(this.frm.doc.rounding_adjustment), precision(\"total_taxes_and_charges\"));\n\n\t\tthis.set_in_company_currency(this.frm.doc, [\"total_taxes_and_charges\", \"rounding_adjustment\"]);\n\n\t\t// Round grand total as per precision\n\t\tfrappe.model.round_floats_in(this.frm.doc, [\"grand_total\", \"base_grand_total\"]);\n\n\t\t// rounded totals\n\t\tthis.set_rounded_total();\n\t}\n\n\tset_rounded_total() {\n\t\tvar disable_rounded_total = 0;\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype, \"disable_rounded_total\", this.frm.doc.name)) {\n\t\t\tdisable_rounded_total = this.frm.doc.disable_rounded_total;\n\t\t} else if (frappe.sys_defaults.disable_rounded_total) {\n\t\t\tdisable_rounded_total = frappe.sys_defaults.disable_rounded_total;\n\t\t}\n\n\t\tif (cint(disable_rounded_total)) {\n\t\t\tthis.frm.doc.rounded_total = 0;\n\t\t\tthis.frm.doc.base_rounded_total = 0;\n\t\t\treturn;\n\t\t}\n\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype, \"rounded_total\", this.frm.doc.name)) {\n\t\t\tthis.frm.doc.rounded_total = round_based_on_smallest_currency_fraction(this.frm.doc.grand_total,\n\t\t\t\tthis.frm.doc.currency, precision(\"rounded_total\"));\n\t\t\tthis.frm.doc.rounding_adjustment += flt(this.frm.doc.rounded_total - this.frm.doc.grand_total,\n\t\t\t\tprecision(\"rounding_adjustment\"));\n\n\t\t\tthis.set_in_company_currency(this.frm.doc, [\"rounding_adjustment\", \"rounded_total\"]);\n\t\t}\n\t}\n\n\t_cleanup() {\n\t\tthis.frm.doc.base_in_words = this.frm.doc.in_words = \"\";\n\n\t\tif(this.frm.doc[\"items\"] && this.frm.doc[\"items\"].length) {\n\t\t\tif(!frappe.meta.get_docfield(this.frm.doc[\"items\"][0].doctype, \"item_tax_amount\", this.frm.doctype)) {\n\t\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\t\t\tdelete item[\"item_tax_amount\"];\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif(this.frm.doc[\"taxes\"] && this.frm.doc[\"taxes\"].length) {\n\t\t\tvar temporary_fields = [\"tax_amount_for_current_item\", \"grand_total_for_current_item\",\n\t\t\t\t\"tax_fraction_for_current_item\", \"grand_total_fraction_for_current_item\"];\n\n\t\t\tif(!frappe.meta.get_docfield(this.frm.doc[\"taxes\"][0].doctype, \"tax_amount_after_discount_amount\", this.frm.doctype)) {\n\t\t\t\ttemporary_fields.push(\"tax_amount_after_discount_amount\");\n\t\t\t}\n\n\t\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\t$.each(temporary_fields, function(i, fieldname) {\n\t\t\t\t\tdelete tax[fieldname];\n\t\t\t\t});\n\n\t\t\t\ttax.item_wise_tax_detail = JSON.stringify(tax.item_wise_tax_detail);\n\t\t\t});\n\t\t}\n\t}\n\n\tset_discount_amount() {\n\t\tif(this.frm.doc.additional_discount_percentage) {\n\t\t\tthis.frm.doc.discount_amount = flt(flt(this.frm.doc[frappe.scrub(this.frm.doc.apply_discount_on)])\n\t\t\t\t* this.frm.doc.additional_discount_percentage / 100, precision(\"discount_amount\"));\n\t\t}\n\t}\n\n\tapply_discount_amount() {\n\t\tvar me = this;\n\t\tvar distributed_amount = 0.0;\n\t\tthis.frm.doc.base_discount_amount = 0.0;\n\n\t\tif (this.frm.doc.discount_amount) {\n\t\t\tif(!this.frm.doc.apply_discount_on)\n\t\t\t\tfrappe.throw(__(\"Please select Apply Discount On\"));\n\n\t\t\tthis.frm.doc.base_discount_amount = flt(this.frm.doc.discount_amount * this.frm.doc.conversion_rate,\n\t\t\t\tprecision(\"base_discount_amount\"));\n\n\t\t\tvar total_for_discount_amount = this.get_total_for_discount_amount();\n\t\t\tvar net_total = 0;\n\t\t\t// calculate item amount after Discount Amount\n\t\t\tif (total_for_discount_amount) {\n\t\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\t\t\tdistributed_amount = flt(me.frm.doc.discount_amount) * item.net_amount / total_for_discount_amount;\n\t\t\t\t\titem.net_amount = flt(item.net_amount - distributed_amount,\n\t\t\t\t\t\tprecision(\"base_amount\", item));\n\t\t\t\t\tnet_total += item.net_amount;\n\n\t\t\t\t\t// discount amount rounding loss adjustment if no taxes\n\t\t\t\t\tif ((!(me.frm.doc.taxes || []).length || total_for_discount_amount==me.frm.doc.net_total || (me.frm.doc.apply_discount_on == \"Net Total\"))\n\t\t\t\t\t\t\t&& i == (me.frm.doc.items || []).length - 1) {\n\t\t\t\t\t\tvar discount_amount_loss = flt(me.frm.doc.net_total - net_total\n\t\t\t\t\t\t\t- me.frm.doc.discount_amount, precision(\"net_total\"));\n\t\t\t\t\t\titem.net_amount = flt(item.net_amount + discount_amount_loss,\n\t\t\t\t\t\t\tprecision(\"net_amount\", item));\n\t\t\t\t\t}\n\t\t\t\t\titem.net_rate = item.qty ? flt(item.net_amount / item.qty, precision(\"net_rate\", item)) : 0;\n\t\t\t\t\tme.set_in_company_currency(item, [\"net_rate\", \"net_amount\"]);\n\t\t\t\t});\n\n\t\t\t\tthis.discount_amount_applied = true;\n\t\t\t\tthis._calculate_taxes_and_totals();\n\t\t\t}\n\t\t}\n\t}\n\n\tget_total_for_discount_amount() {\n\t\tif(this.frm.doc.apply_discount_on == \"Net Total\") {\n\t\t\treturn this.frm.doc.net_total;\n\t\t} else {\n\t\t\tvar total_actual_tax = 0.0;\n\t\t\tvar actual_taxes_dict = {};\n\n\t\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\tif (in_list([\"Actual\", \"On Item Quantity\"], tax.charge_type)) {\n\t\t\t\t\tvar tax_amount = (tax.category == \"Valuation\") ? 0.0 : tax.tax_amount;\n\t\t\t\t\ttax_amount *= (tax.add_deduct_tax == \"Deduct\") ? -1.0 : 1.0;\n\t\t\t\t\tactual_taxes_dict[tax.idx] = tax_amount;\n\t\t\t\t} else if (actual_taxes_dict[tax.row_id] !== null) {\n\t\t\t\t\tvar actual_tax_amount = flt(actual_taxes_dict[tax.row_id]) * flt(tax.rate) / 100;\n\t\t\t\t\tactual_taxes_dict[tax.idx] = actual_tax_amount;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t$.each(actual_taxes_dict, function(key, value) {\n\t\t\t\tif (value) total_actual_tax += value;\n\t\t\t});\n\n\t\t\treturn flt(this.frm.doc.grand_total - total_actual_tax, precision(\"grand_total\"));\n\t\t}\n\t}\n\n\tcalculate_total_advance(update_paid_amount) {\n\t\tvar total_allocated_amount = frappe.utils.sum($.map(this.frm.doc[\"advances\"] || [], function(adv) {\n\t\t\treturn flt(adv.allocated_amount, precision(\"allocated_amount\", adv));\n\t\t}));\n\t\tthis.frm.doc.total_advance = flt(total_allocated_amount, precision(\"total_advance\"));\n\n\t\tthis.calculate_outstanding_amount(update_paid_amount);\n\t}\n\n\tis_internal_invoice() {\n\t\tif (['Sales Invoice', 'Purchase Invoice'].includes(this.frm.doc.doctype)) {\n\t\t\tif (this.frm.doc.company === this.frm.doc.represents_company) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tcalculate_outstanding_amount(update_paid_amount) {\n\t\t// NOTE:\n\t\t// paid_amount and write_off_amount is only for POS/Loyalty Point Redemption Invoice\n\t\t// total_advance is only for non POS Invoice\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype) && this.frm.doc.is_return){\n\t\t\tthis.calculate_paid_amount();\n\t\t}\n\n\t\tif (this.frm.doc.is_return || (this.frm.doc.docstatus > 0) || this.is_internal_invoice()) return;\n\n\t\tfrappe.model.round_floats_in(this.frm.doc, [\"grand_total\", \"total_advance\", \"write_off_amount\"]);\n\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\", \"Purchase Invoice\"], this.frm.doc.doctype)) {\n\t\t\tvar grand_total = this.frm.doc.rounded_total || this.frm.doc.grand_total;\n\n\t\t\tif(this.frm.doc.party_account_currency == this.frm.doc.currency) {\n\t\t\t\tvar total_amount_to_pay = flt((grand_total - this.frm.doc.total_advance\n\t\t\t\t\t- this.frm.doc.write_off_amount), precision(\"grand_total\"));\n\t\t\t} else {\n\t\t\t\tvar total_amount_to_pay = flt(\n\t\t\t\t\t(flt(grand_total*this.frm.doc.conversion_rate, precision(\"grand_total\"))\n\t\t\t\t\t\t- this.frm.doc.total_advance - this.frm.doc.base_write_off_amount),\n\t\t\t\t\tprecision(\"base_grand_total\")\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tfrappe.model.round_floats_in(this.frm.doc, [\"paid_amount\"]);\n\t\t\tthis.set_in_company_currency(this.frm.doc, [\"paid_amount\"]);\n\n\t\t\tif(this.frm.refresh_field){\n\t\t\t\tthis.frm.refresh_field(\"paid_amount\");\n\t\t\t\tthis.frm.refresh_field(\"base_paid_amount\");\n\t\t\t}\n\n\t\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype)) {\n\t\t\t\tlet total_amount_for_payment = (this.frm.doc.redeem_loyalty_points && this.frm.doc.loyalty_amount)\n\t\t\t\t\t? flt(total_amount_to_pay - this.frm.doc.loyalty_amount, precision(\"base_grand_total\"))\n\t\t\t\t\t: total_amount_to_pay;\n\t\t\t\tthis.set_default_payment(total_amount_for_payment, update_paid_amount);\n\t\t\t\tthis.calculate_paid_amount();\n\t\t\t}\n\t\t\tthis.calculate_change_amount();\n\n\t\t\tvar paid_amount = (this.frm.doc.party_account_currency == this.frm.doc.currency) ?\n\t\t\t\tthis.frm.doc.paid_amount : this.frm.doc.base_paid_amount;\n\t\t\tthis.frm.doc.outstanding_amount =  flt(total_amount_to_pay - flt(paid_amount) +\n\t\t\t\tflt(this.frm.doc.change_amount * this.frm.doc.conversion_rate), precision(\"outstanding_amount\"));\n\t\t}\n\t}\n\n\tupdate_paid_amount_for_return() {\n\t\tvar grand_total = this.frm.doc.rounded_total || this.frm.doc.grand_total;\n\n\t\tif(this.frm.doc.party_account_currency == this.frm.doc.currency) {\n\t\t\tvar total_amount_to_pay = flt((grand_total - this.frm.doc.total_advance\n\t\t\t\t- this.frm.doc.write_off_amount), precision(\"grand_total\"));\n\t\t} else {\n\t\t\tvar total_amount_to_pay = flt(\n\t\t\t\t(flt(grand_total*this.frm.doc.conversion_rate, precision(\"grand_total\"))\n\t\t\t\t\t- this.frm.doc.total_advance - this.frm.doc.base_write_off_amount),\n\t\t\t\tprecision(\"base_grand_total\")\n\t\t\t);\n\t\t}\n\n\t\tthis.frm.doc.payments.find(pay => {\n\t\t\tif (pay.default) {\n\t\t\t\tpay.amount = total_amount_to_pay;\n\t\t\t} else {\n\t\t\t\tpay.amount = 0.0\n\t\t\t}\n\t\t});\n\t\tthis.frm.refresh_fields();\n\n\t\tthis.calculate_paid_amount();\n\t}\n\n\tset_default_payment(total_amount_to_pay, update_paid_amount) {\n\t\tvar me = this;\n\t\tvar payment_status = true;\n\t\tif(this.frm.doc.is_pos && (update_paid_amount===undefined || update_paid_amount)) {\n\t\t\t$.each(this.frm.doc['payments'] || [], function(index, data) {\n\t\t\t\tif(data.default && payment_status && total_amount_to_pay > 0) {\n\t\t\t\t\tlet base_amount = flt(total_amount_to_pay, precision(\"base_amount\", data));\n\t\t\t\t\tfrappe.model.set_value(data.doctype, data.name, \"base_amount\", base_amount);\n\t\t\t\t\tlet amount = flt(total_amount_to_pay / me.frm.doc.conversion_rate, precision(\"amount\", data));\n\t\t\t\t\tfrappe.model.set_value(data.doctype, data.name, \"amount\", amount);\n\t\t\t\t\tpayment_status = false;\n\t\t\t\t} else if(me.frm.doc.paid_amount) {\n\t\t\t\t\tfrappe.model.set_value(data.doctype, data.name, \"amount\", 0.0);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tcalculate_paid_amount() {\n\t\tvar me = this;\n\t\tvar paid_amount = 0.0;\n\t\tvar base_paid_amount = 0.0;\n\t\tif(this.frm.doc.is_pos) {\n\t\t\t$.each(this.frm.doc['payments'] || [], function(index, data){\n\t\t\t\tdata.base_amount = flt(data.amount * me.frm.doc.conversion_rate, precision(\"base_amount\", data));\n\t\t\t\tpaid_amount += data.amount;\n\t\t\t\tbase_paid_amount += data.base_amount;\n\t\t\t});\n\t\t} else if(!this.frm.doc.is_return){\n\t\t\tthis.frm.doc.payments = [];\n\t\t}\n\t\tif (this.frm.doc.redeem_loyalty_points && this.frm.doc.loyalty_amount) {\n\t\t\tbase_paid_amount += this.frm.doc.loyalty_amount;\n\t\t\tpaid_amount += flt(this.frm.doc.loyalty_amount / me.frm.doc.conversion_rate, precision(\"paid_amount\"));\n\t\t}\n\n\t\tthis.frm.set_value('paid_amount', flt(paid_amount, precision(\"paid_amount\")));\n\t\tthis.frm.set_value('base_paid_amount', flt(base_paid_amount, precision(\"base_paid_amount\")));\n\t}\n\n\tcalculate_change_amount(){\n\t\tthis.frm.doc.change_amount = 0.0;\n\t\tthis.frm.doc.base_change_amount = 0.0;\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype)\n\t\t\t&& this.frm.doc.paid_amount > this.frm.doc.grand_total && !this.frm.doc.is_return) {\n\n\t\t\tvar payment_types = $.map(this.frm.doc.payments, function(d) { return d.type; });\n\t\t\tif (in_list(payment_types, 'Cash')) {\n\t\t\t\tvar grand_total = this.frm.doc.rounded_total || this.frm.doc.grand_total;\n\t\t\t\tvar base_grand_total = this.frm.doc.base_rounded_total || this.frm.doc.base_grand_total;\n\n\t\t\t\tthis.frm.doc.change_amount = flt(this.frm.doc.paid_amount - grand_total +\n\t\t\t\t\tthis.frm.doc.write_off_amount, precision(\"change_amount\"));\n\n\t\t\t\tthis.frm.doc.base_change_amount = flt(this.frm.doc.base_paid_amount -\n\t\t\t\t\tbase_grand_total + this.frm.doc.base_write_off_amount,\n\t\t\t\t\tprecision(\"base_change_amount\"));\n\t\t\t}\n\t\t}\n\t}\n\n\tcalculate_write_off_amount(){\n\t\tif(this.frm.doc.paid_amount > this.frm.doc.grand_total){\n\t\t\tthis.frm.doc.write_off_amount = flt(this.frm.doc.grand_total - this.frm.doc.paid_amount\n\t\t\t\t+ this.frm.doc.change_amount, precision(\"write_off_amount\"));\n\n\t\t\tthis.frm.doc.base_write_off_amount = flt(this.frm.doc.write_off_amount * this.frm.doc.conversion_rate,\n\t\t\t\tprecision(\"base_write_off_amount\"));\n\t\t}else{\n\t\t\tthis.frm.doc.paid_amount = 0.0;\n\t\t}\n\t\tthis.calculate_outstanding_amount(false);\n\t}\n};\n", "// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nfrappe.provide('erpnext.accounts.dimensions');\n\nerpnext.TransactionController = class TransactionController extends erpnext.taxes_and_totals {\n\tsetup() {\n\t\tsuper.setup();\n\t\tlet me = this;\n\t\tfrappe.flags.hide_serial_batch_dialog = true;\n\t\tfrappe.ui.form.on(this.frm.doctype + \" Item\", \"rate\", function(frm, cdt, cdn) {\n\t\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\t\tvar has_margin_field = frappe.meta.has_field(cdt, 'margin_type');\n\n\t\t\tfrappe.model.round_floats_in(item, [\"rate\", \"price_list_rate\"]);\n\n\t\t\tif(item.price_list_rate) {\n\t\t\t\tif(item.rate > item.price_list_rate && has_margin_field) {\n\t\t\t\t\t// if rate is greater than price_list_rate, set margin\n\t\t\t\t\t// or set discount\n\t\t\t\t\titem.discount_percentage = 0;\n\t\t\t\t\titem.margin_type = 'Amount';\n\t\t\t\t\titem.margin_rate_or_amount = flt(item.rate - item.price_list_rate,\n\t\t\t\t\t\tprecision(\"margin_rate_or_amount\", item));\n\t\t\t\t\titem.rate_with_margin = item.rate;\n\t\t\t\t} else {\n\t\t\t\t\titem.discount_percentage = flt((1 - item.rate / item.price_list_rate) * 100.0,\n\t\t\t\t\t\tprecision(\"discount_percentage\", item));\n\t\t\t\t\titem.discount_amount = flt(item.price_list_rate) - flt(item.rate);\n\t\t\t\t\titem.margin_type = '';\n\t\t\t\t\titem.margin_rate_or_amount = 0;\n\t\t\t\t\titem.rate_with_margin = 0;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\titem.discount_percentage = 0.0;\n\t\t\t\titem.margin_type = '';\n\t\t\t\titem.margin_rate_or_amount = 0;\n\t\t\t\titem.rate_with_margin = 0;\n\t\t\t}\n\t\t\titem.base_rate_with_margin = item.rate_with_margin * flt(frm.doc.conversion_rate);\n\n\t\t\tcur_frm.cscript.set_gross_profit(item);\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t\tcur_frm.cscript.calculate_stock_uom_rate(frm, cdt, cdn);\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"rate\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"tax_amount\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"row_id\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"included_in_print_rate\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.set_dynamic_labels();\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype, \"apply_discount_on\", function(frm) {\n\t\t\tif(frm.doc.additional_discount_percentage) {\n\t\t\t\tfrm.trigger(\"additional_discount_percentage\");\n\t\t\t} else {\n\t\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t\t}\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype, \"additional_discount_percentage\", function(frm) {\n\t\t\tif(!frm.doc.apply_discount_on) {\n\t\t\t\tfrappe.msgprint(__(\"Please set 'Apply Additional Discount On'\"));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tfrm.via_discount_percentage = true;\n\n\t\t\tif(frm.doc.additional_discount_percentage && frm.doc.discount_amount) {\n\t\t\t\t// Reset discount amount and net / grand total\n\t\t\t\tfrm.doc.discount_amount = 0;\n\t\t\t\tfrm.cscript.calculate_taxes_and_totals();\n\t\t\t}\n\n\t\t\tvar total = flt(frm.doc[frappe.model.scrub(frm.doc.apply_discount_on)]);\n\t\t\tvar discount_amount = flt(total*flt(frm.doc.additional_discount_percentage) / 100,\n\t\t\t\tprecision(\"discount_amount\"));\n\n\t\t\tfrm.set_value(\"discount_amount\", discount_amount)\n\t\t\t\t.then(() => delete frm.via_discount_percentage);\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype, \"discount_amount\", function(frm) {\n\t\t\tfrm.cscript.set_dynamic_labels();\n\n\t\t\tif (!frm.via_discount_percentage) {\n\t\t\t\tfrm.doc.additional_discount_percentage = 0;\n\t\t\t}\n\n\t\t\tfrm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype + \" Item\", {\n\t\t\titems_add: function(frm, cdt, cdn) {\n\t\t\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\t\t\tif (!item.warehouse && frm.doc.set_warehouse) {\n\t\t\t\t\titem.warehouse = frm.doc.set_warehouse;\n\t\t\t\t}\n\n\t\t\t\tif (!item.target_warehouse && frm.doc.set_target_warehouse) {\n\t\t\t\t\titem.target_warehouse = frm.doc.set_target_warehouse;\n\t\t\t\t}\n\n\t\t\t\tif (!item.from_warehouse && frm.doc.set_from_warehouse) {\n\t\t\t\t\titem.from_warehouse = frm.doc.set_from_warehouse;\n\t\t\t\t}\n\n\t\t\t\terpnext.accounts.dimensions.copy_dimension_from_first_row(frm, cdt, cdn, 'items');\n\t\t\t}\n\t\t});\n\n\t\tif(this.frm.fields_dict[\"items\"].grid.get_field('batch_no')) {\n\t\t\tthis.frm.set_query(\"batch_no\", \"items\", function(doc, cdt, cdn) {\n\t\t\t\treturn me.set_query_for_batch(doc, cdt, cdn);\n\t\t\t});\n\t\t}\n\n\t\tif(\n\t\t\tthis.frm.docstatus < 2\n\t\t\t&& this.frm.fields_dict[\"payment_terms_template\"]\n\t\t\t&& this.frm.fields_dict[\"payment_schedule\"]\n\t\t\t&& this.frm.doc.payment_terms_template\n\t\t\t&& !this.frm.doc.payment_schedule.length\n\t\t){\n\t\t\tthis.frm.trigger(\"payment_terms_template\");\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"taxes\"]) {\n\t\t\tthis[\"taxes_remove\"] = this.calculate_taxes_and_totals;\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"items\"]) {\n\t\t\tthis[\"items_remove\"] = this.calculate_net_weight;\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"recurring_print_format\"]) {\n\t\t\tthis.frm.set_query(\"recurring_print_format\", function(doc) {\n\t\t\t\treturn{\n\t\t\t\t\tfilters: [\n\t\t\t\t\t\t['Print Format', 'doc_type', '=', cur_frm.doctype],\n\t\t\t\t\t]\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"return_against\"]) {\n\t\t\tthis.frm.set_query(\"return_against\", function(doc) {\n\t\t\t\tvar filters = {\n\t\t\t\t\t\"docstatus\": 1,\n\t\t\t\t\t\"is_return\": 0,\n\t\t\t\t\t\"company\": doc.company\n\t\t\t\t};\n\t\t\t\tif (me.frm.fields_dict[\"customer\"] && doc.customer) filters[\"customer\"] = doc.customer;\n\t\t\t\tif (me.frm.fields_dict[\"supplier\"] && doc.supplier) filters[\"supplier\"] = doc.supplier;\n\n\t\t\t\treturn {\n\t\t\t\t\tfilters: filters\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\tif (this.frm.fields_dict[\"items\"].grid.get_field(\"expense_account\")) {\n\t\t\tthis.frm.set_query(\"expense_account\", \"items\", function(doc) {\n\t\t\t\treturn {\n\t\t\t\t\tfilters: {\n\t\t\t\t\t\t\"company\": doc.company\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype, \"pricing_rules\")) {\n\t\t\tthis.frm.set_indicator_formatter('pricing_rule', function(doc) {\n\t\t\t\treturn (doc.rule_applied) ? \"green\" : \"red\";\n\t\t\t});\n\t\t}\n\n\t\tlet batch_no_field = this.frm.get_docfield(\"items\", \"batch_no\");\n\t\tif (batch_no_field) {\n\t\t\tbatch_no_field.get_route_options_for_new_doc = function(row) {\n\t\t\t\treturn {\n\t\t\t\t\t\"item\": row.doc.item_code\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\n\t\tif (this.frm.fields_dict[\"items\"].grid.get_field('blanket_order')) {\n\t\t\tthis.frm.set_query(\"blanket_order\", \"items\", function(doc, cdt, cdn) {\n\t\t\t\tvar item = locals[cdt][cdn];\n\t\t\t\treturn {\n\t\t\t\t\tquery: \"erpnext.controllers.queries.get_blanket_orders\",\n\t\t\t\t\tfilters: {\n\t\t\t\t\t\t\"company\": doc.company,\n\t\t\t\t\t\t\"blanket_order_type\": doc.doctype === \"Sales Order\" ? \"Selling\" : \"Purchasing\",\n\t\t\t\t\t\t\"item\": item.item_code\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (this.frm.fields_dict.taxes_and_charges) {\n\t\t\tthis.frm.set_query(\"taxes_and_charges\", function() {\n\t\t\t\treturn {\n\t\t\t\t\tfilters: [\n\t\t\t\t\t\t['company', '=', me.frm.doc.company],\n\t\t\t\t\t\t['docstatus', '!=', 2]\n\t\t\t\t\t]\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t}\n\tonload() {\n\t\tvar me = this;\n\t\tif(this.frm.doc.__islocal) {\n\t\t\tvar currency = frappe.defaults.get_user_default(\"currency\");\n\n\t\t\tlet set_value = (fieldname, value) => {\n\t\t\t\tif(me.frm.fields_dict[fieldname] && !me.frm.doc[fieldname]) {\n\t\t\t\t\treturn me.frm.set_value(fieldname, value);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tthis.frm.trigger('set_default_internal_warehouse');\n\n\t\t\treturn frappe.run_serially([\n\t\t\t\t() => set_value('currency', currency),\n\t\t\t\t() => set_value('price_list_currency', currency),\n\t\t\t\t() => set_value('status', 'Draft'),\n\t\t\t\t() => set_value('is_subcontracted', 0),\n\t\t\t\t() => {\n\t\t\t\t\tif(this.frm.doc.company && !this.frm.doc.amended_from) {\n\t\t\t\t\t\tthis.frm.trigger(\"company\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t]);\n\t\t}\n\t}\n\n\tis_return() {\n\t\tif(!this.frm.doc.is_return && this.frm.doc.return_against) {\n\t\t\tthis.frm.set_value('return_against', '');\n\t\t}\n\t}\n\n\tsetup_quality_inspection() {\n\t\tif(!in_list([\"Delivery Note\", \"Sales Invoice\", \"Purchase Receipt\", \"Purchase Invoice\"], this.frm.doc.doctype)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst me = this;\n\t\tif (!this.frm.is_new() && this.frm.doc.docstatus === 0) {\n\t\t\tthis.frm.add_custom_button(__(\"Quality Inspection(s)\"), () => {\n\t\t\t\tme.make_quality_inspection();\n\t\t\t}, __(\"Create\"));\n\t\t\tthis.frm.page.set_inner_btn_group_as_primary(__('Create'));\n\t\t}\n\n\t\tconst inspection_type = in_list([\"Purchase Receipt\", \"Purchase Invoice\"], this.frm.doc.doctype)\n\t\t\t? \"Incoming\" : \"Outgoing\";\n\n\t\tlet quality_inspection_field = this.frm.get_docfield(\"items\", \"quality_inspection\");\n\t\tquality_inspection_field.get_route_options_for_new_doc = function(row) {\n\t\t\tif(me.frm.is_new()) return;\n\t\t\treturn {\n\t\t\t\t\"inspection_type\": inspection_type,\n\t\t\t\t\"reference_type\": me.frm.doc.doctype,\n\t\t\t\t\"reference_name\": me.frm.doc.name,\n\t\t\t\t\"item_code\": row.doc.item_code,\n\t\t\t\t\"description\": row.doc.description,\n\t\t\t\t\"item_serial_no\": row.doc.serial_no ? row.doc.serial_no.split(\"\\n\")[0] : null,\n\t\t\t\t\"batch_no\": row.doc.batch_no\n\t\t\t}\n\t\t}\n\n\t\tthis.frm.set_query(\"quality_inspection\", \"items\", function(doc, cdt, cdn) {\n\t\t\tlet d = locals[cdt][cdn];\n\t\t\treturn {\n\t\t\t\tfilters: {\n\t\t\t\t\tdocstatus: 1,\n\t\t\t\t\tinspection_type: inspection_type,\n\t\t\t\t\treference_name: doc.name,\n\t\t\t\t\titem_code: d.item_code\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tmake_payment_request() {\n\t\tvar me = this;\n\t\tconst payment_request_type = (in_list(['Sales Order', 'Sales Invoice'], this.frm.doc.doctype))\n\t\t\t? \"Inward\" : \"Outward\";\n\n\t\tfrappe.call({\n\t\t\tmethod:\"erpnext.accounts.doctype.payment_request.payment_request.make_payment_request\",\n\t\t\targs: {\n\t\t\t\tdt: me.frm.doc.doctype,\n\t\t\t\tdn: me.frm.doc.name,\n\t\t\t\trecipient_id: me.frm.doc.contact_email,\n\t\t\t\tpayment_request_type: payment_request_type,\n\t\t\t\tparty_type: payment_request_type == 'Outward' ? \"Supplier\" : \"Customer\",\n\t\t\t\tparty: payment_request_type == 'Outward' ? me.frm.doc.supplier : me.frm.doc.customer\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tif(!r.exc){\n\t\t\t\t\tvar doc = frappe.model.sync(r.message);\n\t\t\t\t\tfrappe.set_route(\"Form\", r.message.doctype, r.message.name);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t}\n\n\tonload_post_render() {\n\t\tif(this.frm.doc.__islocal && !(this.frm.doc.taxes || []).length\n\t\t\t&& !(this.frm.doc.__onload ? this.frm.doc.__onload.load_after_mapping : false)) {\n\t\t\tfrappe.after_ajax(() => this.apply_default_taxes());\n\t\t} else if(this.frm.doc.__islocal && this.frm.doc.company && this.frm.doc[\"items\"]\n\t\t\t&& !this.frm.doc.is_pos) {\n\t\t\tfrappe.after_ajax(() => this.calculate_taxes_and_totals());\n\t\t}\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype + \" Item\", \"item_code\")) {\n\t\t\tthis.setup_item_selector();\n\t\t\tthis.frm.get_field(\"items\").grid.set_multiple_add(\"item_code\", \"qty\");\n\t\t}\n\t}\n\n\trefresh() {\n\t\terpnext.toggle_naming_series();\n\t\terpnext.hide_company();\n\t\tthis.set_dynamic_labels();\n\t\tthis.setup_sms();\n\t\tthis.setup_quality_inspection();\n\t\tlet scan_barcode_field = this.frm.get_field('scan_barcode');\n\t\tif (scan_barcode_field && scan_barcode_field.get_value()) {\n\t\t\tscan_barcode_field.set_value(\"\");\n\t\t\tscan_barcode_field.set_new_description(\"\");\n\n\t\t\tif (frappe.is_mobile()) {\n\t\t\t\tif (scan_barcode_field.$input_wrapper.find('.input-group').length) return;\n\n\t\t\t\tlet $input_group = $('<div class=\"input-group\">');\n\t\t\t\tscan_barcode_field.$input_wrapper.find('.control-input').append($input_group);\n\t\t\t\t$input_group.append(scan_barcode_field.$input);\n\t\t\t\t$(`<span class=\"input-group-btn\" style=\"vertical-align: top\">\n\t\t\t\t\t\t<button class=\"btn btn-default border\" type=\"button\">\n\t\t\t\t\t\t\t<i class=\"fa fa-camera text-muted\"></i>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</span>`)\n\t\t\t\t\t.on('click', '.btn', () => {\n\t\t\t\t\t\tfrappe.barcode.scan_barcode().then(barcode => {\n\t\t\t\t\t\t\tscan_barcode_field.set_value(barcode);\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t\t.appendTo($input_group);\n\t\t\t}\n\t\t}\n\t}\n\n\tscan_barcode() {\n\t\tlet scan_barcode_field = this.frm.fields_dict[\"scan_barcode\"];\n\n\t\tlet show_description = function(idx, exist = null) {\n\t\t\tif (exist) {\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tmessage: __('Row #{0}: Qty increased by 1', [idx]),\n\t\t\t\t\tindicator: 'green'\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tmessage: __('Row #{0}: Item added', [idx]),\n\t\t\t\t\tindicator: 'green'\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif(this.frm.doc.scan_barcode) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.selling.page.point_of_sale.point_of_sale.search_for_serial_or_batch_or_barcode_number\",\n\t\t\t\targs: { search_value: this.frm.doc.scan_barcode }\n\t\t\t}).then(r => {\n\t\t\t\tconst data = r && r.message;\n\t\t\t\tif (!data || Object.keys(data).length === 0) {\n\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\tmessage: __('Cannot find Item with this Barcode'),\n\t\t\t\t\t\tindicator: 'red'\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tlet cur_grid = this.frm.fields_dict.items.grid;\n\n\t\t\t\tlet row_to_modify = null;\n\t\t\t\tconst existing_item_row = this.frm.doc.items.find(d => d.item_code === data.item_code);\n\t\t\t\tconst blank_item_row = this.frm.doc.items.find(d => !d.item_code);\n\n\t\t\t\tif (existing_item_row) {\n\t\t\t\t\trow_to_modify = existing_item_row;\n\t\t\t\t} else if (blank_item_row) {\n\t\t\t\t\trow_to_modify = blank_item_row;\n\t\t\t\t}\n\n\t\t\t\tif (!row_to_modify) {\n\t\t\t\t\t// add new row\n\t\t\t\t\trow_to_modify = frappe.model.add_child(this.frm.doc, cur_grid.doctype, 'items');\n\t\t\t\t}\n\n\t\t\t\tshow_description(row_to_modify.idx, row_to_modify.item_code);\n\n\t\t\t\tthis.frm.from_barcode = this.frm.from_barcode ? this.frm.from_barcode + 1 : 1;\n\t\t\t\tfrappe.model.set_value(row_to_modify.doctype, row_to_modify.name, {\n\t\t\t\t\titem_code: data.item_code,\n\t\t\t\t\tqty: (row_to_modify.qty || 0) + 1\n\t\t\t\t});\n\n\t\t\t\t['serial_no', 'batch_no', 'barcode'].forEach(field => {\n\t\t\t\t\tif (data[field] && frappe.meta.has_field(row_to_modify.doctype, field)) {\n\n\t\t\t\t\t\tlet value = (row_to_modify[field] && field === \"serial_no\")\n\t\t\t\t\t\t\t? row_to_modify[field] + '\\n' + data[field] : data[field];\n\n\t\t\t\t\t\tfrappe.model.set_value(row_to_modify.doctype,\n\t\t\t\t\t\t\trow_to_modify.name, field, value);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tscan_barcode_field.set_value('');\n\t\t\t\trefresh_field(\"items\");\n\t\t\t});\n\t\t}\n\t\treturn false;\n\t}\n\n\tapply_default_taxes() {\n\t\tvar me = this;\n\t\tvar taxes_and_charges_field = frappe.meta.get_docfield(me.frm.doc.doctype, \"taxes_and_charges\",\n\t\t\tme.frm.doc.name);\n\n\t\tif (!this.frm.doc.taxes_and_charges && this.frm.doc.taxes && this.frm.doc.taxes.length > 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (taxes_and_charges_field) {\n\t\t\treturn frappe.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_default_taxes_and_charges\",\n\t\t\t\targs: {\n\t\t\t\t\t\"master_doctype\": taxes_and_charges_field.options,\n\t\t\t\t\t\"tax_template\": me.frm.doc.taxes_and_charges || \"\",\n\t\t\t\t\t\"company\": me.frm.doc.company\n\t\t\t\t},\n\t\t\t\tdebounce: 2000,\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc && r.message) {\n\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t// directly set in doc, so as not to call triggers\n\t\t\t\t\t\t\t\tif(r.message.taxes_and_charges) {\n\t\t\t\t\t\t\t\t\tme.frm.doc.taxes_and_charges = r.message.taxes_and_charges;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t// set taxes table\n\t\t\t\t\t\t\t\tif(r.message.taxes) {\n\t\t\t\t\t\t\t\t\tme.frm.set_value(\"taxes\", r.message.taxes);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t() => me.set_dynamic_labels(),\n\t\t\t\t\t\t\t() => me.calculate_taxes_and_totals()\n\t\t\t\t\t\t]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tsetup_sms() {\n\t\tvar me = this;\n\t\tlet blacklist = ['Purchase Invoice', 'BOM'];\n\t\tif(this.frm.doc.docstatus===1 && !in_list([\"Lost\", \"Stopped\", \"Closed\"], this.frm.doc.status)\n\t\t\t&& !blacklist.includes(this.frm.doctype)) {\n\t\t\tthis.frm.page.add_menu_item(__('Send SMS'), function() { me.send_sms(); });\n\t\t}\n\t}\n\n\tsend_sms() {\n\t\tvar sms_man = new erpnext.SMSManager(this.frm.doc);\n\t}\n\n\tbarcode(doc, cdt, cdn) {\n\t\tvar d = locals[cdt][cdn];\n\t\tif(d.barcode==\"\" || d.barcode==null) {\n\t\t\t// barcode cleared, remove item\n\t\t\td.item_code = \"\";\n\t\t}\n\n\t\tthis.frm.from_barcode = this.frm.from_barcode ? this.frm.from_barcode + 1 : 1;\n\t\tthis.item_code(doc, cdt, cdn);\n\t}\n\n\titem_code(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tvar update_stock = 0, show_batch_dialog = 0;\n\t\tif(['Sales Invoice'].includes(this.frm.doc.doctype)) {\n\t\t\tupdate_stock = cint(me.frm.doc.update_stock);\n\t\t\tshow_batch_dialog = update_stock;\n\n\t\t} else if((this.frm.doc.doctype === 'Purchase Receipt' && me.frm.doc.is_return) ||\n\t\t\tthis.frm.doc.doctype === 'Delivery Note') {\n\t\t\tshow_batch_dialog = 1;\n\t\t}\n\t\t// clear barcode if setting item (else barcode will take priority)\n\t\tif (this.frm.from_barcode == 0) {\n\t\t\titem.barcode = null;\n\t\t}\n\t\tthis.frm.from_barcode = this.frm.from_barcode - 1 >= 0 ? this.frm.from_barcode - 1 : 0;\n\n\n\t\tif(item.item_code || item.barcode || item.serial_no) {\n\t\t\tif(!this.validate_company_and_party()) {\n\t\t\t\tthis.frm.fields_dict[\"items\"].grid.grid_rows[item.idx - 1].remove();\n\t\t\t} else {\n\t\t\t\treturn this.frm.call({\n\t\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_item_details\",\n\t\t\t\t\tchild: item,\n\t\t\t\t\targs: {\n\t\t\t\t\t\tdoc: me.frm.doc,\n\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\titem_code: item.item_code,\n\t\t\t\t\t\t\tbarcode: item.barcode,\n\t\t\t\t\t\t\tserial_no: item.serial_no,\n\t\t\t\t\t\t\tbatch_no: item.batch_no,\n\t\t\t\t\t\t\tset_warehouse: me.frm.doc.set_warehouse,\n\t\t\t\t\t\t\twarehouse: item.warehouse,\n\t\t\t\t\t\t\tcustomer: me.frm.doc.customer || me.frm.doc.party_name,\n\t\t\t\t\t\t\tquotation_to: me.frm.doc.quotation_to,\n\t\t\t\t\t\t\tsupplier: me.frm.doc.supplier,\n\t\t\t\t\t\t\tcurrency: me.frm.doc.currency,\n\t\t\t\t\t\t\tupdate_stock: update_stock,\n\t\t\t\t\t\t\tconversion_rate: me.frm.doc.conversion_rate,\n\t\t\t\t\t\t\tprice_list: me.frm.doc.selling_price_list || me.frm.doc.buying_price_list,\n\t\t\t\t\t\t\tprice_list_currency: me.frm.doc.price_list_currency,\n\t\t\t\t\t\t\tplc_conversion_rate: me.frm.doc.plc_conversion_rate,\n\t\t\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\t\t\torder_type: me.frm.doc.order_type,\n\t\t\t\t\t\t\tis_pos: cint(me.frm.doc.is_pos),\n\t\t\t\t\t\t\tis_return: cint(me.frm.doc.is_return),\n\t\t\t\t\t\t\tis_subcontracted: me.frm.doc.is_subcontracted,\n\t\t\t\t\t\t\ttransaction_date: me.frm.doc.transaction_date || me.frm.doc.posting_date,\n\t\t\t\t\t\t\tignore_pricing_rule: me.frm.doc.ignore_pricing_rule,\n\t\t\t\t\t\t\tdoctype: me.frm.doc.doctype,\n\t\t\t\t\t\t\tname: me.frm.doc.name,\n\t\t\t\t\t\t\tproject: item.project || me.frm.doc.project,\n\t\t\t\t\t\t\tqty: item.qty || 1,\n\t\t\t\t\t\t\tnet_rate: item.rate,\n\t\t\t\t\t\t\tstock_qty: item.stock_qty,\n\t\t\t\t\t\t\tconversion_factor: item.conversion_factor,\n\t\t\t\t\t\t\tweight_per_unit: item.weight_per_unit,\n\t\t\t\t\t\t\tweight_uom: item.weight_uom,\n\t\t\t\t\t\t\tmanufacturer: item.manufacturer,\n\t\t\t\t\t\t\tstock_uom: item.stock_uom,\n\t\t\t\t\t\t\tpos_profile: cint(me.frm.doc.is_pos) ? me.frm.doc.pos_profile : '',\n\t\t\t\t\t\t\tcost_center: item.cost_center,\n\t\t\t\t\t\t\ttax_category: me.frm.doc.tax_category,\n\t\t\t\t\t\t\titem_tax_template: item.item_tax_template,\n\t\t\t\t\t\t\tchild_docname: item.name\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\n\t\t\t\t\tcallback: function(r) {\n\t\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tvar d = locals[cdt][cdn];\n\t\t\t\t\t\t\t\t\tme.add_taxes_from_item_tax_template(d.item_tax_rate);\n\t\t\t\t\t\t\t\t\tif (d.free_item_data) {\n\t\t\t\t\t\t\t\t\t\tme.apply_product_discount(d);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\t// for internal customer instead of pricing rule directly apply valuation rate on item\n\t\t\t\t\t\t\t\t\tif (me.frm.doc.is_internal_customer || me.frm.doc.is_internal_supplier) {\n\t\t\t\t\t\t\t\t\t\tme.get_incoming_rate(item, me.frm.posting_date, me.frm.posting_time,\n\t\t\t\t\t\t\t\t\t\t\tme.frm.doc.doctype, me.frm.doc.company);\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tme.frm.script_manager.trigger(\"price_list_rate\", cdt, cdn);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif (me.frm.doc.is_internal_customer || me.frm.doc.is_internal_supplier) {\n\t\t\t\t\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => me.toggle_conversion_factor(item),\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif (show_batch_dialog)\n\t\t\t\t\t\t\t\t\t\treturn frappe.db.get_value(\"Item\", item.item_code, [\"has_batch_no\", \"has_serial_no\"])\n\t\t\t\t\t\t\t\t\t\t\t.then((r) => {\n\t\t\t\t\t\t\t\t\t\t\t\tif (r.message &&\n\t\t\t\t\t\t\t\t\t\t\t\t(r.message.has_batch_no || r.message.has_serial_no)) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfrappe.flags.hide_serial_batch_dialog = false;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\t// check if batch serial selector is disabled or not\n\t\t\t\t\t\t\t\t\tif (show_batch_dialog && !frappe.flags.hide_serial_batch_dialog)\n\t\t\t\t\t\t\t\t\t\treturn frappe.db.get_single_value('Stock Settings', 'disable_serial_no_and_batch_selector')\n\t\t\t\t\t\t\t\t\t\t\t.then((value) => {\n\t\t\t\t\t\t\t\t\t\t\t\tif (value) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfrappe.flags.hide_serial_batch_dialog = true;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif(show_batch_dialog && !frappe.flags.hide_serial_batch_dialog) {\n\t\t\t\t\t\t\t\t\t\tvar d = locals[cdt][cdn];\n\t\t\t\t\t\t\t\t\t\t$.each(r.message, function(k, v) {\n\t\t\t\t\t\t\t\t\t\t\tif(!d[k]) d[k] = v;\n\t\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\t\tif (d.has_batch_no && d.has_serial_no) {\n\t\t\t\t\t\t\t\t\t\t\td.batch_no = undefined;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\terpnext.show_serial_batch_selector(me.frm, d, (item) => {\n\t\t\t\t\t\t\t\t\t\t\tme.frm.script_manager.trigger('qty', item.doctype, item.name);\n\t\t\t\t\t\t\t\t\t\t\tif (!me.frm.doc.set_warehouse)\n\t\t\t\t\t\t\t\t\t\t\t\tme.frm.script_manager.trigger('warehouse', item.doctype, item.name);\n\t\t\t\t\t\t\t\t\t\t}, undefined, !frappe.flags.hide_serial_batch_dialog);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => me.conversion_factor(doc, cdt, cdn, true),\n\t\t\t\t\t\t\t\t() => me.remove_pricing_rule(item),\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif (item.apply_rule_on_other_items) {\n\t\t\t\t\t\t\t\t\t\tlet key = item.name;\n\t\t\t\t\t\t\t\t\t\tme.apply_rule_on_other_items({key: item});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tvar company_currency = me.get_company_currency();\n\t\t\t\t\t\t\t\t\tme.update_item_grid_labels(company_currency);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tprice_list_rate(doc, cdt, cdn) {\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tfrappe.model.round_floats_in(item, [\"price_list_rate\", \"discount_percentage\"]);\n\n\t\t// check if child doctype is Sales Order Item/Qutation Item and calculate the rate\n\t\tif (in_list([\"Quotation Item\", \"Sales Order Item\", \"Delivery Note Item\", \"Sales Invoice Item\", \"POS Invoice Item\", \"Purchase Invoice Item\", \"Purchase Order Item\", \"Purchase Receipt Item\",\"Proforma Invoice Item\"]), cdt)\n\t\t\tthis.apply_pricing_rule_on_item(item);\n\t\telse\n\t\t\titem.rate = flt(item.price_list_rate * (1 - item.discount_percentage / 100.0),\n\t\t\t\tprecision(\"rate\", item));\n\n\t\tthis.calculate_taxes_and_totals();\n\t}\n\n\tmargin_rate_or_amount(doc, cdt, cdn) {\n\t\t// calculated the revised total margin and rate on margin rate changes\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\tthis.apply_pricing_rule_on_item(item);\n\t\tthis.calculate_taxes_and_totals();\n\t\tcur_frm.refresh_fields();\n\t}\n\n\tmargin_type(doc, cdt, cdn) {\n\t\t// calculate the revised total margin and rate on margin type changes\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\tif (!item.margin_type) {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"margin_rate_or_amount\", 0);\n\t\t} else {\n\t\t\tthis.apply_pricing_rule_on_item(item, doc, cdt, cdn);\n\t\t\tthis.calculate_taxes_and_totals();\n\t\t\tcur_frm.refresh_fields();\n\t\t}\n\t}\n\n\tget_incoming_rate(item, posting_date, posting_time, voucher_type, company) {\n\n\t\tlet item_args = {\n\t\t\t'item_code': item.item_code,\n\t\t\t'warehouse': in_list('Purchase Receipt', 'Purchase Invoice') ? item.from_warehouse : item.warehouse,\n\t\t\t'posting_date': posting_date,\n\t\t\t'posting_time': posting_time,\n\t\t\t'qty': item.qty * item.conversion_factor,\n\t\t\t'serial_no': item.serial_no,\n\t\t\t'voucher_type': voucher_type,\n\t\t\t'company': company,\n\t\t\t'allow_zero_valuation_rate': item.allow_zero_valuation_rate\n\t\t}\n\n\t\tfrappe.call({\n\t\t\tmethod: 'erpnext.stock.utils.get_incoming_rate',\n\t\t\targs: {\n\t\t\t\targs: item_args\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tfrappe.model.set_value(item.doctype, item.name, 'rate', r.message * item.conversion_factor);\n\t\t\t}\n\t\t});\n\t}\n\n\tserial_no(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\n\t\tif (item && item.doctype === 'Purchase Receipt Item Supplied') {\n\t\t\treturn;\n\t\t}\n\n\t\tif (item && item.serial_no) {\n\t\t\tif (!item.item_code) {\n\t\t\t\tthis.frm.trigger(\"item_code\", cdt, cdn);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Replacing all occurences of comma with carriage return\n\t\t\t\titem.serial_no = item.serial_no.replace(/,/g, '\\n');\n\t\t\t\titem.conversion_factor = item.conversion_factor || 1;\n\t\t\t\trefresh_field(\"serial_no\", item.name, item.parentfield);\n\t\t\t\tif (!doc.is_return && cint(frappe.user_defaults.set_qty_in_transactions_based_on_serial_no_input)) {\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tme.update_qty(cdt, cdn);\n\t\t\t\t\t}, 10000);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tupdate_qty(cdt, cdn) {\n\t\tvar valid_serial_nos = [];\n\t\tvar serialnos = [];\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tserialnos = item.serial_no.split(\"\\n\");\n\t\tfor (var i = 0; i < serialnos.length; i++) {\n\t\t\tif (serialnos[i] != \"\") {\n\t\t\t\tvalid_serial_nos.push(serialnos[i]);\n\t\t\t}\n\t\t}\n\t\tfrappe.model.set_value(item.doctype, item.name,\n\t\t\t\"qty\", valid_serial_nos.length / item.conversion_factor);\n\t\tfrappe.model.set_value(item.doctype, item.name, \"stock_qty\", valid_serial_nos.length);\n\t}\n\n\tvalidate() {\n\t\tthis.calculate_taxes_and_totals(false);\n\t}\n\n\tupdate_stock() {\n\t\tthis.frm.trigger('set_default_internal_warehouse');\n\t}\n\n\tset_default_internal_warehouse() {\n\t\tlet me = this;\n\t\tif ((this.frm.doc.doctype === 'Sales Invoice' && me.frm.doc.update_stock)\n\t\t\t|| this.frm.doc.doctype == 'Delivery Note') {\n\t\t\tif (this.frm.doc.is_internal_customer && this.frm.doc.company === this.frm.doc.represents_company) {\n\t\t\t\tfrappe.db.get_value('Company', this.frm.doc.company, 'default_in_transit_warehouse', function(value) {\n\t\t\t\t\tme.frm.set_value('set_target_warehouse', value.default_in_transit_warehouse);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif ((this.frm.doc.doctype === 'Purchase Invoice' && me.frm.doc.update_stock)\n\t\t\t|| this.frm.doc.doctype == 'Purchase Receipt') {\n\t\t\tif (this.frm.doc.is_internal_supplier && this.frm.doc.company === this.frm.doc.represents_company) {\n\t\t\t\tfrappe.db.get_value('Company', this.frm.doc.company, 'default_in_transit_warehouse', function(value) {\n\t\t\t\t\tme.frm.set_value('set_from_warehouse', value.default_in_transit_warehouse);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tcompany() {\n\t\tvar me = this;\n\t\tvar set_pricing = function() {\n\t\t\tif(me.frm.doc.company && me.frm.fields_dict.currency) {\n\t\t\t\tvar company_currency = me.get_company_currency();\n\t\t\t\tvar company_doc = frappe.get_doc(\":Company\", me.frm.doc.company);\n\n\t\t\t\tif (!me.frm.doc.currency) {\n\t\t\t\t\tme.frm.set_value(\"currency\", company_currency);\n\t\t\t\t}\n\n\t\t\t\tif (me.frm.doc.currency == company_currency) {\n\t\t\t\t\tme.frm.set_value(\"conversion_rate\", 1.0);\n\t\t\t\t}\n\t\t\t\tif (me.frm.doc.price_list_currency == company_currency) {\n\t\t\t\t\tme.frm.set_value('plc_conversion_rate', 1.0);\n\t\t\t\t}\n\t\t\t\tif (company_doc.default_letter_head) {\n\t\t\t\t\tif(me.frm.fields_dict.letter_head) {\n\t\t\t\t\t\tme.frm.set_value(\"letter_head\", company_doc.default_letter_head);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlet selling_doctypes_for_tc = [\"Sales Invoice\", \"Quotation\", \"Sales Order\", \"Delivery Note\",\"Proforma Invoice\"];\n\t\t\t\tif (company_doc.default_selling_terms && frappe.meta.has_field(me.frm.doc.doctype, \"tc_name\") &&\n\t\t\t\tselling_doctypes_for_tc.indexOf(me.frm.doc.doctype) != -1) {\n\t\t\t\t\tme.frm.set_value(\"tc_name\", company_doc.default_selling_terms);\n\t\t\t\t}\n\t\t\t\tlet buying_doctypes_for_tc = [\"Request for Quotation\", \"Supplier Quotation\", \"Purchase Order\",\n\t\t\t\t\t\"Material Request\", \"Purchase Receipt\"];\n\t\t\t\t// Purchase Invoice is excluded as per issue #3345\n\t\t\t\tif (company_doc.default_buying_terms && frappe.meta.has_field(me.frm.doc.doctype, \"tc_name\") &&\n\t\t\t\tbuying_doctypes_for_tc.indexOf(me.frm.doc.doctype) != -1) {\n\t\t\t\t\tme.frm.set_value(\"tc_name\", company_doc.default_buying_terms);\n\t\t\t\t}\n\n\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t() => me.frm.script_manager.trigger(\"currency\"),\n\t\t\t\t\t() => me.update_item_tax_map(),\n\t\t\t\t\t() => me.apply_default_taxes(),\n\t\t\t\t\t() => me.apply_pricing_rule()\n\t\t\t\t]);\n\t\t\t}\n\t\t}\n\n\t\tvar set_party_account = function(set_pricing) {\n\t\t\tif (in_list([\"Sales Invoice\", \"Purchase Invoice\"], me.frm.doc.doctype)) {\n\t\t\t\tif(me.frm.doc.doctype==\"Sales Invoice\") {\n\t\t\t\t\tvar party_type = \"Customer\";\n\t\t\t\t\tvar party_account_field = 'debit_to';\n\t\t\t\t} else {\n\t\t\t\t\tvar party_type = \"Supplier\";\n\t\t\t\t\tvar party_account_field = 'credit_to';\n\t\t\t\t}\n\n\t\t\t\tvar party = me.frm.doc[frappe.model.scrub(party_type)];\n\t\t\t\tif(party && me.frm.doc.company) {\n\t\t\t\t\treturn frappe.call({\n\t\t\t\t\t\tmethod: \"erpnext.accounts.party.get_party_account\",\n\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\t\t\tparty_type: party_type,\n\t\t\t\t\t\t\tparty: party\n\t\t\t\t\t\t},\n\t\t\t\t\t\tcallback: function(r) {\n\t\t\t\t\t\t\tif(!r.exc && r.message) {\n\t\t\t\t\t\t\t\tme.frm.set_value(party_account_field, r.message);\n\t\t\t\t\t\t\t\tset_pricing();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tset_pricing();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tset_pricing();\n\t\t\t}\n\n\t\t}\n\n\t\tif (frappe.meta.get_docfield(this.frm.doctype, \"shipping_address\") &&\n\t\t\tin_list(['Purchase Order', 'Purchase Receipt', 'Purchase Invoice'], this.frm.doctype)) {\n\t\t\terpnext.utils.get_shipping_address(this.frm, function(){\n\t\t\t\tset_party_account(set_pricing);\n\t\t\t});\n\n\t\t\t// Get default company billing address in Purchase Invoice, Order and Receipt\n\t\t\tfrappe.call({\n\t\t\t\t'method': 'frappe.contacts.doctype.address.address.get_default_address',\n\t\t\t\t'args': {\n\t\t\t\t\t'doctype': 'Company',\n\t\t\t\t\t'name': this.frm.doc.company\n\t\t\t\t},\n\t\t\t\t'callback': function(r) {\n\t\t\t\t\tme.frm.set_value('billing_address', r.message);\n\t\t\t\t}\n\t\t\t});\n\n\t\t} else {\n\t\t\tset_party_account(set_pricing);\n\t\t}\n\n\t\tif(this.frm.doc.company) {\n\t\t\terpnext.last_selected_company = this.frm.doc.company;\n\t\t}\n\t}\n\n\ttransaction_date() {\n\t\tif (this.frm.doc.transaction_date) {\n\t\t\tthis.frm.transaction_date = this.frm.doc.transaction_date;\n\t\t\tfrappe.ui.form.trigger(this.frm.doc.doctype, \"currency\");\n\t\t}\n\t}\n\n\tposting_date() {\n\t\tvar me = this;\n\t\tif (this.frm.doc.posting_date) {\n\t\t\tthis.frm.posting_date = this.frm.doc.posting_date;\n\n\t\t\tif ((this.frm.doc.doctype == \"Sales Invoice\" && this.frm.doc.customer) ||\n\t\t\t\t(this.frm.doc.doctype == \"Purchase Invoice\" && this.frm.doc.supplier)) {\n\t\t\t\treturn frappe.call({\n\t\t\t\t\tmethod: \"erpnext.accounts.party.get_due_date\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\t\"posting_date\": me.frm.doc.posting_date,\n\t\t\t\t\t\t\"party_type\": me.frm.doc.doctype == \"Sales Invoice\" ? \"Customer\" : \"Supplier\",\n\t\t\t\t\t\t\"bill_date\": me.frm.doc.bill_date,\n\t\t\t\t\t\t\"party\": me.frm.doc.doctype == \"Sales Invoice\" ? me.frm.doc.customer : me.frm.doc.supplier,\n\t\t\t\t\t\t\"company\": me.frm.doc.company\n\t\t\t\t\t},\n\t\t\t\t\tcallback: function(r, rt) {\n\t\t\t\t\t\tif(r.message) {\n\t\t\t\t\t\t\tme.frm.doc.due_date = r.message;\n\t\t\t\t\t\t\trefresh_field(\"due_date\");\n\t\t\t\t\t\t\tfrappe.ui.form.trigger(me.frm.doc.doctype, \"currency\");\n\t\t\t\t\t\t\tme.recalculate_terms();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tfrappe.ui.form.trigger(me.frm.doc.doctype, \"currency\");\n\t\t\t}\n\t\t}\n\t}\n\n\tdue_date() {\n\t\t// due_date is to be changed, payment terms template and/or payment schedule must\n\t\t// be removed as due_date is automatically changed based on payment terms\n\t\tif (this.frm.doc.due_date && !this.frm.updating_party_details && !this.frm.doc.is_pos) {\n\t\t\tif (this.frm.doc.payment_terms_template ||\n\t\t\t\t(this.frm.doc.payment_schedule && this.frm.doc.payment_schedule.length)) {\n\t\t\t\tvar message1 = \"\";\n\t\t\t\tvar message2 = \"\";\n\t\t\t\tvar final_message = __(\"Please clear the\") + \" \";\n\n\t\t\t\tif (this.frm.doc.payment_terms_template) {\n\t\t\t\t\tmessage1 = __(\"selected Payment Terms Template\");\n\t\t\t\t\tfinal_message = final_message + message1;\n\t\t\t\t}\n\n\t\t\t\tif ((this.frm.doc.payment_schedule || []).length) {\n\t\t\t\t\tmessage2 = __(\"Payment Schedule Table\");\n\t\t\t\t\tif (message1.length !== 0) message2 = \" and \" + message2;\n\t\t\t\t\tfinal_message = final_message + message2;\n\t\t\t\t}\n\t\t\t\tfrappe.msgprint(final_message);\n\t\t\t}\n\t\t}\n\t}\n\n\tbill_date() {\n\t\tthis.posting_date();\n\t}\n\n\trecalculate_terms() {\n\t\tconst doc = this.frm.doc;\n\t\tif (doc.payment_terms_template) {\n\t\t\tthis.payment_terms_template();\n\t\t} else if (doc.payment_schedule) {\n\t\t\tconst me = this;\n\t\t\tdoc.payment_schedule.forEach(\n\t\t\t\tfunction(term) {\n\t\t\t\t\tif (term.payment_term) {\n\t\t\t\t\t\tme.payment_term(doc, term.doctype, term.name);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfrappe.model.set_value(\n\t\t\t\t\t\t\tterm.doctype, term.name, 'due_date',\n\t\t\t\t\t\t\tdoc.posting_date || doc.transaction_date\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t}\n\n\tget_company_currency() {\n\t\treturn erpnext.get_currency(this.frm.doc.company);\n\t}\n\n\tcontact_person() {\n\t\terpnext.utils.get_contact_details(this.frm);\n\t}\n\n\tcurrency() {\n\t\t/* manqala 19/09/2016: let the translation date be whichever of the transaction_date or posting_date is available */\n\t\tvar transaction_date = this.frm.doc.transaction_date || this.frm.doc.posting_date;\n\t\t/* end manqala */\n\t\tvar me = this;\n\t\tthis.set_dynamic_labels();\n\t\tvar company_currency = this.get_company_currency();\n\t\t// Added `ignore_pricing_rule` to determine if document is loading after mapping from another doc\n\t\tif(this.frm.doc.currency && this.frm.doc.currency !== company_currency\n\t\t\t\t&& !this.frm.doc.ignore_pricing_rule) {\n\n\t\t\tthis.get_exchange_rate(transaction_date, this.frm.doc.currency, company_currency,\n\t\t\t\tfunction(exchange_rate) {\n\t\t\t\t\tif(exchange_rate != me.frm.doc.conversion_rate) {\n\t\t\t\t\t\tme.set_margin_amount_based_on_currency(exchange_rate);\n\t\t\t\t\t\tme.set_actual_charges_based_on_currency(exchange_rate);\n\t\t\t\t\t\tme.frm.set_value(\"conversion_rate\", exchange_rate);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t} else {\n\t\t\tthis.conversion_rate();\n\t\t}\n\t}\n\n\tconversion_rate() {\n\t\tconst me = this.frm;\n\t\tif(this.frm.doc.currency === this.get_company_currency()) {\n\t\t\tthis.frm.set_value(\"conversion_rate\", 1.0);\n\t\t}\n\t\tif(this.frm.doc.currency === this.frm.doc.price_list_currency &&\n\t\t\tthis.frm.doc.plc_conversion_rate !== this.frm.doc.conversion_rate) {\n\t\t\tthis.frm.set_value(\"plc_conversion_rate\", this.frm.doc.conversion_rate);\n\t\t}\n\n\t\tif(flt(this.frm.doc.conversion_rate)>0.0) {\n\t\t\tif(this.frm.doc.ignore_pricing_rule) {\n\t\t\t\tthis.calculate_taxes_and_totals();\n\t\t\t} else if (this.in_apply_price_list){\n\t\t\t\tthis.apply_price_list();\n\t\t\t}\n\n\t\t}\n\t\t// Make read only if Accounts Settings doesn't allow stale rates\n\t\tthis.frm.set_df_property(\"conversion_rate\", \"read_only\", erpnext.stale_rate_allowed() ? 0 : 1);\n\t}\n\n\tshipping_rule() {\n\t\tvar me = this;\n\t\tif(this.frm.doc.shipping_rule) {\n\t\t\treturn this.frm.call({\n\t\t\t\tdoc: this.frm.doc,\n\t\t\t\tmethod: \"apply_shipping_rule\",\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}).fail(() => this.frm.set_value('shipping_rule', ''));\n\t\t}\n\t\telse {\n\t\t\tme.calculate_taxes_and_totals();\n\t\t}\n\t}\n\n\tset_margin_amount_based_on_currency(exchange_rate) {\n\t\tif (in_list([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\", \"Purchase Invoice\", \"Purchase Order\", \"Purchase Receipt\",\"Proforma Invoice\"]), this.frm.doc.doctype) {\n\t\t\tvar me = this;\n\t\t\t$.each(this.frm.doc.items || [], function(i, d) {\n\t\t\t\tif(d.margin_type == \"Amount\") {\n\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"margin_rate_or_amount\",\n\t\t\t\t\t\tflt(d.margin_rate_or_amount) / flt(exchange_rate));\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tset_actual_charges_based_on_currency(exchange_rate) {\n\t\tvar me = this;\n\t\t$.each(this.frm.doc.taxes || [], function(i, d) {\n\t\t\tif(d.charge_type == \"Actual\") {\n\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"tax_amount\",\n\t\t\t\t\tflt(d.tax_amount) / flt(exchange_rate));\n\t\t\t}\n\t\t});\n\t}\n\n\tget_exchange_rate(transaction_date, from_currency, to_currency, callback) {\n\t\tvar args;\n\t\tif ([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\",\"Proforma Invoice\"].includes(this.frm.doctype)) {\n\t\t\targs = \"for_selling\";\n\t\t}\n\t\telse if ([\"Purchase Order\", \"Purchase Receipt\", \"Purchase Invoice\"].includes(this.frm.doctype)) {\n\t\t\targs = \"for_buying\";\n\t\t}\n\n\t\tif (!transaction_date || !from_currency || !to_currency) return;\n\t\treturn frappe.call({\n\t\t\tmethod: \"erpnext.setup.utils.get_exchange_rate\",\n\t\t\targs: {\n\t\t\t\ttransaction_date: transaction_date,\n\t\t\t\tfrom_currency: from_currency,\n\t\t\t\tto_currency: to_currency,\n\t\t\t\targs: args\n\t\t\t},\n\t\t\tfreeze: true,\n\t\t\tfreeze_message: __(\"Fetching exchange rates ...\"),\n\t\t\tcallback: function(r) {\n\t\t\t\tcallback(flt(r.message));\n\t\t\t}\n\t\t});\n\t}\n\n\tprice_list_currency() {\n\t\tvar me=this;\n\t\tthis.set_dynamic_labels();\n\n\t\tvar company_currency = this.get_company_currency();\n\t\t// Added `ignore_pricing_rule` to determine if document is loading after mapping from another doc\n\t\tif(this.frm.doc.price_list_currency !== company_currency  && !this.frm.doc.ignore_pricing_rule) {\n\t\t\tthis.get_exchange_rate(this.frm.doc.posting_date, this.frm.doc.price_list_currency, company_currency,\n\t\t\t\tfunction(exchange_rate) {\n\t\t\t\t\tme.frm.set_value(\"plc_conversion_rate\", exchange_rate);\n\t\t\t\t});\n\t\t} else {\n\t\t\tthis.plc_conversion_rate();\n\t\t}\n\t}\n\n\tplc_conversion_rate() {\n\t\tif(this.frm.doc.price_list_currency === this.get_company_currency()) {\n\t\t\tthis.frm.set_value(\"plc_conversion_rate\", 1.0);\n\t\t} else if(this.frm.doc.price_list_currency === this.frm.doc.currency\n\t\t\t&& this.frm.doc.plc_conversion_rate && cint(this.frm.doc.plc_conversion_rate) != 1 &&\n\t\t\tcint(this.frm.doc.plc_conversion_rate) != cint(this.frm.doc.conversion_rate)) {\n\t\t\tthis.frm.set_value(\"conversion_rate\", this.frm.doc.plc_conversion_rate);\n\t\t}\n\n\t\tif(!this.in_apply_price_list) {\n\t\t\tthis.apply_price_list(null, true);\n\t\t}\n\t}\n\n\tuom(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tif(item.item_code && item.uom) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_conversion_factor\",\n\t\t\t\targs: {\n\t\t\t\t\titem_code: item.item_code,\n\t\t\t\t\tuom: item.uom\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, 'conversion_factor', r.message.conversion_factor);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tme.calculate_stock_uom_rate(doc, cdt, cdn);\n\t}\n\n\tconversion_factor(doc, cdt, cdn, dont_fetch_price_list_rate) {\n\t\tif(frappe.meta.get_docfield(cdt, \"stock_qty\", cdn)) {\n\t\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\t\tfrappe.model.round_floats_in(item, [\"qty\", \"conversion_factor\"]);\n\t\t\titem.stock_qty = flt(item.qty * item.conversion_factor, precision(\"stock_qty\", item));\n\t\t\trefresh_field(\"stock_qty\", item.name, item.parentfield);\n\t\t\tthis.toggle_conversion_factor(item);\n\n\t\t\tif(doc.doctype != \"Material Request\") {\n\t\t\t\titem.total_weight = flt(item.stock_qty * item.weight_per_unit);\n\t\t\t\trefresh_field(\"total_weight\", item.name, item.parentfield);\n\t\t\t\tthis.calculate_net_weight();\n\t\t\t}\n\n\t\t\t// for handling customization not to fetch price list rate\n\t\t\tif(frappe.flags.dont_fetch_price_list_rate) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tif (!dont_fetch_price_list_rate &&\n\t\t\t\tfrappe.meta.has_field(doc.doctype, \"price_list_currency\")) {\n\t\t\t\tthis.apply_price_list(item, true);\n\t\t\t}\n\t\t\tthis.calculate_stock_uom_rate(doc, cdt, cdn);\n\t\t}\n\t}\n\n\tbatch_no(doc, cdt, cdn) {\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\tthis.apply_price_list(item, true);\n\t}\n\n\ttoggle_conversion_factor(item) {\n\t\t// toggle read only property for conversion factor field if the uom and stock uom are same\n\t\tif(this.frm.get_field('items').grid.fields_map.conversion_factor) {\n\t\t\tthis.frm.fields_dict.items.grid.toggle_enable(\"conversion_factor\",\n\t\t\t\t((item.uom != item.stock_uom) && !frappe.meta.get_docfield(cur_frm.fields_dict.items.grid.doctype, \"conversion_factor\").read_only)? true: false);\n\t\t}\n\n\t}\n\n\tqty(doc, cdt, cdn) {\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\tthis.conversion_factor(doc, cdt, cdn, true);\n\t\tthis.calculate_stock_uom_rate(doc, cdt, cdn);\n\t\tthis.apply_pricing_rule(item, true);\n\t}\n\n\tcalculate_stock_uom_rate(doc, cdt, cdn) {\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\titem.stock_uom_rate = flt(item.rate)/flt(item.conversion_factor);\n\t\trefresh_field(\"stock_uom_rate\", item.name, item.parentfield);\n\t}\n\tservice_stop_date(frm, cdt, cdn) {\n\t\tvar child = locals[cdt][cdn];\n\n\t\tif(child.service_stop_date) {\n\t\t\tlet start_date = Date.parse(child.service_start_date);\n\t\t\tlet end_date = Date.parse(child.service_end_date);\n\t\t\tlet stop_date = Date.parse(child.service_stop_date);\n\n\t\t\tif(stop_date < start_date) {\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"service_stop_date\", \"\");\n\t\t\t\tfrappe.throw(__(\"Service Stop Date cannot be before Service Start Date\"));\n\t\t\t} else if (stop_date > end_date) {\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"service_stop_date\", \"\");\n\t\t\t\tfrappe.throw(__(\"Service Stop Date cannot be after Service End Date\"));\n\t\t\t}\n\t\t}\n\t}\n\n\tservice_start_date(frm, cdt, cdn) {\n\t\tvar child = locals[cdt][cdn];\n\n\t\tif(child.service_start_date) {\n\t\t\tfrappe.call({\n\t\t\t\t\"method\": \"erpnext.stock.get_item_details.calculate_service_end_date\",\n\t\t\t\targs: {\"args\": child},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"service_end_date\", r.message.service_end_date);\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}\n\n\tcalculate_net_weight(){\n\t\t/* Calculate Total Net Weight then further applied shipping rule to calculate shipping charges.*/\n\t\tvar me = this;\n\t\tthis.frm.doc.total_net_weight= 0.0;\n\n\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\tme.frm.doc.total_net_weight += flt(item.total_weight);\n\t\t});\n\t\trefresh_field(\"total_net_weight\");\n\t\tthis.shipping_rule();\n\t}\n\n\tset_dynamic_labels() {\n\t\t// What TODO? should we make price list system non-mandatory?\n\t\tthis.frm.toggle_reqd(\"plc_conversion_rate\",\n\t\t\t!!(this.frm.doc.price_list_name && this.frm.doc.price_list_currency));\n\n\t\tvar company_currency = this.get_company_currency();\n\t\tthis.change_form_labels(company_currency);\n\t\tthis.change_grid_labels(company_currency);\n\t\tthis.frm.refresh_fields();\n\t}\n\n\tchange_form_labels(company_currency) {\n\t\tvar me = this;\n\n\t\tthis.frm.set_currency_labels([\"base_total\", \"base_net_total\", \"base_total_taxes_and_charges\",\n\t\t\t\"base_discount_amount\", \"base_grand_total\", \"base_rounded_total\", \"base_in_words\",\n\t\t\t\"base_taxes_and_charges_added\", \"base_taxes_and_charges_deducted\", \"total_amount_to_pay\",\n\t\t\t\"base_paid_amount\", \"base_write_off_amount\", \"base_change_amount\", \"base_operating_cost\",\n\t\t\t\"base_raw_material_cost\", \"base_total_cost\", \"base_scrap_material_cost\",\n\t\t\t\"base_rounding_adjustment\"], company_currency);\n\n\t\tthis.frm.set_currency_labels([\"total\", \"net_total\", \"total_taxes_and_charges\", \"discount_amount\",\n\t\t\t\"grand_total\", \"taxes_and_charges_added\", \"taxes_and_charges_deducted\",\n\t\t\t\"rounded_total\", \"in_words\", \"paid_amount\", \"write_off_amount\", \"operating_cost\",\n\t\t\t\"scrap_material_cost\", \"rounding_adjustment\", \"raw_material_cost\",\n\t\t\t\"total_cost\"], this.frm.doc.currency);\n\n\t\tthis.frm.set_currency_labels([\"outstanding_amount\", \"total_advance\"],\n\t\t\tthis.frm.doc.party_account_currency);\n\n\t\tcur_frm.set_df_property(\"conversion_rate\", \"description\", \"1 \" + this.frm.doc.currency\n\t\t\t+ \" = [?] \" + company_currency);\n\n\t\tif(this.frm.doc.price_list_currency && this.frm.doc.price_list_currency!=company_currency) {\n\t\t\tcur_frm.set_df_property(\"plc_conversion_rate\", \"description\", \"1 \"\n\t\t\t\t+ this.frm.doc.price_list_currency + \" = [?] \" + company_currency);\n\t\t}\n\n\t\t// toggle fields\n\t\tthis.frm.toggle_display([\"conversion_rate\", \"base_total\", \"base_net_total\",\n\t\t\t\"base_total_taxes_and_charges\", \"base_taxes_and_charges_added\", \"base_taxes_and_charges_deducted\",\n\t\t\t\"base_grand_total\", \"base_rounded_total\", \"base_in_words\", \"base_discount_amount\",\n\t\t\t\"base_paid_amount\", \"base_write_off_amount\", \"base_operating_cost\", \"base_raw_material_cost\",\n\t\t\t\"base_total_cost\", \"base_scrap_material_cost\", \"base_rounding_adjustment\"],\n\t\tthis.frm.doc.currency != company_currency);\n\n\t\tthis.frm.toggle_display([\"plc_conversion_rate\", \"price_list_currency\"],\n\t\t\tthis.frm.doc.price_list_currency != company_currency);\n\n\t\tvar show = cint(cur_frm.doc.discount_amount) ||\n\t\t\t\t((cur_frm.doc.taxes || []).filter(function(d) {return d.included_in_print_rate===1}).length);\n\n\t\tif(frappe.meta.get_docfield(cur_frm.doctype, \"net_total\"))\n\t\t\tcur_frm.toggle_display(\"net_total\", show);\n\n\t\tif(frappe.meta.get_docfield(cur_frm.doctype, \"base_net_total\"))\n\t\t\tcur_frm.toggle_display(\"base_net_total\", (show && (me.frm.doc.currency != company_currency)));\n\n\t}\n\n\tchange_grid_labels(company_currency) {\n\t\tvar me = this;\n\n\t\tthis.update_item_grid_labels(company_currency);\n\n\t\tthis.toggle_item_grid_columns(company_currency);\n\n\t\tif (this.frm.doc.operations && this.frm.doc.operations.length > 0) {\n\t\t\tthis.frm.set_currency_labels([\"operating_cost\", \"hour_rate\"], this.frm.doc.currency, \"operations\");\n\t\t\tthis.frm.set_currency_labels([\"base_operating_cost\", \"base_hour_rate\"], company_currency, \"operations\");\n\n\t\t\tvar item_grid = this.frm.fields_dict[\"operations\"].grid;\n\t\t\t$.each([\"base_operating_cost\", \"base_hour_rate\"], function(i, fname) {\n\t\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\t\titem_grid.set_column_disp(fname, me.frm.doc.currency != company_currency);\n\t\t\t});\n\t\t}\n\n\t\tif (this.frm.doc.scrap_items && this.frm.doc.scrap_items.length > 0) {\n\t\t\tthis.frm.set_currency_labels([\"rate\", \"amount\"], this.frm.doc.currency, \"scrap_items\");\n\t\t\tthis.frm.set_currency_labels([\"base_rate\", \"base_amount\"], company_currency, \"scrap_items\");\n\n\t\t\tvar item_grid = this.frm.fields_dict[\"scrap_items\"].grid;\n\t\t\t$.each([\"base_rate\", \"base_amount\"], function(i, fname) {\n\t\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\t\titem_grid.set_column_disp(fname, me.frm.doc.currency != company_currency);\n\t\t\t});\n\t\t}\n\n\t\tif (this.frm.doc.taxes && this.frm.doc.taxes.length > 0) {\n\t\t\tthis.frm.set_currency_labels([\"tax_amount\", \"total\", \"tax_amount_after_discount\"], this.frm.doc.currency, \"taxes\");\n\n\t\t\tthis.frm.set_currency_labels([\"base_tax_amount\", \"base_total\", \"base_tax_amount_after_discount\"], company_currency, \"taxes\");\n\t\t}\n\n\t\tif (this.frm.doc.advances && this.frm.doc.advances.length > 0) {\n\t\t\tthis.frm.set_currency_labels([\"advance_amount\", \"allocated_amount\"],\n\t\t\t\tthis.frm.doc.party_account_currency, \"advances\");\n\t\t}\n\n\t\tthis.update_payment_schedule_grid_labels(company_currency);\n\t}\n\n\tupdate_item_grid_labels(company_currency) {\n\t\tthis.frm.set_currency_labels([\n\t\t\t\"base_rate\", \"base_net_rate\", \"base_price_list_rate\",\n\t\t\t\"base_amount\", \"base_net_amount\", \"base_rate_with_margin\"\n\t\t], company_currency, \"items\");\n\n\t\tthis.frm.set_currency_labels([\n\t\t\t\"rate\", \"net_rate\", \"price_list_rate\", \"amount\",\n\t\t\t\"net_amount\", \"stock_uom_rate\", \"rate_with_margin\"\n\t\t], this.frm.doc.currency, \"items\");\n\t}\n\n\tupdate_payment_schedule_grid_labels(company_currency) {\n\t\tconst me = this;\n\t\tif (this.frm.doc.payment_schedule && this.frm.doc.payment_schedule.length > 0) {\n\t\t\tthis.frm.set_currency_labels([\"base_payment_amount\", \"base_outstanding\", \"base_paid_amount\"],\n\t\t\t\tcompany_currency, \"payment_schedule\");\n\t\t\tthis.frm.set_currency_labels([\"payment_amount\", \"outstanding\", \"paid_amount\"],\n\t\t\t\tthis.frm.doc.currency, \"payment_schedule\");\n\n\t\t\tvar schedule_grid = this.frm.fields_dict[\"payment_schedule\"].grid;\n\t\t\t$.each([\"base_payment_amount\", \"base_outstanding\", \"base_paid_amount\"], function(i, fname) {\n\t\t\t\tif (frappe.meta.get_docfield(schedule_grid.doctype, fname))\n\t\t\t\t\tschedule_grid.set_column_disp(fname, me.frm.doc.currency != company_currency);\n\t\t\t});\n\t\t}\n\t}\n\n\ttoggle_item_grid_columns(company_currency) {\n\t\tconst me = this;\n\t\t// toggle columns\n\t\tvar item_grid = this.frm.fields_dict[\"items\"].grid;\n\t\t$.each([\"base_rate\", \"base_price_list_rate\", \"base_amount\", \"base_rate_with_margin\"], function(i, fname) {\n\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\titem_grid.set_column_disp(fname, me.frm.doc.currency != company_currency);\n\t\t});\n\n\t\tvar show = (cint(cur_frm.doc.discount_amount)) ||\n\t\t\t((cur_frm.doc.taxes || []).filter(function(d) {return d.included_in_print_rate===1}).length);\n\n\t\t$.each([\"net_rate\", \"net_amount\"], function(i, fname) {\n\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\titem_grid.set_column_disp(fname, show);\n\t\t});\n\n\t\t$.each([\"base_net_rate\", \"base_net_amount\"], function(i, fname) {\n\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\titem_grid.set_column_disp(fname, (show && (me.frm.doc.currency != company_currency)));\n\t\t});\n\t}\n\n\trecalculate() {\n\t\tthis.calculate_taxes_and_totals();\n\t}\n\n\trecalculate_values() {\n\t\tthis.calculate_taxes_and_totals();\n\t}\n\n\tcalculate_charges() {\n\t\tthis.calculate_taxes_and_totals();\n\t}\n\n\tignore_pricing_rule() {\n\t\tif(this.frm.doc.ignore_pricing_rule) {\n\t\t\tvar me = this;\n\t\t\tvar item_list = [];\n\n\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, d) {\n\t\t\t\tif (d.item_code && !d.is_free_item) {\n\t\t\t\t\titem_list.push({\n\t\t\t\t\t\t\"doctype\": d.doctype,\n\t\t\t\t\t\t\"name\": d.name,\n\t\t\t\t\t\t\"item_code\": d.item_code,\n\t\t\t\t\t\t\"pricing_rules\": d.pricing_rules,\n\t\t\t\t\t\t\"parenttype\": d.parenttype,\n\t\t\t\t\t\t\"parent\": d.parent\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.accounts.doctype.pricing_rule.pricing_rule.remove_pricing_rules\",\n\t\t\t\targs: { item_list: item_list },\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif (!r.exc && r.message) {\n\t\t\t\t\t\tr.message.forEach(row_item => {\n\t\t\t\t\t\t\tme.remove_pricing_rule(row_item);\n\t\t\t\t\t\t});\n\t\t\t\t\t\tme._set_values_for_item_list(r.message);\n\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t\tif(me.frm.doc.apply_discount_on) me.frm.trigger(\"apply_discount_on\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tthis.apply_pricing_rule();\n\t\t}\n\t}\n\n\tapply_pricing_rule(item, calculate_taxes_and_totals) {\n\t\tvar me = this;\n\t\tvar args = this._get_args(item);\n\t\tif (!(args.items && args.items.length)) {\n\t\t\tif(calculate_taxes_and_totals) me.calculate_taxes_and_totals();\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.frm.call({\n\t\t\tmethod: \"erpnext.accounts.doctype.pricing_rule.pricing_rule.apply_pricing_rule\",\n\t\t\targs: {\targs: args, doc: me.frm.doc },\n\t\t\tcallback: function(r) {\n\t\t\t\tif (!r.exc && r.message) {\n\t\t\t\t\tme._set_values_for_item_list(r.message);\n\t\t\t\t\tif(item) me.set_gross_profit(item);\n\t\t\t\t\tif(me.frm.doc.apply_discount_on) me.frm.trigger(\"apply_discount_on\")\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\t_get_args(item) {\n\t\tvar me = this;\n\t\treturn {\n\t\t\t\"items\": this._get_item_list(item),\n\t\t\t\"customer\": me.frm.doc.customer || me.frm.doc.party_name,\n\t\t\t\"quotation_to\": me.frm.doc.quotation_to,\n\t\t\t\"customer_group\": me.frm.doc.customer_group,\n\t\t\t\"territory\": me.frm.doc.territory,\n\t\t\t\"supplier\": me.frm.doc.supplier,\n\t\t\t\"supplier_group\": me.frm.doc.supplier_group,\n\t\t\t\"currency\": me.frm.doc.currency,\n\t\t\t\"conversion_rate\": me.frm.doc.conversion_rate,\n\t\t\t\"price_list\": me.frm.doc.selling_price_list || me.frm.doc.buying_price_list,\n\t\t\t\"price_list_currency\": me.frm.doc.price_list_currency,\n\t\t\t\"plc_conversion_rate\": me.frm.doc.plc_conversion_rate,\n\t\t\t\"company\": me.frm.doc.company,\n\t\t\t\"transaction_date\": me.frm.doc.transaction_date || me.frm.doc.posting_date,\n\t\t\t\"campaign\": me.frm.doc.campaign,\n\t\t\t\"sales_partner\": me.frm.doc.sales_partner,\n\t\t\t\"ignore_pricing_rule\": me.frm.doc.ignore_pricing_rule,\n\t\t\t\"doctype\": me.frm.doc.doctype,\n\t\t\t\"name\": me.frm.doc.name,\n\t\t\t\"is_return\": cint(me.frm.doc.is_return),\n\t\t\t\"update_stock\": in_list(['Sales Invoice', 'Purchase Invoice'], me.frm.doc.doctype) ? cint(me.frm.doc.update_stock) : 0,\n\t\t\t\"conversion_factor\": me.frm.doc.conversion_factor,\n\t\t\t\"pos_profile\": me.frm.doc.doctype == 'Sales Invoice' ? me.frm.doc.pos_profile : '',\n\t\t\t\"coupon_code\": me.frm.doc.coupon_code\n\t\t};\n\t}\n\n\t_get_item_list(item) {\n\t\tvar item_list = [];\n\t\tvar append_item = function(d) {\n\t\t\tif (d.item_code) {\n\t\t\t\titem_list.push({\n\t\t\t\t\t\"doctype\": d.doctype,\n\t\t\t\t\t\"name\": d.name,\n\t\t\t\t\t\"child_docname\": d.name,\n\t\t\t\t\t\"item_code\": d.item_code,\n\t\t\t\t\t\"item_group\": d.item_group,\n\t\t\t\t\t\"brand\": d.brand,\n\t\t\t\t\t\"qty\": d.qty,\n\t\t\t\t\t\"stock_qty\": d.stock_qty,\n\t\t\t\t\t\"uom\": d.uom,\n\t\t\t\t\t\"stock_uom\": d.stock_uom,\n\t\t\t\t\t\"parenttype\": d.parenttype,\n\t\t\t\t\t\"parent\": d.parent,\n\t\t\t\t\t\"pricing_rules\": d.pricing_rules,\n\t\t\t\t\t\"warehouse\": d.warehouse,\n\t\t\t\t\t\"serial_no\": d.serial_no,\n\t\t\t\t\t\"batch_no\": d.batch_no,\n\t\t\t\t\t\"price_list_rate\": d.price_list_rate,\n\t\t\t\t\t\"conversion_factor\": d.conversion_factor || 1.0\n\t\t\t\t});\n\n\t\t\t\t// if doctype is Quotation Item / Sales Order Iten then add Margin Type and rate in item_list\n\t\t\t\tif (in_list([\"Quotation Item\", \"Sales Order Item\", \"Delivery Note Item\", \"Sales Invoice Item\",  \"Purchase Invoice Item\", \"Purchase Order Item\", \"Purchase Receipt Item\",\"Proforma Invoice Item\"]), d.doctype) {\n\t\t\t\t\titem_list[0][\"margin_type\"] = d.margin_type;\n\t\t\t\t\titem_list[0][\"margin_rate_or_amount\"] = d.margin_rate_or_amount;\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tif (item) {\n\t\t\tappend_item(item);\n\t\t} else {\n\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, d) {\n\t\t\t\tappend_item(d);\n\t\t\t});\n\t\t}\n\t\treturn item_list;\n\t}\n\n\t_set_values_for_item_list(children) {\n\t\tvar me = this;\n\t\tvar price_list_rate_changed = false;\n\t\tvar items_rule_dict = {};\n\n\t\tfor(var i=0, l=children.length; i<l; i++) {\n\t\t\tvar d = children[i];\n\t\t\tvar existing_pricing_rule = frappe.model.get_value(d.doctype, d.name, \"pricing_rules\");\n\t\t\tfor(var k in d) {\n\t\t\t\tvar v = d[k];\n\t\t\t\tif ([\"doctype\", \"name\"].indexOf(k)===-1) {\n\t\t\t\t\tif(k==\"price_list_rate\") {\n\t\t\t\t\t\tif(flt(v) != flt(d.price_list_rate)) price_list_rate_changed = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (k !== 'free_item_data') {\n\t\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, k, v);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// if pricing rule set as blank from an existing value, apply price_list\n\t\t\tif(!me.frm.doc.ignore_pricing_rule && existing_pricing_rule && !d.pricing_rules) {\n\t\t\t\tme.apply_price_list(frappe.get_doc(d.doctype, d.name));\n\t\t\t} else if(!d.pricing_rules) {\n\t\t\t\tme.remove_pricing_rule(frappe.get_doc(d.doctype, d.name));\n\t\t\t}\n\n\t\t\tif (d.free_item_data) {\n\t\t\t\tme.apply_product_discount(d);\n\t\t\t}\n\n\t\t\tif (d.apply_rule_on_other_items) {\n\t\t\t\titems_rule_dict[d.name] = d;\n\t\t\t}\n\t\t}\n\n\t\tme.apply_rule_on_other_items(items_rule_dict);\n\n\t\tif(!price_list_rate_changed) me.calculate_taxes_and_totals();\n\t}\n\n\tapply_rule_on_other_items(args) {\n\t\tconst me = this;\n\t\tconst fields = [\"discount_percentage\", \"pricing_rules\", \"discount_amount\", \"rate\"];\n\n\t\tfor(var k in args) {\n\t\t\tlet data = args[k];\n\n\t\t\tif (data && data.apply_rule_on_other_items) {\n\t\t\t\tme.frm.doc.items.forEach(d => {\n\t\t\t\t\tif (in_list(data.apply_rule_on_other_items, d[data.apply_rule_on])) {\n\t\t\t\t\t\tfor(var k in data) {\n\t\t\t\t\t\t\tif (in_list(fields, k) && data[k] && (data.price_or_product_discount === 'price' || k === 'pricing_rules')) {\n\t\t\t\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, k, data[k]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\tapply_product_discount(args) {\n\t\tconst items = this.frm.doc.items.filter(d => (d.is_free_item)) || [];\n\n\t\tconst exist_items = items.map(row => (row.item_code, row.pricing_rules));\n\n\t\targs.free_item_data.forEach(pr_row => {\n\t\t\tlet row_to_modify = {};\n\t\t\tif (!items || !in_list(exist_items, (pr_row.item_code, pr_row.pricing_rules))) {\n\n\t\t\t\trow_to_modify = frappe.model.add_child(this.frm.doc,\n\t\t\t\t\tthis.frm.doc.doctype + ' Item', 'items');\n\n\t\t\t} else if(items) {\n\t\t\t\trow_to_modify = items.filter(d => (d.item_code === pr_row.item_code\n\t\t\t\t\t&& d.pricing_rules === pr_row.pricing_rules))[0];\n\t\t\t}\n\n\t\t\tfor (let key in pr_row) {\n\t\t\t\trow_to_modify[key] = pr_row[key];\n\t\t\t}\n\t\t});\n\n\t\t// free_item_data is a temporary variable\n\t\targs.free_item_data = '';\n\t\trefresh_field('items');\n\t}\n\n\tapply_price_list(item, reset_plc_conversion) {\n\t\t// We need to reset plc_conversion_rate sometimes because the call to\n\t\t// `erpnext.stock.get_item_details.apply_price_list` is sensitive to its value\n\t\tif (!reset_plc_conversion) {\n\t\t\tthis.frm.set_value(\"plc_conversion_rate\", \"\");\n\t\t}\n\n\t\tvar me = this;\n\t\tvar args = this._get_args(item);\n\t\tif (!((args.items && args.items.length) || args.price_list)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (me.in_apply_price_list == true) return;\n\n\t\tme.in_apply_price_list = true;\n\t\treturn this.frm.call({\n\t\t\tmethod: \"erpnext.stock.get_item_details.apply_price_list\",\n\t\t\targs: {\targs: args },\n\t\t\tcallback: function(r) {\n\t\t\t\tif (!r.exc) {\n\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t() => me.frm.set_value(\"price_list_currency\", r.message.parent.price_list_currency),\n\t\t\t\t\t\t() => me.frm.set_value(\"plc_conversion_rate\", r.message.parent.plc_conversion_rate),\n\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\tif(args.items.length) {\n\t\t\t\t\t\t\t\tme._set_values_for_item_list(r.message.children);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t() => { me.in_apply_price_list = false; }\n\t\t\t\t\t]);\n\n\t\t\t\t} else {\n\t\t\t\t\tme.in_apply_price_list = false;\n\t\t\t\t}\n\t\t\t}\n\t\t}).always(() => {\n\t\t\tme.in_apply_price_list = false;\n\t\t});\n\t}\n\n\tremove_pricing_rule(item) {\n\t\tlet me = this;\n\t\tconst fields = [\"discount_percentage\",\n\t\t\t\"discount_amount\", \"margin_rate_or_amount\", \"rate_with_margin\"];\n\n\t\tif(item.remove_free_item) {\n\t\t\tvar items = [];\n\n\t\t\tme.frm.doc.items.forEach(d => {\n\t\t\t\tif(d.item_code != item.remove_free_item || !d.is_free_item) {\n\t\t\t\t\titems.push(d);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tme.frm.doc.items = items;\n\t\t\trefresh_field('items');\n\t\t} else if(item.applied_on_items && item.apply_on) {\n\t\t\tconst applied_on_items = item.applied_on_items.split(',');\n\t\t\tme.frm.doc.items.forEach(row => {\n\t\t\t\tif(applied_on_items.includes(row[item.apply_on])) {\n\t\t\t\t\tfields.forEach(f => {\n\t\t\t\t\t\trow[f] = 0;\n\t\t\t\t\t});\n\n\t\t\t\t\t[\"pricing_rules\", \"margin_type\"].forEach(field => {\n\t\t\t\t\t\tif (row[field]) {\n\t\t\t\t\t\t\trow[field] = '';\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tme.trigger_price_list_rate();\n\t\t}\n\t}\n\n\ttrigger_price_list_rate() {\n\t\tvar me  = this;\n\n\t\tthis.frm.doc.items.forEach(child_row => {\n\t\t\tme.frm.script_manager.trigger(\"price_list_rate\",\n\t\t\t\tchild_row.doctype, child_row.name);\n\t\t})\n\t}\n\tvalidate_company_and_party() {\n\t\tvar me = this;\n\t\tvar valid = true;\n\n\t\t$.each([\"company\", \"customer\"], function(i, fieldname) {\n\t\t\tif(frappe.meta.has_field(me.frm.doc.doctype, fieldname) && me.frm.doc.doctype != \"Purchase Order\") {\n\t\t\t\tif (!me.frm.doc[fieldname]) {\n\t\t\t\t\tfrappe.msgprint(__(\"Please specify\") + \": \" +\n\t\t\t\t\t\tfrappe.meta.get_label(me.frm.doc.doctype, fieldname, me.frm.doc.name) +\n\t\t\t\t\t\t\". \" + __(\"It is needed to fetch Item Details.\"));\n\t\t\t\t\tvalid = false;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\treturn valid;\n\t}\n\n\tget_terms() {\n\t\tvar me = this;\n\n\t\terpnext.utils.get_terms(this.frm.doc.tc_name, this.frm.doc, function(r) {\n\t\t\tif(!r.exc) {\n\t\t\t\tme.frm.set_value(\"terms\", r.message);\n\t\t\t}\n\t\t});\n\t}\n\n\ttaxes_and_charges() {\n\t\tvar me = this;\n\t\tif(this.frm.doc.taxes_and_charges) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_taxes_and_charges\",\n\t\t\t\targs: {\n\t\t\t\t\t\"master_doctype\": frappe.meta.get_docfield(this.frm.doc.doctype, \"taxes_and_charges\",\n\t\t\t\t\t\tthis.frm.doc.name).options,\n\t\t\t\t\t\"master_name\": this.frm.doc.taxes_and_charges\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\tif(me.frm.doc.shipping_rule && me.frm.doc.taxes) {\n\t\t\t\t\t\t\tfor (let tax of r.message) {\n\t\t\t\t\t\t\t\tme.frm.add_child(\"taxes\", tax);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\trefresh_field(\"taxes\");\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tme.frm.set_value(\"taxes\", r.message);\n\t\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\ttax_category() {\n\t\tvar me = this;\n\t\tif(me.frm.updating_party_details) return;\n\n\t\tfrappe.run_serially([\n\t\t\t() => this.update_item_tax_map(),\n\t\t\t() => erpnext.utils.set_taxes(this.frm, \"tax_category\"),\n\t\t]);\n\t}\n\n\tupdate_item_tax_map() {\n\t\tlet me = this;\n\t\tlet item_codes = [];\n\t\tlet item_rates = {};\n\t\tlet item_tax_templates = {};\n\n\t\t$.each(this.frm.doc.items || [], function(i, item) {\n\t\t\tif (item.item_code) {\n\t\t\t\t// Use combination of name and item code in case same item is added multiple times\n\t\t\t\titem_codes.push([item.item_code, item.name]);\n\t\t\t\titem_rates[item.name] = item.net_rate;\n\t\t\t\titem_tax_templates[item.name] = item.item_tax_template;\n\t\t\t}\n\t\t});\n\n\t\tif (item_codes.length) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_item_tax_info\",\n\t\t\t\targs: {\n\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\ttax_category: cstr(me.frm.doc.tax_category),\n\t\t\t\t\titem_codes: item_codes,\n\t\t\t\t\titem_rates: item_rates,\n\t\t\t\t\titem_tax_templates: item_tax_templates\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif (!r.exc) {\n\t\t\t\t\t\t$.each(me.frm.doc.items || [], function(i, item) {\n\t\t\t\t\t\t\tif (item.name && r.message.hasOwnProperty(item.name) && r.message[item.name].item_tax_template) {\n\t\t\t\t\t\t\t\titem.item_tax_template = r.message[item.name].item_tax_template;\n\t\t\t\t\t\t\t\titem.item_tax_rate = r.message[item.name].item_tax_rate;\n\t\t\t\t\t\t\t\tme.add_taxes_from_item_tax_template(item.item_tax_rate);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\titem_tax_template(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tif(me.frm.updating_party_details) return;\n\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\n\t\tif(item.item_tax_template) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_item_tax_map\",\n\t\t\t\targs: {\n\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\titem_tax_template: item.item_tax_template,\n\t\t\t\t\tas_json: true\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\titem.item_tax_rate = r.message;\n\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\titem.item_tax_rate = \"{}\";\n\t\t\tme.calculate_taxes_and_totals();\n\t\t}\n\t}\n\n\n\n\tis_recurring() {\n\t\t// set default values for recurring documents\n\t\tif(this.frm.doc.is_recurring && this.frm.doc.__islocal) {\n\t\t\tfrappe.msgprint(__(\"Please set recurring after saving\"));\n\t\t\tthis.frm.set_value('is_recurring', 0);\n\t\t\treturn;\n\t\t}\n\n\t\tif(this.frm.doc.is_recurring) {\n\t\t\tif(!this.frm.doc.recurring_id) {\n\t\t\t\tthis.frm.set_value('recurring_id', this.frm.doc.name);\n\t\t\t}\n\n\t\t\tvar owner_email = this.frm.doc.owner==\"Administrator\"\n\t\t\t\t? frappe.user_info(\"Administrator\").email\n\t\t\t\t: this.frm.doc.owner;\n\n\t\t\tthis.frm.doc.notification_email_address = $.map([cstr(owner_email),\n\t\t\t\tcstr(this.frm.doc.contact_email)], function(v) { return v || null; }).join(\", \");\n\t\t\tthis.frm.doc.repeat_on_day_of_month = frappe.datetime.str_to_obj(this.frm.doc.posting_date).getDate();\n\t\t}\n\n\t\trefresh_many([\"notification_email_address\", \"repeat_on_day_of_month\"]);\n\t}\n\n\tfrom_date() {\n\t\t// set to_date\n\t\tif(this.frm.doc.from_date) {\n\t\t\tvar recurring_type_map = {'Monthly': 1, 'Quarterly': 3, 'Half-yearly': 6,\n\t\t\t\t'Yearly': 12};\n\n\t\t\tvar months = recurring_type_map[this.frm.doc.recurring_type];\n\t\t\tif(months) {\n\t\t\t\tvar to_date = frappe.datetime.add_months(this.frm.doc.from_date,\n\t\t\t\t\tmonths);\n\t\t\t\tthis.frm.doc.to_date = frappe.datetime.add_days(to_date, -1);\n\t\t\t\trefresh_field('to_date');\n\t\t\t}\n\t\t}\n\t}\n\n\tset_gross_profit(item) {\n\t\tif ([\"Sales Order\", \"Quotation\",\"Proforma Invoice\"].includes(this.frm.doc.doctype) && item.valuation_rate) {\n\t\t\tvar rate = flt(item.rate) * flt(this.frm.doc.conversion_rate || 1);\n\t\t\titem.gross_profit = flt(((rate - item.valuation_rate) * item.stock_qty), precision(\"amount\", item));\n\t\t}\n\t}\n\n\tsetup_item_selector() {\n\t\t// TODO: remove item selector\n\n\t\treturn;\n\t\t// if(!this.item_selector) {\n\t\t// \tthis.item_selector = new erpnext.ItemSelector({frm: this.frm});\n\t\t// }\n\t}\n\n\tget_advances() {\n\t\tif(!this.frm.is_return) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"set_advances\",\n\t\t\t\tdoc: this.frm.doc,\n\t\t\t\tcallback: function(r, rt) {\n\t\t\t\t\trefresh_field(\"advances\");\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}\n\n\tmake_payment_entry() {\n\t\treturn frappe.call({\n\t\t\tmethod: cur_frm.cscript.get_method_for_payment(),\n\t\t\targs: {\n\t\t\t\t\"dt\": cur_frm.doc.doctype,\n\t\t\t\t\"dn\": cur_frm.doc.name\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tvar doclist = frappe.model.sync(r.message);\n\t\t\t\tfrappe.set_route(\"Form\", doclist[0].doctype, doclist[0].name);\n\t\t\t\t// cur_frm.refresh_fields()\n\t\t\t}\n\t\t});\n\t}\n\n\tmake_quality_inspection () {\n\t\tlet data = [];\n\t\tconst fields = [\n\t\t\t{\n\t\t\t\tlabel: \"Items\",\n\t\t\t\tfieldtype: \"Table\",\n\t\t\t\tfieldname: \"items\",\n\t\t\t\tcannot_add_rows: true,\n\t\t\t\tin_place_edit: true,\n\t\t\t\tdata: data,\n\t\t\t\tget_data: () => {\n\t\t\t\t\treturn data;\n\t\t\t\t},\n\t\t\t\tfields: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Data\",\n\t\t\t\t\t\tfieldname: \"docname\",\n\t\t\t\t\t\thidden: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Read Only\",\n\t\t\t\t\t\tfieldname: \"item_code\",\n\t\t\t\t\t\tlabel: __(\"Item Code\"),\n\t\t\t\t\t\tin_list_view: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Read Only\",\n\t\t\t\t\t\tfieldname: \"item_name\",\n\t\t\t\t\t\tlabel: __(\"Item Name\"),\n\t\t\t\t\t\tin_list_view: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Float\",\n\t\t\t\t\t\tfieldname: \"qty\",\n\t\t\t\t\t\tlabel: __(\"Accepted Quantity\"),\n\t\t\t\t\t\tin_list_view: true,\n\t\t\t\t\t\tread_only: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Float\",\n\t\t\t\t\t\tfieldname: \"sample_size\",\n\t\t\t\t\t\tlabel: __(\"Sample Size\"),\n\t\t\t\t\t\treqd: true,\n\t\t\t\t\t\tin_list_view: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Data\",\n\t\t\t\t\t\tfieldname: \"description\",\n\t\t\t\t\t\tlabel: __(\"Description\"),\n\t\t\t\t\t\thidden: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Data\",\n\t\t\t\t\t\tfieldname: \"serial_no\",\n\t\t\t\t\t\tlabel: __(\"Serial No\"),\n\t\t\t\t\t\thidden: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfieldtype: \"Data\",\n\t\t\t\t\t\tfieldname: \"batch_no\",\n\t\t\t\t\t\tlabel: __(\"Batch No\"),\n\t\t\t\t\t\thidden: true\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t}\n\t\t];\n\n\t\tconst me = this;\n\t\tconst dialog = new frappe.ui.Dialog({\n\t\t\ttitle: __(\"Select Items for Quality Inspection\"),\n\t\t\tfields: fields,\n\t\t\tprimary_action: function () {\n\t\t\t\tconst data = dialog.get_values();\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"erpnext.controllers.stock_controller.make_quality_inspections\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\tdoctype: me.frm.doc.doctype,\n\t\t\t\t\t\tdocname: me.frm.doc.name,\n\t\t\t\t\t\titems: data.items\n\t\t\t\t\t},\n\t\t\t\t\tfreeze: true,\n\t\t\t\t\tcallback: function (r) {\n\t\t\t\t\t\tif (r.message.length > 0) {\n\t\t\t\t\t\t\tif (r.message.length === 1) {\n\t\t\t\t\t\t\t\tfrappe.set_route(\"Form\", \"Quality Inspection\", r.message[0]);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tfrappe.route_options = {\n\t\t\t\t\t\t\t\t\t\"reference_type\": me.frm.doc.doctype,\n\t\t\t\t\t\t\t\t\t\"reference_name\": me.frm.doc.name\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\tfrappe.set_route(\"List\", \"Quality Inspection\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdialog.hide();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\tprimary_action_label: __(\"Create\")\n\t\t});\n\n\t\tthis.frm.doc.items.forEach(item => {\n\t\t\tif (!item.quality_inspection) {\n\t\t\t\tlet dialog_items = dialog.fields_dict.items;\n\t\t\t\tdialog_items.df.data.push({\n\t\t\t\t\t\"docname\": item.name,\n\t\t\t\t\t\"item_code\": item.item_code,\n\t\t\t\t\t\"item_name\": item.item_name,\n\t\t\t\t\t\"qty\": item.qty,\n\t\t\t\t\t\"description\": item.description,\n\t\t\t\t\t\"serial_no\": item.serial_no,\n\t\t\t\t\t\"batch_no\": item.batch_no\n\t\t\t\t});\n\t\t\t\tdialog_items.grid.refresh();\n\t\t\t}\n\t\t});\n\n\t\tdata = dialog.fields_dict.items.df.data;\n\t\tif (!data.length) {\n\t\t\tfrappe.msgprint(__(\"All items in this document already have a linked Quality Inspection.\"));\n\t\t} else {\n\t\t\tdialog.show();\n\t\t}\n\t}\n\n\tget_method_for_payment(){\n\t\tvar method = \"erpnext.accounts.doctype.payment_entry.payment_entry.get_payment_entry\";\n\t\tif(cur_frm.doc.__onload && cur_frm.doc.__onload.make_payment_via_journal_entry){\n\t\t\tif(in_list(['Sales Invoice', 'Purchase Invoice'],  cur_frm.doc.doctype)){\n\t\t\t\tmethod = \"erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_invoice\";\n\t\t\t}else {\n\t\t\t\tmethod= \"erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_order\";\n\t\t\t}\n\t\t}\n\n\t\treturn method\n\t}\n\n\tset_query_for_batch(doc, cdt, cdn) {\n\t\t// Show item's batches in the dropdown of batch no\n\n\t\tvar me = this;\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\n\t\tif(!item.item_code) {\n\t\t\tfrappe.throw(__(\"Please enter Item Code to get batch no\"));\n\t\t} else if (doc.doctype == \"Purchase Receipt\" ||\n\t\t\t(doc.doctype == \"Purchase Invoice\" && doc.update_stock)) {\n\t\t\treturn {\n\t\t\t\tfilters: {'item': item.item_code}\n\t\t\t}\n\t\t} else {\n\t\t\tlet filters = {\n\t\t\t\t'item_code': item.item_code,\n\t\t\t\t'posting_date': me.frm.doc.posting_date || frappe.datetime.nowdate(),\n\t\t\t}\n\n\t\t\tif (doc.is_return) {\n\t\t\t\tfilters[\"is_return\"] = 1;\n\t\t\t}\n\n\t\t\tif (item.warehouse) filters[\"warehouse\"] = item.warehouse;\n\n\t\t\treturn {\n\t\t\t\tquery : \"erpnext.controllers.queries.get_batch_no\",\n\t\t\t\tfilters: filters\n\t\t\t}\n\t\t}\n\t}\n\n\tset_query_for_item_tax_template(doc, cdt, cdn) {\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tif(!item.item_code) {\n\t\t\treturn doc.company ? {filters: {company: doc.company}} : {};\n\t\t} else {\n\t\t\tlet filters = {\n\t\t\t\t'item_code': item.item_code,\n\t\t\t\t'valid_from': [\"<=\", doc.transaction_date || doc.bill_date || doc.posting_date],\n\t\t\t\t'item_group': item.item_group,\n\t\t\t}\n\n\t\t\tif (doc.tax_category)\n\t\t\t\tfilters['tax_category'] = doc.tax_category;\n\t\t\tif (doc.company)\n\t\t\t\tfilters['company'] = doc.company;\n\t\t\treturn {\n\t\t\t\tquery: \"erpnext.controllers.queries.get_tax_template\",\n\t\t\t\tfilters: filters\n\t\t\t}\n\t\t}\n\t}\n\tpayment_terms_template() {\n\t\tvar me = this;\n\t\tconst doc = this.frm.doc;\n\t\tif(doc.payment_terms_template && doc.doctype !== 'Delivery Note') {\n\t\t\tvar posting_date = doc.posting_date || doc.transaction_date;\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_payment_terms\",\n\t\t\t\targs: {\n\t\t\t\t\tterms_template: doc.payment_terms_template,\n\t\t\t\t\tposting_date: posting_date,\n\t\t\t\t\tgrand_total: doc.rounded_total || doc.grand_total,\n\t\t\t\t\tbase_grand_total: doc.base_rounded_total || doc.base_grand_total,\n\t\t\t\t\tbill_date: doc.bill_date\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(r.message && !r.exc) {\n\t\t\t\t\t\tme.frm.set_value(\"payment_schedule\", r.message);\n\t\t\t\t\t\tconst company_currency = me.get_company_currency();\n\t\t\t\t\t\tme.update_payment_schedule_grid_labels(company_currency);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}\n\n\tpayment_term(doc, cdt, cdn) {\n\t\tconst me = this;\n\t\tvar row = locals[cdt][cdn];\n\t\tif(row.payment_term) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_payment_term_details\",\n\t\t\t\targs: {\n\t\t\t\t\tterm: row.payment_term,\n\t\t\t\t\tbill_date: this.frm.doc.bill_date,\n\t\t\t\t\tposting_date: this.frm.doc.posting_date || this.frm.doc.transaction_date,\n\t\t\t\t\tgrand_total: this.frm.doc.rounded_total || this.frm.doc.grand_total,\n\t\t\t\t\tbase_grand_total: this.frm.doc.base_rounded_total || this.frm.doc.base_grand_total\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(r.message && !r.exc) {\n\t\t\t\t\t\tfor (var d in r.message) {\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, d, r.message[d]);\n\t\t\t\t\t\t\tconst company_currency = me.get_company_currency();\n\t\t\t\t\t\t\tme.update_payment_schedule_grid_labels(company_currency);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}\n\n\tagainst_blanket_order(doc, cdt, cdn) {\n\t\tvar item = locals[cdt][cdn];\n\t\tif(!item.against_blanket_order) {\n\t\t\tfrappe.model.set_value(this.frm.doctype + \" Item\", item.name, \"blanket_order\", null);\n\t\t\tfrappe.model.set_value(this.frm.doctype + \" Item\", item.name, \"blanket_order_rate\", 0.00);\n\t\t}\n\t}\n\n\tblanket_order(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tvar item = locals[cdt][cdn];\n\t\tif (item.blanket_order && (item.parenttype==\"Sales Order\" || item.parenttype==\"Purchase Order\")) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_blanket_order_details\",\n\t\t\t\targs: {\n\t\t\t\t\targs:{\n\t\t\t\t\t\titem_code: item.item_code,\n\t\t\t\t\t\tcustomer: doc.customer,\n\t\t\t\t\t\tsupplier: doc.supplier,\n\t\t\t\t\t\tcompany: doc.company,\n\t\t\t\t\t\ttransaction_date: doc.transaction_date,\n\t\t\t\t\t\tblanket_order: item.blanket_order\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif (!r.message) {\n\t\t\t\t\t\tfrappe.throw(__(\"Invalid Blanket Order for the selected Customer and Item\"));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t() => frappe.model.set_value(cdt, cdn, \"blanket_order_rate\", r.message.blanket_order_rate),\n\t\t\t\t\t\t\t() => me.frm.script_manager.trigger(\"price_list_rate\", cdt, cdn)\n\t\t\t\t\t\t]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}\n\n\tset_reserve_warehouse() {\n\t\tthis.autofill_warehouse(this.frm.doc.supplied_items, \"reserve_warehouse\", this.frm.doc.set_reserve_warehouse);\n\t}\n\n\tset_warehouse() {\n\t\tthis.autofill_warehouse(this.frm.doc.items, \"warehouse\", this.frm.doc.set_warehouse);\n\t}\n\n\tset_target_warehouse() {\n\t\tthis.autofill_warehouse(this.frm.doc.items, \"target_warehouse\", this.frm.doc.set_target_warehouse);\n\t}\n\n\tset_from_warehouse() {\n\t\tthis.autofill_warehouse(this.frm.doc.items, \"from_warehouse\", this.frm.doc.set_from_warehouse);\n\t}\n\n\tautofill_warehouse  (child_table, warehouse_field, warehouse) {\n\t\tif (warehouse && child_table && child_table.length) {\n\t\t\tlet doctype = child_table[0].doctype;\n\t\t\t$.each(child_table || [], function(i, item) {\n\t\t\t\tfrappe.model.set_value(doctype, item.name, warehouse_field, warehouse);\n\t\t\t});\n\t\t}\n\t}\n\n\tcoupon_code() {\n\t\tvar me = this;\n\t\tfrappe.run_serially([\n\t\t\t() => this.frm.doc.ignore_pricing_rule=1,\n\t\t\t() => me.ignore_pricing_rule(),\n\t\t\t() => this.frm.doc.ignore_pricing_rule=0,\n\t\t\t() => me.apply_pricing_rule()\n\t\t]);\n\t}\n};\n\nerpnext.show_serial_batch_selector = function (frm, d, callback, on_close, show_dialog) {\n\tlet warehouse, receiving_stock, existing_stock;\n\tif (frm.doc.is_return) {\n\t\tif ([\"Purchase Receipt\", \"Purchase Invoice\"].includes(frm.doc.doctype)) {\n\t\t\texisting_stock = true;\n\t\t\twarehouse = d.warehouse;\n\t\t} else if ([\"Delivery Note\", \"Sales Invoice\"].includes(frm.doc.doctype)) {\n\t\t\treceiving_stock = true;\n\t\t}\n\t} else {\n\t\tif (frm.doc.doctype == \"Stock Entry\") {\n\t\t\tif (frm.doc.purpose == \"Material Receipt\") {\n\t\t\t\treceiving_stock = true;\n\t\t\t} else {\n\t\t\t\texisting_stock = true;\n\t\t\t\twarehouse = d.s_warehouse;\n\t\t\t}\n\t\t} else {\n\t\t\texisting_stock = true;\n\t\t\twarehouse = d.warehouse;\n\t\t}\n\t}\n\n\tif (!warehouse) {\n\t\tif (receiving_stock) {\n\t\t\twarehouse = [\"like\", \"\"];\n\t\t} else if (existing_stock) {\n\t\t\twarehouse = [\"!=\", \"\"];\n\t\t}\n\t}\n\n\tfrappe.require(\"assets/erpnext/js/utils/serial_no_batch_selector.js\", function() {\n\t\tnew erpnext.SerialNoBatchSelector({\n\t\t\tfrm: frm,\n\t\t\titem: d,\n\t\t\twarehouse_details: {\n\t\t\t\ttype: \"Warehouse\",\n\t\t\t\tname: warehouse\n\t\t\t},\n\t\t\tcallback: callback,\n\t\t\ton_close: on_close\n\t\t}, show_dialog);\n\t});\n}\n\nerpnext.apply_putaway_rule = (frm, purpose=null) => {\n\tif (!frm.doc.company) {\n\t\tfrappe.throw({message: __(\"Please select a Company first.\"), title: __(\"Mandatory\")});\n\t}\n\tif (!frm.doc.items.length) return;\n\n\tfrappe.call({\n\t\tmethod: \"erpnext.stock.doctype.putaway_rule.putaway_rule.apply_putaway_rule\",\n\t\targs: {\n\t\t\tdoctype: frm.doctype,\n\t\t\titems: frm.doc.items,\n\t\t\tcompany: frm.doc.company,\n\t\t\tsync: true,\n\t\t\tpurpose: purpose\n\t\t},\n\t\tcallback: (result) => {\n\t\t\tif (!result.exc && result.message) {\n\t\t\t\tfrm.clear_table(\"items\");\n\n\t\t\t\tlet items =  result.message;\n\t\t\t\titems.forEach((row) => {\n\t\t\t\t\tdelete row[\"name\"]; // dont overwrite name from server side\n\t\t\t\t\tlet child = frm.add_child(\"items\");\n\t\t\t\t\tObject.assign(child, row);\n\t\t\t\t\tfrm.script_manager.trigger(\"qty\", child.doctype, child.name);\n\t\t\t\t});\n\t\t\t\tfrm.get_field(\"items\").grid.refresh();\n\t\t\t}\n\t\t}\n\t});\n};\n", "frappe.ui.form.on('Sales Invoice', {\n\trefresh:function(frm){\n\t    frm.ignore_doctypes_on_cancel_all = [\"Delivery Note\"]\n\t},\n\tonload: function(frm) {\n        frm.ignore_doctypes_on_cancel_all = [\"Delivery Note\"]\n\t\tif(frm.doc.company){\n            if (!frm.doc.bank_account){\n                frappe.db.get_value(\"Bank Account\",{\"company\":frm.doc.company,\"is_company_account\":1,\"is_default\":1},\"name\", function(r){\n                    frm.set_value(\"bank_account\",r.name);\n                })\n            }\n        }\n\t},\n    company: function(frm) {\n\t\tif(frm.doc.company){\n            if (!frm.doc.bank_account){\n                frappe.db.get_value(\"Bank Account\",{\"company\":frm.doc.company,\"is_company_account\":1,\"is_default\":1},\"name\", function(r){\n                    frm.set_value(\"bank_account\",r.name);\n                })\n            }\n        }\n\t},\n})\n// cur_frm.fields_dict.set_target_warehouse.get_query = function (doc) {\n// \treturn {\n// \t\tfilters: {\n// \t\t\t\"company\": doc.customer,\n//             \"is_group\":0,\n// \t\t}\n// \t}\n// };"],
  "mappings": "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",
  "names": []
}
