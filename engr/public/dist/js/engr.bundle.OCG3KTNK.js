(()=>{erpnext.taxes_and_totals=class extends erpnext.payments{setup(){this.fetch_round_off_accounts()}apply_pricing_rule_on_item(e){let r=e.price_list_rate,a=e.rate;in_list(["Sales Order","Quotation"],e.parenttype)&&e.blanket_order_rate&&(r=e.blanket_order_rate),e.margin_type=="Percentage"?e.rate_with_margin=flt(r)+flt(r)*(flt(e.margin_rate_or_amount)/100):e.rate_with_margin=flt(r)+flt(e.margin_rate_or_amount),e.base_rate_with_margin=flt(e.rate_with_margin)*flt(this.frm.doc.conversion_rate),a=flt(e.rate_with_margin,precision("rate",e)),e.discount_percentage&&(e.discount_amount=flt(e.rate_with_margin)*flt(e.discount_percentage)/100),e.discount_amount&&(a=flt(e.rate_with_margin-e.discount_amount,precision("rate",e)),e.discount_percentage=100*flt(e.discount_amount)/flt(e.rate_with_margin)),frappe.model.set_value(e.doctype,e.name,"rate",a)}calculate_taxes_and_totals(e){this.discount_amount_applied=!1,this._calculate_taxes_and_totals(),this.calculate_discount_amount(),in_list(["Sales Invoice","POS Invoice","Purchase Invoice"],this.frm.doc.doctype)&&this.frm.doc.docstatus<2&&!this.frm.doc.is_return&&this.calculate_total_advance(e),in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)&&this.frm.doc.is_pos&&this.frm.doc.is_return&&this.update_paid_amount_for_return(),in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice","Proforma Invoice"],this.frm.doc.doctype)&&(this.calculate_commission(),this.calculate_contribution()),this.frm.doc.doctype==="Purchase Invoice"&&this.frm.doc.is_return&&this.frm.doc.grand_total>this.frm.doc.paid_amount&&(this.frm.doc.paid_amount=flt(this.frm.doc.grand_total,precision("grand_total"))),this.frm.refresh_fields()}calculate_discount_amount(){frappe.meta.get_docfield(this.frm.doc.doctype,"discount_amount")&&(this.calculate_item_values(),this.calculate_net_total(),this.set_discount_amount(),this.apply_discount_amount())}_calculate_taxes_and_totals(){this.validate_conversion_rate(),this.calculate_item_values(),this.initialize_taxes(),this.determine_exclusive_rate(),this.calculate_net_total(),this.calculate_taxes(),this.manipulate_grand_total_for_inclusive_tax(),this.calculate_totals(),this._cleanup()}validate_conversion_rate(){this.frm.doc.conversion_rate=flt(this.frm.doc.conversion_rate,cur_frm?precision("conversion_rate"):9);var e=frappe.meta.get_label(this.frm.doc.doctype,"conversion_rate",this.frm.doc.name),r=this.get_company_currency();if(!this.frm.doc.conversion_rate)if(this.frm.doc.currency==r)this.frm.set_value("conversion_rate",1);else{let a=[e,this.frm.doc.currency,r],t=__("{0} is mandatory. Maybe Currency Exchange record is not created for {1} to {2}",a);frappe.throw(t)}}calculate_item_values(){let e=this;this.discount_amount_applied||$.each(this.frm.doc.items||[],function(r,a){frappe.model.round_floats_in(a),a.net_rate=a.rate,!a.qty&&e.frm.doc.is_return?a.amount=flt(a.rate*-1,precision("amount",a)):a.amount=flt(a.rate*a.qty,precision("amount",a)),a.net_amount=a.amount,a.item_tax_amount=0,a.total_weight=flt(a.weight_per_unit*a.stock_qty),e.set_in_company_currency(a,["price_list_rate","rate","amount","net_rate","net_amount"])})}set_in_company_currency(e,r){var a=this;$.each(r,function(t,_){e["base_"+_]=flt(flt(e[_],precision(_,e))*a.frm.doc.conversion_rate,precision("base_"+_,e))})}initialize_taxes(){var e=this;$.each(this.frm.doc.taxes||[],function(r,a){a.item_wise_tax_detail={};var t=["total","tax_amount_after_discount_amount","tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];cstr(a.charge_type)!="Actual"&&!(e.discount_amount_applied&&e.frm.doc.apply_discount_on=="Grand Total")&&t.push("tax_amount"),$.each(t,function(_,o){a[o]=0}),!this.discount_amount_applied&&cur_frm&&(cur_frm.cscript.validate_taxes_and_charges(a.doctype,a.name),e.validate_inclusive_tax(a)),frappe.model.round_floats_in(a)})}fetch_round_off_accounts(){let e=this;if(frappe.flags.round_off_applicable_accounts=[],e.frm.doc.company)return frappe.call({method:"erpnext.controllers.taxes_and_totals.get_round_off_applicable_accounts",args:{company:e.frm.doc.company,account_list:frappe.flags.round_off_applicable_accounts},callback:function(r){frappe.flags.round_off_applicable_accounts.push(...r.message)}})}determine_exclusive_rate(){var e=this,r=!1;$.each(e.frm.doc.taxes||[],function(a,t){cint(t.included_in_print_rate)&&(r=!0)}),r!=!1&&$.each(e.frm.doc.items||[],function(a,t){var _=e._load_item_tax_rate(t.item_tax_rate),o=0,i=0;if($.each(e.frm.doc.taxes||[],function(s,l){var d=e.get_current_tax_fraction(l,_);l.tax_fraction_for_current_item=d[0];var f=d[1];s==0?l.grand_total_fraction_for_current_item=1+l.tax_fraction_for_current_item:l.grand_total_fraction_for_current_item=e.frm.doc.taxes[s-1].grand_total_fraction_for_current_item+l.tax_fraction_for_current_item,o+=l.tax_fraction_for_current_item,i+=f*flt(t.qty)}),!e.discount_amount_applied&&t.qty&&(i||o)){var n=flt(t.amount)-i;t.net_amount=flt(n/(1+o)),t.net_rate=t.qty?flt(t.net_amount/t.qty,precision("net_rate",t)):0,e.set_in_company_currency(t,["net_rate","net_amount"])}})}get_current_tax_fraction(e,r){var a=0,t=0;if(cint(e.included_in_print_rate)){var _=this._get_tax_rate(e,r);e.charge_type=="On Net Total"?a=_/100:e.charge_type=="On Previous Row Amount"?a=_/100*this.frm.doc.taxes[cint(e.row_id)-1].tax_fraction_for_current_item:e.charge_type=="On Previous Row Total"?a=_/100*this.frm.doc.taxes[cint(e.row_id)-1].grand_total_fraction_for_current_item:e.charge_type=="On Item Quantity"&&(t=flt(_))}return e.add_deduct_tax&&e.add_deduct_tax=="Deduct"&&(a*=-1,t*=-1),[a,t]}_get_tax_rate(e,r){return Object.keys(r).indexOf(e.account_head)!=-1?flt(r[e.account_head],precision("rate",e)):e.rate}calculate_net_total(){var e=this;this.frm.doc.total_qty=this.frm.doc.total=this.frm.doc.base_total=this.frm.doc.net_total=this.frm.doc.base_net_total=0,$.each(this.frm.doc.items||[],function(r,a){e.frm.doc.total+=a.amount,e.frm.doc.total_qty+=a.qty,e.frm.doc.base_total+=a.base_amount,e.frm.doc.net_total+=a.net_amount,e.frm.doc.base_net_total+=a.base_net_amount}),frappe.model.round_floats_in(this.frm.doc,["total","base_total","net_total","base_net_total"])}add_taxes_from_item_tax_template(e){let r=this;e&&cint(frappe.defaults.get_default("add_taxes_from_item_tax_template"))&&(typeof e=="string"&&(e=JSON.parse(e)),$.each(e,function(a,t){if(!(r.frm.doc.taxes||[]).find(o=>o.account_head===a)){let o=frappe.model.add_child(r.frm.doc,"taxes");o.charge_type="On Net Total",o.account_head=a,o.rate=0}}))}calculate_taxes(){var e=this;this.frm.doc.rounding_adjustment=0;var r={};$.each(this.frm.doc.taxes||[],function(a,t){t.charge_type=="Actual"&&(r[t.idx]=flt(t.tax_amount,precision("tax_amount",t)))}),$.each(this.frm.doc.items||[],function(a,t){var _=e._load_item_tax_rate(t.item_tax_rate);$.each(e.frm.doc.taxes||[],function(o,i){var n=e.get_current_tax_amount(t,i,_);i.charge_type=="Actual"&&(r[i.idx]-=n,a==e.frm.doc.items.length-1&&(n+=r[i.idx])),i.charge_type!="Actual"&&!(e.discount_amount_applied&&e.frm.doc.apply_discount_on=="Grand Total")&&(i.tax_amount+=n),i.tax_amount_for_current_item=n,i.tax_amount_after_discount_amount+=n,i.category&&(n=i.category=="Valuation"?0:n,n*=i.add_deduct_tax=="Deduct"?-1:1),o==0?i.grand_total_for_current_item=flt(t.net_amount+n):i.grand_total_for_current_item=flt(e.frm.doc.taxes[o-1].grand_total_for_current_item+n),a==e.frm.doc.items.length-1&&(e.round_off_totals(i),e.set_in_company_currency(i,["tax_amount","tax_amount_after_discount_amount"]),e.round_off_base_values(i),e.set_cumulative_total(o,i),e.set_in_company_currency(i,["total"]),o==e.frm.doc.taxes.length-1&&e.discount_amount_applied&&e.frm.doc.apply_discount_on=="Grand Total"&&e.frm.doc.discount_amount&&(e.frm.doc.rounding_adjustment=flt(e.frm.doc.grand_total-flt(e.frm.doc.discount_amount)-i.total,precision("rounding_adjustment"))))})})}set_cumulative_total(e,r){var a=r.tax_amount_after_discount_amount;r.category=="Valuation"&&(a=0),r.add_deduct_tax=="Deduct"&&(a=-1*a),e==0?r.total=flt(this.frm.doc.net_total+a,precision("total",r)):r.total=flt(this.frm.doc.taxes[e-1].total+a,precision("total",r))}_load_item_tax_rate(e){return e?JSON.parse(e):{}}get_current_tax_amount(e,r,a){var t=this._get_tax_rate(r,a),_=0;if(["On Previous Row Amount","On Previous Row Total"].includes(r.charge_type)&&(r.idx===1&&frappe.throw(__("Cannot select charge type as 'On Previous Row Amount' or 'On Previous Row Total' for first row")),r.row_id||(r.row_id=r.idx-1)),r.charge_type=="Actual"){var o=flt(r.tax_amount,precision("tax_amount",r));_=this.frm.doc.net_total?e.net_amount/this.frm.doc.net_total*o:0}else r.charge_type=="On Net Total"?_=t/100*e.net_amount:r.charge_type=="On Previous Row Amount"?_=t/100*this.frm.doc.taxes[cint(r.row_id)-1].tax_amount_for_current_item:r.charge_type=="On Previous Row Total"?_=t/100*this.frm.doc.taxes[cint(r.row_id)-1].grand_total_for_current_item:r.charge_type=="On Item Quantity"&&(_=t*e.qty);return this.set_item_wise_tax(e,r,t,_),_}set_item_wise_tax(e,r,a,t){let _=r.item_wise_tax_detail,o=e.item_code||e.item_name;typeof _=="string"&&(r.item_wise_tax_detail=JSON.parse(r.item_wise_tax_detail),_=r.item_wise_tax_detail);let i=t*this.frm.doc.conversion_rate;_&&_[o]&&(i+=_[o][1]),_[o]=[a,flt(i,precision("base_tax_amount",r))]}round_off_totals(e){frappe.flags.round_off_applicable_accounts.includes(e.account_head)&&(e.tax_amount=Math.round(e.tax_amount),e.tax_amount_after_discount_amount=Math.round(e.tax_amount_after_discount_amount)),e.tax_amount=flt(e.tax_amount,precision("tax_amount",e)),e.tax_amount_after_discount_amount=flt(e.tax_amount_after_discount_amount,precision("tax_amount",e))}round_off_base_values(e){frappe.flags.round_off_applicable_accounts.includes(e.account_head)&&(e.base_tax_amount=Math.round(e.base_tax_amount),e.base_tax_amount_after_discount_amount=Math.round(e.base_tax_amount_after_discount_amount))}manipulate_grand_total_for_inclusive_tax(){var e=this;if(this.frm.doc.taxes&&this.frm.doc.taxes.length){var r=!1;if($.each(this.frm.doc.taxes||[],function(o,i){cint(i.included_in_print_rate)&&(r=!0)}),r){var a=e.frm.doc.taxes.slice(-1)[0],t=frappe.utils.sum($.map(this.frm.doc.taxes||[],function(o){if(!o.included_in_print_rate)return flt(o.tax_amount_after_discount_amount)})),_=e.frm.doc.total+t-flt(a.total,precision("grand_total"));e.discount_amount_applied&&e.frm.doc.discount_amount&&(_-=flt(e.frm.doc.discount_amount)),_=flt(_,precision("rounding_adjustment")),_&&Math.abs(_)<=5/Math.pow(10,precision("tax_amount",a))&&(e.frm.doc.rounding_adjustment=_)}}}calculate_totals(){var e=this,r=this.frm.doc.taxes?this.frm.doc.taxes.length:0;this.frm.doc.grand_total=flt(r?this.frm.doc.taxes[r-1].total+flt(this.frm.doc.rounding_adjustment):this.frm.doc.net_total),in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice","POS Invoice","Proforma Invoice"],this.frm.doc.doctype)?this.frm.doc.base_grand_total=this.frm.doc.total_taxes_and_charges?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total:(this.frm.doc.taxes_and_charges_added=this.frm.doc.taxes_and_charges_deducted=0,r&&($.each(this.frm.doc.taxes||[],function(a,t){in_list(["Valuation and Total","Total"],t.category)&&(t.add_deduct_tax=="Add"?e.frm.doc.taxes_and_charges_added+=flt(t.tax_amount_after_discount_amount):e.frm.doc.taxes_and_charges_deducted+=flt(t.tax_amount_after_discount_amount))}),frappe.model.round_floats_in(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.base_grand_total=flt(this.frm.doc.taxes_and_charges_added||this.frm.doc.taxes_and_charges_deducted?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total),this.set_in_company_currency(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.total_taxes_and_charges=flt(this.frm.doc.grand_total-this.frm.doc.net_total-flt(this.frm.doc.rounding_adjustment),precision("total_taxes_and_charges")),this.set_in_company_currency(this.frm.doc,["total_taxes_and_charges","rounding_adjustment"]),frappe.model.round_floats_in(this.frm.doc,["grand_total","base_grand_total"]),this.set_rounded_total()}set_rounded_total(){var e=0;if(frappe.meta.get_docfield(this.frm.doc.doctype,"disable_rounded_total",this.frm.doc.name)?e=this.frm.doc.disable_rounded_total:frappe.sys_defaults.disable_rounded_total&&(e=frappe.sys_defaults.disable_rounded_total),cint(e)){this.frm.doc.rounded_total=0,this.frm.doc.base_rounded_total=0;return}frappe.meta.get_docfield(this.frm.doc.doctype,"rounded_total",this.frm.doc.name)&&(this.frm.doc.rounded_total=round_based_on_smallest_currency_fraction(this.frm.doc.grand_total,this.frm.doc.currency,precision("rounded_total")),this.frm.doc.rounding_adjustment+=flt(this.frm.doc.rounded_total-this.frm.doc.grand_total,precision("rounding_adjustment")),this.set_in_company_currency(this.frm.doc,["rounding_adjustment","rounded_total"]))}_cleanup(){if(this.frm.doc.base_in_words=this.frm.doc.in_words="",this.frm.doc.items&&this.frm.doc.items.length&&(frappe.meta.get_docfield(this.frm.doc.items[0].doctype,"item_tax_amount",this.frm.doctype)||$.each(this.frm.doc.items||[],function(r,a){delete a.item_tax_amount})),this.frm.doc.taxes&&this.frm.doc.taxes.length){var e=["tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];frappe.meta.get_docfield(this.frm.doc.taxes[0].doctype,"tax_amount_after_discount_amount",this.frm.doctype)||e.push("tax_amount_after_discount_amount"),$.each(this.frm.doc.taxes||[],function(r,a){$.each(e,function(t,_){delete a[_]}),a.item_wise_tax_detail=JSON.stringify(a.item_wise_tax_detail)})}}set_discount_amount(){this.frm.doc.additional_discount_percentage&&(this.frm.doc.discount_amount=flt(flt(this.frm.doc[frappe.scrub(this.frm.doc.apply_discount_on)])*this.frm.doc.additional_discount_percentage/100,precision("discount_amount")))}apply_discount_amount(){var e=this,r=0;if(this.frm.doc.base_discount_amount=0,this.frm.doc.discount_amount){this.frm.doc.apply_discount_on||frappe.throw(__("Please select Apply Discount On")),this.frm.doc.base_discount_amount=flt(this.frm.doc.discount_amount*this.frm.doc.conversion_rate,precision("base_discount_amount"));var a=this.get_total_for_discount_amount(),t=0;a&&($.each(this.frm.doc.items||[],function(_,o){if(r=flt(e.frm.doc.discount_amount)*o.net_amount/a,o.net_amount=flt(o.net_amount-r,precision("base_amount",o)),t+=o.net_amount,(!(e.frm.doc.taxes||[]).length||a==e.frm.doc.net_total||e.frm.doc.apply_discount_on=="Net Total")&&_==(e.frm.doc.items||[]).length-1){var i=flt(e.frm.doc.net_total-t-e.frm.doc.discount_amount,precision("net_total"));o.net_amount=flt(o.net_amount+i,precision("net_amount",o))}o.net_rate=o.qty?flt(o.net_amount/o.qty,precision("net_rate",o)):0,e.set_in_company_currency(o,["net_rate","net_amount"])}),this.discount_amount_applied=!0,this._calculate_taxes_and_totals())}}get_total_for_discount_amount(){if(this.frm.doc.apply_discount_on=="Net Total")return this.frm.doc.net_total;var e=0,r={};return $.each(this.frm.doc.taxes||[],function(a,t){if(in_list(["Actual","On Item Quantity"],t.charge_type)){var _=t.category=="Valuation"?0:t.tax_amount;_*=t.add_deduct_tax=="Deduct"?-1:1,r[t.idx]=_}else if(r[t.row_id]!==null){var o=flt(r[t.row_id])*flt(t.rate)/100;r[t.idx]=o}}),$.each(r,function(a,t){t&&(e+=t)}),flt(this.frm.doc.grand_total-e,precision("grand_total"))}calculate_total_advance(e){var r=frappe.utils.sum($.map(this.frm.doc.advances||[],function(a){return flt(a.allocated_amount,precision("allocated_amount",a))}));this.frm.doc.total_advance=flt(r,precision("total_advance")),this.calculate_outstanding_amount(e)}is_internal_invoice(){return!!(["Sales Invoice","Purchase Invoice"].includes(this.frm.doc.doctype)&&this.frm.doc.company===this.frm.doc.represents_company)}calculate_outstanding_amount(e){if(in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)&&this.frm.doc.is_return&&this.calculate_paid_amount(),!(this.frm.doc.is_return||this.frm.doc.docstatus>0||this.is_internal_invoice())&&(frappe.model.round_floats_in(this.frm.doc,["grand_total","total_advance","write_off_amount"]),in_list(["Sales Invoice","POS Invoice","Purchase Invoice"],this.frm.doc.doctype))){var r=this.frm.doc.rounded_total||this.frm.doc.grand_total;if(this.frm.doc.party_account_currency==this.frm.doc.currency)var a=flt(r-this.frm.doc.total_advance-this.frm.doc.write_off_amount,precision("grand_total"));else var a=flt(flt(r*this.frm.doc.conversion_rate,precision("grand_total"))-this.frm.doc.total_advance-this.frm.doc.base_write_off_amount,precision("base_grand_total"));if(frappe.model.round_floats_in(this.frm.doc,["paid_amount"]),this.set_in_company_currency(this.frm.doc,["paid_amount"]),this.frm.refresh_field&&(this.frm.refresh_field("paid_amount"),this.frm.refresh_field("base_paid_amount")),in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)){let _=this.frm.doc.redeem_loyalty_points&&this.frm.doc.loyalty_amount?flt(a-this.frm.doc.loyalty_amount,precision("base_grand_total")):a;this.set_default_payment(_,e),this.calculate_paid_amount()}this.calculate_change_amount();var t=this.frm.doc.party_account_currency==this.frm.doc.currency?this.frm.doc.paid_amount:this.frm.doc.base_paid_amount;this.frm.doc.outstanding_amount=flt(a-flt(t)+flt(this.frm.doc.change_amount*this.frm.doc.conversion_rate),precision("outstanding_amount"))}}update_paid_amount_for_return(){var e=this.frm.doc.rounded_total||this.frm.doc.grand_total;if(this.frm.doc.party_account_currency==this.frm.doc.currency)var r=flt(e-this.frm.doc.total_advance-this.frm.doc.write_off_amount,precision("grand_total"));else var r=flt(flt(e*this.frm.doc.conversion_rate,precision("grand_total"))-this.frm.doc.total_advance-this.frm.doc.base_write_off_amount,precision("base_grand_total"));this.frm.doc.payments.find(a=>{a.default?a.amount=r:a.amount=0}),this.frm.refresh_fields(),this.calculate_paid_amount()}set_default_payment(e,r){var a=this,t=!0;this.frm.doc.is_pos&&(r===void 0||r)&&$.each(this.frm.doc.payments||[],function(_,o){if(o.default&&t&&e>0){let i=flt(e,precision("base_amount",o));frappe.model.set_value(o.doctype,o.name,"base_amount",i);let n=flt(e/a.frm.doc.conversion_rate,precision("amount",o));frappe.model.set_value(o.doctype,o.name,"amount",n),t=!1}else a.frm.doc.paid_amount&&frappe.model.set_value(o.doctype,o.name,"amount",0)})}calculate_paid_amount(){var e=this,r=0,a=0;this.frm.doc.is_pos?$.each(this.frm.doc.payments||[],function(t,_){_.base_amount=flt(_.amount*e.frm.doc.conversion_rate,precision("base_amount",_)),r+=_.amount,a+=_.base_amount}):this.frm.doc.is_return||(this.frm.doc.payments=[]),this.frm.doc.redeem_loyalty_points&&this.frm.doc.loyalty_amount&&(a+=this.frm.doc.loyalty_amount,r+=flt(this.frm.doc.loyalty_amount/e.frm.doc.conversion_rate,precision("paid_amount"))),this.frm.set_value("paid_amount",flt(r,precision("paid_amount"))),this.frm.set_value("base_paid_amount",flt(a,precision("base_paid_amount")))}calculate_change_amount(){if(this.frm.doc.change_amount=0,this.frm.doc.base_change_amount=0,in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)&&this.frm.doc.paid_amount>this.frm.doc.grand_total&&!this.frm.doc.is_return){var e=$.map(this.frm.doc.payments,function(t){return t.type});if(in_list(e,"Cash")){var r=this.frm.doc.rounded_total||this.frm.doc.grand_total,a=this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total;this.frm.doc.change_amount=flt(this.frm.doc.paid_amount-r+this.frm.doc.write_off_amount,precision("change_amount")),this.frm.doc.base_change_amount=flt(this.frm.doc.base_paid_amount-a+this.frm.doc.base_write_off_amount,precision("base_change_amount"))}}}calculate_write_off_amount(){this.frm.doc.paid_amount>this.frm.doc.grand_total?(this.frm.doc.write_off_amount=flt(this.frm.doc.grand_total-this.frm.doc.paid_amount+this.frm.doc.change_amount,precision("write_off_amount")),this.frm.doc.base_write_off_amount=flt(this.frm.doc.write_off_amount*this.frm.doc.conversion_rate,precision("base_write_off_amount"))):this.frm.doc.paid_amount=0,this.calculate_outstanding_amount(!1)}};frappe.provide("erpnext.accounts.dimensions");erpnext.TransactionController=class extends erpnext.taxes_and_totals{setup(){super.setup();let e=this;frappe.flags.hide_serial_batch_dialog=!0,frappe.ui.form.on(this.frm.doctype+" Item","rate",function(a,t,_){var o=frappe.get_doc(t,_),i=frappe.meta.has_field(t,"margin_type");frappe.model.round_floats_in(o,["rate","price_list_rate"]),o.price_list_rate?o.rate>o.price_list_rate&&i?(o.discount_percentage=0,o.margin_type="Amount",o.margin_rate_or_amount=flt(o.rate-o.price_list_rate,precision("margin_rate_or_amount",o)),o.rate_with_margin=o.rate):(o.discount_percentage=flt((1-o.rate/o.price_list_rate)*100,precision("discount_percentage",o)),o.discount_amount=flt(o.price_list_rate)-flt(o.rate),o.margin_type="",o.margin_rate_or_amount=0,o.rate_with_margin=0):(o.discount_percentage=0,o.margin_type="",o.margin_rate_or_amount=0,o.rate_with_margin=0),o.base_rate_with_margin=o.rate_with_margin*flt(a.doc.conversion_rate),cur_frm.cscript.set_gross_profit(o),cur_frm.cscript.calculate_taxes_and_totals(),cur_frm.cscript.calculate_stock_uom_rate(a,t,_)}),frappe.ui.form.on(this.frm.cscript.tax_table,"rate",function(a,t,_){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"tax_amount",function(a,t,_){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"row_id",function(a,t,_){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"included_in_print_rate",function(a,t,_){cur_frm.cscript.set_dynamic_labels(),cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype,"apply_discount_on",function(a){a.doc.additional_discount_percentage?a.trigger("additional_discount_percentage"):cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype,"additional_discount_percentage",function(a){if(!a.doc.apply_discount_on){frappe.msgprint(__("Please set 'Apply Additional Discount On'"));return}a.via_discount_percentage=!0,a.doc.additional_discount_percentage&&a.doc.discount_amount&&(a.doc.discount_amount=0,a.cscript.calculate_taxes_and_totals());var t=flt(a.doc[frappe.model.scrub(a.doc.apply_discount_on)]),_=flt(t*flt(a.doc.additional_discount_percentage)/100,precision("discount_amount"));a.set_value("discount_amount",_).then(()=>delete a.via_discount_percentage)}),frappe.ui.form.on(this.frm.doctype,"discount_amount",function(a){a.cscript.set_dynamic_labels(),a.via_discount_percentage||(a.doc.additional_discount_percentage=0),a.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype+" Item",{items_add:function(a,t,_){var o=frappe.get_doc(t,_);!o.warehouse&&a.doc.set_warehouse&&(o.warehouse=a.doc.set_warehouse),!o.target_warehouse&&a.doc.set_target_warehouse&&(o.target_warehouse=a.doc.set_target_warehouse),!o.from_warehouse&&a.doc.set_from_warehouse&&(o.from_warehouse=a.doc.set_from_warehouse),erpnext.accounts.dimensions.copy_dimension_from_first_row(a,t,_,"items")}}),this.frm.fields_dict.items.grid.get_field("batch_no")&&this.frm.set_query("batch_no","items",function(a,t,_){return e.set_query_for_batch(a,t,_)}),this.frm.docstatus<2&&this.frm.fields_dict.payment_terms_template&&this.frm.fields_dict.payment_schedule&&this.frm.doc.payment_terms_template&&!this.frm.doc.payment_schedule.length&&this.frm.trigger("payment_terms_template"),this.frm.fields_dict.taxes&&(this.taxes_remove=this.calculate_taxes_and_totals),this.frm.fields_dict.items&&(this.items_remove=this.calculate_net_weight),this.frm.fields_dict.recurring_print_format&&this.frm.set_query("recurring_print_format",function(a){return{filters:[["Print Format","doc_type","=",cur_frm.doctype]]}}),this.frm.fields_dict.return_against&&this.frm.set_query("return_against",function(a){var t={docstatus:1,is_return:0,company:a.company};return e.frm.fields_dict.customer&&a.customer&&(t.customer=a.customer),e.frm.fields_dict.supplier&&a.supplier&&(t.supplier=a.supplier),{filters:t}}),this.frm.fields_dict.items.grid.get_field("expense_account")&&this.frm.set_query("expense_account","items",function(a){return{filters:{company:a.company}}}),frappe.meta.get_docfield(this.frm.doc.doctype,"pricing_rules")&&this.frm.set_indicator_formatter("pricing_rule",function(a){return a.rule_applied?"green":"red"});let r=this.frm.get_docfield("items","batch_no");r&&(r.get_route_options_for_new_doc=function(a){return{item:a.doc.item_code}}),this.frm.fields_dict.items.grid.get_field("blanket_order")&&this.frm.set_query("blanket_order","items",function(a,t,_){var o=locals[t][_];return{query:"erpnext.controllers.queries.get_blanket_orders",filters:{company:a.company,blanket_order_type:a.doctype==="Sales Order"?"Selling":"Purchasing",item:o.item_code}}}),this.frm.fields_dict.taxes_and_charges&&this.frm.set_query("taxes_and_charges",function(){return{filters:[["company","=",e.frm.doc.company],["docstatus","!=",2]]}})}onload(){var e=this;if(this.frm.doc.__islocal){var r=frappe.defaults.get_user_default("currency");let a=(t,_)=>{if(e.frm.fields_dict[t]&&!e.frm.doc[t])return e.frm.set_value(t,_)};return this.frm.trigger("set_default_internal_warehouse"),frappe.run_serially([()=>a("currency",r),()=>a("price_list_currency",r),()=>a("status","Draft"),()=>a("is_subcontracted",0),()=>{this.frm.doc.company&&!this.frm.doc.amended_from&&this.frm.trigger("company")}])}}is_return(){!this.frm.doc.is_return&&this.frm.doc.return_against&&this.frm.set_value("return_against","")}setup_quality_inspection(){if(!in_list(["Delivery Note","Sales Invoice","Purchase Receipt","Purchase Invoice"],this.frm.doc.doctype))return;let e=this;!this.frm.is_new()&&this.frm.doc.docstatus===0&&(this.frm.add_custom_button(__("Quality Inspection(s)"),()=>{e.make_quality_inspection()},__("Create")),this.frm.page.set_inner_btn_group_as_primary(__("Create")));let r=in_list(["Purchase Receipt","Purchase Invoice"],this.frm.doc.doctype)?"Incoming":"Outgoing",a=this.frm.get_docfield("items","quality_inspection");a.get_route_options_for_new_doc=function(t){if(!e.frm.is_new())return{inspection_type:r,reference_type:e.frm.doc.doctype,reference_name:e.frm.doc.name,item_code:t.doc.item_code,description:t.doc.description,item_serial_no:t.doc.serial_no?t.doc.serial_no.split(`
`)[0]:null,batch_no:t.doc.batch_no}},this.frm.set_query("quality_inspection","items",function(t,_,o){let i=locals[_][o];return{filters:{docstatus:1,inspection_type:r,reference_name:t.name,item_code:i.item_code}}})}make_payment_request(){var e=this;let r=in_list(["Sales Order","Sales Invoice"],this.frm.doc.doctype)?"Inward":"Outward";frappe.call({method:"erpnext.accounts.doctype.payment_request.payment_request.make_payment_request",args:{dt:e.frm.doc.doctype,dn:e.frm.doc.name,recipient_id:e.frm.doc.contact_email,payment_request_type:r,party_type:r=="Outward"?"Supplier":"Customer",party:r=="Outward"?e.frm.doc.supplier:e.frm.doc.customer},callback:function(a){if(!a.exc){var t=frappe.model.sync(a.message);frappe.set_route("Form",a.message.doctype,a.message.name)}}})}onload_post_render(){this.frm.doc.__islocal&&!(this.frm.doc.taxes||[]).length&&!(this.frm.doc.__onload&&this.frm.doc.__onload.load_after_mapping)?frappe.after_ajax(()=>this.apply_default_taxes()):this.frm.doc.__islocal&&this.frm.doc.company&&this.frm.doc.items&&!this.frm.doc.is_pos&&frappe.after_ajax(()=>this.calculate_taxes_and_totals()),frappe.meta.get_docfield(this.frm.doc.doctype+" Item","item_code")&&(this.setup_item_selector(),this.frm.get_field("items").grid.set_multiple_add("item_code","qty"))}refresh(){erpnext.toggle_naming_series(),erpnext.hide_company(),this.set_dynamic_labels(),this.setup_sms(),this.setup_quality_inspection();let e=this.frm.get_field("scan_barcode");if(e&&e.get_value()&&(e.set_value(""),e.set_new_description(""),frappe.is_mobile())){if(e.$input_wrapper.find(".input-group").length)return;let r=$('<div class="input-group">');e.$input_wrapper.find(".control-input").append(r),r.append(e.$input),$(`<span class="input-group-btn" style="vertical-align: top">
						<button class="btn btn-default border" type="button">
							<i class="fa fa-camera text-muted"></i>
						</button>
					</span>`).on("click",".btn",()=>{frappe.barcode.scan_barcode().then(a=>{e.set_value(a)})}).appendTo(r)}}scan_barcode(){let e=this.frm.fields_dict.scan_barcode,r=function(a,t=null){t?frappe.show_alert({message:__("Row #{0}: Qty increased by 1",[a]),indicator:"green"}):frappe.show_alert({message:__("Row #{0}: Item added",[a]),indicator:"green"})};return this.frm.doc.scan_barcode&&frappe.call({method:"erpnext.selling.page.point_of_sale.point_of_sale.search_for_serial_or_batch_or_barcode_number",args:{search_value:this.frm.doc.scan_barcode}}).then(a=>{let t=a&&a.message;if(!t||Object.keys(t).length===0){frappe.show_alert({message:__("Cannot find Item with this Barcode"),indicator:"red"});return}let _=this.frm.fields_dict.items.grid,o=null,i=this.frm.doc.items.find(s=>s.item_code===t.item_code),n=this.frm.doc.items.find(s=>!s.item_code);i?o=i:n&&(o=n),o||(o=frappe.model.add_child(this.frm.doc,_.doctype,"items")),r(o.idx,o.item_code),this.frm.from_barcode=this.frm.from_barcode?this.frm.from_barcode+1:1,frappe.model.set_value(o.doctype,o.name,{item_code:t.item_code,qty:(o.qty||0)+1}),["serial_no","batch_no","barcode"].forEach(s=>{if(t[s]&&frappe.meta.has_field(o.doctype,s)){let l=o[s]&&s==="serial_no"?o[s]+`
`+t[s]:t[s];frappe.model.set_value(o.doctype,o.name,s,l)}}),e.set_value(""),refresh_field("items")}),!1}apply_default_taxes(){var e=this,r=frappe.meta.get_docfield(e.frm.doc.doctype,"taxes_and_charges",e.frm.doc.name);if(!(!this.frm.doc.taxes_and_charges&&this.frm.doc.taxes&&this.frm.doc.taxes.length>0)&&r)return frappe.call({method:"erpnext.controllers.accounts_controller.get_default_taxes_and_charges",args:{master_doctype:r.options,tax_template:e.frm.doc.taxes_and_charges||"",company:e.frm.doc.company},debounce:2e3,callback:function(a){!a.exc&&a.message&&frappe.run_serially([()=>{a.message.taxes_and_charges&&(e.frm.doc.taxes_and_charges=a.message.taxes_and_charges),a.message.taxes&&e.frm.set_value("taxes",a.message.taxes)},()=>e.set_dynamic_labels(),()=>e.calculate_taxes_and_totals()])}})}setup_sms(){var e=this;let r=["Purchase Invoice","BOM"];this.frm.doc.docstatus===1&&!in_list(["Lost","Stopped","Closed"],this.frm.doc.status)&&!r.includes(this.frm.doctype)&&this.frm.page.add_menu_item(__("Send SMS"),function(){e.send_sms()})}send_sms(){var e=new erpnext.SMSManager(this.frm.doc)}barcode(e,r,a){var t=locals[r][a];(t.barcode==""||t.barcode==null)&&(t.item_code=""),this.frm.from_barcode=this.frm.from_barcode?this.frm.from_barcode+1:1,this.item_code(e,r,a)}item_code(e,r,a){var t=this,_=frappe.get_doc(r,a),o=0,i=0;if(["Sales Invoice"].includes(this.frm.doc.doctype)?(o=cint(t.frm.doc.update_stock),i=o):(this.frm.doc.doctype==="Purchase Receipt"&&t.frm.doc.is_return||this.frm.doc.doctype==="Delivery Note")&&(i=1),this.frm.from_barcode==0&&(_.barcode=null),this.frm.from_barcode=this.frm.from_barcode-1>=0?this.frm.from_barcode-1:0,_.item_code||_.barcode||_.serial_no)if(!this.validate_company_and_party())this.frm.fields_dict.items.grid.grid_rows[_.idx-1].remove();else return this.frm.call({method:"erpnext.stock.get_item_details.get_item_details",child:_,args:{doc:t.frm.doc,args:{item_code:_.item_code,barcode:_.barcode,serial_no:_.serial_no,batch_no:_.batch_no,set_warehouse:t.frm.doc.set_warehouse,warehouse:_.warehouse,customer:t.frm.doc.customer||t.frm.doc.party_name,quotation_to:t.frm.doc.quotation_to,supplier:t.frm.doc.supplier,currency:t.frm.doc.currency,update_stock:o,conversion_rate:t.frm.doc.conversion_rate,price_list:t.frm.doc.selling_price_list||t.frm.doc.buying_price_list,price_list_currency:t.frm.doc.price_list_currency,plc_conversion_rate:t.frm.doc.plc_conversion_rate,company:t.frm.doc.company,order_type:t.frm.doc.order_type,is_pos:cint(t.frm.doc.is_pos),is_return:cint(t.frm.doc.is_return),is_subcontracted:t.frm.doc.is_subcontracted,transaction_date:t.frm.doc.transaction_date||t.frm.doc.posting_date,ignore_pricing_rule:t.frm.doc.ignore_pricing_rule,doctype:t.frm.doc.doctype,name:t.frm.doc.name,project:_.project||t.frm.doc.project,qty:_.qty||1,net_rate:_.rate,stock_qty:_.stock_qty,conversion_factor:_.conversion_factor,weight_per_unit:_.weight_per_unit,weight_uom:_.weight_uom,manufacturer:_.manufacturer,stock_uom:_.stock_uom,pos_profile:cint(t.frm.doc.is_pos)?t.frm.doc.pos_profile:"",cost_center:_.cost_center,tax_category:t.frm.doc.tax_category,item_tax_template:_.item_tax_template,child_docname:_.name}},callback:function(n){n.exc||frappe.run_serially([()=>{var s=locals[r][a];t.add_taxes_from_item_tax_template(s.item_tax_rate),s.free_item_data&&t.apply_product_discount(s)},()=>{t.frm.doc.is_internal_customer||t.frm.doc.is_internal_supplier?t.get_incoming_rate(_,t.frm.posting_date,t.frm.posting_time,t.frm.doc.doctype,t.frm.doc.company):t.frm.script_manager.trigger("price_list_rate",r,a)},()=>{(t.frm.doc.is_internal_customer||t.frm.doc.is_internal_supplier)&&t.calculate_taxes_and_totals()},()=>t.toggle_conversion_factor(_),()=>{if(i)return frappe.db.get_value("Item",_.item_code,["has_batch_no","has_serial_no"]).then(s=>{s.message&&(s.message.has_batch_no||s.message.has_serial_no)&&(frappe.flags.hide_serial_batch_dialog=!1)})},()=>{if(i&&!frappe.flags.hide_serial_batch_dialog)return frappe.db.get_single_value("Stock Settings","disable_serial_no_and_batch_selector").then(s=>{s&&(frappe.flags.hide_serial_batch_dialog=!0)})},()=>{if(i&&!frappe.flags.hide_serial_batch_dialog){var s=locals[r][a];$.each(n.message,function(l,d){s[l]||(s[l]=d)}),s.has_batch_no&&s.has_serial_no&&(s.batch_no=void 0),erpnext.show_serial_batch_selector(t.frm,s,l=>{t.frm.script_manager.trigger("qty",l.doctype,l.name),t.frm.doc.set_warehouse||t.frm.script_manager.trigger("warehouse",l.doctype,l.name)},void 0,!frappe.flags.hide_serial_batch_dialog)}},()=>t.conversion_factor(e,r,a,!0),()=>t.remove_pricing_rule(_),()=>{if(_.apply_rule_on_other_items){let s=_.name;t.apply_rule_on_other_items({key:_})}},()=>{var s=t.get_company_currency();t.update_item_grid_labels(s)}])}})}price_list_rate(e,r,a){var t=frappe.get_doc(r,a);frappe.model.round_floats_in(t,["price_list_rate","discount_percentage"]),in_list(["Quotation Item","Sales Order Item","Delivery Note Item","Sales Invoice Item","POS Invoice Item","Purchase Invoice Item","Purchase Order Item","Purchase Receipt Item","Proforma Invoice Item"]),r?this.apply_pricing_rule_on_item(t):t.rate=flt(t.price_list_rate*(1-t.discount_percentage/100),precision("rate",t)),this.calculate_taxes_and_totals()}margin_rate_or_amount(e,r,a){let t=frappe.get_doc(r,a);this.apply_pricing_rule_on_item(t),this.calculate_taxes_and_totals(),cur_frm.refresh_fields()}margin_type(e,r,a){let t=frappe.get_doc(r,a);t.margin_type?(this.apply_pricing_rule_on_item(t,e,r,a),this.calculate_taxes_and_totals(),cur_frm.refresh_fields()):frappe.model.set_value(r,a,"margin_rate_or_amount",0)}get_incoming_rate(e,r,a,t,_){let o={item_code:e.item_code,warehouse:in_list("Purchase Receipt","Purchase Invoice")?e.from_warehouse:e.warehouse,posting_date:r,posting_time:a,qty:e.qty*e.conversion_factor,serial_no:e.serial_no,voucher_type:t,company:_,allow_zero_valuation_rate:e.allow_zero_valuation_rate};frappe.call({method:"erpnext.stock.utils.get_incoming_rate",args:{args:o},callback:function(i){frappe.model.set_value(e.doctype,e.name,"rate",i.message*e.conversion_factor)}})}serial_no(e,r,a){var t=this,_=frappe.get_doc(r,a);_&&_.doctype==="Purchase Receipt Item Supplied"||_&&_.serial_no&&(_.item_code?(_.serial_no=_.serial_no.replace(/,/g,`
`),_.conversion_factor=_.conversion_factor||1,refresh_field("serial_no",_.name,_.parentfield),!e.is_return&&cint(frappe.user_defaults.set_qty_in_transactions_based_on_serial_no_input)&&setTimeout(()=>{t.update_qty(r,a)},1e4)):this.frm.trigger("item_code",r,a))}update_qty(e,r){var a=[],t=[],_=frappe.get_doc(e,r);t=_.serial_no.split(`
`);for(var o=0;o<t.length;o++)t[o]!=""&&a.push(t[o]);frappe.model.set_value(_.doctype,_.name,"qty",a.length/_.conversion_factor),frappe.model.set_value(_.doctype,_.name,"stock_qty",a.length)}validate(){this.calculate_taxes_and_totals(!1)}update_stock(){this.frm.trigger("set_default_internal_warehouse")}set_default_internal_warehouse(){let e=this;(this.frm.doc.doctype==="Sales Invoice"&&e.frm.doc.update_stock||this.frm.doc.doctype=="Delivery Note")&&this.frm.doc.is_internal_customer&&this.frm.doc.company===this.frm.doc.represents_company&&frappe.db.get_value("Company",this.frm.doc.company,"default_in_transit_warehouse",function(r){e.frm.set_value("set_target_warehouse",r.default_in_transit_warehouse)}),(this.frm.doc.doctype==="Purchase Invoice"&&e.frm.doc.update_stock||this.frm.doc.doctype=="Purchase Receipt")&&this.frm.doc.is_internal_supplier&&this.frm.doc.company===this.frm.doc.represents_company&&frappe.db.get_value("Company",this.frm.doc.company,"default_in_transit_warehouse",function(r){e.frm.set_value("set_from_warehouse",r.default_in_transit_warehouse)})}company(){var e=this,r=function(){if(e.frm.doc.company&&e.frm.fields_dict.currency){var t=e.get_company_currency(),_=frappe.get_doc(":Company",e.frm.doc.company);e.frm.doc.currency||e.frm.set_value("currency",t),e.frm.doc.currency==t&&e.frm.set_value("conversion_rate",1),e.frm.doc.price_list_currency==t&&e.frm.set_value("plc_conversion_rate",1),_.default_letter_head&&e.frm.fields_dict.letter_head&&e.frm.set_value("letter_head",_.default_letter_head);let o=["Sales Invoice","Quotation","Sales Order","Delivery Note","Proforma Invoice"];_.default_selling_terms&&frappe.meta.has_field(e.frm.doc.doctype,"tc_name")&&o.indexOf(e.frm.doc.doctype)!=-1&&e.frm.set_value("tc_name",_.default_selling_terms);let i=["Request for Quotation","Supplier Quotation","Purchase Order","Material Request","Purchase Receipt"];_.default_buying_terms&&frappe.meta.has_field(e.frm.doc.doctype,"tc_name")&&i.indexOf(e.frm.doc.doctype)!=-1&&e.frm.set_value("tc_name",_.default_buying_terms),frappe.run_serially([()=>e.frm.script_manager.trigger("currency"),()=>e.update_item_tax_map(),()=>e.apply_default_taxes(),()=>e.apply_pricing_rule()])}},a=function(t){if(in_list(["Sales Invoice","Purchase Invoice"],e.frm.doc.doctype)){if(e.frm.doc.doctype=="Sales Invoice")var _="Customer",o="debit_to";else var _="Supplier",o="credit_to";var i=e.frm.doc[frappe.model.scrub(_)];if(i&&e.frm.doc.company)return frappe.call({method:"erpnext.accounts.party.get_party_account",args:{company:e.frm.doc.company,party_type:_,party:i},callback:function(n){!n.exc&&n.message&&(e.frm.set_value(o,n.message),t())}});t()}else t()};frappe.meta.get_docfield(this.frm.doctype,"shipping_address")&&in_list(["Purchase Order","Purchase Receipt","Purchase Invoice"],this.frm.doctype)?(erpnext.utils.get_shipping_address(this.frm,function(){a(r)}),frappe.call({method:"frappe.contacts.doctype.address.address.get_default_address",args:{doctype:"Company",name:this.frm.doc.company},callback:function(t){e.frm.set_value("billing_address",t.message)}})):a(r),this.frm.doc.company&&(erpnext.last_selected_company=this.frm.doc.company)}transaction_date(){this.frm.doc.transaction_date&&(this.frm.transaction_date=this.frm.doc.transaction_date,frappe.ui.form.trigger(this.frm.doc.doctype,"currency"))}posting_date(){var e=this;if(this.frm.doc.posting_date){if(this.frm.posting_date=this.frm.doc.posting_date,this.frm.doc.doctype=="Sales Invoice"&&this.frm.doc.customer||this.frm.doc.doctype=="Purchase Invoice"&&this.frm.doc.supplier)return frappe.call({method:"erpnext.accounts.party.get_due_date",args:{posting_date:e.frm.doc.posting_date,party_type:e.frm.doc.doctype=="Sales Invoice"?"Customer":"Supplier",bill_date:e.frm.doc.bill_date,party:e.frm.doc.doctype=="Sales Invoice"?e.frm.doc.customer:e.frm.doc.supplier,company:e.frm.doc.company},callback:function(r,a){r.message&&(e.frm.doc.due_date=r.message,refresh_field("due_date"),frappe.ui.form.trigger(e.frm.doc.doctype,"currency"),e.recalculate_terms())}});frappe.ui.form.trigger(e.frm.doc.doctype,"currency")}}due_date(){if(this.frm.doc.due_date&&!this.frm.updating_party_details&&!this.frm.doc.is_pos&&(this.frm.doc.payment_terms_template||this.frm.doc.payment_schedule&&this.frm.doc.payment_schedule.length)){var e="",r="",a=__("Please clear the")+" ";this.frm.doc.payment_terms_template&&(e=__("selected Payment Terms Template"),a=a+e),(this.frm.doc.payment_schedule||[]).length&&(r=__("Payment Schedule Table"),e.length!==0&&(r=" and "+r),a=a+r),frappe.msgprint(a)}}bill_date(){this.posting_date()}recalculate_terms(){let e=this.frm.doc;if(e.payment_terms_template)this.payment_terms_template();else if(e.payment_schedule){let r=this;e.payment_schedule.forEach(function(a){a.payment_term?r.payment_term(e,a.doctype,a.name):frappe.model.set_value(a.doctype,a.name,"due_date",e.posting_date||e.transaction_date)})}}get_company_currency(){return erpnext.get_currency(this.frm.doc.company)}contact_person(){erpnext.utils.get_contact_details(this.frm)}currency(){var e=this.frm.doc.transaction_date||this.frm.doc.posting_date,r=this;this.set_dynamic_labels();var a=this.get_company_currency();this.frm.doc.currency&&this.frm.doc.currency!==a&&!this.frm.doc.ignore_pricing_rule?this.get_exchange_rate(e,this.frm.doc.currency,a,function(t){t!=r.frm.doc.conversion_rate&&(r.set_margin_amount_based_on_currency(t),r.set_actual_charges_based_on_currency(t),r.frm.set_value("conversion_rate",t))}):this.conversion_rate()}conversion_rate(){let e=this.frm;this.frm.doc.currency===this.get_company_currency()&&this.frm.set_value("conversion_rate",1),this.frm.doc.currency===this.frm.doc.price_list_currency&&this.frm.doc.plc_conversion_rate!==this.frm.doc.conversion_rate&&this.frm.set_value("plc_conversion_rate",this.frm.doc.conversion_rate),flt(this.frm.doc.conversion_rate)>0&&(this.frm.doc.ignore_pricing_rule?this.calculate_taxes_and_totals():this.in_apply_price_list&&this.apply_price_list()),this.frm.set_df_property("conversion_rate","read_only",erpnext.stale_rate_allowed()?0:1)}shipping_rule(){var e=this;if(this.frm.doc.shipping_rule)return this.frm.call({doc:this.frm.doc,method:"apply_shipping_rule",callback:function(r){r.exc||e.calculate_taxes_and_totals()}}).fail(()=>this.frm.set_value("shipping_rule",""));e.calculate_taxes_and_totals()}set_margin_amount_based_on_currency(e){if(in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice","Purchase Invoice","Purchase Order","Purchase Receipt","Proforma Invoice"]),this.frm.doc.doctype){var r=this;$.each(this.frm.doc.items||[],function(a,t){t.margin_type=="Amount"&&frappe.model.set_value(t.doctype,t.name,"margin_rate_or_amount",flt(t.margin_rate_or_amount)/flt(e))})}}set_actual_charges_based_on_currency(e){var r=this;$.each(this.frm.doc.taxes||[],function(a,t){t.charge_type=="Actual"&&frappe.model.set_value(t.doctype,t.name,"tax_amount",flt(t.tax_amount)/flt(e))})}get_exchange_rate(e,r,a,t){var _;if(["Quotation","Sales Order","Delivery Note","Sales Invoice","Proforma Invoice"].includes(this.frm.doctype)?_="for_selling":["Purchase Order","Purchase Receipt","Purchase Invoice"].includes(this.frm.doctype)&&(_="for_buying"),!(!e||!r||!a))return frappe.call({method:"erpnext.setup.utils.get_exchange_rate",args:{transaction_date:e,from_currency:r,to_currency:a,args:_},freeze:!0,freeze_message:__("Fetching exchange rates ..."),callback:function(o){t(flt(o.message))}})}price_list_currency(){var e=this;this.set_dynamic_labels();var r=this.get_company_currency();this.frm.doc.price_list_currency!==r&&!this.frm.doc.ignore_pricing_rule?this.get_exchange_rate(this.frm.doc.posting_date,this.frm.doc.price_list_currency,r,function(a){e.frm.set_value("plc_conversion_rate",a)}):this.plc_conversion_rate()}plc_conversion_rate(){this.frm.doc.price_list_currency===this.get_company_currency()?this.frm.set_value("plc_conversion_rate",1):this.frm.doc.price_list_currency===this.frm.doc.currency&&this.frm.doc.plc_conversion_rate&&cint(this.frm.doc.plc_conversion_rate)!=1&&cint(this.frm.doc.plc_conversion_rate)!=cint(this.frm.doc.conversion_rate)&&this.frm.set_value("conversion_rate",this.frm.doc.plc_conversion_rate),this.in_apply_price_list||this.apply_price_list(null,!0)}uom(e,r,a){var t=this,_=frappe.get_doc(r,a);if(_.item_code&&_.uom)return this.frm.call({method:"erpnext.stock.get_item_details.get_conversion_factor",args:{item_code:_.item_code,uom:_.uom},callback:function(o){o.exc||frappe.model.set_value(r,a,"conversion_factor",o.message.conversion_factor)}});t.calculate_stock_uom_rate(e,r,a)}conversion_factor(e,r,a,t){if(frappe.meta.get_docfield(r,"stock_qty",a)){var _=frappe.get_doc(r,a);if(frappe.model.round_floats_in(_,["qty","conversion_factor"]),_.stock_qty=flt(_.qty*_.conversion_factor,precision("stock_qty",_)),refresh_field("stock_qty",_.name,_.parentfield),this.toggle_conversion_factor(_),e.doctype!="Material Request"&&(_.total_weight=flt(_.stock_qty*_.weight_per_unit),refresh_field("total_weight",_.name,_.parentfield),this.calculate_net_weight()),frappe.flags.dont_fetch_price_list_rate)return;!t&&frappe.meta.has_field(e.doctype,"price_list_currency")&&this.apply_price_list(_,!0),this.calculate_stock_uom_rate(e,r,a)}}batch_no(e,r,a){let t=frappe.get_doc(r,a);this.apply_price_list(t,!0)}toggle_conversion_factor(e){this.frm.get_field("items").grid.fields_map.conversion_factor&&this.frm.fields_dict.items.grid.toggle_enable("conversion_factor",e.uom!=e.stock_uom&&!frappe.meta.get_docfield(cur_frm.fields_dict.items.grid.doctype,"conversion_factor").read_only)}qty(e,r,a){let t=frappe.get_doc(r,a);this.conversion_factor(e,r,a,!0),this.calculate_stock_uom_rate(e,r,a),this.apply_pricing_rule(t,!0)}calculate_stock_uom_rate(e,r,a){let t=frappe.get_doc(r,a);t.stock_uom_rate=flt(t.rate)/flt(t.conversion_factor),refresh_field("stock_uom_rate",t.name,t.parentfield)}service_stop_date(e,r,a){var t=locals[r][a];if(t.service_stop_date){let _=Date.parse(t.service_start_date),o=Date.parse(t.service_end_date),i=Date.parse(t.service_stop_date);i<_?(frappe.model.set_value(r,a,"service_stop_date",""),frappe.throw(__("Service Stop Date cannot be before Service Start Date"))):i>o&&(frappe.model.set_value(r,a,"service_stop_date",""),frappe.throw(__("Service Stop Date cannot be after Service End Date")))}}service_start_date(e,r,a){var t=locals[r][a];t.service_start_date&&frappe.call({method:"erpnext.stock.get_item_details.calculate_service_end_date",args:{args:t},callback:function(_){frappe.model.set_value(r,a,"service_end_date",_.message.service_end_date)}})}calculate_net_weight(){var e=this;this.frm.doc.total_net_weight=0,$.each(this.frm.doc.items||[],function(r,a){e.frm.doc.total_net_weight+=flt(a.total_weight)}),refresh_field("total_net_weight"),this.shipping_rule()}set_dynamic_labels(){this.frm.toggle_reqd("plc_conversion_rate",!!(this.frm.doc.price_list_name&&this.frm.doc.price_list_currency));var e=this.get_company_currency();this.change_form_labels(e),this.change_grid_labels(e),this.frm.refresh_fields()}change_form_labels(e){var r=this;this.frm.set_currency_labels(["base_total","base_net_total","base_total_taxes_and_charges","base_discount_amount","base_grand_total","base_rounded_total","base_in_words","base_taxes_and_charges_added","base_taxes_and_charges_deducted","total_amount_to_pay","base_paid_amount","base_write_off_amount","base_change_amount","base_operating_cost","base_raw_material_cost","base_total_cost","base_scrap_material_cost","base_rounding_adjustment"],e),this.frm.set_currency_labels(["total","net_total","total_taxes_and_charges","discount_amount","grand_total","taxes_and_charges_added","taxes_and_charges_deducted","rounded_total","in_words","paid_amount","write_off_amount","operating_cost","scrap_material_cost","rounding_adjustment","raw_material_cost","total_cost"],this.frm.doc.currency),this.frm.set_currency_labels(["outstanding_amount","total_advance"],this.frm.doc.party_account_currency),cur_frm.set_df_property("conversion_rate","description","1 "+this.frm.doc.currency+" = [?] "+e),this.frm.doc.price_list_currency&&this.frm.doc.price_list_currency!=e&&cur_frm.set_df_property("plc_conversion_rate","description","1 "+this.frm.doc.price_list_currency+" = [?] "+e),this.frm.toggle_display(["conversion_rate","base_total","base_net_total","base_total_taxes_and_charges","base_taxes_and_charges_added","base_taxes_and_charges_deducted","base_grand_total","base_rounded_total","base_in_words","base_discount_amount","base_paid_amount","base_write_off_amount","base_operating_cost","base_raw_material_cost","base_total_cost","base_scrap_material_cost","base_rounding_adjustment"],this.frm.doc.currency!=e),this.frm.toggle_display(["plc_conversion_rate","price_list_currency"],this.frm.doc.price_list_currency!=e);var a=cint(cur_frm.doc.discount_amount)||(cur_frm.doc.taxes||[]).filter(function(t){return t.included_in_print_rate===1}).length;frappe.meta.get_docfield(cur_frm.doctype,"net_total")&&cur_frm.toggle_display("net_total",a),frappe.meta.get_docfield(cur_frm.doctype,"base_net_total")&&cur_frm.toggle_display("base_net_total",a&&r.frm.doc.currency!=e)}change_grid_labels(e){var r=this;if(this.update_item_grid_labels(e),this.toggle_item_grid_columns(e),this.frm.doc.operations&&this.frm.doc.operations.length>0){this.frm.set_currency_labels(["operating_cost","hour_rate"],this.frm.doc.currency,"operations"),this.frm.set_currency_labels(["base_operating_cost","base_hour_rate"],e,"operations");var a=this.frm.fields_dict.operations.grid;$.each(["base_operating_cost","base_hour_rate"],function(t,_){frappe.meta.get_docfield(a.doctype,_)&&a.set_column_disp(_,r.frm.doc.currency!=e)})}if(this.frm.doc.scrap_items&&this.frm.doc.scrap_items.length>0){this.frm.set_currency_labels(["rate","amount"],this.frm.doc.currency,"scrap_items"),this.frm.set_currency_labels(["base_rate","base_amount"],e,"scrap_items");var a=this.frm.fields_dict.scrap_items.grid;$.each(["base_rate","base_amount"],function(_,o){frappe.meta.get_docfield(a.doctype,o)&&a.set_column_disp(o,r.frm.doc.currency!=e)})}this.frm.doc.taxes&&this.frm.doc.taxes.length>0&&(this.frm.set_currency_labels(["tax_amount","total","tax_amount_after_discount"],this.frm.doc.currency,"taxes"),this.frm.set_currency_labels(["base_tax_amount","base_total","base_tax_amount_after_discount"],e,"taxes")),this.frm.doc.advances&&this.frm.doc.advances.length>0&&this.frm.set_currency_labels(["advance_amount","allocated_amount"],this.frm.doc.party_account_currency,"advances"),this.update_payment_schedule_grid_labels(e)}update_item_grid_labels(e){this.frm.set_currency_labels(["base_rate","base_net_rate","base_price_list_rate","base_amount","base_net_amount","base_rate_with_margin"],e,"items"),this.frm.set_currency_labels(["rate","net_rate","price_list_rate","amount","net_amount","stock_uom_rate","rate_with_margin"],this.frm.doc.currency,"items")}update_payment_schedule_grid_labels(e){let r=this;if(this.frm.doc.payment_schedule&&this.frm.doc.payment_schedule.length>0){this.frm.set_currency_labels(["base_payment_amount","base_outstanding","base_paid_amount"],e,"payment_schedule"),this.frm.set_currency_labels(["payment_amount","outstanding","paid_amount"],this.frm.doc.currency,"payment_schedule");var a=this.frm.fields_dict.payment_schedule.grid;$.each(["base_payment_amount","base_outstanding","base_paid_amount"],function(t,_){frappe.meta.get_docfield(a.doctype,_)&&a.set_column_disp(_,r.frm.doc.currency!=e)})}}toggle_item_grid_columns(e){let r=this;var a=this.frm.fields_dict.items.grid;$.each(["base_rate","base_price_list_rate","base_amount","base_rate_with_margin"],function(_,o){frappe.meta.get_docfield(a.doctype,o)&&a.set_column_disp(o,r.frm.doc.currency!=e)});var t=cint(cur_frm.doc.discount_amount)||(cur_frm.doc.taxes||[]).filter(function(_){return _.included_in_print_rate===1}).length;$.each(["net_rate","net_amount"],function(_,o){frappe.meta.get_docfield(a.doctype,o)&&a.set_column_disp(o,t)}),$.each(["base_net_rate","base_net_amount"],function(_,o){frappe.meta.get_docfield(a.doctype,o)&&a.set_column_disp(o,t&&r.frm.doc.currency!=e)})}recalculate(){this.calculate_taxes_and_totals()}recalculate_values(){this.calculate_taxes_and_totals()}calculate_charges(){this.calculate_taxes_and_totals()}ignore_pricing_rule(){if(this.frm.doc.ignore_pricing_rule){var e=this,r=[];return $.each(this.frm.doc.items||[],function(a,t){t.item_code&&!t.is_free_item&&r.push({doctype:t.doctype,name:t.name,item_code:t.item_code,pricing_rules:t.pricing_rules,parenttype:t.parenttype,parent:t.parent})}),this.frm.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.remove_pricing_rules",args:{item_list:r},callback:function(a){!a.exc&&a.message&&(a.message.forEach(t=>{e.remove_pricing_rule(t)}),e._set_values_for_item_list(a.message),e.calculate_taxes_and_totals(),e.frm.doc.apply_discount_on&&e.frm.trigger("apply_discount_on"))}})}else this.apply_pricing_rule()}apply_pricing_rule(e,r){var a=this,t=this._get_args(e);if(!(t.items&&t.items.length)){r&&a.calculate_taxes_and_totals();return}return this.frm.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.apply_pricing_rule",args:{args:t,doc:a.frm.doc},callback:function(_){!_.exc&&_.message&&(a._set_values_for_item_list(_.message),e&&a.set_gross_profit(e),a.frm.doc.apply_discount_on&&a.frm.trigger("apply_discount_on"))}})}_get_args(e){var r=this;return{items:this._get_item_list(e),customer:r.frm.doc.customer||r.frm.doc.party_name,quotation_to:r.frm.doc.quotation_to,customer_group:r.frm.doc.customer_group,territory:r.frm.doc.territory,supplier:r.frm.doc.supplier,supplier_group:r.frm.doc.supplier_group,currency:r.frm.doc.currency,conversion_rate:r.frm.doc.conversion_rate,price_list:r.frm.doc.selling_price_list||r.frm.doc.buying_price_list,price_list_currency:r.frm.doc.price_list_currency,plc_conversion_rate:r.frm.doc.plc_conversion_rate,company:r.frm.doc.company,transaction_date:r.frm.doc.transaction_date||r.frm.doc.posting_date,campaign:r.frm.doc.campaign,sales_partner:r.frm.doc.sales_partner,ignore_pricing_rule:r.frm.doc.ignore_pricing_rule,doctype:r.frm.doc.doctype,name:r.frm.doc.name,is_return:cint(r.frm.doc.is_return),update_stock:in_list(["Sales Invoice","Purchase Invoice"],r.frm.doc.doctype)?cint(r.frm.doc.update_stock):0,conversion_factor:r.frm.doc.conversion_factor,pos_profile:r.frm.doc.doctype=="Sales Invoice"?r.frm.doc.pos_profile:"",coupon_code:r.frm.doc.coupon_code}}_get_item_list(e){var r=[],a=function(t){t.item_code&&(r.push({doctype:t.doctype,name:t.name,child_docname:t.name,item_code:t.item_code,item_group:t.item_group,brand:t.brand,qty:t.qty,stock_qty:t.stock_qty,uom:t.uom,stock_uom:t.stock_uom,parenttype:t.parenttype,parent:t.parent,pricing_rules:t.pricing_rules,warehouse:t.warehouse,serial_no:t.serial_no,batch_no:t.batch_no,price_list_rate:t.price_list_rate,conversion_factor:t.conversion_factor||1}),in_list(["Quotation Item","Sales Order Item","Delivery Note Item","Sales Invoice Item","Purchase Invoice Item","Purchase Order Item","Purchase Receipt Item","Proforma Invoice Item"]),t.doctype&&(r[0].margin_type=t.margin_type,r[0].margin_rate_or_amount=t.margin_rate_or_amount))};return e?a(e):$.each(this.frm.doc.items||[],function(t,_){a(_)}),r}_set_values_for_item_list(e){for(var r=this,a=!1,t={},_=0,o=e.length;_<o;_++){var i=e[_],n=frappe.model.get_value(i.doctype,i.name,"pricing_rules");for(var s in i){var l=i[s];["doctype","name"].indexOf(s)===-1&&(s=="price_list_rate"&&flt(l)!=flt(i.price_list_rate)&&(a=!0),s!=="free_item_data"&&frappe.model.set_value(i.doctype,i.name,s,l))}!r.frm.doc.ignore_pricing_rule&&n&&!i.pricing_rules?r.apply_price_list(frappe.get_doc(i.doctype,i.name)):i.pricing_rules||r.remove_pricing_rule(frappe.get_doc(i.doctype,i.name)),i.free_item_data&&r.apply_product_discount(i),i.apply_rule_on_other_items&&(t[i.name]=i)}r.apply_rule_on_other_items(t),a||r.calculate_taxes_and_totals()}apply_rule_on_other_items(e){let r=this,a=["discount_percentage","pricing_rules","discount_amount","rate"];for(var t in e){let _=e[t];_&&_.apply_rule_on_other_items&&r.frm.doc.items.forEach(o=>{if(in_list(_.apply_rule_on_other_items,o[_.apply_rule_on]))for(var i in _)in_list(a,i)&&_[i]&&(_.price_or_product_discount==="price"||i==="pricing_rules")&&frappe.model.set_value(o.doctype,o.name,i,_[i])})}}apply_product_discount(e){let r=this.frm.doc.items.filter(t=>t.is_free_item)||[],a=r.map(t=>(t.item_code,t.pricing_rules));e.free_item_data.forEach(t=>{let _={};!r||!in_list(a,(t.item_code,t.pricing_rules))?_=frappe.model.add_child(this.frm.doc,this.frm.doc.doctype+" Item","items"):r&&(_=r.filter(o=>o.item_code===t.item_code&&o.pricing_rules===t.pricing_rules)[0]);for(let o in t)_[o]=t[o]}),e.free_item_data="",refresh_field("items")}apply_price_list(e,r){r||this.frm.set_value("plc_conversion_rate","");var a=this,t=this._get_args(e);if(!!(t.items&&t.items.length||t.price_list)&&a.in_apply_price_list!=!0)return a.in_apply_price_list=!0,this.frm.call({method:"erpnext.stock.get_item_details.apply_price_list",args:{args:t},callback:function(_){_.exc?a.in_apply_price_list=!1:frappe.run_serially([()=>a.frm.set_value("price_list_currency",_.message.parent.price_list_currency),()=>a.frm.set_value("plc_conversion_rate",_.message.parent.plc_conversion_rate),()=>{t.items.length&&a._set_values_for_item_list(_.message.children)},()=>{a.in_apply_price_list=!1}])}}).always(()=>{a.in_apply_price_list=!1})}remove_pricing_rule(e){let r=this,a=["discount_percentage","discount_amount","margin_rate_or_amount","rate_with_margin"];if(e.remove_free_item){var t=[];r.frm.doc.items.forEach(_=>{(_.item_code!=e.remove_free_item||!_.is_free_item)&&t.push(_)}),r.frm.doc.items=t,refresh_field("items")}else if(e.applied_on_items&&e.apply_on){let _=e.applied_on_items.split(",");r.frm.doc.items.forEach(o=>{_.includes(o[e.apply_on])&&(a.forEach(i=>{o[i]=0}),["pricing_rules","margin_type"].forEach(i=>{o[i]&&(o[i]="")}))}),r.trigger_price_list_rate()}}trigger_price_list_rate(){var e=this;this.frm.doc.items.forEach(r=>{e.frm.script_manager.trigger("price_list_rate",r.doctype,r.name)})}validate_company_and_party(){var e=this,r=!0;return $.each(["company","customer"],function(a,t){frappe.meta.has_field(e.frm.doc.doctype,t)&&e.frm.doc.doctype!="Purchase Order"&&(e.frm.doc[t]||(frappe.msgprint(__("Please specify")+": "+frappe.meta.get_label(e.frm.doc.doctype,t,e.frm.doc.name)+". "+__("It is needed to fetch Item Details.")),r=!1))}),r}get_terms(){var e=this;erpnext.utils.get_terms(this.frm.doc.tc_name,this.frm.doc,function(r){r.exc||e.frm.set_value("terms",r.message)})}taxes_and_charges(){var e=this;if(this.frm.doc.taxes_and_charges)return this.frm.call({method:"erpnext.controllers.accounts_controller.get_taxes_and_charges",args:{master_doctype:frappe.meta.get_docfield(this.frm.doc.doctype,"taxes_and_charges",this.frm.doc.name).options,master_name:this.frm.doc.taxes_and_charges},callback:function(r){if(!r.exc)if(e.frm.doc.shipping_rule&&e.frm.doc.taxes){for(let a of r.message)e.frm.add_child("taxes",a);refresh_field("taxes")}else e.frm.set_value("taxes",r.message),e.calculate_taxes_and_totals()}})}tax_category(){var e=this;e.frm.updating_party_details||frappe.run_serially([()=>this.update_item_tax_map(),()=>erpnext.utils.set_taxes(this.frm,"tax_category")])}update_item_tax_map(){let e=this,r=[],a={},t={};if($.each(this.frm.doc.items||[],function(_,o){o.item_code&&(r.push([o.item_code,o.name]),a[o.name]=o.net_rate,t[o.name]=o.item_tax_template)}),r.length)return this.frm.call({method:"erpnext.stock.get_item_details.get_item_tax_info",args:{company:e.frm.doc.company,tax_category:cstr(e.frm.doc.tax_category),item_codes:r,item_rates:a,item_tax_templates:t},callback:function(_){_.exc||$.each(e.frm.doc.items||[],function(o,i){i.name&&_.message.hasOwnProperty(i.name)&&_.message[i.name].item_tax_template&&(i.item_tax_template=_.message[i.name].item_tax_template,i.item_tax_rate=_.message[i.name].item_tax_rate,e.add_taxes_from_item_tax_template(i.item_tax_rate))})}})}item_tax_template(e,r,a){var t=this;if(!t.frm.updating_party_details){var _=frappe.get_doc(r,a);if(_.item_tax_template)return this.frm.call({method:"erpnext.stock.get_item_details.get_item_tax_map",args:{company:t.frm.doc.company,item_tax_template:_.item_tax_template,as_json:!0},callback:function(o){o.exc||(_.item_tax_rate=o.message,t.calculate_taxes_and_totals())}});_.item_tax_rate="{}",t.calculate_taxes_and_totals()}}is_recurring(){if(this.frm.doc.is_recurring&&this.frm.doc.__islocal){frappe.msgprint(__("Please set recurring after saving")),this.frm.set_value("is_recurring",0);return}if(this.frm.doc.is_recurring){this.frm.doc.recurring_id||this.frm.set_value("recurring_id",this.frm.doc.name);var e=this.frm.doc.owner=="Administrator"?frappe.user_info("Administrator").email:this.frm.doc.owner;this.frm.doc.notification_email_address=$.map([cstr(e),cstr(this.frm.doc.contact_email)],function(r){return r||null}).join(", "),this.frm.doc.repeat_on_day_of_month=frappe.datetime.str_to_obj(this.frm.doc.posting_date).getDate()}refresh_many(["notification_email_address","repeat_on_day_of_month"])}from_date(){if(this.frm.doc.from_date){var e={Monthly:1,Quarterly:3,"Half-yearly":6,Yearly:12},r=e[this.frm.doc.recurring_type];if(r){var a=frappe.datetime.add_months(this.frm.doc.from_date,r);this.frm.doc.to_date=frappe.datetime.add_days(a,-1),refresh_field("to_date")}}}set_gross_profit(e){if(["Sales Order","Quotation","Proforma Invoice"].includes(this.frm.doc.doctype)&&e.valuation_rate){var r=flt(e.rate)*flt(this.frm.doc.conversion_rate||1);e.gross_profit=flt((r-e.valuation_rate)*e.stock_qty,precision("amount",e))}}setup_item_selector(){}get_advances(){if(!this.frm.is_return)return this.frm.call({method:"set_advances",doc:this.frm.doc,callback:function(e,r){refresh_field("advances")}})}make_payment_entry(){return frappe.call({method:cur_frm.cscript.get_method_for_payment(),args:{dt:cur_frm.doc.doctype,dn:cur_frm.doc.name},callback:function(e){var r=frappe.model.sync(e.message);frappe.set_route("Form",r[0].doctype,r[0].name)}})}make_quality_inspection(){let e=[],r=[{label:"Items",fieldtype:"Table",fieldname:"items",cannot_add_rows:!0,in_place_edit:!0,data:e,get_data:()=>e,fields:[{fieldtype:"Data",fieldname:"docname",hidden:!0},{fieldtype:"Read Only",fieldname:"item_code",label:__("Item Code"),in_list_view:!0},{fieldtype:"Read Only",fieldname:"item_name",label:__("Item Name"),in_list_view:!0},{fieldtype:"Float",fieldname:"qty",label:__("Accepted Quantity"),in_list_view:!0,read_only:!0},{fieldtype:"Float",fieldname:"sample_size",label:__("Sample Size"),reqd:!0,in_list_view:!0},{fieldtype:"Data",fieldname:"description",label:__("Description"),hidden:!0},{fieldtype:"Data",fieldname:"serial_no",label:__("Serial No"),hidden:!0},{fieldtype:"Data",fieldname:"batch_no",label:__("Batch No"),hidden:!0}]}],a=this,t=new frappe.ui.Dialog({title:__("Select Items for Quality Inspection"),fields:r,primary_action:function(){let _=t.get_values();frappe.call({method:"erpnext.controllers.stock_controller.make_quality_inspections",args:{doctype:a.frm.doc.doctype,docname:a.frm.doc.name,items:_.items},freeze:!0,callback:function(o){o.message.length>0&&(o.message.length===1?frappe.set_route("Form","Quality Inspection",o.message[0]):(frappe.route_options={reference_type:a.frm.doc.doctype,reference_name:a.frm.doc.name},frappe.set_route("List","Quality Inspection"))),t.hide()}})},primary_action_label:__("Create")});this.frm.doc.items.forEach(_=>{if(!_.quality_inspection){let o=t.fields_dict.items;o.df.data.push({docname:_.name,item_code:_.item_code,item_name:_.item_name,qty:_.qty,description:_.description,serial_no:_.serial_no,batch_no:_.batch_no}),o.grid.refresh()}}),e=t.fields_dict.items.df.data,e.length?t.show():frappe.msgprint(__("All items in this document already have a linked Quality Inspection."))}get_method_for_payment(){var e="erpnext.accounts.doctype.payment_entry.payment_entry.get_payment_entry";return cur_frm.doc.__onload&&cur_frm.doc.__onload.make_payment_via_journal_entry&&(in_list(["Sales Invoice","Purchase Invoice"],cur_frm.doc.doctype)?e="erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_invoice":e="erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_order"),e}set_query_for_batch(e,r,a){var t=this,_=frappe.get_doc(r,a);if(!_.item_code)frappe.throw(__("Please enter Item Code to get batch no"));else{if(e.doctype=="Purchase Receipt"||e.doctype=="Purchase Invoice"&&e.update_stock)return{filters:{item:_.item_code}};{let o={item_code:_.item_code,posting_date:t.frm.doc.posting_date||frappe.datetime.nowdate()};return e.is_return&&(o.is_return=1),_.warehouse&&(o.warehouse=_.warehouse),{query:"erpnext.controllers.queries.get_batch_no",filters:o}}}}set_query_for_item_tax_template(e,r,a){var t=frappe.get_doc(r,a);if(t.item_code){let _={item_code:t.item_code,valid_from:["<=",e.transaction_date||e.bill_date||e.posting_date],item_group:t.item_group};return e.tax_category&&(_.tax_category=e.tax_category),e.company&&(_.company=e.company),{query:"erpnext.controllers.queries.get_tax_template",filters:_}}else return e.company?{filters:{company:e.company}}:{}}payment_terms_template(){var e=this;let r=this.frm.doc;if(r.payment_terms_template&&r.doctype!=="Delivery Note"){var a=r.posting_date||r.transaction_date;frappe.call({method:"erpnext.controllers.accounts_controller.get_payment_terms",args:{terms_template:r.payment_terms_template,posting_date:a,grand_total:r.rounded_total||r.grand_total,base_grand_total:r.base_rounded_total||r.base_grand_total,bill_date:r.bill_date},callback:function(t){if(t.message&&!t.exc){e.frm.set_value("payment_schedule",t.message);let _=e.get_company_currency();e.update_payment_schedule_grid_labels(_)}}})}}payment_term(e,r,a){let t=this;var _=locals[r][a];_.payment_term&&frappe.call({method:"erpnext.controllers.accounts_controller.get_payment_term_details",args:{term:_.payment_term,bill_date:this.frm.doc.bill_date,posting_date:this.frm.doc.posting_date||this.frm.doc.transaction_date,grand_total:this.frm.doc.rounded_total||this.frm.doc.grand_total,base_grand_total:this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total},callback:function(o){if(o.message&&!o.exc)for(var i in o.message){frappe.model.set_value(r,a,i,o.message[i]);let n=t.get_company_currency();t.update_payment_schedule_grid_labels(n)}}})}against_blanket_order(e,r,a){var t=locals[r][a];t.against_blanket_order||(frappe.model.set_value(this.frm.doctype+" Item",t.name,"blanket_order",null),frappe.model.set_value(this.frm.doctype+" Item",t.name,"blanket_order_rate",0))}blanket_order(e,r,a){var t=this,_=locals[r][a];_.blanket_order&&(_.parenttype=="Sales Order"||_.parenttype=="Purchase Order")&&frappe.call({method:"erpnext.stock.get_item_details.get_blanket_order_details",args:{args:{item_code:_.item_code,customer:e.customer,supplier:e.supplier,company:e.company,transaction_date:e.transaction_date,blanket_order:_.blanket_order}},callback:function(o){o.message?frappe.run_serially([()=>frappe.model.set_value(r,a,"blanket_order_rate",o.message.blanket_order_rate),()=>t.frm.script_manager.trigger("price_list_rate",r,a)]):frappe.throw(__("Invalid Blanket Order for the selected Customer and Item"))}})}set_reserve_warehouse(){this.autofill_warehouse(this.frm.doc.supplied_items,"reserve_warehouse",this.frm.doc.set_reserve_warehouse)}set_warehouse(){this.autofill_warehouse(this.frm.doc.items,"warehouse",this.frm.doc.set_warehouse)}set_target_warehouse(){this.autofill_warehouse(this.frm.doc.items,"target_warehouse",this.frm.doc.set_target_warehouse)}set_from_warehouse(){this.autofill_warehouse(this.frm.doc.items,"from_warehouse",this.frm.doc.set_from_warehouse)}autofill_warehouse(e,r,a){if(a&&e&&e.length){let t=e[0].doctype;$.each(e||[],function(_,o){frappe.model.set_value(t,o.name,r,a)})}}coupon_code(){var e=this;frappe.run_serially([()=>this.frm.doc.ignore_pricing_rule=1,()=>e.ignore_pricing_rule(),()=>this.frm.doc.ignore_pricing_rule=0,()=>e.apply_pricing_rule()])}};erpnext.show_serial_batch_selector=function(c,e,r,a,t){let _,o,i;c.doc.is_return?["Purchase Receipt","Purchase Invoice"].includes(c.doc.doctype)?(i=!0,_=e.warehouse):["Delivery Note","Sales Invoice"].includes(c.doc.doctype)&&(o=!0):c.doc.doctype=="Stock Entry"?c.doc.purpose=="Material Receipt"?o=!0:(i=!0,_=e.s_warehouse):(i=!0,_=e.warehouse),_||(o?_=["like",""]:i&&(_=["!=",""])),frappe.require("assets/erpnext/js/utils/serial_no_batch_selector.js",function(){new erpnext.SerialNoBatchSelector({frm:c,item:e,warehouse_details:{type:"Warehouse",name:_},callback:r,on_close:a},t)})};erpnext.apply_putaway_rule=(c,e=null)=>{c.doc.company||frappe.throw({message:__("Please select a Company first."),title:__("Mandatory")}),c.doc.items.length&&frappe.call({method:"erpnext.stock.doctype.putaway_rule.putaway_rule.apply_putaway_rule",args:{doctype:c.doctype,items:c.doc.items,company:c.doc.company,sync:!0,purpose:e},callback:r=>{!r.exc&&r.message&&(c.clear_table("items"),r.message.forEach(t=>{delete t.name;let _=c.add_child("items");Object.assign(_,t),c.script_manager.trigger("qty",_.doctype,_.name)}),c.get_field("items").grid.refresh())}})};frappe.ui.form.on("Sales Invoice",{refresh:function(c){c.ignore_doctypes_on_cancel_all=["Delivery Note"]},onload:function(c){c.ignore_doctypes_on_cancel_all=["Delivery Note"],c.doc.company&&(c.doc.bank_account||frappe.db.get_value("Bank Account",{company:c.doc.company,is_company_account:1,is_default:1},"name",function(e){c.set_value("bank_account",e.name)}))},company:function(c){c.doc.company&&(c.doc.bank_account||frappe.db.get_value("Bank Account",{company:c.doc.company,is_company_account:1,is_default:1},"name",function(e){c.set_value("bank_account",e.name)}))}});})();
//# sourceMappingURL=engr.bundle.OCG3KTNK.js.map
